<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Peter Niederwieser, Leonard BrÃ¼nings, The Spock Framework Team">
<title>Spock Framework Reference Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
  .includeSourceLinkerTable tr td:first-child {
    padding: 0;
  }
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Spock Framework Reference Documentation</h1>
<div class="details">
<span id="author" class="author">Peter Niederwieser, Leonard BrÃ¼nings, The Spock Framework Team</span><br>
<span id="revnumber">version X-replaced-by-gradle</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_getting_started">Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_groovy_web_console">Groovy Web Console</a></li>
<li><a href="#_spock_example_project">Spock Example Project</a></li>
</ul>
</li>
<li><a href="#_spock_primer">Spock Primer</a>
<ul class="sectlevel2">
<li><a href="#_terminology">Terminology</a></li>
<li><a href="#_imports">Imports</a></li>
<li><a href="#_specification">Specification</a></li>
<li><a href="#_fields">Fields</a></li>
<li><a href="#_fixture_methods">Fixture Methods</a>
<ul class="sectlevel3">
<li><a href="#_invocation_order">Invocation Order</a></li>
</ul>
</li>
<li><a href="#_feature_methods">Feature Methods</a>
<ul class="sectlevel3">
<li><a href="#_blocks">Blocks</a></li>
</ul>
</li>
<li><a href="#_helper_methods">Helper Methods</a></li>
<li><a href="#_using_with_for_expectations">Using <code>with</code> for expectations</a></li>
<li><a href="#_using_verifyall_or_verifyall_helper_methods_to_assert_multiple_expectations_together">Using <code>verifyAll</code> or <code>@VerifyAll</code> helper methods to assert multiple expectations together</a></li>
<li><a href="#_using_verifyeach_to_assert_on_each_element_of_an_iterable">Using <code>verifyEach</code> to assert on each element of an <code>Iterable</code></a>
<ul class="sectlevel3">
<li><a href="#_list_equality">List Equality</a></li>
<li><a href="#_set_equality">Set Equality</a></li>
<li><a href="#_every_method">Every Method</a></li>
<li><a href="#verify-each">VerifyEach Method</a></li>
</ul>
</li>
<li><a href="#specifications-as-documentation">Specifications as Documentation</a></li>
<li><a href="#_extensions">Extensions</a></li>
<li><a href="#_comparison_to_junit">Comparison to JUnit</a></li>
</ul>
</li>
<li><a href="#data-driven-testing">Data Driven Testing</a>
<ul class="sectlevel2">
<li><a href="#_introduction_2">Introduction</a></li>
<li><a href="#data-tables">Data Tables</a></li>
<li><a href="#_isolated_execution_of_iterations">Isolated Execution of Iterations</a></li>
<li><a href="#_sharing_of_objects_between_iterations">Sharing of Objects between Iterations</a></li>
<li><a href="#_syntactic_variations">Syntactic Variations</a></li>
<li><a href="#_reporting_of_failures">Reporting of Failures</a></li>
<li><a href="#_method_uprolling_and_unrolling">Method Uprolling and Unrolling</a></li>
<li><a href="#_data_pipes">Data Pipes</a></li>
<li><a href="#_multi_variable_data_pipes">Multi-Variable Data Pipes</a>
<ul class="sectlevel3">
<li><a href="#multi-data-pipe-named">Named deconstruction of data pipes</a></li>
</ul>
</li>
<li><a href="#_cross_multiplying_data_providers">Cross-multiplying Data Providers</a></li>
<li><a href="#_data_variable_assignment">Data Variable Assignment</a></li>
<li><a href="#_accessing_other_data_variables">Accessing Other Data Variables</a></li>
<li><a href="#_multi_variable_assignment">Multi-Variable Assignment</a></li>
<li><a href="#_combining_data_tables_data_pipes_and_variable_assignments">Combining Data Tables, Data Pipes, and Variable Assignments</a></li>
<li><a href="#_type_coercion_for_data_variable_values">Type Coercion for Data Variable Values</a></li>
<li><a href="#_number_of_iterations">Number of Iterations</a></li>
<li><a href="#_filtering_iterations">Filtering iterations</a></li>
<li><a href="#_closing_of_data_providers">Closing of Data Providers</a></li>
<li><a href="#_unrolled_iteration_names">Unrolled Iteration Names</a>
<ul class="sectlevel3">
<li><a href="#unroll-tokens">Special Tokens</a></li>
<li><a href="#_configuration">Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#interaction-based-testing">Interaction Based Testing</a>
<ul class="sectlevel2">
<li><a href="#_creating_mock_objects">Creating Mock Objects</a></li>
<li><a href="#_default_behavior_of_mock_objects">Default Behavior of Mock Objects</a></li>
<li><a href="#_injecting_mock_objects_into_code_under_specification">Injecting Mock Objects into Code Under Specification</a></li>
<li><a href="#_dynamic_method_names_in_interactions">Dynamic Method Names in Interactions</a></li>
<li><a href="#_mocking">Mocking</a>
<ul class="sectlevel3">
<li><a href="#_interactions_2">Interactions</a></li>
<li><a href="#_cardinality">Cardinality</a></li>
<li><a href="#_target_constraint">Target Constraint</a></li>
<li><a href="#_method_constraint">Method Constraint</a></li>
<li><a href="#_argument_constraints">Argument Constraints</a></li>
<li><a href="#_matching_any_method_call">Matching Any Method Call</a></li>
<li><a href="#_strict_mocking">Strict Mocking</a></li>
<li><a href="#_where_to_declare_interactions">Where to Declare Interactions</a></li>
<li><a href="#declaring-interactions-at-creation-time">Declaring Interactions at Mock Creation Time</a></li>
<li><a href="#_grouping_interactions_with_same_target">Grouping Interactions with Same Target</a></li>
<li><a href="#_mixing_interactions_and_conditions">Mixing Interactions and Conditions</a></li>
<li><a href="#_explicit_interaction_blocks">Explicit Interaction Blocks</a></li>
<li><a href="#_scope_of_interactions">Scope of Interactions</a></li>
<li><a href="#_verification_of_interactions">Verification of Interactions</a></li>
<li><a href="#_invocation_order_2">Invocation Order</a></li>
<li><a href="#_mocking_classes">Mocking Classes</a></li>
<li><a href="#_mock_instance_construction">Mock Instance Construction</a></li>
<li><a href="#_selecting_a_mock_maker">Selecting a Mock Maker</a></li>
</ul>
</li>
<li><a href="#_stubbing">Stubbing</a>
<ul class="sectlevel3">
<li><a href="#_returning_fixed_values">Returning Fixed Values</a></li>
<li><a href="#_returning_sequences_of_values">Returning Sequences of Values</a></li>
<li><a href="#_computing_return_values">Computing Return Values</a></li>
<li><a href="#_performing_side_effects">Performing Side Effects</a></li>
<li><a href="#_chaining_method_responses">Chaining Method Responses</a></li>
<li><a href="#_returning_a_default_response">Returning a default response</a></li>
</ul>
</li>
<li><a href="#_combining_mocking_and_stubbing">Combining Mocking and Stubbing</a></li>
<li><a href="#OtherKindsOfMockObjects">Other Kinds of Mock Objects</a>
<ul class="sectlevel3">
<li><a href="#Stubs">Stubs</a></li>
<li><a href="#Spies">Spies</a></li>
<li><a href="#PartialMocks">Partial Mocks</a></li>
</ul>
</li>
<li><a href="#MockingStaticMethods">Mocking Static Methods</a>
<ul class="sectlevel3">
<li><a href="#static-mocks">Static Mocks</a></li>
<li><a href="#_static_mocks_and_threading">Static Mocks and Threading</a></li>
</ul>
</li>
<li><a href="#GroovyMocks">Groovy Mocks</a>
<ul class="sectlevel3">
<li><a href="#_mocking_dynamic_methods">Mocking Dynamic Methods</a></li>
<li><a href="#MockingAllInstancesOfAType">Mocking All Instances of a Type</a></li>
<li><a href="#MockingConstructors">Mocking Constructors</a></li>
<li><a href="#global-groovy-mock-static-methods">Global Groovy Mocks for Static Methods</a></li>
</ul>
</li>
<li><a href="#_advanced_features">Advanced Features</a>
<ul class="sectlevel3">
<li><a href="#ALaCarteMocks">A la Carte Mocks</a></li>
<li><a href="#DetectingMockObjects">Detecting Mock Objects</a></li>
<li><a href="#DetachedMockFactory">Create Mocks Outside Specifications</a></li>
</ul>
</li>
<li><a href="#_further_reading">Further Reading</a></li>
</ul>
</li>
<li><a href="#extensions">Extensions</a>
<ul class="sectlevel2">
<li><a href="#spock-configuration-file">Spock Configuration File</a>
<ul class="sectlevel3">
<li><a href="#_stack_trace_filtering">Stack Trace Filtering</a></li>
<li><a href="#_parallel_execution_configuration">Parallel Execution Configuration</a></li>
</ul>
</li>
<li><a href="#_built_in_extensions">Built-In Extensions</a>
<ul class="sectlevel3">
<li><a href="#_ignore">Ignore</a></li>
<li><a href="#_ignorerest">IgnoreRest</a></li>
<li><a href="#_ignoreif">IgnoreIf</a></li>
<li><a href="#_requires">Requires</a></li>
<li><a href="#_pendingfeature">PendingFeature</a></li>
<li><a href="#_pendingfeatureif">PendingFeatureIf</a></li>
<li><a href="#_stepwise">Stepwise</a></li>
<li><a href="#timeout-extension">Timeout</a></li>
<li><a href="#_retry">Retry</a></li>
<li><a href="#_use">Use</a></li>
<li><a href="#_confinemetaclasschanges">ConfineMetaClassChanges</a></li>
<li><a href="#_restoresystemproperties">RestoreSystemProperties</a></li>
<li><a href="#_autoattach">AutoAttach</a></li>
<li><a href="#_autocleanup">AutoCleanup</a></li>
<li><a href="#temp-dir">TempDir</a></li>
<li><a href="#title-and-narrative-extension">Title and Narrative</a></li>
<li><a href="#_see">See</a></li>
<li><a href="#_issue">Issue</a></li>
<li><a href="#_subject">Subject</a></li>
<li><a href="#_rule">Rule</a></li>
<li><a href="#_classrule">ClassRule</a></li>
<li><a href="#_include_and_exclude">Include and Exclude</a></li>
<li><a href="#test-tag-extension">Tags</a></li>
<li><a href="#_repeat_until_failure">Repeat until failure</a></li>
<li><a href="#_optimize_run_order">Optimize Run Order</a></li>
<li><a href="#snapshot-testing">Snapshot testing</a></li>
</ul>
</li>
<li><a href="#_third_party_extensions">Third-Party Extensions</a></li>
<li><a href="#_writing_custom_extensions">Writing Custom Extensions</a>
<ul class="sectlevel3">
<li><a href="#_global_extensions">Global Extensions</a></li>
<li><a href="#_annotation_driven_local_extensions">Annotation Driven Local Extensions</a></li>
<li><a href="#_configuration_objects">Configuration Objects</a></li>
<li><a href="#interceptors">Interceptors</a></li>
<li><a href="#mock-makers">Mock Maker Extensions</a></li>
<li><a href="#extension-store">Keeping State in Extensions</a></li>
<li><a href="#default-value-provider">Default Value Provider Extensions</a></li>
<li><a href="#_listeners">Listeners</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#utilities">Utilities</a>
<ul class="sectlevel2">
<li><a href="#mutable-clock">Testing Time with <code>MutableClock</code></a>
<ul class="sectlevel3">
<li><a href="#_example">Example</a></li>
</ul>
</li>
<li><a href="#collection-conditions">Collection Conditions</a>
<ul class="sectlevel3">
<li><a href="#_lenient_match">Lenient Match</a></li>
<li><a href="#_strict_match">Strict Match</a></li>
</ul>
</li>
<li><a href="#file-stystem-fixture">Interact with the file system using <code>FileSystemFixture</code></a>
<ul class="sectlevel3">
<li><a href="#_examples">Examples</a></li>
</ul>
</li>
<li><a href="#old-method">Capture Values for Assertions with <code>old()</code></a>
<ul class="sectlevel3">
<li><a href="#_example_2">Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#parallel-execution">Parallel Execution</a>
<ul class="sectlevel2">
<li><a href="#execution-modes">Execution modes</a>
<ul class="sectlevel3">
<li><a href="#_execution_hierarchy">Execution Hierarchy</a></li>
</ul>
</li>
<li><a href="#_resource_locks">Resource Locks</a>
<ul class="sectlevel3">
<li><a href="#_lock_inheritance">Lock inheritance</a></li>
<li><a href="#_lock_coarsening">Lock coarsening</a></li>
<li><a href="#isolated-execution">Isolated Execution</a></li>
</ul>
</li>
<li><a href="#parallel-thread-pool">Parallel Thread Pool</a></li>
</ul>
</li>
<li><a href="#_modules">Modules</a>
<ul class="sectlevel2">
<li><a href="#junit-4">JUnit 4 Module</a></li>
<li><a href="#_guice_module">Guice Module</a></li>
<li><a href="#spring-module">Spring Module</a>
<ul class="sectlevel3">
<li><a href="#SpringMocks">Mocks</a></li>
<li><a href="#_scopes">Scopes</a></li>
<li><a href="#_shared_fields_injection">Shared fields injection</a></li>
</ul>
</li>
<li><a href="#_tapestry_module">Tapestry Module</a></li>
<li><a href="#_unitils_module">Unitils Module</a></li>
<li><a href="#_grails_module">Grails Module</a></li>
</ul>
</li>
<li><a href="#_groovy_syntax_useful_for_spock">Groovy Syntax Useful for Spock</a>
<ul class="sectlevel2">
<li><a href="#_merge_2_maps">Merge 2 Maps</a></li>
</ul>
</li>
<li><a href="#release-notes">Release Notes</a>
<ul class="sectlevel2">
<li><a href="#_2_4_tbd">2.4 (tbd)</a>
<ul class="sectlevel3">
<li><a href="#_highlights">Highlights</a></li>
<li><a href="#_breaking_changes">Breaking Changes</a></li>
</ul>
</li>
<li><a href="#_2_4_m6_2025_04_15">2.4-M6 (2025-04-15)</a>
<ul class="sectlevel3">
<li><a href="#_highlights_2">Highlights</a></li>
<li><a href="#_breaking_changes_2">Breaking Changes</a></li>
<li><a href="#_misc">Misc</a></li>
</ul>
</li>
<li><a href="#_2_4_m5_2025_01_07">2.4-M5 (2025-01-07)</a>
<ul class="sectlevel3">
<li><a href="#_highlights_3">Highlights</a></li>
<li><a href="#_misc_2">Misc</a></li>
</ul>
</li>
<li><a href="#_2_4_m4_2024_03_21">2.4-M4 (2024-03-21)</a></li>
<li><a href="#_2_4_m3_2024_03_21">2.4-M3 (2024-03-21)</a>
<ul class="sectlevel3">
<li><a href="#_breaking_changes_3">Breaking Changes</a></li>
<li><a href="#_misc_3">Misc</a></li>
</ul>
</li>
<li><a href="#_2_4_m2_2024_02_26">2.4-M2 (2024-02-26)</a>
<ul class="sectlevel3">
<li><a href="#_highlights_4">Highlights</a></li>
<li><a href="#_breaking_changes_4">Breaking Changes</a></li>
<li><a href="#_misc_4">Misc</a></li>
</ul>
</li>
<li><a href="#_2_4_m1_2022_11_30">2.4-M1 (2022-11-30)</a></li>
<li><a href="#_2_3_2022_09_29">2.3 (2022-09-29)</a></li>
<li><a href="#_2_2_2022_08_31">2.2 (2022-08-31)</a></li>
<li><a href="#_2_2_m3_2022_07_15">2.2-M3 (2022-07-15)</a></li>
<li><a href="#_2_2_m2_2022_07_15">2.2-M2 (2022-07-15)</a></li>
<li><a href="#_2_2_m1_2022_02_16">2.2-M1 (2022-02-16)</a></li>
<li><a href="#_2_1_2022_02_15">2.1 (2022-02-15)</a></li>
<li><a href="#_official_spock_logo">Official Spock Logo</a></li>
<li><a href="#_misc_5">Misc</a></li>
<li><a href="#_2_1_m2_2021_11_12">2.1-M2 (2021-11-12)</a></li>
<li><a href="#_2_1_m1_2021_11_12">2.1-M1 (2021-11-12)</a>
<ul class="sectlevel3">
<li><a href="#_highlights_5">Highlights</a></li>
<li><a href="#_breaking_changes_5">Breaking Changes</a></li>
<li><a href="#_misc_6">Misc</a></li>
</ul>
</li>
<li><a href="#_2_0_2021_05_17">2.0 (2021-05-17)</a>
<ul class="sectlevel3">
<li><a href="#_highlights_6">Highlights</a></li>
<li><a href="#_migrating_from_1_x">Migrating from 1.x</a></li>
<li><a href="#_breaking_changes_from_2_0_m5">Breaking Changes (from 2.0-M5)</a></li>
<li><a href="#_misc_7">Misc</a></li>
</ul>
</li>
<li><a href="#_2_0_m5_2021_03_23">2.0-M5 (2021-03-23)</a>
<ul class="sectlevel3">
<li><a href="#_breaking_changes_6">Breaking Changes</a></li>
<li><a href="#_misc_8">Misc</a></li>
</ul>
</li>
<li><a href="#_2_0_m4_2020_11_01">2.0-M4 (2020-11-01)</a></li>
<li><a href="#_2_0_m3_2020_06_11">2.0-M3 (2020-06-11)</a>
<ul class="sectlevel3">
<li><a href="#_breaking_changes_7">Breaking Changes</a></li>
<li><a href="#_misc_9">Misc</a></li>
</ul>
</li>
<li><a href="#_2_0_m2_2020_02_10">2.0-M2 (2020-02-10)</a>
<ul class="sectlevel3">
<li><a href="#_groovy_3_0_support">Groovy-3.0 Support</a></li>
<li><a href="#_breaking_changes_8">Breaking Changes</a></li>
<li><a href="#_misc_10">Misc</a></li>
</ul>
</li>
<li><a href="#_2_0_m1_2019_12_31">2.0-M1 (2019-12-31)</a>
<ul class="sectlevel3">
<li><a href="#_breaking_changes_9">Breaking Changes</a></li>
</ul>
</li>
<li><a href="#_1_3_2019_03_05">1.3 (2019-03-05)</a></li>
<li><a href="#_1_3_rc1_2019_01_22">1.3-RC1 (2019-01-22)</a>
<ul class="sectlevel3">
<li><a href="#_potential_breaking_changes">Potential breaking changes</a></li>
<li><a href="#_whats_new_in_this_release">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_2_2018_09_23">1.2 (2018-09-23)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_2">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_2_rc3_2018_09_16">1.2-RC3 (2018-09-16)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_3">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_2_rc2_2018_09_04">1.2-RC2 (2018-09-04)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_4">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_2_rc1_2018_08_14">1.2-RC1 (2018-08-14)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_5">What&#8217;s New In This release</a></li>
<li><a href="#_known_issues">Known Issues</a></li>
</ul>
</li>
<li><a href="#_1_1_2017_05_01">1.1 (2017-05-01)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_6">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_1_rc_4_2017_03_28">1.1-rc-4 (2017-03-28)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_7">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_1_rc_3_released_2016_10_17">1.1-rc-3 (released 2016-10-17)</a></li>
<li><a href="#_1_1_rc_2_released_2016_08_22">1.1-rc-2 (released 2016-08-22)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_8">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_1_rc_1_released_2016_06_30">1.1-rc-1 (released 2016-06-30)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_9">What&#8217;s New In This release</a></li>
</ul>
</li>
<li><a href="#_1_0_released_2015_03_02">1.0 (released 2015-03-02)</a>
<ul class="sectlevel3">
<li><a href="#_whats_new_in_this_release_10">What&#8217;s New In This Release</a></li>
<li><a href="#_other_news">Other News</a></li>
<li><a href="#_whats_up_next">What&#8217;s Up Next?</a></li>
<li><a href="#_contributors">Contributors</a></li>
<li><a href="#_resolved_issues">Resolved Issues</a></li>
<li><a href="#_merged_pull_requests">Merged Pull Requests</a></li>
<li><a href="#_new_third_party_extensions">New Third Party Extensions</a></li>
<li><a href="#_ongoing_work">Ongoing Work</a></li>
</ul>
</li>
<li><a href="#_0_7_released_2012_10_08">0.7 (released 2012-10-08)</a>
<ul class="sectlevel3">
<li><a href="#_snapshot_repository_moved">Snapshot Repository Moved</a></li>
<li><a href="#_new_reference_documentation">New Reference Documentation</a></li>
<li><a href="#_improved_mocking_failure_message_for_toomanyinvocationserror">Improved Mocking Failure Message for <code>TooManyInvocationsError</code></a></li>
<li><a href="#_improved_mocking_failure_message_for_toofewinvocationserror">Improved Mocking Failure Message for <code>TooFewInvocationsError</code></a></li>
<li><a href="#_stubs">Stubs</a></li>
<li><a href="#_spies">Spies</a></li>
<li><a href="#_declaring_interactions_at_mock_creation_time">Declaring Interactions at Mock Creation Time</a></li>
<li><a href="#_groovy_mocks">Groovy Mocks</a></li>
<li><a href="#_global_mocks">Global Mocks</a></li>
<li><a href="#_grouping_conditions_with_same_target_object">Grouping Conditions with Same Target Object</a></li>
<li><a href="#_grouping_interactions_with_same_target_object">Grouping Interactions with Same Target Object</a></li>
<li><a href="#_polling_conditions">Polling Conditions</a></li>
<li><a href="#_experimental_dsl_support_for_eclipse">Experimental DSL Support for Eclipse</a></li>
<li><a href="#_experimental_dsl_support_for_intellij_idea">Experimental DSL Support for IntelliJ IDEA</a></li>
<li><a href="#_splitting_up_class_specification">Splitting up Class Specification</a></li>
<li><a href="#_improved_failure_messages_for_notthrown_and_noexceptionthrown">Improved Failure Messages for <code>notThrown</code> and <code>noExceptionThrown</code></a></li>
<li><a href="#_hamcrestsupport_expect"><code>HamcrestSupport.expect</code></a></li>
<li><a href="#_beta">@Beta</a></li>
<li><a href="#_fixed_issues">Fixed Issues</a></li>
</ul>
</li>
<li><a href="#_0_6_released_2012_05_02">0.6 (released 2012-05-02)</a>
<ul class="sectlevel3">
<li><a href="#_mocking_improvements">Mocking Improvements</a></li>
<li><a href="#_extended_junit_rules_support">Extended JUnit Rules Support</a></li>
<li><a href="#_condition_rendering_improvements">Condition Rendering Improvements</a></li>
<li><a href="#_junit_fixture_annotations">JUnit Fixture Annotations</a></li>
<li><a href="#_tapestry_5_3_support">Tapestry 5.3 Support</a></li>
<li><a href="#_ibm_jdk_support">IBM JDK Support</a></li>
<li><a href="#_improved_junit_compatibility">Improved JUnit Compatibility</a></li>
<li><a href="#improved-unroll-0.6">Improved <code>@Unroll</code></a></li>
<li><a href="#_improved_timeout">Improved <code>@Timeout</code></a></li>
<li><a href="#_improved_data_table_syntax">Improved Data Table Syntax</a></li>
<li><a href="#_groovy_1_82_0_support">Groovy 1.8/2.0 Support</a></li>
<li><a href="#_grails_2_0_support">Grails 2.0 Support</a></li>
<li><a href="#_intellij_idea_integration">IntelliJ IDEA Integration</a></li>
<li><a href="#_github_repository">GitHub Repository</a></li>
<li><a href="#_gradle_build">Gradle Build</a></li>
<li><a href="#_fixed_issues_2">Fixed Issues</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_migration_guide">Migration Guide</a>
<ul class="sectlevel2">
<li><a href="#migration-guide-2-0">2.0</a>
<ul class="sectlevel3">
<li><a href="#_junit_4_support">JUnit 4 support</a></li>
<li><a href="#_reduce_spock_core_direct_groovy_dependencies_2">Reduce spock-core direct groovy dependencies</a></li>
<li><a href="#_unroll_changes">Unroll changes</a></li>
<li><a href="#_assert_unroll_expressions_by_default_2">Assert unroll expressions by default</a></li>
<li><a href="#_renamed_iterationcount_token_2">Renamed iterationCount token</a></li>
<li><a href="#_new_meaning_of_2">New meaning of <code>&gt;&gt; _</code></a></li>
<li><a href="#_no_access_to_data_variables_in_data_pipes_anymore_2">No access to data variables in data pipes anymore</a></li>
<li><a href="#_ant_support_removed_2">Ant support removed</a></li>
<li><a href="#_other_breaking_changes">Other Breaking changes</a></li>
</ul>
</li>
<li><a href="#_1_0">1.0</a></li>
<li><a href="#_0_7">0.7</a></li>
<li><a href="#_0_6">0.6</a>
<ul class="sectlevel3">
<li><a href="#_class_initialization_order">Class initialization order</a></li>
<li><a href="#_unroll_naming_pattern_syntax"><code>@Unroll</code> naming pattern syntax</a></li>
<li><a href="#_hamcrest_matcher_syntax">Hamcrest matcher syntax</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_frequently_asked_questions_faq">Frequently Asked Questions (FAQ)</a>
<ul class="sectlevel2">
<li><a href="#_what_are_spocks_optional_dependencies_used_for">What are Spock&#8217;s optional dependencies used for?</a></li>
<li><a href="#_why_are_there_two_options_bytebuddy_vs_cglib_for_mocking_classes">Why are there two options (ByteBuddy vs CGLIB) for mocking classes?</a></li>
</ul>
</li>
<li><a href="#_known_issues_2">Known Issues</a>
<ul class="sectlevel2">
<li><a href="#instance-spy-on-java-17">Constructing a Spy from an existing instance on Java 17+</a></li>
<li><a href="#_usage_of_final_in_a_feature_method_with_cleanup_spockissue1017">Usage of <code>final</code> in a feature method with <code>cleanup</code> spockIssue:1017[]</a></li>
<li><a href="#_using_traits_with_specifications">Using Traits with Specifications</a></li>
<li><a href="#_groovy_version_compatibility">Groovy version compatibility</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="link" href="#_introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/spock-main-logo.png" alt="Spock Logo" width="20%">
</div>
</div>
<div class="paragraph">
<p>Spock is a testing and specification framework for Java and Groovy applications. What makes it stand out from the crowd
is its beautiful and highly expressive specification language. Thanks to its JUnit runner, Spock is compatible with most
IDEs, build tools, and continuous integration servers. Spock is inspired from <a href="https://junit.org/">JUnit</a>,
<a href="https://www.jmock.org/">jMock</a>, <a href="https://rspec.info/">RSpec</a>, <a href="https://groovy-lang.org/">Groovy</a>, <a href="https://scala-lang.org/">Scala</a>,
<a href="https://en.wikipedia.org/wiki/Vulcan_(Star_Trek)">Vulcans</a>, and other fascinating life forms.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="link" href="#_getting_started">Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s really easy to get started with Spock. This section shows you how.</p>
</div>
<div class="sect2">
<h3 id="_groovy_web_console"><a class="link" href="#_groovy_web_console">Groovy Web Console</a></h3>
<div class="paragraph">
<p><a href="https://groovyconsole.dev/">Groovy Web Console</a> is a website that allows you to instantly view, edit, run, and
even publish Spock specifications. It is the perfect place to toy around with Spock without making any commitments.
So why not run <a href="https://groovyconsole.dev/?g=groovy_4_0&amp;codez=eNpdizEKg0AQRfs9xU81hgTsBUuDTSpPYMYRBhc3ZEc0BO-ejbGy-5_3Xp6jVgNVi_BkQniID7Nj38aI-_umr2jNUxiymIxdxO9or9yahhEfB3TSg2rxPlwTDTycKDtvBKlKuhXb_juEC2jXUJbHMpmrW90Xc9sttg">Hello, Spock!</a> right away?</p>
</div>
</div>
<div class="sect2">
<h3 id="_spock_example_project"><a class="link" href="#_spock_example_project">Spock Example Project</a></h3>
<div class="paragraph">
<p>To try Spock in your local environment, clone or download/unzip the
<a href="https://github.com/spockframework/spock-example">Spock Example Project</a>. It comes with fully working Ant, Gradle, and
Maven builds that require no further setup. The Gradle build even bootstraps Gradle itself and gets you up and
running in Eclipse or IDEA with a single command. See the README for detailed instructions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spock_primer"><a class="link" href="#_spock_primer">Spock Primer</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter assumes that you have a basic knowledge of Groovy and unit testing. If you are a Java developer but haven&#8217;t
heard about Groovy, don&#8217;t worry - Groovy will feel very familiar to you! In fact, one of Groovy&#8217;s main design goals is to
be <em>the</em> scripting language alongside Java. So just follow along and consult the
<a href="https://groovy-lang.org/documentation.html">Groovy documentation</a> whenever you feel like it.</p>
</div>
<div class="paragraph">
<p>The goals of this chapter are to teach you enough Spock to write real-world Spock specifications, and to
whet your appetite for more.</p>
</div>
<div class="paragraph">
<p>To learn more about Groovy, go to <a href="https://groovy-lang.org/" class="bare">https://groovy-lang.org/</a>.</p>
</div>
<div class="paragraph">
<p>To learn more about unit testing, go to <a href="https://en.wikipedia.org/wiki/Unit_testing" class="bare">https://en.wikipedia.org/wiki/Unit_testing</a>.</p>
</div>
<div class="sect2">
<h3 id="_terminology"><a class="link" href="#_terminology">Terminology</a></h3>
<div class="paragraph">
<p>Let&#8217;s start with a few definitions: Spock lets you write <a href="https://en.wikipedia.org/wiki/Specification_by_example"><em>specifications</em></a>
that describe expected <em>features</em> (properties, aspects) exhibited by a system of interest. The system of interest could be
anything between a single class and a whole application, and is also called the <em>system under specification or SUS</em>.
The description of a feature starts from a specific snapshot of the SUS and its collaborators; this snapshot is called the feature&#8217;s <em>fixture</em>.</p>
</div>
<div class="paragraph">
<p>The following sections walk you through all building blocks of which a Spock specification may be composed. A typical
specification uses only a subset of them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_imports"><a class="link" href="#_imports">Imports</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import spock.lang.*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Package <code>spock.lang</code> contains the most important types for writing specifications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_specification"><a class="link" href="#_specification">Specification</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MyFirstSpecification extends Specification {
  // fields
  // fixture methods
  // feature methods
  // helper methods
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A specification is represented as a Groovy class that extends from <code>spock.lang.Specification</code>. The name of a specification
usually relates to the system or system operation described by the specification. For example, <code>CustomerSpec</code>,
<code>H264VideoPlayback</code>, and <code>ASpaceshipAttackedFromTwoSides</code> are all reasonable names for a specification.</p>
</div>
<div class="paragraph">
<p>Class <code>Specification</code> contains a number of useful methods for writing specifications. Furthermore it instructs JUnit to
run specification with <code>Sputnik</code>, Spock&#8217;s JUnit runner. Thanks to Sputnik, Spock specifications can be run by most modern
Java IDEs and build tools.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fields"><a class="link" href="#_fields">Fields</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def obj = new ClassUnderSpecification()
def coll = new Collaborator()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instance fields are a good place to store objects belonging to the specification&#8217;s fixture. It is good practice to
initialize them right at the point of declaration. (Semantically, this is equivalent to initializing them at the very
beginning of the <code>setup()</code> method.) Objects stored into instance fields are <em>not</em> shared between feature methods.
Instead, every feature method gets its own object. This helps to isolate feature methods from each other, which is often
a desirable goal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Shared res = new VeryExpensiveResource()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you need to share an object between feature methods. For example, the object might be very expensive to create,
or you might want your feature methods to interact with each other. To achieve this, declare a <code>@Shared</code> field. Again
it&#8217;s best to initialize the field right at the point of declaration. (Semantically, this is equivalent to initializing
the field at the very beginning of the <code>setupSpec()</code> method.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">static final PI = 3.141592654</code></pre>
</div>
</div>
<div class="paragraph">
<p>Static fields should only be used for constants.
Otherwise, shared fields are preferable, because their semantics with respect to sharing are more well-defined.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixture_methods"><a class="link" href="#_fixture_methods">Fixture Methods</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def setupSpec() {}    // runs once -  before the first feature method
def setup() {}        // runs before every feature method
def cleanup() {}      // runs after every feature method
def cleanupSpec() {}  // runs once -  after the last feature method</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fixture methods are responsible for setting up and cleaning up the environment in which feature methods are run.
Usually it&#8217;s a good idea to use a fresh fixture for every feature method, which is what the <code>setup()</code> and <code>cleanup()</code> methods are for.</p>
</div>
<div class="paragraph">
<p>All fixture methods are optional.</p>
</div>
<div class="paragraph">
<p>Occasionally it makes sense for feature methods to share a fixture, which is achieved by using shared fields together with the <code>setupSpec()</code> and <code>cleanupSpec()</code> methods.
Note that <code>setupSpec()</code> and <code>cleanupSpec()</code> <em>may not</em> reference instance fields unless they are annotated with <code>@Shared</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There may be only one fixture method of each type per specification class.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_invocation_order"><a class="link" href="#_invocation_order">Invocation Order</a></h4>
<div class="paragraph">
<p>If fixture methods are overridden in a specification subclass then <code>setup()</code> of the superclass will run before <code>setup()</code> of the subclass.
<code>cleanup()</code> works in reverse order, that is <code>cleanup()</code> of the subclass will execute before <code>cleanup()</code> of the superclass.
<code>setupSpec()</code> and <code>cleanupSpec()</code> behave in the same way.
There is no need to explicitly call <code>super.setup()</code> or <code>super.cleanup()</code> as Spock will automatically find and execute fixture methods at all levels in an inheritance hierarchy.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>super.setupSpec</code></p>
</li>
<li>
<p><code>sub.setupSpec</code></p>
</li>
<li>
<p><code>super.setup</code></p>
</li>
<li>
<p><code>sub.setup</code></p>
</li>
<li>
<p>feature method</p>
</li>
<li>
<p><code>sub.cleanup</code></p>
</li>
<li>
<p><code>super.cleanup</code></p>
</li>
<li>
<p><code>sub.cleanupSpec</code></p>
</li>
<li>
<p><code>super.cleanupSpec</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_feature_methods"><a class="link" href="#_feature_methods">Feature Methods</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "pushing an element on the stack"() {
  // blocks go here
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Feature methods are the heart of a specification. They describe the features (properties, aspects) that you expect to
find in the system under specification. By convention, feature methods are named with String literals. Try to choose
good names for your feature methods, and feel free to use any characters you like!</p>
</div>
<div class="paragraph">
<p>Conceptually, a feature method consists of four phases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up the feature&#8217;s fixture</p>
</li>
<li>
<p>Provide a <em>stimulus</em> to the system under specification</p>
</li>
<li>
<p>Describe the <em>response</em> expected from the system</p>
</li>
<li>
<p>Clean up the feature&#8217;s fixture</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Whereas the first and last phases are optional, the stimulus and response phases are always present (except in
interacting feature methods), and may occur more than once.</p>
</div>
<div class="sect3">
<h4 id="_blocks"><a class="link" href="#_blocks">Blocks</a></h4>
<div class="paragraph">
<p>Spock has built-in support for implementing each of the conceptual phases of a feature method. To this end, feature
methods are structured into so-called <em>blocks</em>. Blocks start with a label, and extend to the beginning of the next block,
or the end of the method. There are seven kinds of blocks: <code>given</code>, <code>when</code>, <code>then</code>, <code>expect</code>, <code>cleanup</code>, <code>where</code>, and <code>filter</code> blocks.
Any statements between the beginning of the method and the first explicit block belong to an implicit <code>given</code> block.</p>
</div>
<div class="paragraph">
<p>A feature method must have at least one explicit (i.e. labelled) block - in fact, the presence of an explicit block is
what makes a method a feature method. Blocks divide a method into distinct sections, and cannot be nested.</p>
</div>
<div class="openblock float-group">
<div class="content">
<div class="imageblock right text-left">
<div class="content">
<img src="images/Blocks2Phases.png" alt="Blocks2Phases">
</div>
</div>
<div class="paragraph">
<p>The picture on the right shows how blocks map to the conceptual phases of a feature method. The <code>where</code> block has a
special role, which will be revealed shortly. But first, let&#8217;s have a closer look at the other blocks.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_given_blocks"><a class="link" href="#_given_blocks">Given Blocks</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
def stack = new Stack()
def elem = "push me"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>given</code> block is where you do any setup work for the feature that you are describing. It may not be preceded by
other blocks, and may not be repeated. A <code>given</code> block doesn&#8217;t have any special semantics. The <code>given:</code> label is
optional and may be omitted, resulting in an <em>implicit</em> <code>given</code> block. Originally, the alias <code>setup:</code> was the preferred block name,
but using <code>given:</code> often leads to a more readable feature method description (see <a href="#specifications-as-documentation">Specifications as Documentation</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_when_and_then_blocks"><a class="link" href="#_when_and_then_blocks">When and Then Blocks</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:   // stimulus
then:   // response</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>when</code> and <code>then</code> blocks always occur together. They describe a stimulus and the expected response. Whereas <code>when</code>
blocks may contain arbitrary code, <code>then</code> blocks are restricted to <em>conditions</em>, <em>exception conditions</em>, <em>interactions</em>,
and variable definitions. A feature method may contain multiple pairs of <code>when-then</code> blocks.</p>
</div>
<div class="sect5">
<h6 id="_conditions"><a class="link" href="#_conditions">Conditions</a></h6>
<div class="paragraph">
<p>Conditions describe an expected state, much like JUnit&#8217;s assertions. However, conditions are written as plain boolean
expressions, eliminating the need for an assertion API. (More precisely, a condition may also produce a non-boolean
value, which will then be evaluated according to Groovy truth.) Let&#8217;s see some conditions in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
stack.push(elem)

then:
!stack.empty
stack.size() == 1
stack.peek() == elem</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try to keep the number of conditions per feature method small. One to five conditions is a good guideline. If you
have more than that, ask yourself if you are specifying multiple unrelated features at once. If the answer is yes,
break up the feature method in several smaller ones. If your conditions only differ in their values, consider using
a <a href="#data-tables">data table</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What kind of feedback does Spock provide if a condition is violated? Let&#8217;s try and change the second condition to
<code>stack.size() == 2</code>. Here is what we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Condition not satisfied:

stack.size() == 2
|     |      |
|     1      false
[push me]</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, Spock captures all values produced during the evaluation of a condition, and presents them in an easily
digestible form. Nice, isn&#8217;t it?</p>
</div>
</div>
<div class="sect5">
<h6 id="_implicit_and_explicit_conditions"><a class="link" href="#_implicit_and_explicit_conditions">Implicit and explicit conditions</a></h6>
<div class="paragraph">
<p>Conditions are an essential ingredient of <code>then</code> blocks and <code>expect</code> blocks. Except for calls to <code>void</code> methods and
expressions classified as interactions, all top-level expressions in these blocks are implicitly treated as conditions.
To use conditions in other places, you need to designate them with Groovy&#8217;s assert keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def setup() {
  stack = new Stack()
  assert stack.empty
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an explicit condition is violated, it will produce the same nice diagnostic message as an implicit condition.</p>
</div>
<div class="sect6">
<h7 id="opt-out-of-condition-handling"><a class="link" href="#opt-out-of-condition-handling">Opt-out of condition handling</a></h7>
<div class="paragraph">
<p>Sometimes, you may want to use a top-level expression that is not treated as a condition.</p>
</div>
<div class="paragraph">
<p>For example, you may want to loop over a list with <code>each</code> and do assertions on its items.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">expect:
aList.each { assert it &gt; 0 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this will fail if the list is empty, as <code>each</code> returns the list again and an empty list is falsy according to Groovy-truth.</p>
</div>
<div class="paragraph">
<p>To avoid this, you can use the <code>!!</code> operator to opt-out of condition handling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">expect:
!!aList.each { assert it &gt; 0 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>!!</code> operator can also be used to hide the contents of an expression in an explicit assertion statement.
This can be helpful, if the rendered expression is too long to be readable, or if you want to hide the data itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def foo = 'very long foo'
def bar = 'very long bar'
assert !!(foo == bar) : "foobar"</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(foo == bar)

foobar</pre>
</div>
</div>
<div class="paragraph">
<p>as opposed to</p>
</div>
<div class="listingblock">
<div class="content">
<pre>foo == bar
|   |  |
|   |  very long bar
|   false
|   3 differences (76% similarity)
|   very long (foo)
|   very long (bar)
very long foo

foobar</pre>
</div>
</div>
<div class="paragraph">
<p>and you can even leave out the message, although it is not recommended, to get this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">assert !!(foo == bar)</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(foo == bar)</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>!!</code> must be the outermost expression, see <a href="https://groovy-lang.org/operators.html#_operator_precedence">Groovy&#8217;s docs on Operator Precedence</a>.
           If in doubt use parentheses, <code>!!(expression)</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_exception_conditions"><a class="link" href="#_exception_conditions">Exception Conditions</a></h6>
<div class="paragraph">
<p>Exception conditions are used to describe that a <code>when</code> block should throw an exception. They are defined using the
<code>thrown()</code> method, passing along the expected exception type. For example, to describe that popping from an empty stack
should throw an <code>EmptyStackException</code>, you could write the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
stack.pop()

then:
thrown(EmptyStackException)
stack.empty</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, exception conditions may be followed by other conditions (and even other blocks). This is particularly
useful for specifying the expected content of an exception. To access the exception, first bind it to a variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
stack.pop()

then:
def e = thrown(EmptyStackException)
e.cause == null</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you may use a slight variation of the above syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
stack.pop()

then:
EmptyStackException e = thrown()
e.cause == null</code></pre>
</div>
</div>
<div class="paragraph">
<p>This syntax has two small advantages: First, the exception variable is strongly typed, making it easier for IDEs to
offer code completion. Second, the condition reads a bit more like a sentence ("then an EmptyStackException is thrown").
Note that if no exception type is passed to the <code>thrown()</code> method, it is inferred from the variable type on the left-hand
side.</p>
</div>
<div class="paragraph">
<p>Sometimes we need to convey that an exception should <strong>not</strong> be thrown. For example, let&#8217;s try to express that a <code>HashMap</code>
should accept a <code>null</code> key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "HashMap accepts null key"() {
  setup:
  def map = new HashMap()
  map.put(null, "elem")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This works but doesn&#8217;t reveal the intention of the code. Did someone just leave the building before he had finished
implementing this method? After all, where are the conditions? Fortunately, we can do better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "HashMap accepts null key"() {
  given:
  def map = new HashMap()

  when:
  map.put(null, "elem")

  then:
  notThrown(NullPointerException)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By using <code>notThrown()</code>, we make it clear that in particular a <code>NullPointerException</code> should not be thrown. (As per the
contract of <code>Map.put()</code>, this would be the right thing to do for a map that doesn&#8217;t support <code>null</code> keys.) However,
the method will also fail if any other exception is thrown.</p>
</div>
</div>
<div class="sect5">
<h6 id="_methods_accepting_implicit_conditions_as_code_blocks"><a class="link" href="#_methods_accepting_implicit_conditions_as_code_blocks">Methods Accepting Implicit Conditions as Code Blocks</a></h6>
<div class="paragraph">
<p>Methods annotated with <code>@ConditionBlock</code> will treat <code>Closure</code> arguments as code blocks containing
conditions allowing to leave off the <code>assert</code> keyword. As in <code>expect</code>-blocks and <code>then</code>-blocks, variable declarations
and void method invocations will not be considered conditions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">AsyncConditions conds = new AsyncConditions()

when:
Thread.start {
  //The method AsyncConditions.evaluate() is annotated with @ConditionBlock
  conds.evaluate {
    //There is an implicit assert here
    false
  }
}

then:
conds.await()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>@ConditionBlock</code> only works, if the types involved are known at compile time (no <code>def</code> keyword). See below for more details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@ConditionBlock</code> annotation only takes effect if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>Closures</code> are passed as literals,
and the Groovy compiler can (at compilation time) determine the target type of the method invocation
referencing the annotated method,</p>
</li>
<li>
<p>the annotated method is called on object of type known at compilation time (no <code>def</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the annotated method is overloaded, the closure arguments of all overloads are considered code blocks.</p>
</div>
</div>
<div class="sect5">
<h6 id="_interactions"><a class="link" href="#_interactions">Interactions</a></h6>
<div class="paragraph">
<p>Whereas conditions describe an object&#8217;s state, interactions describe how objects communicate with each other.
Interactions and Interaction based testing are described in a separate <a href="#interaction-based-testing">chapter</a>, so we only give a quick example here.
Suppose we want to describe the flow of events from a publisher to its subscribers. Here is the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "events are published to all subscribers"() {
  given:
  def subscriber1 = Mock(Subscriber)
  def subscriber2 = Mock(Subscriber)
  def publisher = new Publisher()
  publisher.add(subscriber1)
  publisher.add(subscriber2)

  when:
  publisher.fire("event")

  then:
  1 * subscriber1.receive("event")
  1 * subscriber2.receive("event")
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_expect_blocks"><a class="link" href="#_expect_blocks">Expect Blocks</a></h5>
<div class="paragraph">
<p>An <code>expect</code> block is more limited than a <code>then</code> block in that it may only contain conditions and variable definitions.
It is useful in situations where it is more natural to describe stimulus and expected response in a single expression.
For example, compare the following two attempts to describe the <code>Math.max()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
def x = Math.max(1, 2)

then:
x == 2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">expect:
Math.max(1, 2) == 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although both snippets are semantically equivalent, the second one is clearly preferable. As a guideline, use <code>when-then</code>
to describe methods with side effects, and <code>expect</code> to describe purely functional methods.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Leverage <a href="https://docs.groovy-lang.org/docs/latest/html/groovy-jdk/">Groovy JDK</a> methods like <code>any()</code> and <code>every()</code>
to create more expressive and succinct conditions.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_cleanup_blocks"><a class="link" href="#_cleanup_blocks">Cleanup Blocks</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
def file = new File("/some/path")
file.createNewFile()

// ...

cleanup:
file.delete()</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>cleanup</code> block may only be followed by a <code>where</code> block, and may not be repeated. Like a <code>cleanup</code> method, it is used
to free any resources used by a feature method, and is run even if (a previous part of) the feature method has produced
an exception. As a consequence, a <code>cleanup</code> block must be coded defensively; in the worst case, it must gracefully
handle the situation where the first statement in a feature method has thrown an exception, and all local variables
still have their default values.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Groovy&#8217;s safe dereference operator (<code>foo?.bar()</code>) simplifies writing defensive code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Object-level specifications usually don&#8217;t need a <code>cleanup</code> method, as the only resource they consume is memory, which
is automatically reclaimed by the garbage collector. More coarse-grained specifications, however, might use a <code>cleanup</code>
block to clean up the file system, close a database connection, or shut down a network service.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If a specification is designed in such a way that all its feature methods require the same resources, use a
<code>cleanup()</code> method; otherwise, prefer <code>cleanup</code> blocks. The same trade-off applies to <code>setup()</code> methods and <code>given</code> blocks.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_where_blocks"><a class="link" href="#_where_blocks">Where Blocks</a></h5>
<div class="paragraph">
<p>A <code>where</code> block may only be followed by a <code>filter</code> block, and may not be repeated. It is used to write data-driven feature methods.
To give you an idea how this is done, have a look at the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "computing the maximum of two numbers"() {
  expect:
  Math.max(a, b) == c

  where:
  a &lt;&lt; [5, 3]
  b &lt;&lt; [1, 9]
  c &lt;&lt; [5, 9]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>where</code> block effectively creates two "versions" of the feature method: One where <code>a</code> is 5, <code>b</code> is 1, and <code>c</code> is 5,
and another one where <code>a</code> is 3, <code>b</code> is 9, and <code>c</code> is 9.</p>
</div>
<div class="paragraph">
<p>Although it is declared last, the <code>where</code> block is evaluated before the feature method containing it runs.</p>
</div>
<div class="paragraph">
<p>The <code>where</code> block is further explained in the <a href="#data-driven-testing">Data Driven Testing</a> chapter.</p>
</div>
</div>
<div class="sect4">
<h5 id="_filter_blocks"><a class="link" href="#_filter_blocks">Filter Blocks</a></h5>
<div class="paragraph">
<p>A <code>filter</code> block always comes last in a method, and may not be repeated. It is used to filter iterations in data-driven feature methods.
To give you an idea how this is done, have a look at the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "excluding iterations"() {
  expect:
  i in ((1..5) - 3)

  where:
  i &lt;&lt; (1..5)

  filter:
  i != 3
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The content of the <code>filter</code> block is treated like the content of an <code>expect</code> block. If any of the implicit or explicit
assertions in it fail for a given iteration, this iteration is skipped.</p>
</div>
<div class="paragraph">
<p>The <code>filter</code> block is further explained in the <a href="#data-driven-testing">Data Driven Testing</a> chapter.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_helper_methods"><a class="link" href="#_helper_methods">Helper Methods</a></h3>
<div class="paragraph">
<p>Sometimes feature methods grow large and/or contain lots of duplicated code. In such cases it can make sense to introduce
one or more helper methods. Two good candidates for helper methods are setup/cleanup logic and complex conditions.
Factoring out the former is straightforward, so let&#8217;s have a look at conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "offered PC matches preferred configuration"() {
  when:
  def pc = shop.buyPc()

  then:
  pc.vendor == "Sunny"
  pc.clockRate &gt;= 2333
  pc.ram &gt;= 4096
  pc.os == "Linux"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you happen to be a computer geek, your preferred PC configuration might be very detailed, or you might want to
compare offers from many different shops. Therefore, let&#8217;s factor out the conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "offered PC matches preferred configuration"() {
  when:
  def pc = shop.buyPc()

  then:
  matchesPreferredConfiguration(pc)
}

def matchesPreferredConfiguration(pc) {
  pc.vendor == "Sunny"
  &amp;&amp; pc.clockRate &gt;= 2333
  &amp;&amp; pc.ram &gt;= 4096
  &amp;&amp; pc.os == "Linux"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new helper method <code>matchesPreferredConfiguration()</code> consists of a single boolean expression whose result is returned.
(The <code>return</code> keyword is optional in Groovy.) This is fine except for the way that an inadequate offer is now presented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Condition not satisfied:

matchesPreferredConfiguration(pc)
|                             |
false                         ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not very helpful. Fortunately, we can do better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Verify
void matchesPreferredConfiguration(PC pc) {
  pc.vendor == "Sunny"
  pc.clockRate &gt;= 2333
  pc.ram &gt;= 4096
  pc.os == "Linux"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When factoring out conditions into a helper method, you need to ensure the method has return type <code>void</code>.
Otherwise, Spock might interpret the return value as a failing condition, which is not what we want.</p>
</div>
<div class="paragraph">
<p>As expected, the improved helper method tells us exactly what&#8217;s wrong:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Condition not satisfied:

pc.clockRate &gt;= 2333
|  |         |
|  1666      false</code></pre>
</div>
</div>
<div class="paragraph">
<p>A final advice: Although code reuse is generally a good thing, don&#8217;t take it too far. Be aware that the use of fixture
and helper methods can increase the coupling between feature methods. If you reuse too much or the wrong code, you will
end up with specifications that are fragile and hard to evolve.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_with_for_expectations"><a class="link" href="#_using_with_for_expectations">Using <code>with</code> for expectations</a></h3>
<div class="paragraph">
<p>As an alternative to the above helper methods, you can use a <code>with(target, closure)</code> method to interact on the object being verified.
This is especially useful in <code>then</code> and <code>expect</code> blocks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "offered PC matches preferred configuration"() {
  when:
  def pc = shop.buyPc()

  then:
  with(pc) {
    vendor == "Sunny"
    clockRate &gt;= 2333
    ram &gt;= 406
    os == "Linux"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unlike when you use helper methods, there is no need for explicit assert statements for proper error reporting.</p>
</div>
<div class="paragraph">
<p>When verifying mocks, a <code>with</code> statement can also cut out verbose verification statements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def service = Mock(Service) // has start(), stop(), and doWork() methods
def app = new Application(service) // controls the lifecycle of the service

when:
app.run()

then:
with(service) {
  1 * start()
  1 * doWork()
  1 * stop()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes an IDE has trouble to determine the type of the target, in that case you can help out by manually specifying the
target type via <code>with(target, type, closure)</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_verifyall_or_verifyall_helper_methods_to_assert_multiple_expectations_together"><a class="link" href="#_using_verifyall_or_verifyall_helper_methods_to_assert_multiple_expectations_together">Using <code>verifyAll</code> or <code>@VerifyAll</code> helper methods to assert multiple expectations together</a></h3>
<div class="paragraph">
<p>Normal expectations fail the test on the first failed assertions. Sometimes it is helpful to collect these failures before
failing the test to have more information, this behavior is also known as soft assertions.</p>
</div>
<div class="paragraph">
<p>The <code>verifyAll</code> method can be used like <code>with</code>,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "offered PC matches preferred configuration"() {
  when:
  def pc = shop.buyPc()

  then:
  verifyAll(pc) {
    vendor == "Sunny"
    clockRate &gt;= 2333
    ram &gt;= 406
    os == "Linux"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or it can be used without a target.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  expect:
  verifyAll {
    2 == 2
    4 == 4
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like <code>with</code> you can also optionally define a type hint for the IDE.</p>
</div>
<div class="paragraph">
<p>Alternatively, <code>verifyAll</code> conditions can be extracted into a helper method annotated with <code>@VerifyAll</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@VerifyAll
void matchesPreferredConfiguration(PC pc) {
  pc.vendor == "Sunny"
  pc.clockRate &gt;= 2333
  pc.ram &gt;= 406
  pc.os == "Linux"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_verifyeach_to_assert_on_each_element_of_an_iterable"><a class="link" href="#_using_verifyeach_to_assert_on_each_element_of_an_iterable">Using <code>verifyEach</code> to assert on each element of an <code>Iterable</code></a></h3>
<div class="paragraph">
<p>There are several ways to do assertions on <code>Iterable</code> or <code>Collection</code>.</p>
</div>
<div class="sect3">
<h4 id="_list_equality"><a class="link" href="#_list_equality">List Equality</a></h4>
<div class="paragraph">
<p>List equality is useful when the expected values are few and can be easily constructed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def list = [1, 2, 3]
assert list == [1, 2, 4]</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>list == [1, 2, 4]
|    |
|    false
[1, 2, 3]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_set_equality"><a class="link" href="#_set_equality">Set Equality</a></h4>
<div class="paragraph">
<p>As with list equality, set equality is useful when the expected values are few and can be easily constructed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def set = [2, 3, 1] as Set
assert set == [1, 2, 4] as Set</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>set == [1, 2, 4] as Set
|   |
|   false
|   2 differences (66% similarity, 1 missing, 1 extra)
|   missing: [4]
|   extra: [3]
[2, 3, 1]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_every_method"><a class="link" href="#_every_method">Every Method</a></h4>
<div class="paragraph">
<p>You can also use the standard Groovy method <code>every</code> to do assertions.
The downside is, that you don&#8217;t get any insight into which element failed, or why.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def list = [1, 2, 3]
assert list.every { it == 2 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>list.every { it == 2 }
|    |
|    false
[1, 2, 3]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="verify-each"><a class="link" href="#verify-each">VerifyEach Method</a></h4>
<div class="paragraph">
<p>Since 2.4, you can use the <code>verifyEach</code> method to perform assertions on every element of an iterable.
In contrast to <code>every</code>, it will not stop at the first failure and instead check every element and provide a comprehensive report at the end.
It won&#8217;t render the full list of items, which makes it useful in cases of a large number of items.
Like <code>with</code> the current item will be set as the delegate and passed as parameter to the closure.
The statements in the closure will also be treated as implicit assertions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def list = [1, 2, 3]
verifyEach(list) { it == 2 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Multiple Failures (2 failures)
	org.spockframework.runtime.SpockAssertionError: Assertions failed for item[0] 1:
Condition not satisfied:

it == 2
|  |
1  false

	org.spockframework.runtime.SpockAssertionError: Assertions failed for item[2] 3:
Condition not satisfied:

it == 2
|  |
3  false</pre>
</div>
</div>
<div class="paragraph">
<p>By default, the item will be rendered with a simple <code>toString()</code>.
However, you can provide a custom "namer"-method to provide your own representation.
This is useful when the item either has no useful <code>toString()</code> method or if it is too verbose.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def list = [1, 2, 3]
verifyEach(list, { "int($it)" }) { it == 2 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Multiple Failures (2 failures)
	org.spockframework.runtime.SpockAssertionError: Assertions failed for item[0] int(1):
Condition not satisfied:

it == 2
|  |
1  false

	org.spockframework.runtime.SpockAssertionError: Assertions failed for item[2] int(3):
Condition not satisfied:

it == 2
|  |
3  false</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the optional index parameter to get the index of the current item.
This is useful when you want to do assertions based on the index.
For example, if you want to compare with a list of expected values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def list = [1, 2, 3]
def expected = [1, 3, 4]
verifyEach(list) { it, i -&gt; it == expected[i] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be rendered as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Multiple Failures (2 failures)
	org.spockframework.runtime.SpockAssertionError: Assertions failed for item[1] 2:
Condition not satisfied:

it == expected[i]
|  |  |       ||
2  |  |       |1
   |  |       3
   |  [1, 3, 4]
   false

	org.spockframework.runtime.SpockAssertionError: Assertions failed for item[2] 3:
Condition not satisfied:

it == expected[i]
|  |  |       ||
3  |  |       |2
   |  |       4
   |  [1, 3, 4]
   false</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="specifications-as-documentation"><a class="link" href="#specifications-as-documentation">Specifications as Documentation</a></h3>
<div class="paragraph">
<p>Well-written specifications are a valuable source of information. Especially for higher-level specifications targeting
a wider audience than just developers (architects, domain experts, customers, etc.), it makes sense to provide more
information in natural language than just the names of specifications and features. Therefore, Spock provides a way to
attach textual descriptions to blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given: "open a database connection"
// code goes here</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>and:</code> label to describe logically different parts of a block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given: "open a database connection"
// code goes here

and: "seed the customer table"
// code goes here

and: "seed the product table"
// code goes here</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>and:</code> label followed by a description can be inserted at any (top-level) position of a feature method, without
altering the method&#8217;s semantics.</p>
</div>
<div class="paragraph">
<p>In Behavior Driven Development, customer-facing features (called <em>stories</em>) are described in a given-when-then format.
Spock directly supports this style of specification with the <code>given:</code> label:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given: "an empty bank account"
// ...

when: "the account is credited \$10"
// ...

then: "the account's balance is \$10"
// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Block descriptions are not only present in source code, but are also available to the Spock runtime. Planned usages of
block descriptions are enhanced diagnostic messages, and textual reports that are equally understood by all stakeholders.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extensions"><a class="link" href="#_extensions">Extensions</a></h3>
<div class="paragraph">
<p>As we have seen, Spock offers lots of functionality for writing specifications. However, there always comes a time
when something else is needed. Therefore, Spock provides an interception-based extension mechanism. Extensions are
activated by annotations called <em>directives</em>. Currently, Spock ships with the following directives:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>@Timeout</code>
</td>
<td class="hdlist2">
<p>Sets a timeout for execution of a feature or fixture method.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>@Ignore</code>
</td>
<td class="hdlist2">
<p>Ignores any feature method carrying this annotation.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>@IgnoreRest</code>
</td>
<td class="hdlist2">
<p>Any feature method carrying this annotation will be executed, all others will be ignored. Useful for quickly running just a single method.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>@FailsWith</code>
</td>
<td class="hdlist2">
<p>Expects a feature method to complete abruptly. <code>@FailsWith</code> has two use cases: First, to document known bugs that cannot
be resolved immediately. Second, to replace exception conditions in certain corner cases where the latter cannot be
used (like specifying the behavior of exception conditions). In all other cases, exception conditions are preferable.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Go to the <a href="#extensions">Extensions</a> chapter to learn how to implement your own directives and extensions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_comparison_to_junit"><a class="link" href="#_comparison_to_junit">Comparison to JUnit</a></h3>
<div class="paragraph">
<p>Although Spock uses a different terminology, many of its concepts and features are inspired by JUnit. Here is a rough comparison:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spock</th>
<th class="tableblock halign-left valign-top">JUnit</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setup()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Before</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cleanup()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@After</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setupSpec()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeClass</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cleanupSpec()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AfterClass</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Feature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Feature method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data-driven feature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Theory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Condition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assertion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception condition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Test(expected=&#8230;&#8203;)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mock expectation (e.g. in Mockito)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-driven-testing"><a class="link" href="#data-driven-testing">Data Driven Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oftentimes, it is useful to exercise the same test code multiple times, with varying inputs and expected results.
Spock&#8217;s data driven testing support makes this a first class feature.</p>
</div>
<div class="sect2">
<h3 id="_introduction_2"><a class="link" href="#_introduction_2">Introduction</a></h3>
<div class="paragraph">
<p>Suppose we want to specify the behavior of the <code>Math.max</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MathSpec extends Specification {
  def "maximum of two numbers"() {
    expect:
    // exercise math method for a few different inputs
    Math.max(1, 3) == 3
    Math.max(7, 4) == 7
    Math.max(0, 0) == 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this approach is fine in simple cases like this one, it has some potential drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code and data are mixed and cannot easily be changed independently</p>
</li>
<li>
<p>Data cannot easily be auto-generated or fetched from external sources</p>
</li>
<li>
<p>In order to exercise the same code multiple times, it either has to be duplicated or extracted into a separate method</p>
</li>
<li>
<p>In case of a failure, it may not be immediately clear which inputs caused the failure</p>
</li>
<li>
<p>Exercising the same code multiple times does not benefit from the same isolation as executing separate methods does</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spock&#8217;s data-driven testing support tries to address these concerns. To get started, let&#8217;s refactor above code into a
data-driven feature method. First, we introduce three method parameters (called <em>data variables</em>) that replace the
hard-coded integer values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MathSpec extends Specification {
  def "maximum of two numbers"(int a, int b, int c) {
    expect:
    Math.max(a, b) == c
    ...
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have finished the test logic, but still need to supply the data values to be used. This is done in a <code>where:</code> block,
which always comes at the end of the method. In the simplest (and most common) case, the <code>where:</code> block holds a <em>data table</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="data-tables"><a class="link" href="#data-tables">Data Tables</a></h3>
<div class="paragraph">
<p>Data tables are a convenient way to exercise a feature method with a fixed set of data values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MathSpec extends Specification {
  def "maximum of two numbers"(int a, int b, int c) {
    expect:
    Math.max(a, b) == c

    where:
    a | b | c
    1 | 3 | 3
    7 | 4 | 7
    0 | 0 | 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line of the table, called the <em>table header</em>, declares the data variables. The subsequent lines, called
<em>table rows</em>, hold the corresponding values. For each row, the feature method will get executed once; we call this an
<em>iteration</em> of the method. If an iteration fails, the remaining iterations will nevertheless be executed. All
failures will be reported.</p>
</div>
<div class="paragraph">
<p>Data tables must have at least two columns. A single-column table can be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a | _
1 | _
7 | _
0 | _</code></pre>
</div>
</div>
<div class="paragraph">
<p>A sequence of two or more underscores can be used to split one wide data table into multiple narrower ones.
Without this separator and without any other data variable assignment in between there
is no way to have multiple data tables in one <code>where</code> block, the second table would just
be further iterations of the first table, including the seemingly header row:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a | _
1 | _
7 | _
0 | _
__

b | c
1 | 2
3 | 4
5 | 6</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is semantically exactly the same, just as one wider joined data table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a | b | c
1 | 1 | 2
7 | 3 | 4
0 | 5 | 6</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sequence of two or more underscores can be used anywhere in the <code>where</code> block.
It will be ignored everywhere, except for in between two data tables, where it is
used to separate the two data tables. This means that the separator can also be used
as styling element in different ways. It can be used as separator line like shown in
the last example or it can for example be used visually as top border of tables
additionally to its effect of separating them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
_____
a | _
1 | _
7 | _
0 | _
_____
b | c
1 | 2
3 | 4
5 | 6</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_isolated_execution_of_iterations"><a class="link" href="#_isolated_execution_of_iterations">Isolated Execution of Iterations</a></h3>
<div class="paragraph">
<p>Iterations are isolated from each other in the same way as separate feature methods. Each iteration gets its own instance
of the specification class, and the <code>setup</code> and <code>cleanup</code> methods will be called before and after each iteration,
respectively.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_of_objects_between_iterations"><a class="link" href="#_sharing_of_objects_between_iterations">Sharing of Objects between Iterations</a></h3>
<div class="paragraph">
<p>In order to share an object between iterations, it has to be kept in a <code>@Shared</code> or static field.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only <code>@Shared</code> and static variables can be accessed from within a <code>where:</code> block.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that such objects will also be shared with other methods. There is currently no good way to share an object
just between iterations of the same method. If you consider this a problem, consider putting each method into a separate
spec, all of which can be kept in the same file. This achieves better isolation at the cost of some boilerplate code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_syntactic_variations"><a class="link" href="#_syntactic_variations">Syntactic Variations</a></h3>
<div class="paragraph">
<p>The previous code can be tweaked in a few ways.</p>
</div>
<div class="paragraph">
<p>First, since the <code>where:</code> block already declares all data variables, the method parameters can be
omitted.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>You can also omit some parameters and specify others, for example to have them typed.
The order also is not important, data variables are matched by name to the specified method parameters.</p>
</div>
<div class="paragraph">
<p>Second, inputs and expected outputs can be separated with a double pipe symbol (<code>||</code>) to visually set them apart.</p>
</div>
<div class="paragraph">
<p>With this, the code becomes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MathSpec extends Specification {
  def "maximum of two numbers"() {
    expect:
    Math.max(a, b) == c

    where:
    a | b || c
    1 | 3 || 3
    7 | 4 || 7
    0 | 0 || 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively to using single or double pipes you can also use any amount of semicolons to separate data columns
from each other:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MathSpec extends Specification {
  def "maximum of two numbers"() {
    expect:
    Math.max(a, b) == c

    where:
    a ; b ;; c
    1 ; 3 ;; 3
    7 ; 4 ;; 7
    0 ; 0 ;; 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pipes and semicolons as data column separator can not be mixed within one table.
If the column separator changes, this starts a new stand-alone data table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MathSpec extends Specification {
  def "maximum of two numbers"() {
    expect:
    Math.max(a, b) == c
    Math.max(d, e) == f

    where:
    a | b || c
    1 | 3 || 3
    7 | 4 || 7
    0 | 0 || 0

    d ; e ;; f
    1 ; 3 ;; 3
    7 ; 4 ;; 7
    0 ; 0 ;; 0
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reporting_of_failures"><a class="link" href="#_reporting_of_failures">Reporting of Failures</a></h3>
<div class="paragraph">
<p>Let&#8217;s assume that our implementation of the <code>max</code> method has a flaw, and one of the iterations fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>maximum of two numbers [a: 1, b: 3, c: 3, #0]   PASSED
maximum of two numbers [a: 7, b: 4, c: 7, #1]   FAILED

Condition not satisfied:

Math.max(a, b) == c
|    |   |  |  |  |
|    |   7  4  |  7
|    42        false
class java.lang.Math

maximum of two numbers [a: 0, b: 0, c: 0, #2]   PASSED</pre>
</div>
</div>
<div class="paragraph">
<p>The obvious question is: Which iteration failed, and what are its data values? In our example, it isn&#8217;t hard to figure
out that it&#8217;s the second iteration (with index 1) that failed even from the rich condition rendering. At other times
this can be more difficult or even impossible.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> In any case, Spock makes it loud and clear which iteration failed, rather
than just reporting the failure. Iterations of a feature method are by default unrolled with a rich naming pattern.
This pattern can also be configured as documented at <a href="#_unrolled_iteration_names">Unrolled Iteration Names</a> or the unrolling can be disabled
like described in the following section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_method_uprolling_and_unrolling"><a class="link" href="#_method_uprolling_and_unrolling">Method Uprolling and Unrolling</a></h3>
<div class="paragraph">
<p>A method annotated with <code>@Rollup</code> will have its iterations not reported independently but only aggregated within the
feature. This can for example be used if you produce many test cases from calculations or if you use external data
like the contents of a database as test data and do not want the test count to vary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Rollup
def "maximum of two numbers"() {
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that up- and unrolling has no effect on how the method gets executed; it is only an alternation in reporting.
Depending on the execution environment, the output will look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>maximum of two numbers   FAILED

Condition not satisfied:

Math.max(a, b) == c
|    |   |  |  |  |
|    |   7  4  |  7
|    42        false
class java.lang.Math</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Rollup</code> annotation can also be placed on a spec.
This has the same effect as placing it on each data-driven feature method of the spec that does not have an
<code>@Unroll</code> annotation.</p>
</div>
<div class="paragraph">
<p>Alternatively the <a href="#spock-configuration-file">configuration file</a> setting <code>unrollByDefault</code>
in the <code>unroll</code> section can be set to <code>false</code> to roll up all features automatically unless
they are annotated with <code>@Unroll</code> or are contained in an <code>@Unroll</code>ed spec and thus reinstate the pre Spock 2.0
behavior where this was the default.</p>
</div>
<div class="listingblock">
<div class="title">Disable Default Unrolling</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">unroll {
    unrollByDefault false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is illegal to annotate a spec or a feature with both the <code>@Unroll</code> and the <code>@Rollup</code> annotation and if detected
this will cause an exception to be thrown.</p>
</div>
<hr>
<div class="paragraph">
<p>To summarize:</p>
</div>
<div class="paragraph">
<p>A feature will be uprolled</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the method is annotated with <code>@Rollup</code></p>
</li>
<li>
<p>if the method is not annotated with <code>@Unroll</code> and the spec is annotated with <code>@Rollup</code></p>
</li>
<li>
<p>if neither the method nor the spec is annotated with <code>@Unroll</code>
and the configuration option <code>unroll { unrollByDefault }</code> is set to <code>false</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A feature will be unrolled</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the method is annotated with <code>@Unroll</code></p>
</li>
<li>
<p>if the method is not annotated with <code>@Rollup</code> and the spec is annotated with <code>@Unroll</code></p>
</li>
<li>
<p>if neither the method nor the spec is annotated with <code>@Rollup</code>
and the configuration option <code>unroll { unrollByDefault }</code> is set to its default value <code>true</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_data_pipes"><a class="link" href="#_data_pipes">Data Pipes</a></h3>
<div class="paragraph">
<p>Data tables aren&#8217;t the only way to supply values to data variables. In fact, a data table is just syntactic sugar for
one or more <em>data pipes</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a &lt;&lt; [1, 7, 0]
b &lt;&lt; [3, 4, 0]
c &lt;&lt; [3, 7, 0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A data pipe, indicated by the left-shift (<code>&lt;&lt;</code>) operator, connects a data variable to a <em>data provider</em>. The data
provider holds all values for the variable, one per iteration. Any object that Groovy knows how to iterate over can be
used as a data provider. This includes objects of type <code>Collection</code>, <code>String</code>, <code>Iterable</code>, and objects implementing the
<code>Iterable</code> contract. Data providers don&#8217;t necessarily have to <em>be</em> the data (as in the case of a <code>Collection</code>);
they can fetch data from external sources like text files, databases and spreadsheets, or generate data randomly.
Data providers are queried for their next value only when needed (before the next iteration).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spock uses the <code>size()</code> method to calculate the amount of iterations,
      except for data providers that implement <code>Iterator</code>,
      so make sure <code>size()</code> is working efficient, or supply an <code>Iterator</code> if that is not possible.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_multi_variable_data_pipes"><a class="link" href="#_multi_variable_data_pipes">Multi-Variable Data Pipes</a></h3>
<div class="paragraph">
<p>If a data provider returns multiple values per iteration (as an object that Groovy knows how to iterate over),
it can be connected to multiple data variables simultaneously. The syntax is somewhat similar to Groovy multi-assignment
but uses brackets instead of parentheses on the left-hand side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Shared sql = Sql.newInstance("jdbc:h2:mem:", "org.h2.Driver")

def "maximum of two numbers"() {
  expect:
  Math.max(a, b) == c

  where:
  [a, b, c] &lt;&lt; sql.rows("select a, b, c from maxdata")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Data values that aren&#8217;t of interest can be ignored with an underscore (<code>_</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
[a, b, _, c] &lt;&lt; sql.rows("select * from maxdata")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The multi-assignments can even be nested. The following example will generate these iterations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">a</th>
<th class="tableblock halign-left valign-top">b</th>
<th class="tableblock halign-left valign-top">c</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>['a1', 'a2']</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'b1'</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'c1'</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>['a2', 'a1']</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'b1'</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'c1'</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>['a1', 'a2']</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'b2'</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'c2'</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>['a2', 'a1']</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'b2'</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'c2'</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
[a, [b, _, c]] &lt;&lt; [
  ['a1', 'a2'].permutations(),
  [
    ['b1', 'd1', 'c1'],
    ['b2', 'd2', 'c2']
  ]
].combinations()</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="multi-data-pipe-named"><a class="link" href="#multi-data-pipe-named">Named deconstruction of data pipes</a></h4>
<div class="paragraph">
<p>Since Spock 2.2, multi variable data pipes can also be deconstructed from maps.
This is useful when the data provider returns a map with named keys.
Or, if you have long values that don&#8217;t fit well into a data-table, then using the maps makes it easier to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
[a, b, c] &lt;&lt; [
  [
    a: 1,
    b: 3,
    c: 5
  ],
  [
    a: 2,
    b: 4,
    c: 6
  ]
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use named deconstruction with nested data pipes, but only on the innermost nesting level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
[a, [b, c]] &lt;&lt; [
  [1, [b: 3, c: 5]],
  [2, [c: 6, b: 4]]
]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cross_multiplying_data_providers"><a class="link" href="#_cross_multiplying_data_providers">Cross-multiplying Data Providers</a></h3>
<div class="paragraph">
<p>Two or more consecutive data providers, be it a data table or a data pipe, can also be combined
using a cartesian product using the <code>combined:</code> label between them. The following will result
in these executed tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>feature [a: 1, b: 3, c: 5, d: 1, e: 4, #0]</code></p>
</li>
<li>
<p><code>feature [a: 1, b: 4, c: 6, d: 1, e: 5, #1]</code></p>
</li>
<li>
<p><code>feature [a: 2, b: 3, c: 5, d: 1, e: 5, #2]</code></p>
</li>
<li>
<p><code>feature [a: 2, b: 4, c: 6, d: 1, e: 6, #3]</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a | _
1 | _
2 | _

combined:

b | c
3 | 5
4 | 6

combined:

d | _
1 | _

e = a + b</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exactly the same result can be achieved using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a &lt;&lt; [1, 2]
combined:
b | c
3 | 5
4 | 6

d = 1
e = a + b</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Combining with a derived data variable (<code>x = &#8230;&#8203;</code>) makes no sense and thus is forbidden.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a data table takes part in a cross-multiplication, accessing columns of previous
      data tables would not behave in an intuitive way and thus is currently forbidden. Accessing
      previous columns within one data table even works while taking part in a cross-multiplication.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only the data provider right before the <code>combined:</code> label is
combined with the data provider right after the <code>combined:</code> label.</p>
</div>
<div class="paragraph">
<p>So if you execute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a &lt;&lt; [1, 2, 3, 4, 5, 6]
b &lt;&lt; [5, 6]
combined:
c &lt;&lt; [7, 8, 9]</code></pre>
</div>
</div>
<div class="paragraph">
<p>it will result in these executed tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>feature [a: 1, b: 5, c: 7, #0]</code></p>
</li>
<li>
<p><code>feature [a: 2, b: 5, c: 8, #1]</code></p>
</li>
<li>
<p><code>feature [a: 3, b: 5, c: 9, #2]</code></p>
</li>
<li>
<p><code>feature [a: 4, b: 6, c: 7, #3]</code></p>
</li>
<li>
<p><code>feature [a: 5, b: 6, c: 8, #4]</code></p>
</li>
<li>
<p><code>feature [a: 6, b: 6, c: 9, #5]</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want to combine <code>a</code> and <code>b</code> with <code>c</code> to get this result:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>feature [a: 1, b: 3, c: 5, #0]</code></p>
</li>
<li>
<p><code>feature [a: 1, b: 3, c: 6, #1]</code></p>
</li>
<li>
<p><code>feature [a: 2, b: 4, c: 5, #2]</code></p>
</li>
<li>
<p><code>feature [a: 2, b: 4, c: 6, #3]</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>you have to for example use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
[a, b] &lt;&lt; [
  [1, 2],
  [3, 4]
].transpose()
combined:
c &lt;&lt; [5, 6]</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a | b
1 | 3
2 | 4
combined:
c &lt;&lt; [5, 6]</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_data_variable_assignment"><a class="link" href="#_data_variable_assignment">Data Variable Assignment</a></h3>
<div class="paragraph">
<p>A data variable can be directly assigned a value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a = 3
b = Math.random() * 100
c = a &gt; b ? a : b</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assignments are re-evaluated for every iteration. As already shown above, the right-hand side of an assignment may refer
to other data variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
row &lt;&lt; sql.rows("select * from maxdata")
// pick apart columns
a = row.a
b = row.b
c = row.c</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_other_data_variables"><a class="link" href="#_accessing_other_data_variables">Accessing Other Data Variables</a></h3>
<div class="paragraph">
<p>There are only two possibilities to access one data variable from the calculation
of another data variable.</p>
</div>
<div class="paragraph">
<p>The first possibility are derived data variables like shown in the last section.
Every data variable that is defined by a direct assignment can access all
previously defined data variables, including the ones defined through data
tables or data pipes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a = 3
b = Math.random() * 100
c = a &gt; b ? a : b</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second possibility is to access previous columns within data tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a | b
3 | a + 1
7 | a + 2
0 | a + 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also includes columns in previous data tables in the same <code>where</code> block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a | b
3 | a + 1
7 | a + 2
0 | a + 3

and:
c = 1

and:
d     | e
a * 2 | b * 2
a * 3 | b * 3
a * 4 | b * 4</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_variable_assignment"><a class="link" href="#_multi_variable_assignment">Multi-Variable Assignment</a></h3>
<div class="paragraph">
<p>Like with data pipes, you can also assign to multiple variables in one expression, if you have some object Groovy
can iterate over. Unlike with data pipes, the syntax here is identical to standard Groovy multi-assignment syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Shared sql = Sql.newInstance("jdbc:h2:mem:", "org.h2.Driver")

def "maximum of two numbers multi-assignment"() {
  expect:
  Math.max(a, b) == c

  where:
  row &lt;&lt; sql.rows("select a, b, c from maxdata")
  (a, b, c) = row
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Data values that aren&#8217;t of interest can be ignored with an underscore (<code>_</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
row &lt;&lt; sql.rows("select * from maxdata")
(a, b, _, c) = row</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_combining_data_tables_data_pipes_and_variable_assignments"><a class="link" href="#_combining_data_tables_data_pipes_and_variable_assignments">Combining Data Tables, Data Pipes, and Variable Assignments</a></h3>
<div class="paragraph">
<p>Data tables, data pipes, and variable assignments can be combined as needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a | b
1 | a + 1
7 | a + 2
0 | a + 3

c &lt;&lt; [3, 4, 0]

d = a &gt; c ? a : c</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_coercion_for_data_variable_values"><a class="link" href="#_type_coercion_for_data_variable_values">Type Coercion for Data Variable Values</a></h3>
<div class="paragraph">
<p>Data variable values are coerced to the declared parameter type using
<a href="https://groovy-lang.org/operators.html#_coercion_operator">type coercion</a>. Due to that custom type conversions can be
provided as <a href="https://groovy-lang.org/metaprogramming.html#_extension_modules">extension module</a> or with the help of
the <a href="#_use"><code>@Use</code></a> extension on the specification (as it has no effect to the <code>where:</code> block if
applied to a feature).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "type coercion for data variable values"(Integer i) {
  expect:
  i instanceof Integer
  i == 10

  where:
  i = "10"
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Use(CoerceBazToBar)
class Foo extends Specification {
  def foo(Bar bar) {
    expect:
    bar == Bar.FOO

    where:
    bar = Baz.FOO
  }
}
enum Bar { FOO, BAR }
enum Baz { FOO, BAR }
class CoerceBazToBar {
  static Bar asType(Baz self, Class&lt;Bar&gt; clazz) {
    return Bar.valueOf(self.name())
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_number_of_iterations"><a class="link" href="#_number_of_iterations">Number of Iterations</a></h3>
<div class="paragraph">
<p>The number of iterations depends on how much data is available. Successive executions of the same method can
yield different numbers of iterations. If a data provider runs out of values sooner than its peers, an exception will occur.
Variable assignments don&#8217;t affect the number of iterations. A <code>where:</code> block that only contains assignments yields
exactly one iteration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_filtering_iterations"><a class="link" href="#_filtering_iterations">Filtering iterations</a></h3>
<div class="paragraph">
<p>If you want to filter out some iterations, you can use the <code>@IgnoreIf</code> annotation on the feature method.
This has one significant drawback though, the iteration would be reported as skipped in test reports.
Therefor you can have a <code>filter</code> block after the <code>where</code> block.
The content of this block is treated like the content of the <code>expect</code> block.
If any of the implicit or explicit assertions in the <code>filter</code> block fails, the iteration is treated like it would not exist.
This also means, that if all iterations are filtered out, the test will fail like when giving a data provider without content.</p>
</div>
<div class="paragraph">
<p>In the following example the test is executed with the values <code>1</code>, <code>2</code>, <code>4</code>, and <code>5</code> for the variable <code>i</code>,
the iteration where <code>i</code> would be <code>3</code> is filtered out by the <code>filter</code> block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "excluding iterations"() {
  expect:
  i in ((1..5) - 3)

  where:
  i &lt;&lt; (1..5)

  filter:
  i != 3
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_closing_of_data_providers"><a class="link" href="#_closing_of_data_providers">Closing of Data Providers</a></h3>
<div class="paragraph">
<p>After all iterations have completed, the zero-argument <code>close</code> method is called on all data providers that have
such a method.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unrolled_iteration_names"><a class="link" href="#_unrolled_iteration_names">Unrolled Iteration Names</a></h3>
<div class="paragraph">
<p>By default, the names of unrolled iterations are the name of the feature, plus the data variables and the iteration
index. This will always produce unique names and should enable you to identify easily the failing data variable
combination.</p>
</div>
<div class="paragraph">
<p>The example at <a href="#_reporting_of_failures">Reporting of Failures</a> for example shows with <code>maximum of two numbers [a: 7, b: 4, c: 7, #1]</code>,
that the second iteration (<code>#1</code>) where the data variables have the values <code>7</code>, <code>4</code> and <code>7</code> failed.</p>
</div>
<div class="paragraph">
<p>With a bit of effort, we can do even better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "maximum of #a and #b is #c"() {
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method name uses placeholders, denoted by a leading hash sign (<code>#</code>), to refer to data variables <code>a</code>, <code>b</code>, and <code>c</code>.
In the output, the placeholders will be replaced with concrete values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>maximum of 1 and 3 is 3   PASSED
maximum of 7 and 4 is 7   FAILED

Math.max(a, b) == c
|    |   |  |  |  |
|    |   7  4  |  7
|    42        false
class java.lang.Math

maximum of 0 and 0 is 0   PASSED</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can tell at a glance that the <code>max</code> method failed for inputs <code>7</code> and <code>4</code>.</p>
</div>
<div class="paragraph">
<p>An unrolled method name is similar to a Groovy <code>GString</code>, except for the following differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expressions are denoted with <code>#</code> instead of <code>$</code>, and there is no equivalent for the <code>${&#8230;&#8203;}</code> syntax.</p>
</li>
<li>
<p>Expressions only support property access and zero-arg method calls.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Given a class <code>Person</code> with properties <code>name</code> and <code>age</code>, and a data variable <code>person</code> of type <code>Person</code>, the
following are valid method names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "#person is #person.age years old"() { // property access
def "#person.name.toUpperCase()"() { // zero-arg method call</code></pre>
</div>
</div>
<div class="paragraph">
<p>Non-string values (like <code>#person</code> above) are converted to Strings according to Groovy semantics.</p>
</div>
<div class="paragraph">
<p>The following are invalid method names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "#person.name.split(' ')[1]" {  // cannot have method arguments
def "#person.age / 2" {  // cannot use operators</code></pre>
</div>
</div>
<div class="paragraph">
<p>If necessary, additional data variables can be introduced to hold more complex expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "#lastName"() {
  ...
  where:
  person &lt;&lt; [new Person(age: 14, name: 'Phil Cole')]
  lastName = person.name.split(' ')[1]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, to the data variables the tokens <code>#featureName</code> and <code>#iterationIndex</code> are supported.
The former does not make much sense inside an actual feature name, but there are two other places
where an unroll-pattern can be defined, where it is more useful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "#person is #person.age years old [#iterationIndex]"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be reported as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>â·
ââ Spock â
   ââ PersonSpec â
      ââ #person.name is #person.age years old [#iterationIndex] â
         ââ Fred is 38 years old [0] â
         ââ Wilma is 36 years old [1] â
         ââ Pebbles is 5 years old [2] â</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to specifying the unroll-pattern as method name, it can be given as parameter
to the <code>@Unroll</code> annotation which takes precedence over the method name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll("#featureName[#iterationIndex] (#person.name is #person.age years old)")
def "person age should be calculated properly"() {
// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be reported as</p>
</div>
<div class="listingblock">
<div class="content">
<pre>â·
ââ Spock â
   ââ PersonSpec â
      ââ person age should be calculated properly â
         ââ person age should be calculated properly[0] (Fred is 38 years old) â
         ââ person age should be calculated properly[1] (Wilma is 36 years old) â
         ââ person age should be calculated properly[2] (Pebbles is 5 years old) â</pre>
</div>
</div>
<div class="paragraph">
<p>The advantage is, that you can have a descriptive method name for the whole feature, while having a separate template for each iteration.
Furthermore, the feature method name is not filled with placeholders and thus better readable.</p>
</div>
<div class="paragraph">
<p>If neither a parameter to the annotation is given, nor the method name contains a <code>#</code>,
the <a href="#spock-configuration-file">configuration file</a> setting <code>defaultPattern</code>
in the <code>unroll</code> section is inspected. If it is set to a non-<code>null</code>
string, this value is used as unroll-pattern. This could for example be set to</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#featureName</code> to have all iterations reported with the same name, or</p>
</li>
<li>
<p><code>#featureName[#iterationIndex]</code> to have a simply indexed iteration name, or</p>
</li>
<li>
<p><code>#iterationName</code> if you make sure that in each data-driven feature you also set
a data variable called <code>iterationName</code> that is then used for reporting</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="unroll-tokens"><a class="link" href="#unroll-tokens">Special Tokens</a></h4>
<div class="paragraph">
<p>This is the complete list of special tokens:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#featureName</code> is the name of the feature (mostly useful for the <code>defaultPattern</code> setting)</p>
</li>
<li>
<p><code>#iterationIndex</code> is the current iteration index</p>
</li>
<li>
<p><code>#dataVariables</code> lists all data variables for this iteration, e.g. <code>x: 1, y: 2, z: 3</code></p>
</li>
<li>
<p><code>#dataVariablesWithIndex</code> the same as <code>#dataVariables</code> but with an index at the end, e.g. <code>x: 1, y: 2, z: 3, #0</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_configuration"><a class="link" href="#_configuration">Configuration</a></h4>
<div class="listingblock">
<div class="title">Set Default Unroll-Pattern</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">unroll {
    defaultPattern '#featureName[#iterationIndex]'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If none of the three described ways is used to set a custom unroll-pattern, by default
the feature name is used, suffixed with all data variable names and their values and
finally the iteration index, so the result will be for example
<code>my feature [x: 1, y: 2, z: 3, #0]</code>.</p>
</div>
<div class="paragraph">
<p>If there is an error in an unroll expression, for example typo in variable name, exception during
evaluation of a property or method in the expression and so on, the test will fail. This is not
true for the automatic fall back rendering of the data variables if there is no unroll-pattern
set in any way, this will never fail the test, no matter what happens.</p>
</div>
<div class="paragraph">
<p>The failing of test with errors in the unroll expression can be disabled by setting the
<a href="#spock-configuration-file">configuration file</a> setting <code>validateExpressions</code>
in the <code>unroll</code> section to <code>false</code>. If this is done and an error happens, the erroneous expression
<code>#foo.bar</code> will be substituted by <code>#Error:foo.bar</code>.</p>
</div>
<div class="listingblock">
<div class="title">Disable Unroll-pattern Expression Asserting</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">unroll {
    validateExpressions false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some reporting frameworks, or IDEs support proper tree based reporting.
For these cases it might be desirable to omit the feature name from the iteration reporting.</p>
</div>
<div class="listingblock">
<div class="title">Disable repetition of feature name in iterations</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">unroll {
    includeFeatureNameForIterations false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>includeFeatureNameForIterations true</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>â·
ââ Spock â
   ââ ASpec â
      ââ really long and informative test name that doesn't have to be repeated â
         ââ really long and informative test name that doesn't have to be repeated [x: 1, y: a, #0] â
         ââ really long and informative test name that doesn't have to be repeated [x: 2, y: b, #1] â
         ââ really long and informative test name that doesn't have to be repeated [x: 3, y: c, #2] â</pre>
</div>
</div>
<div class="listingblock">
<div class="title">With <code>includeFeatureNameForIterations false</code></div>
<div class="content">
<pre>â·
ââ Spock â
   ââ ASpec â
      ââ really long and informative test name that doesn't have to be repeated â
         ââ x: 1, y: a, #0 â
         ââ x: 2, y: b, #1 â
         ââ x: 3, y: c, #2 â</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The same can be achieved for individual features by using <code>@Unroll('#dataVariablesWithIndex')</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interaction-based-testing"><a class="link" href="#interaction-based-testing">Interaction Based Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interaction-based testing is a design and testing technique that emerged in the Extreme Programming
(XP) community in the early 2000&#8217;s. Focusing on the behavior of objects rather than their state, it explores how
the object(s) under specification interact, by way of method calls, with their collaborators.</p>
</div>
<div class="paragraph">
<p>For example, suppose we have a <code>Publisher</code> that sends messages to its `Subscriber`s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Publisher {
  List&lt;Subscriber&gt; subscribers = []
  int messageCount = 0
  void send(String message){
    subscribers*.receive(message)
    messageCount++
  }
}

interface Subscriber {
  void receive(String message)
}

class PublisherSpec extends Specification {
  Publisher publisher = new Publisher()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>How are we going to test <code>Publisher</code>? With state-based testing, we can verify that the publisher keeps track of its
subscribers. The more interesting question, though, is whether a message sent by the publisher
is received by the subscribers. To answer this question, we need a special implementation of
<code>Subscriber</code> that listens in on the conversation between the publisher and its subscribers. Such an
implementation is called a <em>mock object</em>.</p>
</div>
<div class="paragraph">
<p>While we could certainly create a mock implementation of <code>Subscriber</code> by hand, writing and maintaining this code
can get unpleasant as the number of methods and complexity of interactions increases. This is where mocking frameworks
come in: They provide a way to describe the expected interactions between an object under specification and its
collaborators, and can generate mock implementations of collaborators that verify these expectations.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How Are Mock Implementations Generated?</div>
<div class="paragraph">
<p>Like most Java mocking frameworks, Spock uses
<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html">JDK dynamic proxies</a> (when mocking interfaces)
and <a href="https://bytebuddy.net/">Byte Buddy</a> or <a href="https://github.com/cglib/cglib">CGLIB</a> proxies (when mocking classes) to generate mock implementations at runtime.
Compared to implementations based on Groovy meta-programming, this has the advantage that it also works for testing Java code.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The Java world has no shortage of popular and mature mocking frameworks: <a href="https://www.jmock.org/">JMock</a>,
<a href="https://www.easymock.org">EasyMock</a>, <a href="https://mockito.org/">Mockito</a>, to name just a few.
Although each of these tools can be used together with Spock, we decided to roll our own mocking framework,
tightly integrated with Spock&#8217;s specification language. This decision was driven by the desire to leverage all of
Groovy&#8217;s capabilities to make interaction-based tests easier to write, more readable, and ultimately more fun.
We hope that by the end of this chapter, you will agree that we have achieved these goals.</p>
</div>
<div class="paragraph">
<p>Except where indicated, all features of Spock&#8217;s mocking framework work both for testing Java and Groovy code.</p>
</div>
<div class="sect2">
<h3 id="_creating_mock_objects"><a class="link" href="#_creating_mock_objects">Creating Mock Objects</a></h3>
<div class="paragraph">
<p>Mock objects are created with the <code>MockingApi.Mock()</code> method.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>
Let&#8217;s create two mock subscribers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def subscriber = Mock(Subscriber)
def subscriber2 = Mock(Subscriber)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the following Java-like syntax is supported, which may give better IDE support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = Mock()
Subscriber subscriber2 = Mock()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the mock&#8217;s type is inferred from the variable type on the left-hand side of the assignment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the mock&#8217;s type is given on the left-hand side of the assignment, it&#8217;s permissible
(though not required) to omit it on the right-hand side.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mock objects literally implement (or, in the case of a class, extend) the type they stand in for. In other
words, in our example <code>subscriber</code> <em>is-a</em> <code>Subscriber</code>. Hence it can be passed to statically typed (Java)
code that expects this type.</p>
</div>
</div>
<div class="sect2">
<h3 id="_default_behavior_of_mock_objects"><a class="link" href="#_default_behavior_of_mock_objects">Default Behavior of Mock Objects</a></h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Lenient vs. Strict Mocking Frameworks</div>
<div class="paragraph">
<p>Like Mockito, we firmly believe that a mocking framework should be lenient by default. This means that unexpected
method calls on mock objects (or, in other words, interactions that aren&#8217;t relevant for the test at hand) are allowed
and answered with a default response. Conversely, mocking frameworks like EasyMock and JMock are strict by default,
and throw an exception for every unexpected method call. While strictness enforces rigor, it can also lead
to over-specification, resulting in brittle tests that fail with every other internal code change. Spock&#8217;s mocking
framework makes it easy to describe only what&#8217;s relevant about an interaction, avoiding the over-specification trap.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Initially, mock objects have no behavior. Calling methods on them is allowed but has no effect other than returning
the default value for the method&#8217;s return type (<code>false</code>, <code>0</code>, or <code>null</code>). An exception are the <code>Object.equals</code>,
<code>Object.hashCode</code>, and <code>Object.toString</code> methods, which have the following default behavior: A mock object is only
equal to itself, has a unique hash code, and a string representation that includes the name of the type it represents.
This default behavior is overridable by stubbing the methods, which we will learn about in the <a href="#_stubbing">Stubbing</a> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_injecting_mock_objects_into_code_under_specification"><a class="link" href="#_injecting_mock_objects_into_code_under_specification">Injecting Mock Objects into Code Under Specification</a></h3>
<div class="paragraph">
<p>After creating the publisher and its subscribers, we need to make the latter known to the former:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class PublisherSpec extends Specification {
  Publisher publisher = new Publisher()
  Subscriber subscriber = Mock()
  Subscriber subscriber2 = Mock()

  def setup() {
    publisher.subscribers &lt;&lt; subscriber // &lt;&lt; is a Groovy shorthand for List.add()
    publisher.subscribers &lt;&lt; subscriber2
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now ready to describe the expected interactions between the two parties.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_method_names_in_interactions"><a class="link" href="#_dynamic_method_names_in_interactions">Dynamic Method Names in Interactions</a></h3>
<div class="paragraph">
<p>Specifying interactions on method names defined by a variable is very useful when several methods share testing code. We
could parameterize the methods name to test. For Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def 'm1, m2 and m3 delegate its execution'(){
    given:
    def myObject = myObject(delegateMock)

    when:
    myObject."$methodName"()
    then:
    1 * delegateMock."do$methodName"()

    where:
    methodName &lt;&lt; ['m1', 'm2', 'm3']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll
def "Factory produces '#dataFetcher' as singleton"() {
    expect:
    DataFetcherFactory."get$dataFetcher"() is DataFetcherFactory."get$dataFetcher"()

    where:
    _ | dataFetcher
    _ | "BookDataFetcher"
    _ | "AuthorDataFetcher"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mocking"><a class="link" href="#_mocking">Mocking</a></h3>
<div class="paragraph">
<p>Mocking is the act of describing (mandatory) interactions between the object under specification and its collaborators.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "should send messages to all subscribers"() {
  when:
  publisher.send("hello")

  then:
  1 * subscriber.receive("hello")
  1 * subscriber2.receive("hello")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read out aloud: "When the publisher sends a 'hello' message, then both subscribers should receive that message exactly once."</p>
</div>
<div class="paragraph">
<p>When this feature method gets run, all invocations on mock objects that occur while executing the
<code>when</code> block will be matched against the interactions described in the <code>then:</code> block. If one of the interactions isn&#8217;t
satisfied, a (subclass of) <code>InteractionNotSatisfiedError</code> will be thrown. This verification happens automatically
and does not require any additional code.</p>
</div>
<div class="sect3">
<h4 id="_interactions_2"><a class="link" href="#_interactions_2">Interactions</a></h4>
<div class="sidebarblock">
<div class="content">
<div class="title">Is an Interaction Just a Regular Method Invocation?</div>
<div class="paragraph">
<p>Not quite. While an interaction looks similar to a regular method invocation, it is simply a way to express which
method invocations are expected to occur. A good way to think of an interaction is as a regular expression
that all incoming invocations on mock objects are matched against. Depending on the circumstances, the interaction
may match zero, one, or multiple invocations.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a closer look at the <code>then:</code> block. It contains two <em>interactions</em>, each of which has four distinct
parts: a <em>cardinality</em>, a <em>target constraint</em>, a <em>method constraint</em>, and an <em>argument constraint</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1 * subscriber.receive("hello")
|   |          |       |
|   |          |       argument constraint
|   |          method constraint
|   target constraint
cardinality</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cardinality"><a class="link" href="#_cardinality">Cardinality</a></h4>
<div class="paragraph">
<p>The cardinality of an interaction describes how often a method call is expected. It can either be a fixed number or
a range:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.receive("hello")      // exactly one call
0 * subscriber.receive("hello")      // zero calls
(1..3) * subscriber.receive("hello") // between one and three calls (inclusive)
(1.._) * subscriber.receive("hello") // at least one call
(_..3) * subscriber.receive("hello") // at most three calls
_ * subscriber.receive("hello")      // any number of calls, including zero
                                     // (rarely needed; see 'Strict Mocking')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_target_constraint"><a class="link" href="#_target_constraint">Target Constraint</a></h4>
<div class="paragraph">
<p>The target constraint of an interaction describes which mock object is expected to receive the method call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.receive("hello") // a call to 'subscriber'
1 * _.receive("hello")          // a call to any mock object</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_constraint"><a class="link" href="#_method_constraint">Method Constraint</a></h4>
<div class="paragraph">
<p>The method constraint of an interaction describes which method is expected to be called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.receive("hello") // a method named 'receive'
1 * subscriber./r.*e/("hello")  // a method whose name matches the given regular expression
                                // (here: method name starts with 'r' and ends in 'e')</code></pre>
</div>
</div>
<div class="paragraph">
<p>When expecting a call to a getter method, Groovy property syntax <em>can</em> be used instead of method syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.status // same as: 1 * subscriber.getStatus()</code></pre>
</div>
</div>
<div class="paragraph">
<p>When expecting a call to a setter method, only method syntax can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.setStatus("ok") // NOT: 1 * subscriber.status = "ok"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_argument_constraints"><a class="link" href="#_argument_constraints">Argument Constraints</a></h4>
<div class="paragraph">
<p>The argument constraints of an interaction describe which method arguments are expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.receive("hello")        // an argument that is equal to the String "hello"
1 * subscriber.receive(!"hello")       // an argument that is unequal to the String "hello"
1 * subscriber.receive()               // the empty argument list (would never match in our example)
1 * subscriber.receive(_)              // any single argument (including null)
1 * subscriber.receive(*_)             // any argument list (including the empty argument list)
1 * subscriber.receive(!null)          // any non-null argument
1 * subscriber.receive(_ as String)    // any non-null argument that is-a String
1 * subscriber.receive(endsWith("lo")) // an argument matching the given Hamcrest matcher
                                       // a String argument ending with "lo" in this case
1 * subscriber.receive({ it.size() &gt; 3 &amp;&amp; it.contains('a') })
// an argument that satisfies the given predicate, meaning that
// code argument constraints need to return true of false
// depending on whether they match or not
// (here: message length is greater than 3 and contains the character a)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Argument constraints work as expected for methods with multiple arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * process.invoke("ls", "-a", _, !null, { ["abcdefghiklmnopqrstuwx1"].contains(it) })</code></pre>
</div>
</div>
<div class="paragraph">
<p>When dealing with vararg methods, vararg syntax can also be used in the corresponding interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">interface VarArgSubscriber {
    void receive(String... messages)
}

...

subscriber.receive("hello", "goodbye")</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Spock Deep Dive: Groovy Varargs</div>
<div class="paragraph">
<p>Groovy allows any method whose last parameter has an array type to be called in vararg style.
Consequently, vararg syntax can also be used in interactions matching such methods.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_equality_constraint"><a class="link" href="#_equality_constraint">Equality Constraint</a></h5>
<div class="paragraph">
<p>The equality constraint uses groovy equality to check the argument, i.e, <code>argument == constraint</code>. You can use</p>
</div>
<div class="ulist">
<ul>
<li>
<p>any literal <code>1 * check('string')</code> / <code>1 * check(1)</code> / <code>1 * check(null)</code>,</p>
</li>
<li>
<p>a variable <code>1 * check(var)</code>,</p>
</li>
<li>
<p>a list or map literal <code>1 * check([1])</code> / <code>1 * check([foo: 'bar'])</code>,</p>
</li>
<li>
<p>an object <code>1 * check(new Person('sam'))</code>,</p>
</li>
<li>
<p>or the result of a method call <code>1 * check(person())</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>as an equality constraint.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hamcrest_constraint"><a class="link" href="#_hamcrest_constraint">Hamcrest Constraint</a></h5>
<div class="paragraph">
<p>A variation of the equality constraint, if the constraint object is a Hamcrest matcher, then it will use that matcher
to check the argument.</p>
</div>
</div>
<div class="sect4">
<h5 id="_wildcard_constraint"><a class="link" href="#_wildcard_constraint">Wildcard Constraint</a></h5>
<div class="paragraph">
<p>The wildcard constraint will match any argument <code>null</code> or otherwise. It is the <code><em></code>, i.e. <code>1 * subscriber.receive(</em>)</code>.
There is also the spread wildcard constraint <code>*_</code> which matches any number of arguments <code>1 * subscriber.receive(*_)</code> including none.</p>
</div>
</div>
<div class="sect4">
<h5 id="_code_constraint"><a class="link" href="#_code_constraint">Code Constraint</a></h5>
<div class="paragraph">
<p>The code constraint is the most versatile of all. It is a groovy closure that gets the argument as its parameter.
The closure is treated as an condition block, so it behaves like a <code>then</code> block, i.e., every line is treated as an implicit assertion.
It can emulate all but the spread wildcard constraint, however it is suggested to use the simpler constraints where possible.
You can do multiple assertions, call methods for assertions, or use <code>with</code>/<code>verifyAll</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * list.add({
  verifyAll(it, Person) {
    firstname == 'William'
    lastname == 'Kirk'
    age == 45
  }
})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_negating_constraint"><a class="link" href="#_negating_constraint">Negating Constraint</a></h5>
<div class="paragraph">
<p>The negating constraint <code>!</code> is a compound constraint, i.e. it needs to be combined with another constraint to work.
It inverts the result of the nested constraint, e.g, <code>1 * subscriber.receive(!null)</code> is the combination of
an equality constraint checking for null and then the negating constraint inverting the result, turning it into not null.</p>
</div>
<div class="paragraph">
<p>Although it can be combined with any other constraint it does not always make sense, e.g., <code>1 * subscriber.receive(!_)</code> will match nothing.
Also keep in mind that the diagnostics for a non matching negating constraint will just be that the inner
constraint did match, without any more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_type_constraint"><a class="link" href="#_type_constraint">Type Constraint</a></h5>
<div class="paragraph">
<p>The type constraint checks for the type/class of the argument, like the negating constraint it is also a compound constraint.
It usually written as <code>_ as Type</code>, which is a combination of the wildcard constraint and the type constraint.
You can combined it with other constraints as well, <code>1 * subscriber.receive({ it.contains('foo')} as String)</code> will assert that it is
a <code>String</code> before executing the code constraint to check if it contains <code>foo</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_matching_any_method_call"><a class="link" href="#_matching_any_method_call">Matching Any Method Call</a></h4>
<div class="paragraph">
<p>Sometimes it can be useful to match "anything", in some sense of the word:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber._(*_)     // any method on subscriber, with any argument list
1 * subscriber._         // shortcut for and preferred over the above

1 * _._                  // any method call on any mock object
1 * _                    // shortcut for and preferred over the above</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although <code>(_.._) * _._(*_) &gt;&gt; _</code> is a valid interaction declaration,
it is neither good style nor particularly useful.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_strict_mocking"><a class="link" href="#_strict_mocking">Strict Mocking</a></h4>
<div class="paragraph">
<p>Now, when would matching any method call be useful? A good example is <em>strict mocking</em>,
a style of mocking where no interactions other than those explicitly declared are allowed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
publisher.publish("hello")

then:
1 * subscriber.receive("hello") // demand one 'receive' call on 'subscriber'
_ * auditing._                  // allow any interaction with 'auditing'
0 * _                           // don't allow any other interaction</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>0 *</code> only makes sense as the last interaction of a <code>then:</code> block or method. Note the
use of <code>_ *</code> (any number of calls), which allows any interaction with the auditing component.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>_ *</code> is only meaningful in the context of strict mocking. In particular, it is never necessary
when <a href="#_stubbing">Stubbing</a> an invocation. For example, <code>_ * auditing.record(<em>) &gt;&gt; "ok"</code>
can (and should!) be simplified to <code>auditing.record(</em>) &gt;&gt; "ok"</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_where_to_declare_interactions"><a class="link" href="#_where_to_declare_interactions">Where to Declare Interactions</a></h4>
<div class="paragraph">
<p>So far, we declared all our interactions in a <code>then:</code> block. This often results in a spec that reads naturally.
However, it is also permissible to put interactions anywhere <em>before</em> the <code>when:</code> block that is supposed to satisfy
them. In particular, this means that interactions can be declared in a <code>setup</code> method. Interactions can also be
declared in any "helper" instance method of the same specification class.</p>
</div>
<div class="paragraph">
<p>When an invocation on a mock object occurs, it is matched against interactions in the interactions' declared order.
If an invocation matches multiple interactions, the earliest declared interaction that hasn&#8217;t reached its upper
invocation limit will win. There is one exception to this rule: Interactions declared in a <code>then:</code> block are
matched against before any other interactions. This allows to override interactions declared in, say, a <code>setup</code>
method with interactions declared in a <code>then:</code> block.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Spock Deep Dive: How Are Interactions Recognized?</div>
<div class="paragraph">
<p>In other words, what makes an expression an interaction declaration, rather than, say, a regular method call?
Spock uses a simple syntactic rule to recognize interactions: If an expression is in statement position
and is either a multiplication (<code>*</code>) or a right-shift (<code>&gt;&gt;</code>, <code>&gt;&gt;&gt;</code>) operation, then it is considered
an interaction and will be parsed accordingly. Such an expression would have little to no value in statement
position, so changing its meaning works out fine. Note how the operations correspond to the syntax for declaring
a cardinality (when mocking) or a response generator (when stubbing). Either of them must always be present;
<code>foo.bar()</code> alone will never be considered an interaction.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="declaring-interactions-at-creation-time"><a class="link" href="#declaring-interactions-at-creation-time">Declaring Interactions at Mock Creation Time</a></h4>
<div class="paragraph">
<p>If a mock has a set of "base" interactions that don&#8217;t vary, they can be declared right at mock creation time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = Mock {
   1 * receive("hello")
   1 * receive("goodbye")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature is particularly attractive for <a href="#_stubbing">Stubbing</a> and with dedicated <a href="#Stubs">Stubs</a>. Note that the
interactions don&#8217;t (and cannot <sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>) have a target constraint; it&#8217;s clear from the context which mock
object they belong to.</p>
</div>
<div class="paragraph">
<p>Interactions can also be declared when initializing an instance field with a mock:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class MySpec extends Specification {
    Subscriber subscriber = Mock {
        1 * receive("hello")
        1 * receive("goodbye")
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grouping_interactions_with_same_target"><a class="link" href="#_grouping_interactions_with_same_target">Grouping Interactions with Same Target</a></h4>
<div class="paragraph">
<p>Interactions sharing the same target can be grouped in a <code>Specification.with</code> block. Similar to
<a href="#declaring-interactions-at-creation-time">Declaring Interactions at Mock Creation Time</a>, this makes it unnecessary
to repeat the target constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">with(subscriber) {
    1 * receive("hello")
    1 * receive("goodbye")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>with</code> block can also be used for grouping conditions with the same target.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mixing_interactions_and_conditions"><a class="link" href="#_mixing_interactions_and_conditions">Mixing Interactions and Conditions</a></h4>
<div class="paragraph">
<p>A <code>then:</code> block may contain both interactions and conditions. Although not strictly required, it is customary
to declare interactions before conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
publisher.send("hello")

then:
1 * subscriber.receive("hello")
publisher.messageCount == 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read out aloud: "When the publisher sends a 'hello' message, then the subscriber should receive the message exactly
once, and the publisher&#8217;s message count should be one."</p>
</div>
</div>
<div class="sect3">
<h4 id="_explicit_interaction_blocks"><a class="link" href="#_explicit_interaction_blocks">Explicit Interaction Blocks</a></h4>
<div class="paragraph">
<p>Internally, Spock must have full information about expected interactions <em>before</em> they take place.
So how is it possible for interactions to be declared in a <code>then:</code> block?
The answer is that under the hood, Spock moves interactions declared in a <code>then:</code> block to immediately
before the preceding <code>when:</code> block. In most cases this works out just fine, but sometimes it can lead to problems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
publisher.send("hello")

then:
def message = "hello"
1 * subscriber.receive(message)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have introduced a variable for the expected argument. (Likewise, we could have introduced a variable
for the cardinality.) However, Spock isn&#8217;t smart enough (huh?) to tell that the interaction is intrinsically
linked to the variable declaration. Hence it will just move the interaction, which will cause a
<code>MissingPropertyException</code> at runtime.</p>
</div>
<div class="paragraph">
<p>One way to solve this problem is to move (at least) the variable declaration to before the <code>when:</code>
block. (Fans of <a href="#data-driven-testing">Data Driven Testing</a> might move the variable into a <code>where:</code> block.)
In our example, this would have the added benefit that we could use the same variable for sending the message.</p>
</div>
<div class="paragraph">
<p>Another solution is to be explicit about the fact that variable declaration and interaction belong together:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
publisher.send("hello")

then:
interaction {
  def message = "hello"
  1 * subscriber.receive(message)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since an <code>MockingApi.interaction</code> block is always moved in its entirety, the code now works as intended.</p>
</div>
</div>
<div class="sect3">
<h4 id="_scope_of_interactions"><a class="link" href="#_scope_of_interactions">Scope of Interactions</a></h4>
<div class="paragraph">
<p>Interactions declared in a <code>then:</code> block are scoped to the preceding <code>when:</code> block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
publisher.send("message1")

then:
1 * subscriber.receive("message1")

when:
publisher.send("message2")

then:
1 * subscriber.receive("message2")</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes sure that <code>subscriber</code> receives <code>"message1"</code> during execution of the first <code>when:</code> block,
and <code>"message2"</code> during execution of the second <code>when:</code> block.</p>
</div>
<div class="paragraph">
<p>Interactions declared outside a <code>then:</code> block are active from their declaration until the end of the
containing feature method.</p>
</div>
<div class="paragraph">
<p>Interactions are always scoped to a particular feature method. Hence they cannot be declared in a static method,
<code>setupSpec</code> method, or <code>cleanupSpec</code> method. Likewise, mock objects should not be stored in static or <code>@Shared</code>
fields.</p>
</div>
</div>
<div class="sect3">
<h4 id="_verification_of_interactions"><a class="link" href="#_verification_of_interactions">Verification of Interactions</a></h4>
<div class="paragraph">
<p>There are two main ways in which a mock-based test can fail: An interaction can match more invocations than
allowed, or it can match fewer invocations than required. The former case is detected right when the invocation
happens, and causes a <code>TooManyInvocationsError</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Too many invocations for:

2 * subscriber.receive(_) (3 invocations)</pre>
</div>
</div>
<div id="ShowAllMatchingInvocations" class="paragraph">
<p>To make it easier to diagnose why too many invocations matched, Spock will show all invocations matching
the interaction in question:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Matching invocations (ordered by last occurrence):

2 * subscriber.receive("hello")   &lt;-- this triggered the error
1 * subscriber.receive("goodbye")</pre>
</div>
</div>
<div class="paragraph">
<p>According to this output, one of the <code>receive("hello")</code> calls triggered the <code>TooManyInvocationsError</code>.
Note that because indistinguishable calls like the two invocations of <code>subscriber.receive("hello")</code> are aggregated
into a single line of output, the first <code>receive("hello")</code> may well have occurred before the <code>receive("goodbye")</code>.</p>
</div>
<div class="paragraph">
<p>The second case (fewer invocations than required) can only be detected once execution of the <code>when</code> block has completed.
(Until then, further invocations may still occur.) It causes a <code>TooFewInvocationsError</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Too few invocations for:

1 * subscriber.receive("hello") (0 invocations)</pre>
</div>
</div>
<div class="paragraph">
<p>Note that it doesn&#8217;t matter whether the method was not called at all, the same method was called with different arguments,
the same method was called on a different mock object, or a different method was called "instead" of this one;
in either case, a <code>TooFewInvocationsError</code> error will occur.</p>
</div>
<div id="ShowUnmatchedInvocations" class="paragraph">
<p>To make it easier to diagnose what happened "instead" of a missing invocation, Spock will show all
invocations that didn&#8217;t match any interaction, ordered by their similarity with the interaction in question.
In particular, invocations that match everything but the interaction&#8217;s arguments will be shown first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Unmatched invocations (ordered by similarity):

1 * subscriber.receive("goodbye")
1 * subscriber2.receive("hello")</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_invocation_order_2"><a class="link" href="#_invocation_order_2">Invocation Order</a></h4>
<div class="paragraph">
<p>Often, the exact method invocation order isn&#8217;t relevant and may change over time. To avoid over-specification,
Spock defaults to allowing any invocation order, provided that the specified interactions are eventually satisfied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">then:
2 * subscriber.receive("hello")
1 * subscriber.receive("goodbye")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, any of the invocation sequences <code>"hello"</code> <code>"hello"</code> <code>"goodbye"</code>, <code>"hello"</code> <code>"goodbye"</code> <code>"hello"</code>, and
<code>"goodbye"</code> <code>"hello"</code> <code>"hello"</code> will satisfy the specified interactions.</p>
</div>
<div class="paragraph">
<p>In those cases where invocation order matters, you can impose an order by splitting up interactions into
multiple <code>then:</code> blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">then:
2 * subscriber.receive("hello")

then:
1 * subscriber.receive("goodbye")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Spock will verify that both <code>"hello"</code>'s are received before the <code>"goodbye"</code>.
In other words, invocation order is enforced <em>between</em> but not <em>within</em> <code>then:</code> blocks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Splitting up a <code>then:</code> block with <code>and:</code> does not impose any ordering, as <code>and:</code>
is only meant for documentation purposes and doesn&#8217;t carry any semantics.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_mocking_classes"><a class="link" href="#_mocking_classes">Mocking Classes</a></h4>
<div class="paragraph">
<p>Besides interfaces, Spock also supports mocking of classes and interfaces with
different <a href="#mock-makers">mock makers</a>.
Mocking classes works just like mocking interfaces, but you may need to put
additional runtime dependencies on the class path, depending on the used mock maker.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mock_instance_construction"><a class="link" href="#_mock_instance_construction">Mock Instance Construction</a></h4>
<div class="paragraph">
<p>When using for example</p>
</div>
<div class="ulist">
<ul>
<li>
<p>normal <code>Mock</code>s or <code>Stub</code>s or</p>
</li>
<li>
<p><code>Spy</code>s that are configured with <code>useObjenesis: true</code> or</p>
</li>
<li>
<p><code>Spy</code>s that spy on a concrete instance like <code>Spy(myInstance)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>it is necessary to put <code>org.objenesis:objenesis</code> 3.0+ on the class path, except for classes with accessible
no-arg constructor or configured <code>constructorArgs</code> unless the constructor call should not be done,
for example to avoid unwanted side effects.</p>
</div>
<div class="paragraph">
<p>If the library is missing from the class path, Spock will gently let you know.</p>
</div>
</div>
<div class="sect3">
<h4 id="_selecting_a_mock_maker"><a class="link" href="#_selecting_a_mock_maker">Selecting a Mock Maker</a></h4>
<div class="paragraph">
<p>The different <a href="#mock-makers">mock makers</a> have different capabilities and drawbacks.
You can manually select the used mock maker for the mocked object,
by specifying an <code>IMockMakerSettings</code> instance as the <code>mockMaker</code> mock option.</p>
</div>
<div class="paragraph">
<p>The class <code>spock.mock.MockMakers</code> provides constants and methods for the built-in mock makers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def subscriber = Mock(mockMaker: MockMakers.byteBuddy, Subscriber)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will use the <code>byte-buddy</code> mock maker to create the <code>subscriber</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stubbing"><a class="link" href="#_stubbing">Stubbing</a></h3>
<div class="paragraph">
<p>Stubbing is the act of making collaborators respond to method calls in a certain way. When stubbing
a method, you don&#8217;t care if and how many times the method is going to be called; you just want it to
return some value, or perform some side effect, <em>whenever</em> it gets called.</p>
</div>
<div class="paragraph">
<p>For the sake of the following examples, let&#8217;s modify the <code>Subscriber</code>'s <code>receive</code> method
to return a status code that tells if the subscriber was able to process a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">interface Subscriber {
    String receive(String message)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s make the <code>receive</code> method return <code>"ok"</code> on every invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; "ok"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read out aloud: "<em>Whenever</em> the subscriber receives a message, <em>make</em> it respond with 'ok'."</p>
</div>
<div class="paragraph">
<p>Compared to a mocked interaction, a stubbed interaction has no cardinality on the left end, but adds a
<em>response generator</em> on the right end:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>subscriber.receive(_) &gt;&gt; "ok"
|          |       |     |
|          |       |     response generator
|          |       argument constraint
|          method constraint
target constraint</pre>
</div>
</div>
<div class="paragraph">
<p>A stubbed interaction can be declared in the usual places: either inside a <code>then:</code> block, or anywhere before a
<code>when:</code> block. (See <a href="#_where_to_declare_interactions">Where to Declare Interactions</a> for the details.) If a mock object is only used for stubbing,
it&#8217;s common to declare interactions <a href="#declaring-interactions-at-creation-time">at mock creation time</a> or in a
<code>given:</code> block.</p>
</div>
<div class="sect3">
<h4 id="_returning_fixed_values"><a class="link" href="#_returning_fixed_values">Returning Fixed Values</a></h4>
<div class="paragraph">
<p>We have already seen the use of the right-shift (<code>&gt;&gt;</code>) operator to return a fixed value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; "ok"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To return different values for different invocations, use multiple interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive("message1") &gt;&gt; "ok"
subscriber.receive("message2") &gt;&gt; "fail"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return <code>"ok"</code> whenever <code>"message1"</code> is received, and <code>"fail"</code> whenever
<code>"message2"</code> is received. There is no limit as to which values can be returned, provided they are
compatible with the method&#8217;s declared return type.</p>
</div>
</div>
<div class="sect3">
<h4 id="_returning_sequences_of_values"><a class="link" href="#_returning_sequences_of_values">Returning Sequences of Values</a></h4>
<div class="paragraph">
<p>To return different values on successive invocations, use the triple-right-shift (<code>&gt;&gt;&gt;</code>) operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt;&gt; ["ok", "error", "error", "ok"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return <code>"ok"</code> for the first invocation, <code>"error"</code> for the second and third invocation,
and <code>"ok"</code> for all remaining invocations. The right-hand side must be a value that Groovy knows how to iterate over;
in this example, we&#8217;ve used a plain list.</p>
</div>
</div>
<div class="sect3">
<h4 id="_computing_return_values"><a class="link" href="#_computing_return_values">Computing Return Values</a></h4>
<div class="paragraph">
<p>To compute a return value based on the method&#8217;s argument, use the the right-shift (<code>&gt;&gt;</code>) operator together with a closure.
If the closure declares a single untyped parameter, it gets passed the method&#8217;s argument list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; { args -&gt; args[0].size() &gt; 3 ? "ok" : "fail" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>"ok"</code> gets returned if the message is more than three characters long, and <code>"fail"</code> otherwise.</p>
</div>
<div class="paragraph">
<p>In most cases it would be more convenient to have direct access to the method&#8217;s arguments. If the closure declares more
than one parameter or a single <em>typed</em> parameter, method arguments will be mapped one-by-one to closure
parameters:<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; { String message -&gt; message.size() &gt; 3 ? "ok" : "fail" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This response generator behaves the same as the previous one, but is arguably more readable.</p>
</div>
<div class="paragraph">
<p>If you find yourself in need of more information about a method invocation than its arguments, have a look at
<code>org.spockframework.mock.IMockInvocation</code>. All methods declared in this interface are available inside the closure,
without a need to prefix them. (In Groovy terminology, the closure <em>delegates</em> to an instance of <code>IMockInvocation</code>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_performing_side_effects"><a class="link" href="#_performing_side_effects">Performing Side Effects</a></h4>
<div class="paragraph">
<p>Sometimes you may want to do more than just computing a return value. A typical example is
throwing an exception. Again, closures come to the rescue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; { throw new InternalError("ouch") }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the closure can contain more code, for example a <code>println</code> statement. It
will get executed every time an incoming invocation matches the interaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chaining_method_responses"><a class="link" href="#_chaining_method_responses">Chaining Method Responses</a></h4>
<div class="paragraph">
<p>Method responses can be chained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt;&gt; ["ok", "fail", "ok"] &gt;&gt; { throw new InternalError() } &gt;&gt; "ok"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return <code>"ok", "fail", "ok"</code> for the first three invocations, throw <code>InternalError</code>
for the fourth invocations, and return <code>ok</code> for any further invocation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_returning_a_default_response"><a class="link" href="#_returning_a_default_response">Returning a default response</a></h4>
<div class="paragraph">
<p>If you don&#8217;t really care what you return, but you must return a non-null value, you can use <code>_</code>.
This will use the same logic to compute a response as <code>Stub</code> (see <a href="#Stubs">Stubs</a>), so it is only really useful for <code>Mock</code> and <code>Spy</code> instances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; _</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can of course use this with chaining as well. Here it might be useful for <code>Stub</code> instances as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt;&gt; ["ok", "fail"] &gt;&gt; _ &gt;&gt; "ok"</code></pre>
</div>
</div>
<div class="paragraph">
<p>An application of this is to let a <code>Mock</code> behave like a <code>Stub</code>, but still be able to do assertions.
The default response will return the mock itself, if the return type of the method is assignable from the mock type (excluding object).
This is useful when dealing with fluent APIs, like builders, which are otherwise really painful to mock.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
ThingBuilder builder = Mock() {
  _ &gt;&gt; _
}

when:
Thing thing = builder
  .id("id-42")
  .name("spock")
  .weight(100)
  .build()

then:
1 * builder.build() &gt;&gt; new Thing(id: 'id-1337')
thing.id == 'id-1337'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>_ &gt;&gt; _</code> instructs the mock to return the default response for all interactions.
However, interactions defined in the <code>then</code> block will have precedence over the interactions defined in the <code>given</code> block,
this lets us override and assert the interaction we actually care about.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_combining_mocking_and_stubbing"><a class="link" href="#_combining_mocking_and_stubbing">Combining Mocking and Stubbing</a></h3>
<div class="paragraph">
<p>Mocking and stubbing go hand-in-hand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.receive("message1") &gt;&gt; "ok"
1 * subscriber.receive("message2") &gt;&gt; "fail"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When mocking and stubbing the same method call, they have to happen in the same interaction.
In particular, the following Mockito-style splitting of stubbing and mocking into two separate
statements will <em>not</em> work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
subscriber.receive("message1") &gt;&gt; "ok"

when:
publisher.send("message1")

then:
1 * subscriber.receive("message1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>As explained in <a href="#_where_to_declare_interactions">Where to Declare Interactions</a>, the <code>receive</code> call will first get matched against
the interaction in the <code>then:</code> block. Since that interaction doesn&#8217;t specify a response, the default
value for the method&#8217;s return type (<code>null</code> in this case) will be returned. (This is just another
facet of Spock&#8217;s lenient approach to mocking.). Hence, the interaction in the <code>given:</code> block will never
get a chance to match.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Mocking and stubbing of the same method call has to happen in the same interaction.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="OtherKindsOfMockObjects"><a class="link" href="#OtherKindsOfMockObjects">Other Kinds of Mock Objects</a></h3>
<div class="paragraph">
<p>So far, we have created mock objects with the <code>MockingApi.Mock</code> method. Aside from
this method, the <code>MockingApi</code> class provides a couple of other factory methods for creating
more specialized kinds of mock objects.</p>
</div>
<div class="sect3">
<h4 id="Stubs"><a class="link" href="#Stubs">Stubs</a></h4>
<div class="paragraph">
<p>A <em>stub</em> is created with the <code>MockingApi.Stub</code> factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = Stub()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas a mock can be used both for stubbing and mocking, a stub can only be used for stubbing.
Limiting a collaborator to a stub communicates its role to the readers of the specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a stub invocation matches a <em>mandatory</em> interaction (like <code>1 * foo.bar()</code>), an <code>InvalidSpecException</code> is thrown.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Like a mock, a stub allows unexpected invocations. However, the values returned by a stub in such cases are more ambitious:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For primitive types, the primitive type&#8217;s default value is returned.</p>
</li>
<li>
<p>For non-primitive numerical values (such as <code>BigDecimal</code>), zero is returned.</p>
</li>
<li>
<p>If the value is assignable from the stub instance, then the instance is returned (e.g. builder pattern)</p>
</li>
<li>
<p>For non-numerical values, an "empty" or "dummy" object is returned. This could mean an empty String, an empty collection,
an object constructed from its default constructor, or another stub returning default values.
See class <code>org.spockframework.mock.EmptyOrDummyResponse</code> for the details.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the response type of the method is a final class or if it requires a class-mocking library and cglib or ByteBuddy
      are not available, then the "dummy" object creation will fail with a <code>CannotCreateMockException</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A stub often has a fixed set of interactions, which makes
<a href="#declaring-interactions-at-creation-time">declaring interactions at mock creation time</a> particularly attractive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = Stub {
    receive("message1") &gt;&gt; "ok"
    receive("message2") &gt;&gt; "fail"
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Spies"><a class="link" href="#Spies">Spies</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <em>spy</em> is created with the <code>MockingApi.Spy</code> factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">SubscriberImpl subscriber = Spy(constructorArgs: ["Fred"])</code></pre>
</div>
</div>
<div class="paragraph">
<p>A spy is always based on a real object. Hence you must provide a class type rather
than an interface type, along with any constructor arguments for the type.
If no constructor arguments are provided, the type&#8217;s no-arg constructor will be used.</p>
</div>
<div class="paragraph">
<p>If the given constructor arguments lead to an ambiguity, you can cast the constructor
arguments as usual using <code>as</code> or Java-style cast. If the testee for example has
one constructor with a <code>String</code> parameter and one with a <code>Pattern</code> parameter
and you want <code>null</code> as <code>constructorArg</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">SubscriberImpl subscriber = Spy(constructorArgs: [null as String])
SubscriberImpl subscriber2 = Spy(constructorArgs: [(Pattern) null])</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also create a spy from an instantiated object. This may be useful in cases
where you do not have full control over the instantiation of types you are interested
in spying. (For example when testing within a Dependency Injection framework such as
Spring or Guice.)</p>
</div>
<div class="paragraph">
<p>Method calls on a spy are automatically delegated to the real object. Likewise, values
returned from the real object&#8217;s methods are passed back to the caller via the spy.</p>
</div>
<div class="paragraph">
<p>After creating a spy, you can listen in on the conversation between the caller and the real object underlying the spy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * subscriber.receive(_)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apart from making sure that <code>receive</code> gets called exactly once,
the conversation between the publisher and the <code>SubscriberImpl</code> instance underlying the spy remains unaltered.</p>
</div>
<div class="paragraph">
<p>When stubbing a method on a spy, the real method no longer gets called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; "ok"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of calling <code>SubscriberImpl.receive</code>, the <code>receive</code> method will now simply return <code>"ok"</code>.</p>
</div>
<div class="paragraph">
<p>Sometimes, it is desirable to both execute some code <em>and</em> delegate to the real method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; { String message -&gt; callRealMethod(); message.size() &gt; 3 ? "ok" : "fail" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use <code>callRealMethod()</code> to delegate the method invocation to the real object.
Note that we don&#8217;t have to pass the <code>message</code> argument along; this is taken care of automatically. <code>callRealMethod()</code>
returns the real invocation&#8217;s result, but in this example we opted to return our own result instead.
If we had wanted to pass a different message to the real method, we could have used <code>callRealMethodWithArgs("changed message")</code>.</p>
</div>
<div class="paragraph">
<p>Please note that while semantically both <code>callRealMethod()</code> and <code>callRealMethodWithArgs(&#8230;&#8203;)</code> only make sense with spies,
technically you can also call these methods on mock or stub objects, kind of turning them into (pseudo) spy objects
"through the backdoor". The only precondition is that the mocked/stubbed object actually has a real method implementation,
i.e. for interface mocks there must be a default method, for class mocks there must be a (non-abstract) original method.</p>
</div>
</div>
<div class="sect3">
<h4 id="PartialMocks"><a class="link" href="#PartialMocks">Partial Mocks</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spies can also be used as partial mocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">// this is now the object under specification, not a collaborator
MessagePersister persister = Spy {
  // stub a call on the same object
  isPersistable(_) &gt;&gt; true
}

when:
persister.receive("msg")

then:
// demand a call on the same object
1 * persister.persist("msg")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="MockingStaticMethods"><a class="link" href="#MockingStaticMethods">Mocking Static Methods</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spock supports two ways of mocking static methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SpyStatic()</code> static mocks: Works with Java and Groovy, but requires a mock maker supporting this, e.g. <a href="#mock-makers-mockito">mockito</a> Mock Maker.</p>
</li>
<li>
<p><a href="#global-groovy-mock-static-methods">Global Groovy mocks</a>: Work only for Groovy code not for Java.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="static-mocks"><a class="link" href="#static-mocks">Static Mocks</a></h4>
<div class="paragraph">
<p>You can create static mocks with <code>SpyStatic()</code>.</p>
</div>
<div class="paragraph">
<p><code>SpyStatic(&lt;Type&gt;)</code> mocks the static methods of the given type; by default, delegates all calls to the real static methods.
Supports both stubbing and mocking.</p>
</div>
<div class="paragraph">
<p>We are using the class <code>StaticClass</code> in the examples:</p>
</div>
<div class="listingblock">
<div class="title">Example static class used in the test examples</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">private static class StaticClass {
  static String staticMethod() {
    return "RealValue"
  }

  static String otherStaticMethod() {
    return "OtherValue"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to mock the method <code>staticMethod()</code>, so we can create a static mock for the <code>StaticClass</code> type:</p>
</div>
<div class="listingblock">
<div class="title">Mock static method of a class with SpyStatic()</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
SpyStatic(StaticClass)

expect: "By default SpyStatic() will return the real value"
StaticClass.staticMethod() == "RealValue"

when:
def result = StaticClass.staticMethod()

then:
1 * StaticClass.staticMethod() &gt;&gt; "MockValue"
result == "MockValue"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify the answers after construction by defining the interactions as for a normal mock:</p>
</div>
<div class="listingblock">
<div class="title">Mock static method of a class with interactions</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
SpyStatic(StaticClass)
StaticClass.staticMethod() &gt;&gt; "MockValue"

expect:
StaticClass.staticMethod() == "MockValue"</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to stub all static methods of a class like a <code>Stub</code> would do:</p>
</div>
<div class="listingblock">
<div class="title">Stub all static methods of a class with default interaction</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
SpyStatic(StaticClass)
StaticClass._ &gt;&gt; _

expect:
StaticClass.staticMethod() == ""
StaticClass.otherStaticMethod() == ""</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The static mocks require a mock maker supporting static methods, e.g. <a href="#mock-makers-mockito">mockito</a>.
See <a href="#mock-makers">mock makers</a> table for mock makers supporting it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_static_mocks_and_threading"><a class="link" href="#_static_mocks_and_threading">Static Mocks and Threading</a></h4>
<div class="paragraph">
<p>The static mocks are thread-local, so they do not interfere with concurrent test execution.
But this also means that a static mock will not be active, if your code under test will use other threads.</p>
</div>
<div class="paragraph">
<p>A static mock is activated on the thread, which created the mock, up until the feature execution ends.
You can activate all static mocks on a different thread by hand:</p>
</div>
<div class="listingblock">
<div class="title">Use static mocks in a different Thread</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
SpyStatic(StaticClass)
StaticClass.staticMethod() &gt;&gt; "MockValue"

when:
def executor = Executors.newSingleThreadExecutor()
def wasCalled = false
def future = executor.submit {
  assert StaticClass.staticMethod() == "RealValue"

  withActiveThreadAwareMocks {
    //Now the static methods of StaticClass are mocked:
    assert StaticClass.staticMethod() == "MockValue"
    wasCalled = true
  }

  assert StaticClass.staticMethod() == "RealValue"
}
future.get()

then:
StaticClass.staticMethod() == "MockValue"
wasCalled

cleanup:
executor.shutdown()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>spock.mock.MockingApi</code> provides methods to activate a static mock on other threads:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>runWithThreadAwareMocks(Runnable)</code></p>
</li>
<li>
<p><code>withActiveThreadAwareMocks(Callable)</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="GroovyMocks"><a class="link" href="#GroovyMocks">Groovy Mocks</a></h3>
<div class="paragraph">
<p>So far, all the mocking features we have seen work the same no matter if the calling code is written in Java or Groovy.
By leveraging Groovy&#8217;s dynamic capabilities, Groovy mocks offer some additional features specifically for testing Groovy code.
They are created with the <code>MockingApi.GroovyMock()</code>, <code>MockingApi.GroovyStub()</code>, and <code>MockingApi.GroovySpy()</code> factory methods.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When Should Groovy Mocks be Favored over Regular Mocks?
Groovy mocks should be used when the code under specification is written in Groovy <em>and</em> some of the unique Groovy
mock features are needed. When called from Java code, Groovy mocks will behave like regular mocks. Note that it
isn&#8217;t necessary to use a Groovy mock merely because the code under specification and/or mocked type is written
in Groovy. Unless you have a concrete reason to use a Groovy mock, prefer a regular mock.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_mocking_dynamic_methods"><a class="link" href="#_mocking_dynamic_methods">Mocking Dynamic Methods</a></h4>
<div class="paragraph">
<p>All Groovy mocks implement the <code>GroovyObject</code> interface. They support the mocking and stubbing of
dynamic methods as if they were physically declared methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = GroovyMock()

1 * subscriber.someDynamicMethod("hello")</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="MockingAllInstancesOfAType"><a class="link" href="#MockingAllInstancesOfAType">Mocking All Instances of a Type</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usually, Groovy mocks need to be injected into the code under specification just like regular mocks.
However, when a Groovy mock is created as <em>global</em>, it automagically replaces all real instances
of the mocked type for the duration from mock creation up until the end of the feature method:<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
def publisher = new Publisher()
def anySubscriber = GroovySpy(global: true, RealSubscriber)
publisher.subscribers.add(new RealSubscriber())
publisher.subscribers.add(new RealSubscriber())

when:
publisher.send("message")

then:
2 * anySubscriber.receive("message")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we set up the publisher with two instances of a real subscriber implementation.
Then we create a global mock of the <em>same</em> type. This reroutes all method calls on the
real subscribers to the mock object. The mock object&#8217;s instance isn&#8217;t ever passed to the publisher;
it is only used to describe the interaction.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A global mock can only be created for a class type. It effectively replaces
all instances of that type for the duration from mock creation up until the end of the feature method.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Using global mocks for standard types from the JDK, for example <code>ArrayList</code>, is a bad idea and can lead to unforeseen and widespread consequences.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The declaration order of global mocks is relevant.
         The <code>GroovySpy(global:true, &lt;type&gt;)</code> must come before all creations of new mocked/spied objects of <code>&lt;type&gt;</code>.
         The global spies will only take effect on objects of that type, if the <code>GroovySpy(global:true, &lt;type&gt;)</code> was
         executed before the <code>new &lt;type&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since global mocks have a somewhat, well, global effect, it&#8217;s often convenient
to use them together with <code>GroovySpy</code>. This leads to the real code getting
executed <em>unless</em> an interaction matches, allowing you to selectively listen
in on objects and change their behavior just where needed.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
When using <code>GroovyMock(global:true)</code> it will also replace constructor calls, which will return <code>null</code> by default.
         If you want working real constructors, please use <code>GroovySpy</code> instead.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">GroovyMock(global) will also replace constructors</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
GroovyMock(global: true, RealSubscriber)
when:
def sub = new RealSubscriber()
then: "The GroovyMock(global: true) will also mock the constructor"
sub == null</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want, that the real constructors are called:</p>
</div>
<div class="listingblock">
<div class="title">GroovyMock(global), but using the real constructors</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">given:
GroovyMock(global: true, RealSubscriber) {
  //Allow that the real constructor is called
  new RealSubscriber(*_) &gt;&gt; { callRealMethod() }
}
when:
def sub = new RealSubscriber()
then:
sub instanceof RealSubscriber</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>Specifications</code> or <code>Features</code> are executed concurrently you have to make sure that the <code>Features</code> which create
global mocks on the same types are properly guarded against each other, because a global mock changes the global state
for the mocked <code>Class</code> during execution.</p>
</div>
<div class="sect4">
<h5 id="global-mocks-parallel-execution"><a class="link" href="#global-mocks-parallel-execution">Global mocks and parallel execution</a></h5>
<div class="paragraph">
<p>Creating a global <code>GroovyMock</code>/<code>GroovyStub</code>/<code>GroovySpy</code> when <a href="#parallel-execution">parallel execution</a> is enabled,
requires that the spec is annotated with <a href="#isolated-execution">@Isolated</a> or <code>@ResourceLock(org.spockframework.runtime.model.parallel.Resources.META_CLASS_REGISTRY)</code>.
If it is only used for a feature, then it suffices that the feature is annotated with <code>@ResourceLock(org.spockframework.runtime.model.parallel.Resources.META_CLASS_REGISTRY)</code>.
The rule of thumb to choose between <code>@ResourceLock</code> and <code>@Isolated</code>, is to look at how widespread the mocked type is used.
If it is widely used, then <code>@Isolated</code> is the safe choice, otherwise <code>@ResourceLock</code> may be sufficient.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How Are Global Groovy Mocks Implemented?</div>
<div class="paragraph">
<p>Global Groovy mocks get their super powers from Groovy meta-programming. To be more precise,
every globally mocked type is assigned a custom <code>MetaClass</code> for the duration of the feature method.
Since a global Groovy mock is still based on a proxy class, it will retain its general mocking capabilities
(but not its super powers) when called from Java code.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="MockingConstructors"><a class="link" href="#MockingConstructors">Mocking Constructors</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Global mocks support mocking of constructors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">RealSubscriber anySubscriber = GroovySpy(global: true)

1 * new RealSubscriber("Fred")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we are using a spy, the object returned from the constructor call remains unchanged.
To change which object gets constructed, we can stub the constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">new RealSubscriber("Fred") &gt;&gt; new RealSubscriber("Barney")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, whenever some code tries to construct a subscriber named Fred, we&#8217;ll construct
a subscriber named Barney instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="global-groovy-mock-static-methods"><a class="link" href="#global-groovy-mock-static-methods">Global Groovy Mocks for Static Methods</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Think twice before using this feature.
It might be better to change the design of the code under specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Global mocks support mocking and stubbing of static methods in Groovy code.
If you want to mock static methods for Java code please use <a href="#static-mocks">Static Mocks</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">RealSubscriber anySubscriber = GroovySpy(global: true)

1 * RealSubscriber.someStaticMethod("hello") &gt;&gt; 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same works for dynamic static methods.</p>
</div>
<div class="paragraph">
<p>When a global mock is used solely for mocking constructors and static methods,
the mock&#8217;s instance isn&#8217;t really needed. In such a case one can just write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">GroovySpy(RealSubscriber, global: true)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Global mocks will only work for Groovy code under test not for Java code.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_features"><a class="link" href="#_advanced_features">Advanced Features</a></h3>
<div class="paragraph">
<p>Most of the time you shouldn&#8217;t need these features. But if you do, you&#8217;ll be glad to have them.</p>
</div>
<div class="sect3">
<h4 id="ALaCarteMocks"><a class="link" href="#ALaCarteMocks">A la Carte Mocks</a></h4>
<div class="paragraph">
<p>At the end of the day, the <code>Mock()</code>, <code>Stub()</code>, and <code>Spy()</code> factory methods are just canned ways to
create mock objects with a certain configuration. If you want more fine-grained control over a mock&#8217;s configuration,
have a look at the <code>org.spockframework.mock.IMockConfiguration</code> interface. All properties of this interface
<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>
can be passed as named arguments to the <code>Mock()</code> method. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = Mock(name: "Fred", type: Person, defaultResponse: ZeroOrNullResponse.INSTANCE, verified: false)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we create a mock whose default return values match those of a <code>Mock()</code>, but whose invocations aren&#8217;t
verified (as for a <code>Stub()</code>). Instead of passing <code>ZeroOrNullResponse</code>, we could have supplied our own custom
<code>org.spockframework.mock.IDefaultResponse</code> for responding to unexpected method invocations.</p>
</div>
</div>
<div class="sect3">
<h4 id="DetectingMockObjects"><a class="link" href="#DetectingMockObjects">Detecting Mock Objects</a></h4>
<div class="paragraph">
<p>To find out whether a particular object is a Spock mock object, use a <code>org.spockframework.mock.MockUtil</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">MockUtil mockUtil = new MockUtil()
List list1 = []
List list2 = Mock()

expect:
!mockUtil.isMock(list1)
mockUtil.isMock(list2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>An util can also be used to get more information about a mock object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">IMockObject mock = mockUtil.asMock(list2)

expect:
mock.name == "list2"
mock.type == List
mock.nature == MockNature.MOCK</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="DetachedMockFactory"><a class="link" href="#DetachedMockFactory">Create Mocks Outside Specifications</a></h4>
<div class="paragraph">
<p>Sometimes, it can be helpful to create and possibly preconfigure mock, stub or spy objects outside specifications, especially if you want to factor out duplicate or similar code from there.
Use <code>DetachedMockFactory</code> to create such mock objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Detached mocks, as the name implies, must be attached to a specification to make them functional.
      This either happens manually by calling <code>MockUtil.attachMock(Object, Specification)</code> or automatically by declaring the mock as an instance field with an <code>@AutoAttach</code> annotation, see <a href="#_autoattach">AutoAttach</a>.
      While auto-attached mocks will also be auto-detached during specification clean-up, you need to take care of manually attached mocks by yourself, calling <code>MockUtil.detachMock(Object)</code> when they are no longer in use.
      Spring and Guice dependency injection will also automatically attach mocks, when the <code>SpringExtension</code> or <code>GuiceExtension</code> is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming that we have an application class <code>Car</code> and each car has an <code>Engine</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Engine {
  private boolean started

  boolean isStarted() { return started }

  void start() { started = true }

  void stop() { started = false }
}

class Car {
  private Engine engine

  void drive() { engine.start() }

  void park() { engine.stop() }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our specification, we declare a detached mock factory and a mock util, either inside a feature method or, if we need them for multiple features, as (preferably) shared or (suboptimally) static instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Shared
def mockFactory = new DetachedMockFactory()

@Shared
def mockUtil = new MockUtil()</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_manually_attach_detach"><a class="link" href="#_manually_attach_detach">Manually attach / detach</a></h5>
<div class="paragraph">
<p>Now in our feature, we create a detached <code>Engine</code> mock, attach the mock to the specification manually, stub its <code>isStarted()</code> method, inject the mock into a <code>Car</code> subject under specification, use the subject and finally detach the mock again after use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "Manually attach detached mock"() {
  given:
  def manuallyAttachedEngine = mockFactory.Mock(Engine)
  mockUtil.attachMock(manuallyAttachedEngine, this)
  manuallyAttachedEngine.isStarted() &gt;&gt; true
  def car = new Car(engine: manuallyAttachedEngine)

  when:
  car.drive()

  then:
  1 * manuallyAttachedEngine.start()
  manuallyAttachedEngine.isStarted()

  when:
  car.park()

  then:
  1 * manuallyAttachedEngine.stop()
  manuallyAttachedEngine.isStarted()

  cleanup:
  mockUtil.detachMock(manuallyAttachedEngine)
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_use_autoattach"><a class="link" href="#_use_autoattach">Use @AutoAttach</a></h5>
<div class="paragraph">
<p>Same situation, different approach:
We let Spock take care of automatically attaching the detached mock when starting the feature method and detaching it again after running the feature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@AutoAttach
def autoAttachedEngine = mockFactory.Mock(Engine)

def "Auto-attach detached mock"() {
  given:
  autoAttachedEngine.isStarted() &gt;&gt; true
  def car = new Car(engine: autoAttachedEngine)

  when:
  car.drive()

  then:
  1 * autoAttachedEngine.start()
  autoAttachedEngine.isStarted()

  when:
  car.park()

  then:
  1 * autoAttachedEngine.stop()
  autoAttachedEngine.isStarted()
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pre_configure_detached_mock_with_default_response"><a class="link" href="#_pre_configure_detached_mock_with_default_response">Pre-configure detached mock with default response</a></h5>
<div class="paragraph">
<p>This advanced use case might only be of interest to a minority of users, you may skip it for now if you just want to learn Spock basics.</p>
</div>
<div class="paragraph">
<p>Usually, you would simply create your detached mock outside of Spock, but then define interactions (stubbed method results, method call verifications) inside the feature method itself.
Sometimes however, you might want to define some (user-overridable) default behaviour right in the detached mock definition itself and even make it somewhat configurable.</p>
</div>
<div class="paragraph">
<p>A valid use case could be a detached mock used in a dependency injection framework like Spring or Guice.
The framework might wire the mock and rely on some default behaviour, before Spock even gets a chance to stub any methods.
Defining default behaviour is possible using a combination of Spock&#8217;s mocking API and custom <code>IDefaultResponse</code> implementations.</p>
</div>
<div class="paragraph">
<p>A custom detached mock creator could look like this (please figure out by yourself what it does and how it works):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class EngineMockCreator {
  enum StartMode {
    ALWAYS_STARTED, ALWAYS_STOPPED, RANDOMLY_STARTED, REAL_RESPONSE
  }

  static DetachedMockFactory mockFactory = new DetachedMockFactory()

  static class EngineStateResponse implements IDefaultResponse {
    StartMode startMode

    @Override
    Object respond(IMockInvocation invocation) {
      if (invocation.method.name != 'isStarted')
        return ZeroOrNullResponse.INSTANCE.respond(invocation)
      startMode == RANDOMLY_STARTED
        ? ThreadLocalRandom.current().nextBoolean()
        : startMode == ALWAYS_STARTED
    }
  }

  static Engine getMock(StartMode startMode) {
    startMode == REAL_RESPONSE
      ? mockFactory.Spy(new Engine())
      : mockFactory.Mock(Engine, defaultResponse: new EngineStateResponse(startMode: startMode)) as Engine
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first parametrized feature uses the mock without attach:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll("Engine state #engineStateResponseType")
def "Mock usage without manually attach detach with preconfigured engine state"() {
  given:
  def car = new Car(engine: preconfiguredEngine)
  // The preconfigured mock with default behaviour behaves as defined,
  // even *without* attaching it to the spec.

  when:
  car.drive()

  then:
  possibleResponsesAfterStart.contains(preconfiguredEngine.isStarted())

  when:
  car.park()

  then:
  possibleResponsesAfterStop.contains(preconfiguredEngine.isStarted())

  where:
  engineStateResponseType | possibleResponsesAfterStart | possibleResponsesAfterStop
  ALWAYS_STARTED          | [true]                      | [true]
  ALWAYS_STOPPED          | [false]                     | [false]
  RANDOMLY_STARTED        | [true, false]               | [true, false]
  REAL_RESPONSE           | [true]                      | [false]
  preconfiguredEngine = EngineMockCreator.getMock(engineStateResponseType)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next parametrized feature method showcasing a set of usage scenarios when a detached mock
is attached to a spec before usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll("Engine state #engineStateResponseType")
def "Manually attach detached mock with preconfigured engine state"() {
  given:
  def car = new Car(engine: preconfiguredEngine)
  //Now, let's attach the mock to the spec and override its default behaviour.
  mockUtil.attachMock(preconfiguredEngine, this)
  preconfiguredEngine.isStarted() &gt;&gt; true

  expect:
  preconfiguredEngine.isStarted()
  // The attached mock now behaves differently. Because it has been attached to the
  // spec, we can also verify interactions using '1 * ...' or similar, which
  // would not be possible without attaching it.

  when:
  car.drive()

  then:
  1 * preconfiguredEngine.start()
  preconfiguredEngine.isStarted()

  when:
  car.park()

  then:
  1 * preconfiguredEngine.stop()
  preconfiguredEngine.isStarted()

  cleanup:
  mockUtil.detachMock(preconfiguredEngine)

  where:
  engineStateResponseType | possibleResponsesAfterStart | possibleResponsesAfterStop
  ALWAYS_STARTED          | [true]                      | [true]
  ALWAYS_STOPPED          | [false]                     | [false]
  RANDOMLY_STARTED        | [true, false]               | [true, false]
  REAL_RESPONSE           | [true]                      | [false]
  preconfiguredEngine = EngineMockCreator.getMock(engineStateResponseType)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_further_reading"><a class="link" href="#_further_reading">Further Reading</a></h3>
<div class="paragraph">
<p>If you would like to dive deeper into interaction-based testing, we recommend the following resources:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://www.ccs.neu.edu/research/demeter/related-work/extreme-programming/MockObjectsFinal.PDF">Endo-Testing: Unit Testing with Mock Objects</a></dt>
<dd>
<p>Paper from the XP2000 conference that introduces the concept of mock objects.</p>
</dd>
<dt class="hdlist1"><a href="https://www.jmock.org/oopsla2004.pdf">Mock Roles, not Objects</a></dt>
<dd>
<p>Paper from the OOPSLA2004 conference that explains how to do mocking <em>right</em>.</p>
</dd>
<dt class="hdlist1"><a href="https://martinfowler.com/articles/mocksArentStubs.html">Mocks Aren&#8217;t Stubs</a></dt>
<dd>
<p>Martin Fowler&#8217;s take on mocking.</p>
</dd>
<dt class="hdlist1"><a href="https://www.growing-object-oriented-software.com">Growing Object-Oriented Software Guided by Tests</a></dt>
<dd>
<p>TDD pioneers Steve Freeman and Nat Pryce explain in detail how test-driven development and mocking work in the real world.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extensions"><a class="link" href="#extensions">Extensions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spock comes with a powerful extension mechanism, which allows to hook into a spec&#8217;s lifecycle to enrich or alter its
behavior. In this chapter, we will first learn about Spock&#8217;s built-in extensions, and then dive into writing custom
extensions.</p>
</div>
<div class="sect2">
<h3 id="spock-configuration-file"><a class="link" href="#spock-configuration-file">Spock Configuration File</a></h3>
<div class="paragraph">
<p>Some extensions can be configured with options in a Spock configuration file. The description for each extension will
mention how it can be configured. All those configurations are in a Groovy file that usually is called
<code>SpockConfig.groovy</code>. Spock first searches for a custom location given in a system property called <code>spock.configuration</code>
which is then used either as classpath location or if not found as file system location if it can be found there,
otherwise the default locations are investigated for a configuration file. Next it searches for the <code>SpockConfig.groovy</code>
in the root of the test execution classpath. If there is also no such file, you can at last have a <code>SpockConfig.groovy</code>
in your Spock user home. This by default is the directory <code>.spock</code> within your home directory, but can be changed using
the system property <code>spock.user.home</code> or if not set the environment property <code>SPOCK_USER_HOME</code>.</p>
</div>
<div class="sect3">
<h4 id="_stack_trace_filtering"><a class="link" href="#_stack_trace_filtering">Stack Trace Filtering</a></h4>
<div class="paragraph">
<p>You can configure Spock whether it should filter stack traces or not by using the configuration file. The default value
is <code>true</code>.</p>
</div>
<div class="listingblock">
<div class="title">Stack Trace Filtering Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">runner {
  filterStackTrace false
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_parallel_execution_configuration"><a class="link" href="#_parallel_execution_configuration">Parallel Execution Configuration</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">runner {
  parallel {
    //...
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="#parallel-execution">Parallel Execution</a> section for a detailed description.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_built_in_extensions"><a class="link" href="#_built_in_extensions">Built-In Extensions</a></h3>
<div class="paragraph">
<p>Most of Spock&#8217;s built-in extensions are <em>annotation-driven</em>. In other words, they are triggered by annotating a
spec class or method with a certain annotation. You can tell such an annotation by its <code>@ExtensionAnnotation</code>
meta-annotation.</p>
</div>
<div class="sect3">
<h4 id="_ignore"><a class="link" href="#_ignore">Ignore</a></h4>
<div class="paragraph">
<p>To temporarily prevent a feature method from getting executed, annotate it with <code>spock.lang.Ignore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Ignore
def "my feature"() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For documentation purposes, a reason can be provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Ignore("TODO")
def "my feature"() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To ignore a whole specification, annotate its class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Ignore
class MySpec extends Specification { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In most execution environments, ignored feature methods and specs will be reported as "skipped".</p>
</div>
<div class="paragraph">
<p>By default, <code>@Ignore</code> will only affect the annotated specification, by setting <code>inherited</code> to <code>true</code> you can configure it to apply to sub-specifications as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Ignore(inherited = true)
class MySpec extends Specification { ... }
class MySubSpec extends MySpec { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Care should be taken when ignoring feature methods in a spec class annotated with <code>spock.lang.Stepwise</code> since
later feature methods may depend on earlier feature methods having executed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ignorerest"><a class="link" href="#_ignorerest">IgnoreRest</a></h4>
<div class="paragraph">
<p>To ignore all but a (typically) small subset of methods, annotate the latter with <code>spock.lang.IgnoreRest</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "I'll be ignored"() { ... }

@IgnoreRest
def "I'll run"() { ... }

def "I'll also be ignored"() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@IgnoreRest</code> is especially handy in execution environments that don&#8217;t provide an (easy) way to run a subset of methods.</p>
</div>
<div class="paragraph">
<p>Care should be taken when ignoring feature methods in a spec class annotated with <code>spock.lang.Stepwise</code> since
later feature methods may depend on earlier feature methods having executed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ignoreif"><a class="link" href="#_ignoreif">IgnoreIf</a></h4>
<div class="paragraph">
<p>To ignore a feature method or specification under certain conditions, annotate it with <code>spock.lang.IgnoreIf</code>,
followed by a predicate and an optional reason:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf({ System.getProperty("os.name").toLowerCase().contains("windows") })
def "I'll run everywhere but on Windows"() {</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="precondition-context"><a class="link" href="#precondition-context">Precondition Context</a></h5>
<div class="paragraph">
<p>To make predicates easier to read and write, the following properties are available inside the closure:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>sys</code></dt>
<dd>
<p>A map of all system properties</p>
</dd>
<dt class="hdlist1"><code>env</code></dt>
<dd>
<p>A map of all environment variables</p>
</dd>
<dt class="hdlist1"><code>os</code></dt>
<dd>
<p>Information about the operating system (see <code>spock.util.environment.OperatingSystem</code>)</p>
</dd>
<dt class="hdlist1"><code>jvm</code></dt>
<dd>
<p>Information about the JVM (see <code>spock.util.environment.Jvm</code>)</p>
</dd>
<dt class="hdlist1"><code>shared</code></dt>
<dd>
<p>The shared specification instance, only shared fields will have been initialized.
If this property is used, then the whole annotated element cannot be skipped up-front without initializing the shared instance.</p>
</dd>
<dt class="hdlist1"><code>instance</code></dt>
<dd>
<p>The specification instance, if instance fields, shared fields, or instance methods are needed.
If this property is used, the whole annotated element cannot be skipped up-front without executing fixtures,
data providers and similar. Instead, the whole workflow is followed up to the feature method invocation,
where then the closure is checked, and it is decided whether to abort the specific iteration or not.</p>
</dd>
<dt class="hdlist1"><code>data</code></dt>
<dd>
<p>A map of all the data variables for the current iteration.
Similar to <code>instance</code> this will run the whole workflow and only skip individual iterations.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Using the <code>os</code> property, the previous example can be rewritten as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf({ os.windows })
def "I will run everywhere but on Windows"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also give an optional <code>reason</code> why the given feature or specification is to be ignored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf(value = { os.macOs }, reason = "No platform driver available")
def "For the given reason, I will not run on MacOS"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, <code>@IgnoreIf</code> will only affect the annotated specification, by setting <code>inherited</code> to <code>true</code> you can configure it to apply to sub-specifications as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf(value = { jvm.java8Compatible }, inherited = true)
abstract class Foo extends Specification {
}

class Bar extends Foo {
  def "I won't run on Java 8 and above"() {
    expect: true
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If multiple <code>@IgnoreIf</code> annotations are present, they are effectively combined with a logical "or".
The annotated element is skipped if any of the conditions evaluates to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf({ os.windows })
@IgnoreIf({ jvm.java8 })
def "I'll run everywhere but on Windows or anywhere on Java 8"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Care should be taken when ignoring feature methods in a spec class annotated with <code>spock.lang.Stepwise</code> since
later feature methods may depend on earlier feature methods having executed.</p>
</div>
<div class="paragraph">
<p>To use IDE support like code completion, you can also use the argument to the closure and have it typed as
<code>org.spockframework.runtime.extension.builtin.PreconditionContext</code>. This enables the IDE with type information
which is not available otherwise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf({ PreconditionContext it -&gt; it.os.windows })
def "I will run everywhere but not on Windows"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>data.*</code> to filter out iterations is especially helpful when using <code>.combinations()</code> to generate iterations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf({ os.windows })
@IgnoreIf({ data.a == 5 &amp;&amp; data.b &gt;= 6 })
def "I'll run everywhere but on Windows and only if a != 5 and b &lt; 6"(int a, int b) {
  // ...
  where:
  [a, b] &lt;&lt; [(1..10), (1..8)].combinations()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also note that the condition is split into separate <code>@IgnoreIf</code> annotations so that they can be evaluated independently.
It is good practice ordering them based on their specificity, so that the least specific one is evaluated first, that is from static to shared to instance.
If you need to combine the conditions in a single <code>@IgnoreIf</code> annotation, you should order them from least specific to most specific inside as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_requires"><a class="link" href="#_requires">Requires</a></h4>
<div class="paragraph">
<p>To execute a feature method under certain conditions, annotate it with <code>spock.lang.Requires</code>,
followed by a predicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Requires({ os.windows })
def "I'll only run on Windows"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Requires</code> works exactly like <code>IgnoreIf</code>, except that the predicate is inverted. In general, it is preferable
to state the conditions under which a method gets executed, rather than the conditions under which it gets ignored.</p>
</div>
<div class="paragraph">
<p>If multiple <code>@Requires</code> annotations are present, they are effectively combined with a logical "and".
The annotated element is skipped if any of the conditions evaluates to <code>false</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Requires({ os.windows })
@Requires({ jvm.java8 })
def "I'll run only on Windows with Java 8"() {</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pendingfeature"><a class="link" href="#_pendingfeature">PendingFeature</a></h4>
<div class="paragraph">
<p>To indicate that the feature is not fully implemented yet and should not be reported as error, annotate it with <code>spock.lang.PendingFeature</code>.</p>
</div>
<div class="paragraph">
<p>The use case is to annotate tests that can not yet run but should already be committed.
The main difference to <code>Ignore</code> is that the test are executed, but test failures are ignored.
If the test passes without an error, then it will be reported as failure since the <code>PendingFeature</code> annotation should be removed.
This way the tests will become part of the normal tests instead of being ignored forever.</p>
</div>
<div class="paragraph">
<p>Groovy has the <code>groovy.transform.NotYetImplemented</code> annotation which is similar but behaves a differently.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it will mark failing tests as passed</p>
</li>
<li>
<p>if at least one iteration of a data-driven test passes it will be reported as error</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>PendingFeature</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it will mark failing tests as skipped</p>
</li>
<li>
<p>if at least one iteration of a data-driven test fails it will be reported as skipped</p>
</li>
<li>
<p>if every iteration of a data-driven test passes it will be reported as error</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@PendingFeature
def "not implemented yet"() { ... }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pendingfeatureif"><a class="link" href="#_pendingfeatureif">PendingFeatureIf</a></h4>
<div class="paragraph">
<p>To conditionally indicate that a feature is not fully implemented, and should not be reported as an error you can annotate
it as <code>spock.lang.PendingFeatureIf</code> and include a precondition similar to <code>IgnoreIf</code> or <code>Requires</code></p>
</div>
<div class="paragraph">
<p>If the conditional expression <em>passes</em> it behaves the same way as <code>PendingFeature</code>, otherwise it does nothing.</p>
</div>
<div class="paragraph">
<p>For instance, annotating a feature as <code>@PendingFeatureIf({ false })</code> effectively does nothing, but annotating it as
<code>@PendingFeatureIf({ true })</code> behaves the same was as if it was marked as <code>@PendingFeature</code></p>
</div>
<div class="paragraph">
<p>If applied to a data driven feature, the closure can also access the data variables.
If the closure does not reference any actual data variables, the whole feature is deemed pending
and only if all iterations become successful will be marked as failing. But if the closure actually
does reference valid data variables, the individual iterations where the condition holds are
deemed pending and each will individually fail as soon as it would be successful without this annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@PendingFeatureIf({ os.windows })
def "I'm not yet implemented on windows, but I am on other operating systems"() {

@PendingFeatureIf({ sys.targetEnvironment == "prod" })
def "This feature isn't deployed out to production yet, and isn't expected to pass"() {</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also supported to have multiple <code>@PendingFeatureIf</code> annotations or a mixture of <code>@PendingFeatureIf</code> and
<code>@PendingFeature</code>, for example to ignore certain exceptions only under certain conditions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@PendingFeature(exceptions = UnsupportedOperationException)
@PendingFeatureIf(
  exceptions = IllegalArgumentException,
  value = { os.windows },
  reason = 'Does not yet work on Windows')
@PendingFeatureIf(
  exceptions = IllegalAccessException,
  value = { jvm.java8 },
  reason = 'Does not yet work on Java 8')
def "I have various problems in certain situations"() {</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_stepwise"><a class="link" href="#_stepwise">Stepwise</a></h4>
<div class="paragraph">
<p>To execute features in the order that they are declared, annotate a spec class with <code>spock.lang.Stepwise</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Stepwise
class RunInOrderSpec extends Specification {
  def "I run first"()  { expect: true }
  def "I run second"() { expect: false }
  def "I will be skipped"() { expect: true }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Stepwise</code> only affects the class carrying the annotation; not sub or super classes.  Features after the first
failure are skipped.</p>
</div>
<div class="paragraph">
<p><code>Stepwise</code> does not override the behaviour of annotations such as <code>Ignore</code>, <code>IgnoreRest</code>, and <code>IgnoreIf</code>, so care
should be taken when ignoring feature methods in spec classes annotated with <code>Stepwise</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will also set the execution mode to <code>SAME_THREAD</code>, see <a href="#parallel-execution">Parallel Execution</a> for more information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since Spock 2.2, <code>Stepwise</code> can be applied to data-driven feature methods, having the effect of executing them sequentially (even if concurrent test mode is active) and to skip subsequent iterations if one iteration fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class SkipAfterFailingIterationSpec extends Specification {
  @Stepwise
  def "iteration #count"()  {
    expect:
    count != 3

    where:
    count &lt;&lt; (1..5)
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will pass for the first two iterations, fail on the third and skip the remaining two. Without <code>Stepwise</code> on feature method level, the third iteration would fail and the remaining 4 iterations would pass.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For backward compatibility with Spock versions prior to 2.2, applying the annotation on spec level will <em>not</em> automatically skip subsequent feature method iterations upon failure in a previous iteration. If you want that in addition to (or instead of) step-wise spec mode, you do have to annotate each individual feature method you wish to have that capability. This also conforms to the principle that if you want to skip tests under whatever conditions, you ought to document your intent explicitly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="timeout-extension"><a class="link" href="#timeout-extension">Timeout</a></h4>
<div class="paragraph">
<p>To fail a feature method, fixture, or class that exceeds a given execution duration, use <code>spock.lang.Timeout</code>,
followed by a duration, and optionally a time unit. The default time unit is seconds.</p>
</div>
<div class="paragraph">
<p>When applied to a feature method, the timeout is per execution of one iteration, excluding time spent in fixture methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Timeout(5)
def "I fail if I run for more than five seconds"() { ... }

@Timeout(value = 100, unit = TimeUnit.MILLISECONDS)
def "I better be quick" { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applying <code>@Timeout</code> to a spec class has the same effect as applying it to each feature and fixture method that is not already annotated with <code>@Timeout</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Timeout(10)
class TimedSpec extends Specification {
  def "I fail after ten seconds"() { ... }
  def "Me too"() { ... }

  @Timeout(value = 250, unit = MILLISECONDS)
  def "I fail much faster"() { ... }

  def setup() { /* I have 10 seconds */}

  @Timeout(value = 25, unit = SECONDS)
  def cleanup() { /* I have 25 seconds */ }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When applied to a fixture method, the timeout is per execution of the fixture method.</p>
</div>
<div class="paragraph">
<p>When a timeout is reported to the user, the stack trace shown reflects the execution stack of the test framework when
the timeout was exceeded. Additionally, thread dumps can be captured and logged on unsuccessful interrupt attempts if configured using the <a href="#spock-configuration-file">Spock Configuration File</a>.</p>
</div>
<div class="listingblock">
<div class="title">Timeout Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">timeout {
  // java.time.Duration, default null: If set applies global timeout for all features, unless overridden
  globalTimeout java.time.Duration.ofMinutes(1);
  // boolean, default false: Determines whether the global timeout will be applied to fixtures
  applyGlobalTimeoutToFixtures false
  // boolean, default false
  printThreadDumpsOnInterruptAttempts true
  // integer, default 3
  maxInterruptAttemptsWithThreadDumps 1
  // org.spockframework.runtime.extension.builtin.ThreadDumpUtilityType, default JCMD
  threadDumpUtilityType ThreadDumpUtilityType.JSTACK
  // list of java.lang.Runnable, default []
  interruptAttemptListeners.add({ println('Unsuccessful interrupt occurred!') })
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since Spock 2.4, you can also configure a global timeout via the configuration file.
This will apply to all features that are not already annotated with <code>@Timeout</code>.
Setting the global to non-null will have the same effect as applying <code>@Timeout</code> it to all features.
With the flag <code>applyGlobalTimeoutToFixtures</code> you can control if the global timeout should also be applied to fixture methods.</p>
</div>
</div>
<div class="sect3">
<h4 id="_retry"><a class="link" href="#_retry">Retry</a></h4>
<div class="paragraph">
<p>The <code>@Retry</code> extensions can be used for flaky integration tests, where remote systems can fail sometimes.
By default it retries an iteration <code>3</code> times with <code>0</code> delay if either an <code>Exception</code> or <code>AssertionError</code> has been thrown, all this is configurable.
In addition, an optional <code>condition</code> closure can be used to determine if a feature should be retried.
It also provides special support for data driven features, offering to either retry all iterations or just the failing ones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class FlakyIntegrationSpec extends Specification {
  @Retry
  def retry3Times() { ... }

  @Retry(count = 5)
  def retry5Times() { ... }

  @Retry(exceptions=[IOException])
  def onlyRetryIOException() { ... }

  @Retry(condition = { failure.message.contains('foo') })
  def onlyRetryIfConditionOnFailureHolds() { ... }

  @Retry(condition = { instance.field != null })
  def onlyRetryIfConditionOnInstanceHolds() { ... }

  @Retry
  def retryFailingIterations() {
    ...
    where:
    data &lt;&lt; sql.select()
  }

  @Retry(mode = Retry.Mode.FEATURE)
  def retryWholeFeature() {
    ...
    where:
    data &lt;&lt; sql.select()
  }

  @Retry(delay = 1000)
  def retryAfter1000MsDelay() { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Retries can also be applied to spec classes which has the same effect as applying it to each feature method that isn&#8217;t
already annotated with {@code Retry}.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Retry
class FlakyIntegrationSpec extends Specification {
  def "will be retried with config from class"() {
    ...
  }
  @Retry(count = 5)
  def "will be retried using its own config"() {
    ...
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A {@code @Retry} annotation that is declared on a spec class is applied to all features in all subclasses as well,
unless a subclass declares its own annotation. If so, the retries defined in the subclass are applied to all feature
methods declared in the subclass as well as inherited ones.</p>
</div>
<div class="paragraph">
<p>Given the following example, running <code>FooIntegrationSpec</code> will execute both <code>inherited</code> and <code>foo</code> with one retry.
Running <code>BarIntegrationSpec</code> will execute <code>inherited</code> and <code>bar</code> with two retries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Retry(count = 1)
abstract class AbstractIntegrationSpec extends Specification {
  def inherited() {
    ...
  }
}

class FooIntegrationSpec extends AbstractIntegrationSpec {
  def foo() {
    ...
  }
}

@Retry(count = 2)
class BarIntegrationSpec extends AbstractIntegrationSpec {
  def bar() {
    ...
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check <a href="https://github.com/spockframework/spock/blob/master/spock-specs/src/test/groovy/org/spockframework/smoke/extension/RetryFeatureExtensionSpec.groovy">RetryFeatureExtensionSpec</a> for more examples.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use"><a class="link" href="#_use">Use</a></h4>
<div class="paragraph">
<p>To activate one or more Groovy categories within the scope of a feature method or spec, use <code>spock.util.mop.Use</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class ListExtensions {
  static avg(List list) { list.sum() / list.size() }
}

class UseDocSpec extends Specification {
  @Use(ListExtensions)
  def "can use avg() method"() {
    expect:
    [1, 2, 3].avg() == 2
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful for stubbing of dynamic methods, which are usually provided by the runtime environment (e.g. Grails).
It has no effect when applied to a helper method. However, when applied to a spec class, it will also affect its helper
methods.</p>
</div>
<div class="paragraph">
<p>To use multiple categories, you can either give multiple categories to the <code>value</code> attribute
of the annotation or you can apply the annotation multiple times to the same target.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will also set the execution mode to <code>SAME_THREAD</code> if applied on a <code>Specification</code>, see <a href="#parallel-execution">Parallel Execution</a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_confinemetaclasschanges"><a class="link" href="#_confinemetaclasschanges">ConfineMetaClassChanges</a></h4>
<div class="paragraph">
<p>To confine meta class changes to the scope of a feature method or spec class, use <code>spock.util.mop.ConfineMetaClassChanges</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Stepwise
class ConfineMetaClassChangesDocSpec extends Specification {
  @ConfineMetaClassChanges(String)
  def "I run first"() {
    when:
    String.metaClass.someMethod = { delegate }

    then:
    String.metaClass.hasMetaMethod('someMethod')
  }

  def "I run second"() {
    when:
    "Foo".someMethod()

    then:
    thrown(MissingMethodException)
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When applied to a spec class, the meta classes are restored to the state that they were in before <code>setupSpec</code> was executed,
after <code>cleanupSpec</code> is executed.</p>
</div>
<div class="paragraph">
<p>When applied to a feature method, the meta classes are restored to as they were after <code>setup</code> was executed,
before <code>cleanup</code> is executed.</p>
</div>
<div class="paragraph">
<p>To confine meta class changes for multiple classes, you can either give multiple classes to the <code>value</code> attribute
of the annotation or you can apply the annotation multiple times to the same target.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Temporarily changing the meta classes is only safe when specs are
run in a single thread per JVM. Even though many execution environments do limit themselves to one thread
per JVM, keep in mind that Spock cannot enforce this.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will acquire a <code>READ_WRITE</code> lock for <code>Resources.META_CLASS_REGISTRY</code>, see <a href="#parallel-execution">Parallel Execution</a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_restoresystemproperties"><a class="link" href="#_restoresystemproperties">RestoreSystemProperties</a></h4>
<div class="paragraph">
<p>Saves system properties before the annotated feature method (including any setup and cleanup methods) gets run,
and restores them afterwards.</p>
</div>
<div class="paragraph">
<p>Applying this annotation to a spec class has the same effect as applying it to all its feature methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@RestoreSystemProperties
def "determines family based on os.name system property"() {
  given:
  System.setProperty('os.name', 'Windows 7')

  expect:
  OperatingSystem.current.family == OperatingSystem.Family.WINDOWS
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Temporarily changing the values of system properties is only safe when specs are
run in a single thread per JVM. Even though many execution environments do limit themselves to one thread
per JVM, keep in mind that Spock cannot enforce this.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will acquire a <code>READ_WRITE</code> lock for <code>Resources.SYSTEM_PROPERTIES</code>, see <a href="#parallel-execution">Parallel Execution</a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_autoattach"><a class="link" href="#_autoattach">AutoAttach</a></h4>
<div class="paragraph">
<p>Automatically attaches a detached mock to the current specification.
<code>@AutoAttach</code> can only be used regular instance fields, not on shared or static ones.
Use this, if there is no direct framework support available.
To create detached mocks, see <a href="#DetachedMockFactory">Create Mocks Outside Specifications</a></p>
</div>
<div class="paragraph">
<p>Spring and Guice dependency injection is automatically handled by the
<a href="#spring-module">Spring Module</a> and <a href="#_guice_module">Guice Module</a>, respectively.</p>
</div>
</div>
<div class="sect3">
<h4 id="_autocleanup"><a class="link" href="#_autocleanup">AutoCleanup</a></h4>
<div class="paragraph">
<p>Automatically clean up a field or property at the end of its lifetime by using <code>spock.lang.AutoCleanup</code>.</p>
</div>
<div class="paragraph">
<p>By default, an object is cleaned up by invoking its parameterless <code>close()</code> method. If some other
method should be called instead, override the annotation&#8217;s <code>value</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">// invoke foo.dispose()
@AutoCleanup("dispose")
def foo</code></pre>
</div>
</div>
<div class="paragraph">
<p>If multiple fields or properties are annotated with <code>AutoCleanup</code>, their objects are cleaned up sequentially, in reverse
field/property declaration order, starting from the most derived class class and walking up the inheritance chain.</p>
</div>
<div class="paragraph">
<p>If a cleanup operation fails with an exception, the exception is reported by default, and cleanup proceeds with the next
annotated object. To prevent cleanup exceptions from being reported, override the annotation&#8217;s <code>quiet</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@AutoCleanup(quiet = true)
def ignoreMyExceptions</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="temp-dir"><a class="link" href="#temp-dir">TempDir</a></h4>
<div class="paragraph">
<p>In order to generate a temporary directory for test and delete it after test, annotate a member field of type
<code>java.io.File</code>, <code>java.nio.file.Path</code> or untyped using <code>def</code> in a spec class (<code>def</code> will inject a <code>Path</code>).
Alternatively, you can annotate a field with a custom type that has a public constructor accepting either <code>java.io.File</code> or <code>java.nio.file.Path</code> as its single parameter (see <a href="#file-stystem-fixture">FileSystemFixture</a> for an example).
If the annotated field is <code>@Shared</code>, the temporary directory will be shared in the corresponding specification, otherwise every feature method and every iteration per parametrized feature method will have their own temporary directories.</p>
</div>
<div class="paragraph">
<p>Since Spock 2.4, you can also use parameter injection with <code>@TempDir</code>.
The types follow the same rules as for field injection.
Valid methods are <code>setup()</code>, <code>setupSpec()</code>, or any feature methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">// all features will share the same temp directory path1
@TempDir
@Shared
Path path1

// all features and iterations will have their own path2
@TempDir
File path2

// will be injected using java.nio.file.Path
@TempDir
def path3

// use a custom class that accepts java.nio.file.Path as sole constructor parameter
@TempDir
FileSystemFixture path4

// Use for parameter injection of a setupSpec method
def setupSpec(@TempDir Path sharedPath) {
  assert sharedPath instanceof Path
}

// Use for parameter injection of a setup method
def setup(@TempDir Path setupPath) {
  assert setupPath instanceof Path
}

// Use for parameter injection of a feature
def demo(@TempDir Path path5) {
  expect:
  path1 instanceof Path
  path2 instanceof File
  path3 instanceof Path
  path4 instanceof FileSystemFixture
  path5 instanceof Path
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="temp-dir-cleanup"><a class="link" href="#temp-dir-cleanup">Cleanup</a></h5>
<div class="paragraph">
<p>You can configure the cleanup behavior via <code>@TempDir(cleanup = &lt;mode&gt;)</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEFAULT</code> will use the global value</p>
</li>
<li>
<p><code>ALWAYS</code> Spock will delete temporary directories after tests</p>
</li>
<li>
<p><code>NEVER</code> Spock will not delete temporary directories after tests.</p>
</li>
<li>
<p><code>ON_SUCCESS</code> Spock will not delete temporary directories if a test failed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The global value for <code>DEFAULT</code> is taken from system property <code>spock.tempdir.cleanup</code>, or the configuration file.
If nothing is configured, it will default to <code>ALWAYS</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_2"><a class="link" href="#_configuration_2">Configuration</a></h5>
<div class="paragraph">
<p>If you want to customize the parent directory for temporary directories, you can use the <a href="#spock-configuration-file">Spock Configuration File</a>.</p>
</div>
<div class="listingblock">
<div class="title">Temporary Directory Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">tempdir {
  // java.nio.Path object, default null,
  // which means system property "java.io.tmpdir"
  baseDir Paths.get("/tmp")
  // boolean, default is system property "spock.tempDir.keep"
  keep true
  // spock.lang.TempDir.CleanupMode, default ALWAYS
  // allows to set the default cleanup mode to use
  cleanup spock.lang.TempDir.CleanupMode.ON_SUCCESS
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="title-and-narrative-extension"><a class="link" href="#title-and-narrative-extension">Title and Narrative</a></h4>
<div class="paragraph">
<p>To attach a natural-language name to a spec, use <code>spock.lang.Title</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Title("This is easy to read")
class ThisIsHarderToReadSpec extends Specification {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, to attach a natural-language description to a spec, use <code>spock.lang.Narrative</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Narrative("""
As a user
I want foo
So that bar
""")
class GiveTheUserFooSpec() { ... }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_see"><a class="link" href="#_see">See</a></h4>
<div class="paragraph">
<p>To link to one or more references to external information related to a specification or feature, use <code>spock.lang.See</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@See("https://spockframework.org/spec")
class SeeDocSpec extends Specification {
  @See(["https://en.wikipedia.org/wiki/Levenshtein_distance", "https://www.levenshtein.net/"])
  def "Even more information is available on the feature"() {
    expect: true
  }

  @See("https://www.levenshtein.de/")
  @See(["https://en.wikipedia.org/wiki/Levenshtein_distance", "https://www.levenshtein.net/"])
  def "And even more information is available on the feature"() {
    expect: true
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_issue"><a class="link" href="#_issue">Issue</a></h4>
<div class="paragraph">
<p>To indicate that a feature or spec relates to one or more issues in an external tracking system, use <code>spock.lang.Issue</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Issue("https://my.issues.org/FOO-1")
class IssueDocSpec extends Specification {
  @Issue("https://my.issues.org/FOO-2")
  def "Foo should do bar"() {
    expect: true
  }

  @Issue(["https://my.issues.org/FOO-3", "https://my.issues.org/FOO-4"])
  def "I have two related issues"() {
    expect: true
  }

  @Issue(["https://my.issues.org/FOO-5", "https://my.issues.org/FOO-6"])
  @Issue("https://my.issues.org/FOO-7")
  def "I have three related issues"() {
    expect: true
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a common prefix URL for all issues in a project, you can use the <a href="#spock-configuration-file">Spock Configuration File</a> to set it up
for all at once. If it is set, it is prepended to the value of the <code>@Issue</code> annotation when building the URL.</p>
</div>
<div class="paragraph">
<p>If the <code>issueNamePrefix</code> is set, it is prepended to the value of the <code>@Issue</code> annotation when building the name for the
issue.</p>
</div>
<div class="listingblock">
<div class="title">Issue Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">report {
    issueNamePrefix 'Bug '
    issueUrlPrefix 'https://my.issues.org/'
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_subject"><a class="link" href="#_subject">Subject</a></h4>
<div class="paragraph">
<p>To indicate one or more subjects of a spec, use <code>spock.lang.Subject</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Subject([Foo, Bar])
class SubjectDocSpec extends Specification {</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use multiple <code>@Subject</code> annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Subject(Foo)
@Subject(Bar)
class SubjectDocSpec extends Specification {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, <code>Subject</code> can be applied to fields and local variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Subject
Foo myFoo</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Subject</code> currently has only informational purposes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rule"><a class="link" href="#_rule">Rule</a></h4>
<div class="paragraph">
<p>Spock understands <code>@org.junit.Rule</code> annotations on non-<code>@Shared</code> instance fields when the <a href="#junit-4">JUnit 4 module</a> is included. The according rules are run at the
iteration interception point in the Spock lifecycle. This means that the rules before-actions are done before the
execution of <code>setup</code> methods and the after-actions are done after the execution of <code>cleanup</code> methods.</p>
</div>
</div>
<div class="sect3">
<h4 id="_classrule"><a class="link" href="#_classrule">ClassRule</a></h4>
<div class="paragraph">
<p>Spock understands <code>@org.junit.ClassRule</code> annotations on <code>@Shared</code> fields when the <a href="#junit-4">JUnit 4 module</a> is included. The according rules are run at the
specification interception point in the Spock lifecycle. This means that the rules before-actions are done before the
execution of <code>setupSpec</code> methods and the after-actions are done after the execution of <code>cleanupSpec</code> methods.</p>
</div>
</div>
<div class="sect3">
<h4 id="_include_and_exclude"><a class="link" href="#_include_and_exclude">Include and Exclude</a></h4>
<div class="paragraph">
<p>Spock is capable of including and excluding specifications according to their classes, super-classes and interfaces and
according to annotations that are applied to the specification.Spock is also capable of including and excluding
individual features according to annotations that are applied to the feature method.The configuration for what to
include or exclude is done according to the <a href="#spock-configuration-file">Spock Configuration File</a> section.</p>
</div>
<div class="listingblock">
<div class="title">Include / Exclude Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import some.pkg.Fast
import some.pkg.IntegrationSpec

runner {
  include Fast // could be either an annotation or a (base) class
  exclude {
    annotation some.pkg.Slow
    baseClass IntegrationSpec
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="test-tag-extension"><a class="link" href="#test-tag-extension">Tags</a></h4>
<div class="paragraph">
<p>Since version 2.2 Spock supports <a href="https://junit.org/junit5/docs/current/user-guide/#running-tests-tags">JUnit Platform tags</a>.
See the platform documentation for more information regarding valid tag values and how to configure your test execution to use them.</p>
</div>
<div class="paragraph">
<p>The <code>@Tag</code> annotation can be used to tag a spec or feature with one or more tags.
If applied on a spec, the tags are applied to all features in the spec.
Tags are inherited from parent specs.
If applied on a feature, the tags are applied to the feature.</p>
</div>
<div class="listingblock">
<div class="title">Tag Extension</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Tag("docs")
class TagDocSpec extends Specification {
  def "has one tag"() {
    expect: true
  }

  @Tag("other")
  def "has two tags"() {
    expect: true
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JUnit Jupiter also has a <code>@Tag</code> annotation, but it will have no effect when used on a <code>Specification</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_repeat_until_failure"><a class="link" href="#_repeat_until_failure">Repeat until failure</a></h4>
<div class="paragraph">
<p>Since version 2.3 the <code>@RepeatUntilFailure</code> annotation can be used to repeat a single feature until it fails or until it reaches the <code>maxAttempts</code> value.
This is intended to aid in manual debugging of flaky tests and should not be committed to source control.</p>
</div>
</div>
<div class="sect3">
<h4 id="_optimize_run_order"><a class="link" href="#_optimize_run_order">Optimize Run Order</a></h4>
<div class="paragraph">
<p>Spock can remember which features last failed and how often successively and also how long a feature needed to be
tested. For successive runs Spock will then first run features that failed at last run and first features that failed
more often successively. Within the previously failed or non-failed features Spock will run the fastest tests first.
This behaviour can be enabled according to the <a href="#spock-configuration-file">Spock Configuration File</a> section. The default value is <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="title">Optimize Run Order Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">runner {
  optimizeRunOrder true
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="snapshot-testing"><a class="link" href="#snapshot-testing">Snapshot testing</a></h4>
<div class="paragraph">
<p>Since version 2.4, the <code>@Snapshot</code> extension has been added for snapshot testing.
This type of testing compares the current output of your code with a saved version (a snapshot) to check for any changes.
It&#8217;s especially useful for checking if your code still produces the right text outputs after changes.
The <code>@Snapshot</code> extension also makes it easy to create and update these snapshots.</p>
</div>
<div class="paragraph">
<p>You use the <code>@Snapshot</code> extension along with the <code>Snapshotter</code> class.
The <code>Snapshotter</code> class provides the entrypoint for the tests.
You can use <code>@Snapshot</code> in two ways: you can add it to a field in your code, or you can use it as a parameter in a method.
The examples below will show you how to do both.</p>
</div>
<div class="listingblock">
<div class="title">Snapshot Extension as field</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  @Snapshot
  Snapshotter snapshotter

  def "using field based snapshot"() {
    expect:
    snapshotter.assertThat("from field").matchesSnapshot()
  }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Snapshot Extension as parameter</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  def "using parameter based snapshot"(@Snapshot Snapshotter snapshotter) {
    expect:
    snapshotter.assertThat("from parameter").matchesSnapshot()
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can store and assert over multiple snapshots by providing an optional snapshotId as identifier.</p>
</div>
<div class="listingblock">
<div class="title">Multiple snapshots</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  def "multi snapshot"() {
    expect:
    snapshotter.assertThat("from parameter").matchesSnapshot()
    snapshotter.assertThat("other parameter").matchesSnapshot("otherId")
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, snapshots are stored and compared as plain text.
However, you can plug your own matching logic.
For example, you could compare two json structures with a third-party library.</p>
</div>
<div class="listingblock">
<div class="title">Custom matching</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  def "custom matching"() {
    expect:
    snapshotter.assertThat("data").matchesSnapshot { snapshot, actual -&gt;
      /* Hamcrest matchers */
      assertThat(actual, equalTo(snapshot))
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also extend from the <code>Snapshotter</code> class to provide your own convenience methods.
Check <code>org.spockframework.specs.extension.SpockSnapshotter</code> in the spock codebase for an example.</p>
</div>
<div class="sect4">
<h5 id="_configuration_3"><a class="link" href="#_configuration_3">Configuration</a></h5>
<div class="paragraph">
<p>The snapshots are stored in the <code>rootPath</code> directory, which can be configured either in the  <a href="#spock-configuration-file">Spock Configuration File</a>, or via the <code>spock.snapshots.rootPath</code> system property.
The <code>rootPath</code> directory is required and the <code>@Snapshot</code> extension will throw an exception if it is not configured when the extension is used.</p>
</div>
<div class="paragraph">
<p>Snapshots can be updated when setting the <code>spock.snapshots.updateSnapshots</code> system property to <code>true</code>, or via the config file.</p>
</div>
<div class="paragraph">
<p>You can configure the extension to store the actual value in case of a mismatch by setting the <code>spock.snapshots.writeActual</code> system property to <code>true</code>, or via the config file.
If enabled the extension will store the result in a file next to the original one with an additional <code>.actual</code> extension.
The <code>.actual</code> file will automatically be deleted on the next successful run, as long as the feature is still enabled.
This option is useful, when the snapshot is too large or complex to analyze with the built-in reporting.</p>
</div>
<div class="listingblock">
<div class="title">Example snapshot config</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">snapshots {
  rootPath = Paths.get("src/test/resources")
  updateSnapshots = System.getenv("UPDATE_SNAPSHOTS") == "true"
  writeActualSnapshotOnMismatch = !System.getenv("CI")
  defaultExtension = 'snap.groovy'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Snapshot</code> extension will also set the <code>snapshot</code> <a href="#test-tag-extension">tag</a> on the affected features.
This can be utilized to only run the features that produce snapshots when updating them.</p>
</div>
<div class="listingblock">
<div class="title">Example Gradle config for snapshot testing</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">tasks.named("test", Test) {
  useJUnitPlatform()
  // set the snapshot directory, as resources are already an input we don't need to track them separately
  systemProperty("spock.snapshots.rootPath", "src/test/resources")
  // allow updating the snapshots with running `gradlew test -PupdateSnapshots`
  if (project.hasProperty("updateSnapshots")) {
    systemProperty("spock.snapshots.updateSnapshots", "true")
    // not strictly necessary but speeds up the process by only executing snapshot tests
    useJUnitPlatform {
      includeTags("snapshot")
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_third_party_extensions"><a class="link" href="#_third_party_extensions">Third-Party Extensions</a></h3>
<div class="paragraph">
<p>You can find a list of third-party extensions in the <a href="https://github.com/spockframework/spock/wiki/Third-Party-Extensions">Spock Wiki</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_writing_custom_extensions"><a class="link" href="#_writing_custom_extensions">Writing Custom Extensions</a></h3>
<div class="paragraph">
<p>There are two types of extensions that can be created for usage with Spock. These are global extensions and annotation
driven local extensions. For both extension types you implement a specific interface which defines some callback
methods. In your implementation of those methods you can set up the magic of your extension, for example by adding
interceptors to various interception points that are described below.</p>
</div>
<div class="paragraph">
<p>It depends on your use case which type of annotation you create. If you want to do something once during the Spock run - at
the start or end - or want to apply something to all executed specifications without the user of the extension having to
do anything besides including your extension in the classpath, then you should opt for a global extension. If you
instead want to apply your magic only by choice of the user, then you should implement an annotation driven local
extension.</p>
</div>
<div class="sect3">
<h4 id="_global_extensions"><a class="link" href="#_global_extensions">Global Extensions</a></h4>
<div class="paragraph">
<p>To create a global extension you need to create a class that implements the interface <code>IGlobalExtension</code> and put its
fully-qualified class name in a file <code>META-INF/services/org.spockframework.runtime.extension.IGlobalExtension</code> in the
class path. As soon as these two conditions are satisfied, the extension is automatically loaded and used when Spock is
running.</p>
</div>
<div class="paragraph">
<p><code>IGlobalExtension</code> has the following three methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>start()</code></dt>
<dd>
<p>This is called once at the very start of the Spock execution.</p>
</dd>
<dt class="hdlist1"><code>visitSpec(SpecInfo spec)</code></dt>
<dd>
<p>This is called once for each specification. In this method you can prepare a specification with your extension magic,
like attaching interceptors to various interception points as described in the chapter <a href="#interceptors">Interceptors</a>.</p>
</dd>
<dt class="hdlist1"><code>stop()</code></dt>
<dd>
<p>This is called at least once at the very end of the Spock execution.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_annotation_driven_local_extensions"><a class="link" href="#_annotation_driven_local_extensions">Annotation Driven Local Extensions</a></h4>
<div class="paragraph">
<p>To create an annotation driven local extension you need to create a class implementing the interface
<code>IAnnotationDrivenExtension</code>. As type argument to the interface you need to supply an annotation class having
<code>@Retention</code> set to <code>RUNTIME</code>, <code>@Target</code> set to one or more of <code>FIELD</code>, <code>METHOD</code>, and <code>TYPE</code> - depending on where you
want your annotation to be applicable - and <code>@ExtensionAnnotation</code> applied, with the <code>IAnnotationDrivenExtension</code> class
as argument. Of course the annotation class can have some attributes with which the user can further configure the
behaviour of the extension for each annotation application.</p>
</div>
<div class="paragraph">
<p>Your annotation can be applied to a specification, a feature method, a fixture method or a field. On all other places
like helper methods or other places if the <code>@Target</code> is set accordingly, the annotation will be ignored and has no
effect other than being visible in the source code, except you check its existence in other places yourself.</p>
</div>
<div class="paragraph">
<p>Since Spock 2.0 your annotation can also be defined as <code>@Repeatable</code> and applied multiple times to the same target.
<code>IAnnotationDrivenExtension</code> has <code>visit&#8230;&#8203;Annotations</code> methods that are called by Spock with all annotations of the
extension applied to the same target. Their default implementations will then call the respective singular
<code>visit&#8230;&#8203;Annotation</code> method once for each annotation. If you want a repeatable annotation that is compatible with
Spock before 2.0 you need to make the container annotation an extension annotation itself and handle all cases
accordingly, but you need to make sure to only handle the container annotation if Spock version is before 2.0,
or your annotations might be handled twice. Be aware that the repeatable annotation can be attached to the target
directly, inside the container annotation or even both if the user added the container annotation manually
and also attached one annotation directly.</p>
</div>
<div class="paragraph">
<p>Repeatable annotations are not supported for parameter annotations,
as they are primarily intended to provide a value and only a singular value is allowed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since Spock 2.4 the new subtype <code>IStatelessAnnotationDrivenExtension</code> is available, which should be used if the extension does not need to store <code>Specification</code> specific state and is thread-safe.
Otherwise, it behaves the same as <code>IAnnotationDrivenExtension</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>IAnnotationDrivenExtension</code> has the following nine methods, where in each you can prepare a specification with your
extension magic, like attaching interceptors to various interception points as described in the chapter
<a href="#interceptors">Interceptors</a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>visitSpecAnnotations(List&lt;T&gt; annotations, SpecInfo spec)</code></dt>
<dd>
<p>This is called once for each specification where the annotation is applied one or multiple times
with the annotation instances as first parameter, and the specification info object as second parameter.
The default implementation calls <code>visitSpecAnnotation</code> once for each given annotation.</p>
</dd>
<dt class="hdlist1"><code>visitSpecAnnotation(T annotation, SpecInfo spec)</code></dt>
<dd>
<p>This is used as singular delegate for <code>visitSpecAnnotations</code> and is otherwise not called by Spock directly.
The default implementation throws an exception.</p>
</dd>
<dt class="hdlist1"><code>visitFieldAnnotations(List&lt;T&gt; annotations, FieldInfo field)</code></dt>
<dd>
<p>This is called once for each field where the annotation is applied one or multiple times
with the annotation instances as first parameter, and the field info object as second parameter.
The default implementation calls <code>visitFieldAnnotation</code> once for each given annotation.</p>
</dd>
<dt class="hdlist1"><code>visitFieldAnnotation(T annotation, FieldInfo field)</code></dt>
<dd>
<p>This is used as singular delegate for <code>visitFieldAnnotations</code> and is otherwise not called by Spock directly.
The default implementation throws an exception.</p>
</dd>
<dt class="hdlist1"><code>visitFixtureAnnotations(List&lt;T&gt; annotations, MethodInfo fixtureMethod)</code></dt>
<dd>
<p>This is called once for each fixture method where the annotation is applied one or multiple times
with the annotation instances as first parameter, and the fixture method info object as second parameter.
The default implementation calls <code>visitFixtureAnnotation</code> once for each given annotation.</p>
</dd>
<dt class="hdlist1"><code>visitFixtureAnnotation(T annotation, MethodInfo fixtureMethod)</code></dt>
<dd>
<p>This is used as singular delegate for <code>visitFixtureAnnotations</code> and is otherwise not called by Spock directly.
The default implementation throws an exception.</p>
</dd>
<dt class="hdlist1"><code>visitFeatureAnnotations(List&lt;T&gt; annotations, FeatureInfo feature)</code></dt>
<dd>
<p>This is called once for each feature method where the annotation is applied one or multiple times
with the annotation instances as first parameter, and the feature info object as second parameter.
The default implementation calls <code>visitFeatureAnnotation</code> once for each given annotation.</p>
</dd>
<dt class="hdlist1"><code>visitFeatureAnnotation(T annotation, FeatureInfo feature)</code></dt>
<dd>
<p>This is used as singular delegate for <code>visitFeatureAnnotations</code> and is otherwise not called by Spock directly.
The default implementation throws an exception.</p>
</dd>
<dt class="hdlist1"><code>visitParameterAnnotation(T annotation, ParameterInfo parameter)</code></dt>
<dd>
<p>This is called once for each parameter of a feature or fixture method where the annotation is applied to.
It gets the annotation instance as first parameter and the <code>ParameterInfo</code> object as second parameter.</p>
</dd>
<dt class="hdlist1"><code>visitSpec(SpecInfo spec)</code></dt>
<dd>
<p>This is called once for each specification within which the annotation is applied to at least one of the supported
places like defined above. It gets the specification info object as sole parameter. This method is called after all
other methods of this interface for each applied annotation are processed.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_objects"><a class="link" href="#_configuration_objects">Configuration Objects</a></h4>
<div class="paragraph">
<p>You can add own sections in the <a href="#spock-configuration-file">Spock Configuration File</a> for your extension by creating POJOs or POGOs that are
annotated with <code>@ConfigurationObject</code> and have a default constructor (either implicitly or explicitly). The argument to
the annotation is the name of the top-level section that is added to the Spock configuration file syntax. The default
values for the configuration options are defined in the class by initializing the fields at declaration time or in the
constructor. In the Spock configuration file those values can then be edited by the user of your extension.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is an error to have multiple configuration objects with the same name, so choose wisely if you pick one and
probably prefix it with some package-like name to minimize the risk for name clashes with other extensions or the core
Spock code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use the values of the configuration object in your extension, you can either use constructor injection or field injection.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To use constructor injection just define a constructor with one or more configuration object parameters.</p>
</li>
<li>
<p>To use field injection just define an uninitialized non-final instance field of that type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spock will then automatically create exactly one instance of the configuration object per Spock run, apply the
settings from the configuration file to it (before the <code>start()</code> methods of global extensions are called) and inject
that instance into the extension class instances.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Constructor injection has a higher priority than field injection and Spock won&#8217;t inject any fields if it finds a suitable constructor.
      If you want to support both Spock 1.x and 2.x you can either use only field injection (Spock 1.x only supports field injection),
      or you can have both a default constructor and an injectable constructor, this way Spock 2.x will use constructor injection and Spock 1.x will use field injection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a configuration object should be used exclusively in an annotation driven local extension you must register it in
<code>META-INF/services/spock.config.ConfigurationObject</code>.
This is similar to a global extension, put the fully-qualified class name of the annotated class on a new line in the file.
This will cause the configuration object to properly get initialized and populated with the settings from the configuration file.
However, if the configuration object is used in a global extension, you can also use it just fine in an annotation driven local
extension. If the configuration object is only used in an annotation driven local extension, you will get an exception
when then configuration object is to be injected into the extension, and you will also get an error when the
configuration file is evaluated, and it contains the section, as the configuration object is not properly registered yet.</p>
</div>
</div>
<div class="sect3">
<h4 id="interceptors"><a class="link" href="#interceptors">Interceptors</a></h4>
<div class="paragraph">
<p>For applying the magic of your extension, there are various interception points, where you can attach interceptors from
the extension methods described above to hook into the Spock lifecycle. For each interception point there can of course
be multiple interceptors added by arbitrary Spock extensions (shipped or 3rd party). Their order currently depends
on the order they are added, but there should not be made any order assumptions within one interception point.</p>
</div>
<div id="spock-interceptors" class="imageblock text-center">
<div class="content">
<img src="images/spock_interceptors.png" alt="Spock Interceptors">
</div>
<div class="title">Figure 1. Spock Interceptors</div>
</div>
<div class="paragraph">
<p>An ellipsis in the figure means that the block before it can be repeated an arbitrary amount of times.</p>
</div>
<div class="paragraph">
<p>The <code>&#8230;&#8203; method interceptors</code> are of course only run if there are actual methods of this type to be executed (the white
boxes) and those can <a href="#parameter-injection">inject parameters</a> to be given to the method that will be run.</p>
</div>
<div class="paragraph">
<p>The shared initializer method interceptor and initializer method interceptor are called around two methods that are
generated by the compiler if there are <code>@Shared</code>, respectively non-<code>@Shared</code>, fields that get values assigned at
declaration time. The compiler will put those initializations in a generated method and call it at the proper place in
the lifecycle. So if there are no such initializations, no method is generated and thus the method interceptor is never
called. The non-method interceptors are always called at the proper place in the lifecycle to do work that has to be
done at that time. There can also be multiple such methods, if you for example have a super specification that itself
has fields with initialization expressions.</p>
</div>
<div class="paragraph">
<p>To create an interceptor to be attached to an interception point, you need to create a class that implements the
interface <code>IMethodInterceptor</code>. This interface has the sole method <code>intercept(IMethodInvocation invocation)</code>. The
<code>invocation</code> parameter can be used to get and modify the current state of execution. Each interceptor <strong>must</strong> call the
method <code>invocation.proceed()</code>, which will go on in the lifecycle, except you really want to prevent further execution of
the nested elements like shown in the figure above. But this should be a very rare use case.</p>
</div>
<div class="paragraph">
<p>If you write an interceptor that can be used at different interception points and should do different work at different
interception points, there is also the convenience class <code>AbstractMethodInterceptor</code>, which you can extend and which
provides various methods for overriding that are called for the various interception points. Most of these methods have
a double meaning, like <code>interceptSetupMethod</code> which is called for the <code>setup interceptor</code> and the <code>setup method
interceptor</code>. If you attach your interceptor to both of them and need a differentiation, you can check for
<code>invocation.method.reflection</code>, which will be set in the method interceptor case and <code>null</code> otherwise, or you can check
<code>invocation.method.name</code> which behaves the same, or you can check for <code>invocation.target == invocation.instance</code>.
Alternatively, you can of course build two different interceptors or add a parameter to your interceptor and create
two instances, telling each at addition time whether it is attached to the method interceptor or the other one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class I extends AbstractMethodInterceptor {
  I(def s) {}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Add All Interceptors</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">// DISCLAIMER: The following shows all possible injection points that you could use
//             depending on need and situation. You should normally not need to
//             register a listener to all these places.
//
//             Also, when building an annotation driven local extension, you should
//             consider where you want the effects to be present, for example only
//             for the features in the same class (specInfo.features), or for features
//             in the same and superclasses (specInfo.allFeatures), or also for
//             features in subclasses (specInfo.bottomSpec.allFeatures), and so on.

// on SpecInfo
specInfo.specsBottomToTop*.addSharedInitializerInterceptor new I('shared initializer')
specInfo.allSharedInitializerMethods*.addInterceptor new I('shared initializer method')
specInfo.addInterceptor new I('specification')
specInfo.specsBottomToTop*.addSetupSpecInterceptor new I('setup spec')
specInfo.allSetupSpecMethods*.addInterceptor new I('setup spec method')
specInfo.allFeatures*.addInterceptor new I('feature')
specInfo.specsBottomToTop*.addInitializerInterceptor new I('initializer')
specInfo.allInitializerMethods*.addInterceptor new I('initializer method')
specInfo.allFeatures*.addIterationInterceptor new I('iteration')
specInfo.specsBottomToTop*.addSetupInterceptor new I('setup')
specInfo.allSetupMethods*.addInterceptor new I('setup method')
specInfo.allFeatures*.featureMethod*.addInterceptor new I('feature method')
specInfo.specsBottomToTop*.addCleanupInterceptor new I('cleanup')
specInfo.allCleanupMethods*.addInterceptor new I('cleanup method')
specInfo.specsBottomToTop*.addCleanupSpecInterceptor new I('cleanup spec')
specInfo.allCleanupSpecMethods*.addInterceptor new I('cleanup spec method')
specInfo.allFixtureMethods*.addInterceptor new I('fixture method')

// on FeatureInfo (already included above, handling all features)
featureInfo.addInterceptor new I('feature')
featureInfo.addIterationInterceptor new I('iteration')
featureInfo.featureMethod.addInterceptor new I('feature method')

// since Spock 2.4 there are also feature-scoped interceptors that only apply for a single feature
// they will execute before the spec interceptors
featureInfo.addInitializerInterceptor new I('feature scoped initializer')
featureInfo.addSetupInterceptor new I('feature scoped setup')
featureInfo.addCleanupInterceptor new I('feature scoped cleanup')
// you can also perform a feature-scoped interception of spec methods
featureInfo.parent.allInitializerMethods.each { method -&gt;
  featureInfo.addScopedMethodInterceptor(method, new I('feature scoped initializer method'))
}
featureInfo.parent.allSetupMethods.each { method -&gt;
  featureInfo.addScopedMethodInterceptor(method, new I('feature scoped setup method'))
}
featureInfo.parent.allCleanupMethods.each { method -&gt;
  featureInfo.addScopedMethodInterceptor(method, new I('feature scoped cleanup method'))
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="parameter-injection"><a class="link" href="#parameter-injection">Injecting Method Parameters</a></h5>
<div class="paragraph">
<p>Starting with Spock 2.4, it is possible to create <code>IAnnotationDrivenExtension</code> that target method parameters directly.
The extension annotation must use the <code>@Target({ElementType.PARAMETER})</code> and the extension must implement <code>IAnnotationDrivenExtension.visitParameterAnnotation(T annotation, ParameterInfo parameter)</code>.
In the <code>visitParameterAnnotation</code> you can then register a custom interceptor, or use the convenience <code>ParameterResolver.Interceptor</code> to handle the parameter injection.
Parameter injection is supported for fixture methods, such as <code>setup</code> and <code>cleanup</code>, as well as for feature methods.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>ParameterIndex</code> extension</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.PARAMETER)
@ExtensionAnnotation(ParameterIndexExtension)
@interface ParameterIndex {}

class ParameterIndexExtension implements IAnnotationDrivenExtension&lt;ParameterIndex&gt; {
  @Override
  void visitParameterAnnotation(ParameterIndex annotation, ParameterInfo parameter) {
    Class&lt;?&gt; type = parameter.reflection.type
    if (!(type in [int, Integer])) {
      throw new SpockExecutionException("Parameter must be a int/Integer but was ${type}")
    }
    parameter.parent.addInterceptor(       <i class="conum" data-value="1"></i><b>(1)</b>
      new ParameterResolver.Interceptor(   <i class="conum" data-value="2"></i><b>(2)</b>
        parameter,                         <i class="conum" data-value="3"></i><b>(3)</b>
        { parameter.index }                <i class="conum" data-value="4"></i><b>(4)</b>
      ))
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add the interceptor to the method, which is the <code>parent</code> of the <code>ParameterInfo</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The built-in <code>ParameterResolver.Interceptor</code> will handle the boilerplate part of parameter injection.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the <code>ParameterInfo</code> to the interceptor, so the interceptor knows which parameter it is handling.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is a <code>Function&lt;IMethodInvocation, Object&gt;</code>, which is called by the <code>ParameterResolver.Interceptor</code> to resolve the parameter value. Here we just return the value of the <code>ParameterInfo&#8217;s `index</code> property, but you could also do some more complex logic here.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example usage of <code>ParameterIndex</code> extension</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  def setup(@ParameterIndex int param1) {
    assert param1 == 0
  }

  def "test"(@ParameterIndex int param1, @ParameterIndex Integer param2, @ParameterIndex int param3) {
    expect:
    param1 == 0
    param2 == 1
    param3 == 2
  }</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_for_spock_versions_prior_to_2_4_or_for_advanced_use_cases"><a class="link" href="#_for_spock_versions_prior_to_2_4_or_for_advanced_use_cases">For Spock versions prior to 2.4 or for advanced use cases</a></h6>
<div class="paragraph">
<p>If your interceptor should support custom method parameters for wrapped methods, this can be done by modifying
<code>invocation.arguments</code>. Two use cases for this would be a mocking framework that can inject method parameters that are
annotated with a special annotation, or some test helper that injects objects of a specific type that are created and
prepared for usage automatically.</p>
</div>
<div class="paragraph">
<p>When called from at least Spock 2.0, the <code>arguments</code> array will always have the size of the method parameter count,
so you can directly set the arguments you want to set. You cannot change the size of the <code>arguments</code> array either.
All parameters that did not yet get any value injected, either from data variables or some extension, will have the
value <code>MethodInfo.MISSING_ARGUMENT</code> and if any of those remain, after all interceptors were run, an exception will be
thrown.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When your extension might be used with a version before Spock 2.0, the <code>arguments</code> array may be an empty array
or an array of arbitrary length, depending on what interceptors were run before that maybe also have manipulated
this array for parameter injection. If you for example investigated the method parameters with
<code>invocation.method.reflection.parameters</code> and found that you want to inject the fifth parameter,
you should first check whether the <code>arguments</code> array is at least five elements long. If not, you should assign it a new
array that is at least five elements long and copy the contents of the old array into the new one. Then you can assign
your objects to be injected.</p>
</div>
<div class="listingblock">
<div class="title">Inject Method Parameters</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">// create a map of all MyInjectable parameters with their parameter index
Map&lt;Parameter, Integer&gt; parameters = [:]
invocation.method.reflection.parameters.eachWithIndex { parameter, i -&gt;
  parameters &lt;&lt; [(parameter): i]
}
parameters = parameters.findAll { MyInjectable.equals it.key.type }

// enlarge arguments array if necessary
def lastMyInjectableParameterIndex = parameters*.value.max()
lastMyInjectableParameterIndex = lastMyInjectableParameterIndex == null ?
                                 0 :
                                 lastMyInjectableParameterIndex + 1
if(invocation.arguments.length &lt; lastMyInjectableParameterIndex) {
  def newArguments = new Object[lastMyInjectableParameterIndex]
  System.arraycopy invocation.arguments, 0, newArguments, 0, invocation.arguments.length
  invocation.arguments = newArguments
}

parameters.each { parameter, i -&gt;
  invocation.arguments[i] = new MyInjectable(parameter)
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Pre Spock 2.0 only:</strong> When using data driven features (methods with a <code>where:</code> block), the user of your extension has to follow some
restrictions, if parameters should be injected by your extension:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all data variables and all to-be-injected parameters have to be defined as method parameters</p>
</li>
<li>
<p>all method parameters have to be assigned a value in the <code>where:</code> block, for example <code>null</code></p>
</li>
<li>
<p>the order of the method parameters has to be identical to the order of the data variables in the <code>where:</code> block</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course, you can also make your extension only inject a value if none is set already, as the <code>where:</code> block
assignments happen before the method interceptor is called</p>
</div>
<div class="paragraph">
<p>for this simply check whether <code>invocation.arguments[i]</code> is <code>null</code> or not</p>
</div>
<div class="listingblock">
<div class="title">Data Driven Feature with Injected Parameter pre Spock 2.0</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def 'test parameter injection'(a, b, MyInjectable myInjectable) {
  expect: myInjectable

  where:
  a    | b
  'a1' | 'b1'
  'a2' | 'b2'

  and:
  myInjectable = null
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Data Driven Feature with Injected Parameter post Spock 2.0</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def 'test parameter injection'(MyInjectable myInjectable) {
  expect: myInjectable

  where:
  a    | b
  'a1' | 'b1'
  'a2' | 'b2'
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mock-makers"><a class="link" href="#mock-makers">Mock Maker Extensions</a></h4>
<div class="paragraph">
<p>Spock creates mock objects via the <code>IMockMaker</code> interface.
When Spock is creating a mock, it will ask the available mock makers in order of priority,
if it can mock the requested type. Spock will use the first mock maker which is capable to mock the requested type.</p>
</div>
<div class="paragraph">
<p>The following mock makers are built-in, and are selected in this order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java-proxy</code>: Uses the <code>java.lang.reflect.Proxy</code> API to create mocks of interfaces.</p>
</li>
<li>
<p><code>byte-buddy</code>: Uses <a href="https://bytebuddy.net/">Byte Buddy</a> to create mock objects.</p>
<div class="ulist">
<ul>
<li>
<p>Requires <code>net.bytebuddy:byte-buddy</code> 1.9+ on the class path.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>cglib</code>: Deprecated: Uses <a href="https://github.com/cglib/cglib">CGLIB</a> to create mock objects.</p>
<div class="ulist">
<ul>
<li>
<p>Requires <code>cglib:cglib-nodep</code> 3.2.0+ on the class path.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>mockito</code>: Uses <a href="https://site.mockito.org/">Mockito</a> to create mock objects.</p>
<div class="ulist">
<ul>
<li>
<p>Can be configured to use additional Mockito feature like mock <code>Serializable</code></p>
</li>
<li>
<p>Requires <code>org.mockito:mockito-core</code> 4.11+ on the class path.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Capabilities of the different built-in mock makers</caption>
<colgroup>
<col>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Capability</th>
<th class="tableblock halign-center valign-middle"><code>java-proxy</code></th>
<th class="tableblock halign-center valign-middle"><code>byte-buddy</code></th>
<th class="tableblock halign-center valign-middle"><code>cglib</code></th>
<th class="tableblock halign-center valign-middle"><code>mockito</code></th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Interface</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Class</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Additional Interfaces</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Explicit Constructor Arguments</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Final Class</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Final Method</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-middle"><p class="tableblock">Static Method</p></th>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">â</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The class <code>spock.mock.MockMakers</code> provides constants and methods for the built-in mock makers.</p>
</div>
<div class="paragraph">
<p>You can select your preferred mock maker, by defining the <code>preferredMockMaker</code> property
in the <a href="#spock-configuration-file">Spock Configuration File</a>.
The preferred mock maker will be used globally, if no mock maker is explicitly specified for a given mock.</p>
</div>
<div class="listingblock">
<div class="title">Mock Maker settings in the Spock Configuration file</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">mockMaker {
  preferredMockMaker spock.mock.MockMakers.byteBuddy
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="mock-makers-mockito"><a class="link" href="#mock-makers-mockito">Mockito Mock Maker</a></h5>
<div class="paragraph">
<p>The <code>mockito</code> Mock Maker provides the ability to mock final types, enums and final methods.
The mocking of final classes is automatically enabled, if <code>org.mockito:mockito-core</code> 4.11+ is on the class path.</p>
</div>
<div class="paragraph">
<p>For mocking of final methods, you need to select the <code>mockito</code> mock maker during mock construction,
like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = Mock(mockMaker: MockMakers.mockito)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to make final methods mockable by default, you can select this mock maker as the preferred mock maker.
It can&#8217;t mock native methods, see <a href="https://javadoc.io/doc/org.mockito/mockito-core/5.6.0/org/mockito/Mockito.html#Mocking_Final">the Mockito documentation</a> for details.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If you try to mock a final method without a Mock Maker supporting it,
         it will silently fail, without honoring your specified interactions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can configure the created mock objects using the interface <code>org.mockito.MockSettings</code> during the construction to use features provided by Mockito:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Subscriber subscriber = Mock(mockMaker: MockMakers.mockito {
  serializable()
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>mockito</code> mock maker uses <code>org.mockito.MockMakers.INLINE</code> under the hood,
please see the Mockito manual "Mocking final types, enums and final methods" for all pros and cons,
when using <code>org.mockito.MockMakers.INLINE</code>.
It also supports mocking of static methods of classes and interfaces with <code>SpyStatic</code>.
See <a href="#static-mocks">static mocks</a> section for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_custom_mock_maker"><a class="link" href="#_custom_mock_maker">Custom Mock Maker</a></h5>
<div class="paragraph">
<p>Spock provides an extension point to plug in your own mock maker for creating mock objects.
To create a mock maker you need to create a class that implements the interface <code>IMockMaker</code> and put its
fully-qualified class name in a file <code>META-INF/services/org.spockframework.mock.runtime.IMockMaker</code> in the
class path. As soon as these two conditions are satisfied, your mock maker is automatically loaded and used when Spock is
running.</p>
</div>
<div class="paragraph">
<p>You should provide a constant class containing the mock maker ID or a method for creating <code>IMockMakerSettings</code> to your users,
that your mock maker can be easily selected.</p>
</div>
<div class="paragraph">
<p>The <code>IMockMakerSettings</code> can be used by a custom <code>IMockMaker</code> to provide mock maker specific API settings in a type-safe way.
The custom mock maker may subclass <code>IMockMakerSettings</code> to transport custom data from the declaration site to the mock
creation. The custom mock maker then provides a static method to create an instance of that subclass and the parameters
are then used during mock creation.</p>
</div>
<div class="listingblock">
<div class="title">Custom Mock Maker Example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public final class FancyMockMaker implements IMockMaker {
  static final MockMakerId ID = new MockMakerId("fancy");

  private static final Set&lt;MockMakerCapability&gt; CAPABILITIES = EnumSet.of(
    MockMakerCapability.CLASS,
    MockMakerCapability.EXPLICIT_CONSTRUCTOR_ARGUMENTS);

  public FancyMockMaker() {
  }

  @Override
  public MockMakerId getId() {
    return ID;
  }

  @Override
  public Set&lt;MockMakerCapability&gt; getCapabilities() {
    return CAPABILITIES;
  }

  @Override
  public int getPriority() {
    return 5000;
  }

  @Override
  public Object makeMock(IMockCreationSettings settings) {
    FancyMockMakerSettings fancySettings = settings.getMockMakerSettings();
    return makeMockInternal(fancySettings);
  }

  @Override
  public IMockabilityResult getMockability(IMockCreationSettings settings) {
    FancyMockMakerSettings fancySettings = settings.getMockMakerSettings();
    if (fancySettings != null &amp;&amp;
      fancySettings.isSerialization() &amp;&amp;
      !fancySettings.getFancyTypes().isEmpty()) {
      return () -&gt; "Mock with serialization and fancy types is not supported.";
    }
    return IMockabilityResult.MOCKABLE;
  }

  Object makeMockInternal(FancyMockMakerSettings settings) {
    //Implementation omitted ...
    return null;
  }
}

final class FancyMockMakerSettings implements IMockMakerSettings {
  private boolean serialization;
  private final List&lt;Type&gt; specialTypes = new ArrayList&lt;&gt;();

  FancyMockMakerSettings() {
  }

  boolean isSerialization() {
    return serialization;
  }

  List&lt;Type&gt; getFancyTypes() {
    return specialTypes;
  }

  @Override
  public MockMakerId getMockMakerId() {
    return FancyMockMaker.ID;
  }

  public void withSerialization() {
    serialization = true;
  }

  public void fancyTypes(Type... types) {
    this.specialTypes.addAll(Arrays.asList(types));
  }
}

final class FancyMockMakers {
  /**
   * Public static entry point for the User.
   */
  public static IMockMakerSettings fancyMock(
    @DelegatesTo(FancyMockMakerSettings.class)
    Closure&lt;?&gt; code) {
    FancyMockMakerSettings settings = new FancyMockMakerSettings();
    code.setDelegate(settings);
    code.call();
    return settings;
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Custom Mock Maker Usage Example</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
Mock(ArrayList, mockMaker: FancyMockMakers.fancyMock {
  fancyTypes(List.class, String.class)
  withSerialization()
})
then:
CannotCreateMockException ex = thrown()
ex.message == "Cannot create mock for class java.util.ArrayList. fancy: Mock with serialization and fancy types is not supported."</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="extension-store"><a class="link" href="#extension-store">Keeping State in Extensions</a></h4>
<div class="paragraph">
<p>Prior to Spock 2.4, extensions could only store state either in their own instances or their interceptor instances.
Often, the state can be kept locally in the <code>intercept(IMethodInvocation)</code> method around the <code>IMethodInvocation.proceed()</code> call. However, there are cases where this is not possible, for example when using initializer interceptors.</p>
</div>
<div class="paragraph">
<p>Spock 2.4 adds a new <code>org.spockframework.runtime.extension.IStore</code> interface that allows extensions to store and retrieve data during the execution of a specification.</p>
</div>
<div class="paragraph">
<p>The store is available from the <code>org.spockframework.runtime.extension.IMethodInvocation</code> interface via the <code>getStore(IStore.Namespace namespace)</code> method. Currently, it is not possible to access the store directly from an extension, only via registering an <a href="#interceptors">interceptor</a>.</p>
</div>
<div class="paragraph">
<p>The stores are hierarchical and follow roughly the same hierarchy as shown in the <a href="#spock-interceptors">Spock Interceptors</a> figure. The hierarchy is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Root
â Specification
  â Feature
    â Iteration</code></pre>
</div>
</div>
<div class="literalblock">
<div class="title">Store hierarchy</div>
<div class="content">
<pre>@startuml
state Root #88CCEE {
    state ASpec #DDCC77 {
        state AFeature1 #44AA99 {
            state "AFeature1[1]" #CC6677
            state "AFeature1[2]" #CC6677
        }
        state AFeature2 #44AA99 {
            state "AFeature2[1]" #CC6677
            state "AFeature2[2]" #CC6677
        }
    }
    state BSpec #DDCC77{
        state BFeature1 #44AA99 {
            state "BFeature1[1]" #CC6677
            state "BFeature1[2]" #CC6677
        }
        state BFeature2 #44AA99 {
            state "BFeature2[1]" #CC6677
            state "BFeature2[2]" #CC6677
        }
    }
}

'// color palette is TOL from https://davidmathlogic.com/colorblind/
'// https://personal.sron.nl/~pault/ muted variant
@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>If an item is not found in the current store, its parent store is searched, and so on until the root store is reached. For more information see the JavaDoc of <code>org.spockframework.runtime.extension.IStore</code>.</p>
</div>
<div class="paragraph">
<div class="title">Example</div>
<p>If an interceptor adds a <code>Macguffin</code> to the store via a <code>sharedInitializerInterceptor</code>  for <code>ASpec</code> it will be available to all features (<code>AFeature1</code> and <code>AFeature2</code>) and iterations (<code>AFeature1[1]</code>, <code>AFeature1[2]</code>, <code>AFeature2[1]</code>, <code>AFeature2[2]</code>) of that specification, but not to <code>BSpec</code> or its features. Conversely, if a feature interceptor adds a <code>Thingmajig</code> to the store for <code>AFeature1</code> it will be available to all its iterations (<code>AFeature1[1]</code>, <code>AFeature1[2]</code>), but not to sibling features (<code>AFeature2</code>) or to the specification (<code>ASpec</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When the store is closed, it will call the <code>close()</code> method for all stored values that implement <code>java.lang.AutoCloseable</code>.
      Stored values will be closed in reverse insertion order.
      This does not happen, if the value was added and subsequently removed from the store, before the store was closed.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_example_of_a_global_extension_using_the_store"><a class="link" href="#_example_of_a_global_extension_using_the_store">Example of a global extension using the Store</a></h5>
<div class="listingblock">
<div class="title">Global Extension implementation</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class ExceptionCounterGlobalExtension implements IGlobalExtension {
  private static final Namespace EXAMPLE_NS =                             <i class="conum" data-value="1"></i><b>(1)</b>
    Namespace.create(ExceptionCounterGlobalExtension)
  private static final String ACCUMULATOR = "accumulator"
  private static final IMethodInterceptor INTERCEPTOR =  {
    try {
      it.proceed()
    } catch (Exception e) {
      it.getStore(EXAMPLE_NS)                                             <i class="conum" data-value="6"></i><b>(6)</b>
        .get(ACCUMULATOR, ConcurrentHashMap)                              <i class="conum" data-value="7"></i><b>(7)</b>
        .computeIfAbsent(e.class.name, { __ -&gt; new AtomicInteger() })     <i class="conum" data-value="8"></i><b>(8)</b>
        .incrementAndGet()
      throw e
    }
  }

  @Override
  void visitSpec(SpecInfo spec) {
    spec.allFeatures.featureMethod*.addInterceptor(INTERCEPTOR)           <i class="conum" data-value="2"></i><b>(2)</b>
  }

  @Override
  void executionStart(ISpockExecution spockExecution) {                   <i class="conum" data-value="3"></i><b>(3)</b>
    spockExecution.getStore(EXAMPLE_NS)                                   <i class="conum" data-value="4"></i><b>(4)</b>
      .put(ACCUMULATOR, new ConcurrentHashMap())                          <i class="conum" data-value="5"></i><b>(5)</b>
  }

  @Override
  void executionStop(ISpockExecution spockExecution) {                    <i class="conum" data-value="9"></i><b>(9)</b>
    def results = spockExecution.getStore(EXAMPLE_NS)
      .get(ACCUMULATOR, ConcurrentHashMap)

    if (!results.isEmpty()) {
      println "========================"
      println "==Exception statistics=="
      println "========================"
      results.toSorted().each { exceptionName, counter -&gt;
        println "${counter}x $exceptionName"
      }
      println "========================"
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Namespace</code> for the extension is created, here we use the extension&#8217;s class as key</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The extension registers the <code>INTERCEPTOR</code> for each feature method</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>executionStart</code> is called right before the specifications are executed, it also gives access to the root-level <code>IStore</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The extensions uses its <code>Namespace</code> to retrieve the <code>IStore</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>It then puts a <code>ConcurrentHashMap</code> into the store to serve as collector for the data</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>During the feature method execution the <code>INTERCEPTOR</code> retrieves the <code>IStore</code> via the shared <code>Namespace</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>It then retrieves the <code>ConcurrentHashMap</code> via the key, retrieval request will propagate through the hierarchy until it finds the value at the root-level</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>It then increments the counter for the occurred exception type, creating the counter if it was not yet present.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><code>executionStop</code> is called after all tests have been executed and also give access to the root-level <code>IStore</code>.
The extension uses this to print a report of the collected exception statistics.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example Specs</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class ASpec extends Specification {
  def "a failing test"() {
    expect: false
  }

  def "a test failing with an exception"() {
    given:
    if(1==1) throw new IllegalStateException()

    expect: true
  }
}

class BSpec extends Specification {

  def "illegal parameter for List"() {
    given:
    def value = new ArrayList&lt;&gt;(-1)

    expect:
    value.empty
  }

  def "illegal parameter for Map"() {
    given:
    def value = new HashMap(-1)

    expect:
    value.empty
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The extension generates the following output for the example code above.</p>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre class="highlight"><code>========================
==Exception statistics==
========================
1x java.lang.IllegalStateException
2x java.lang.IllegalArgumentException
========================</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default-value-provider"><a class="link" href="#default-value-provider">Default Value Provider Extensions</a></h4>
<div class="paragraph">
<p>Stubs use the <code>EmptyOrDummyResponse</code> to return a default value for a method call.
If the <code>EmptyOrDummyResponse</code> doesn&#8217;t have specific instructions for a type it will return a new <code>Stub</code> for that type.
This works for most cases, but can lead to unexpected behavior if the type does have a behavioral contract that is not fulfilled by the <code>Stub</code>.
Another problematic case is when the type is <code>final</code> or <code>sealed</code> as those are not mockable by default.</p>
</div>
<div class="paragraph">
<p>To address these issues, Spock 2.4 introduces the <code>org.spockframework.runtime.extension.IDefaultValueProviderExtension</code> that is loaded via Java&#8217;s <code>ServiceLoader</code> mechanism.
This extension allows you to provide a default value if the <code>EmptyOrDummyResponse</code> doesn&#8217;t have specific instructions for a type.</p>
</div>
<div class="listingblock">
<div class="title">Example Implementation</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">public class MaybeDefaultValueProvider implements IDefaultValueProviderExtension {
  @Override
  public @Nullable Object provideDefaultValue(Class&lt;?&gt; type, Type exactType) {
    if (type == IMaybe.class) {
      return IMaybe.none();
    }
    return null;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is primarily for framework developers who want to provide a default value for their framework types.
Or users of a framework that doesn&#8217;t provide default values for their special types.</p>
</div>
<div class="paragraph">
<p>If you want to change the default response behavior for <code>Stub</code> have a look at <a href="#ALaCarteMocks">A la Carte Mocks</a> and how to use your own <code>org.spockframework.mock.IDefaultResponse</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_listeners"><a class="link" href="#_listeners">Listeners</a></h4>
<div class="paragraph">
<p>Extensions can register listeners to receive notifications about the progress of the test run.
These listeners are intended to be used for reporting, logging, or other monitoring purposes.
They are not intended to modify the test run in any way.
You can register the same listener instance on multiple specifications or features.
Please consult the JavaDoc of the respective listener interfaces for more information.</p>
</div>
<div class="sect4">
<h5 id="_irunlistener"><a class="link" href="#_irunlistener"><code>IRunListener</code></a></h5>
<div class="paragraph">
<p>The <code>org.spockframework.runtime.IRunListener</code> can be registered via <code>SpecInfo.addListener(IRunListener)</code> and will receive notifications about the progress of the test run of a single specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="block-listener"><a class="link" href="#block-listener"><code>IBlockListener</code></a></h5>
<div class="paragraph">
<p>The <code>org.spockframework.runtime.extension.IBlockListener</code> can be registered on a feature via, <code>FeatureInfo.addBlockListener(IBlockListener)</code> and will receive notifications about the progress of the feature.</p>
</div>
<div class="paragraph">
<p>It will be called once when entering a block (<code>blockEntered</code>) and once when exiting a block (<code>blockExited</code>).
Both methods receive the <code>BlockInfo</code> of the block that is entered or exited.
They also receive the current <code>Specification</code> instance which gives access to the <code>ISpecificationContext</code> to get the current <code>IterationInfo</code> or retrieve an <code>IStore</code>.
While this gives extensive access to the current state of the test run, it should be used responsibly as it can lead to surprising results if abused.</p>
</div>
<div class="paragraph">
<p>When an exception is thrown in a block, the <code>blockExited</code> will not be called for that block.
The failed block will be part of the <code>ErrorContext</code> in <code>ErrorInfo</code> that is passed to <code>IRunListener.error(ErrorInfo)</code>.
If a <code>cleanup</code> block is present the cleanup block listener methods will still be called.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="utilities"><a class="link" href="#utilities">Utilities</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mutable-clock"><a class="link" href="#mutable-clock">Testing Time with <code>MutableClock</code></a></h3>
<div class="paragraph">
<p>When working with dates or time we often have the problem of writing stable tests.
Java only provides a <code>FixedClock</code> for testing.
However, often time related code has to deal with the change of time,
so a fixed clock is not enough or makes the test harder to follow.</p>
</div>
<div class="paragraph">
<p>The prerequisite for using both <code>FixedClock</code> and Spocks <code>MutableClock</code> is that the production code,
actually uses a configurable <code>Clock</code> and not just the parameterless <code>Instant.now()</code>
or the corresponding methods in the other <code>java.time.*</code> classes.</p>
</div>
<div class="sect3">
<h4 id="_example"><a class="link" href="#_example">Example</a></h4>
<div class="listingblock">
<div class="title">Class under Test</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">public class AgeFilter implements Predicate&lt;LocalDate&gt; {
  private final Clock clock;
  private final int age;

  public AgeFilter(Clock clock, int age) {                                       <i class="conum" data-value="1"></i><b>(1)</b>
    this.clock = clock;
    this.age = age;
  }

  @Override
  public boolean test(LocalDate date) {
    return Period.between(date, LocalDate.now(clock)).getYears() &gt;= age;         <i class="conum" data-value="2"></i><b>(2)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Clock</code> is injected via constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Clock</code> is used to get the current date</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Test</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "AgeFilter reacts to time"() {
  given:
  ZonedDateTime defaultTime = ZonedDateTime.of(2018, 6, 5, 0, 0, 0, 0, ZoneId.of('UTC'))
  MutableClock clock = new MutableClock(defaultTime)                                       <i class="conum" data-value="1"></i><b>(1)</b>
  AgeFilter ageFilter = new AgeFilter(clock,18)                                            <i class="conum" data-value="2"></i><b>(2)</b>

  LocalDate birthday = defaultTime.minusYears(18).plusDays(1).toLocalDate()

  expect:
  !ageFilter.test(birthday)                                                                <i class="conum" data-value="3"></i><b>(3)</b>

  when:
  clock + Duration.ofDays(1)                                                               <i class="conum" data-value="4"></i><b>(4)</b>

  then:
  ageFilter.test(birthday)                                                                 <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>MutableClock</code> created with a well known time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Clock</code> is injected via constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>age</code> is less than <code>18</code> so the result is <code>false</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the clock is advanced by one day</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>age</code> is equal to <code>18</code> so the result is <code>true</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are many more ways to modify <code>MutableClock</code> just have a look at the JavaDocs, or the test code <code>spock.util.time.MutableClockSpec</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="collection-conditions"><a class="link" href="#collection-conditions">Collection Conditions</a></h3>
<div class="paragraph">
<p>Sometimes, you want to assert the elements of a collection regardless of their order.
The Groovy way to do this is to cast both to <code>Set</code>, i.e. <code>x as Set == [1, 2, 3] as Set</code>.
While this works, it is very noisy.</p>
</div>
<div class="paragraph">
<p>Since Spock 2.1 you can use two new conditions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>x =~ [1, 2, 3]</code> is a lenient match, i.e., checking that x contains at least one instance of every item in the list (same semantics as casting both to <code>Set</code> before comparing).</p>
</li>
<li>
<p><code>x ==~ [1, 2, 3, 3]</code> is a strict match, i.e., checking that x contains exactly the items in the list regardless of their order (using Hamcrest&#8217;s <code>containsInAnyOrder</code> under the hood).</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_lenient_match"><a class="link" href="#_lenient_match">Lenient Match</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def x = [2, 2, 1, 3, 3]
assert x =~ [4, 1, 2]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>x =~ [4, 1, 2]
| |
| false
| 2 differences (66% similarity, 1 missing, 1 extra)
| missing: [4]
| extra: [3]
[2, 1, 3]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_strict_match"><a class="link" href="#_strict_match">Strict Match</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def x = [2, 2, 1, 3, 3]
assert x ==~ [4, 1, 2]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>x ==~ [4, 1, 2]
| |
| false
[2, 2, 1, 3, 3]

Expected: iterable with items [&lt;4&gt;, &lt;1&gt;, &lt;2&gt;] in any order
     but: not matched: <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both operands must either be <code>Iterable</code> or an array for this to work.
Otherwise, it will be treated like the standard groovy <a href="https://groovy-lang.org/operators.html#_find_operator">find operator</a> or <a href="https://groovy-lang.org/operators.html#_match_operator">match operators</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="file-stystem-fixture"><a class="link" href="#file-stystem-fixture">Interact with the file system using <code>FileSystemFixture</code></a></h3>
<div class="paragraph">
<p>In integration tests you often have to prepare the file system for a test.
For trivial cases like creating a single temp directory, you can use the <a href="#temp-dir">@TempDir</a> extension directly.
However, for more complex cases like creating a directory tree <code>FileSystemFixture</code> offers convenience and better readability.</p>
</div>
<div class="sect3">
<h4 id="_examples"><a class="link" href="#_examples">Examples</a></h4>
<div class="listingblock">
<div class="title">Creating a directory tree</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@TempDir
FileSystemFixture fsFixture

def "FileSystemFixture can create a directory structure"() {
  when:
  fsFixture.create {
    dir('src') {
      dir('main') {
        dir('groovy') {
          file('HelloWorld.java') &lt;&lt; 'println "Hello World"'
        }
      }
      dir('test/resources') {
        file('META-INF/MANIFEST.MF') &lt;&lt; 'bogus entry'
        copyFromClasspath('/org/spockframework/smoke/extension/SampleFile.txt')
      }
    }
  }

  then:
  Files.isDirectory(fsFixture.resolve('src/main/groovy'))
  Files.isDirectory(fsFixture.resolve('src/test/resources/META-INF'))
  fsFixture.resolve('src/main/groovy/HelloWorld.java').text == 'println "Hello World"'
  fsFixture.resolve('src/test/resources/META-INF/MANIFEST.MF').text == 'bogus entry'
  fsFixture.resolve('src/test/resources/SampleFile.txt').text == 'HelloWorld\n'
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To get the nice Groovy methods for <code>Path</code>, you need to add a dependency on <code>groovy-nio</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="old-method"><a class="link" href="#old-method">Capture Values for Assertions with <code>old()</code></a></h3>
<div class="paragraph">
<p>It can be helpful to know the old value of an expression before the <code>when:</code> was executed.
This allows you to compare the changes made by a <code>when:</code> block.</p>
</div>
<div class="paragraph">
<p>You can capture the old value of an expression with <code>old(&lt;expr&gt;)</code> in a <code>then:</code> block,
which will return the value of the <code>&lt;expr&gt;</code> before the previous <code>when:</code> block is executed.</p>
</div>
<div class="paragraph">
<p>The usage of the <code>old()</code> method makes a test less fragile, because you can assert the difference,
which was made by the <code>when:</code> block.</p>
</div>
<div class="sect3">
<h4 id="_example_2"><a class="link" href="#_example_2">Example</a></h4>
<div class="listingblock">
<div class="title">Using <code>old()</code> to capture the old value of <code>x</code></div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def "Usage of the old() method"() {
  given:
  def x = 0

  when:
  x++

  then:
  x == old(x) + 1
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parallel-execution"><a class="link" href="#parallel-execution">Parallel Execution</a></h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is an experimental feature for Spock, which is based on the experimental implementation of parallel execution in the JUnit Platform.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Parallel execution has the potential to reduce the overall test execution time.
The actual achievable reduction will heavily depend on the respective codebase and can vary wildly.</p>
</div>
<div class="paragraph">
<p>By default, Spock runs tests sequentially with a single thread.
As of version 2.0, Spock supports parallel execution based on the JUnit Platform.
To enable parallel execution set the <code>runner.parallel.enabled</code> configuration to <code>true</code>.
See <a href="#spock-configuration-file">Spock Configuration File</a> for general information about this file.</p>
</div>
<div class="listingblock">
<div class="title">SpockConfig.groovy</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">runner {
  parallel {
    enabled true
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JUnit Jupiter also supports  <a href="https://junit.org/junit5/docs/5.7.0/user-guide/#writing-tests-parallel-execution">parallel execution</a>, both rely on the JUnit Platform implementation, but function independently of each other.
      If you enable parallel execution in Spock it won&#8217;t affect Jupiter and vice versa.
      The JUnit Platform executes the test engines (Spock, Jupiter) sequentially, so there should not be any interference between engines.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="execution-modes"><a class="link" href="#execution-modes">Execution modes</a></h3>
<div class="paragraph">
<p>Spock supports two execution modes <code>SAME_THREAD</code> and <code>CONCURRENT</code>.
You can define the execution mode explicitly for a specification or feature via the <code>@Execution</code> annotation.
Otherwise, Spock will use the value of <code>defaultSpecificationExecutionMode</code> and <code>defaultExecutionMode</code> respectively, both have <code>CONCURRENT</code> as default value.
Certain <a href="#extensions">extensions</a> also set execution modes when they are applied.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>defaultSpecificationExecutionMode</code> controls what execution mode a specification will use by default.</p>
</li>
<li>
<p><code>defaultExecutionMode</code> controls what execution mode a feature and its iterations (if data driven) will use by default.</p>
</li>
</ul>
</div>
<div id="figure-sequential-sequential-execution" class="literalblock">
<div class="title">Sequential Execution, either <code>runner.parallel.enabled=false</code> or <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features</div>
<div class="content">
<pre>@startgantt
scale 2
[A.test1()] lasts 4 days
then [A.test2()] lasts 8 days
then [B.test1()] lasts 6 days
then [B.test2()] lasts 4 days
@endgantt</pre>
</div>
</div>
<div id="figure-concurrent-concurrent-execution" class="literalblock">
<div class="title"><code>CONCURRENT</code> Specifications, <code>CONCURRENT</code> Features</div>
<div class="content">
<pre>@startgantt
scale 2
[A.test1()] lasts 4 days
[A.test2()] lasts 8 days
[B.test1()] lasts 6 days
[B.test2()] lasts 4 days
@endgantt</pre>
</div>
</div>
<div id="figure-concurrent-sequential-execution" class="literalblock">
<div class="title"><code>CONCURRENT</code> Specifications, <code>SAME_THREAD</code> Features</div>
<div class="content">
<pre>@startgantt
scale 2
[A.test1()] lasts 4 days
then [A.test2()] lasts 8 days
[B.test1()] lasts 6 days
then [B.test2()] lasts 4 days
@endgantt</pre>
</div>
</div>
<div id="figure-sequential-concurrent-execution" class="literalblock">
<div class="title"><code>SAME_THREAD</code> Specifications, <code>CONCURRENT</code> Features</div>
<div class="content">
<pre>@startgantt
scale 2
[A.test1()] lasts 4 days
[A.test2()] lasts 8 days
[B.test1()] lasts 6 days and starts at [A.test2()]'s end
[B.test2()] lasts 4 days and starts at [A.test2()]'s end
@endgantt</pre>
</div>
</div>
<div class="sect3">
<h4 id="_execution_hierarchy"><a class="link" href="#_execution_hierarchy">Execution Hierarchy</a></h4>
<div class="literalblock">
<div class="title">Legend for the following figures</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {

  BackgroundColor #88CCEE
  RoundCorner 10

  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .concurrent * {
      BackgroundColor #88CCEE
      RoundCorner 10
  }

  .samethread * {
      BackgroundColor #DDCC77
      RoundCorner 0
  }

  .write_lock * {
      LineStyle 4
      LineThickness 2.5
      LineColor #117733
  }

  .read_lock * {
      LineStyle 2
      LineThickness 2.5
      LineColor #117733
  }

  .isolated * {
      BackgroundColor #CC6677
      RoundCorner 0
      LineStyle 8
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** Same Thread &lt;&lt;samethread&gt;&gt;
** Concurrent &lt;&lt;concurrent&gt;&gt;
** ResourceLock(READ) &lt;&lt;read_lock&gt;&gt;
** ResourceLock(READ_WRITE) &lt;&lt;write_lock&gt;&gt;
*** Same Thread with Lock &lt;&lt;samethread&gt;&gt;
** Data Driven Feature
*** Data Driven Feature[1]
*** Data Driven Feature[2]
** Isolated &lt;&lt;isolated&gt;&gt;
@endwbs</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The node <code>Same Thread</code> will run in the same thread as its parent.</p>
</li>
<li>
<p>The node <code>Concurrent</code> will be executed in another thread, all concurrent nodes can execute in different threads from each other.</p>
</li>
<li>
<p>The node <code>ResourceLock(READ)</code> will be executed in another thread, but will also acquire a <code>READ</code>-lock for a resource.</p>
</li>
<li>
<p>The node <code>ResourceLock(READ_WRITE)</code> will be executed in another thread, but will also acquire a <code>READ_WRITE</code>-lock for a resource.</p>
</li>
<li>
<p>The node <code>Same Thread with Lock</code> will run in the same thread as its parent thus inheriting the lock.</p>
</li>
<li>
<p>The node <code>Data Driven Feature</code> represents a data driven feature with <code>Data Driven Feature[1]</code> and <code>Data Driven Feature[2]</code> being the iterations.</p>
</li>
<li>
<p>The node <code>Isolated</code> will run exclusively, no other specifications or features will run at the same time.</p>
</li>
</ul>
</div>
<div id="figure-execution-hierarchy-same-thread" class="literalblock">
<div class="title">Single threaded execution</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** SpecB
*** testB1
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#figure-execution-hierarchy-same-thread">Single threaded execution</a> shows the default case when parallel execution is disabled (<code>runner.parallel.enabled=false</code>) or when both specifications (<code>defaultSpecificationExecutionMode</code>) and features (<code>defaultExecutionMode</code>) are set to <code>SAME_THREAD</code>.</p>
</div>
<div id="figure-execution-hierarchy-concurrent-sequential-execution" class="literalblock">
<div class="title">Execution with <code>CONCURRENT</code> Specifications, <code>SAME_THREAD</code></div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
  node {
    :depth(1) {
      BackgroundColor #88CCEE
      RoundCorner 10
    }
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** SpecB
*** testB1
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#figure-execution-hierarchy-concurrent-sequential-execution">Execution with <code>CONCURRENT</code> Specifications, <code>SAME_THREAD</code></a> shows the result of setting <code>defaultSpecificationExecutionMode=CONCURRENT</code> and <code>defaultExecutionMode=SAME_THREAD</code>, the specifications will run concurrently but all features will run in the same thread as their specification.</p>
</div>
<div id="figure-execution-hierarchy-sequential-concurrent-execution" class="literalblock">
<div class="title">Execution with <code>SAME_THREAD</code> Specifications, <code>CONCURRENT</code> Features</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
  node {
    :depth(2) {
      BackgroundColor #88CCEE
      RoundCorner 10
    }
    :depth(3) {
      BackgroundColor #88CCEE
      RoundCorner 10
    }
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** SpecB
*** testB1
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#figure-execution-hierarchy-sequential-concurrent-execution">Execution with <code>SAME_THREAD</code> Specifications, <code>CONCURRENT</code> Features</a> shows the result of setting <code>defaultSpecificationExecutionMode=SAME_THREAD</code> and <code>defaultExecutionMode=CONCURRENT</code>, the specifications will run in the same thread, causing them to run one after the other.
The features inside a specification will run concurrently.</p>
</div>
<div id="figure-execution-hierarchy-concurrent-concurrent-execution" class="literalblock">
<div class="title">Execution with <code>CONCURRENT</code> Specifications, <code>CONCURRENT</code> Features</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
  node {
    :depth(1) {
      BackgroundColor #88CCEE
      RoundCorner 10
    }
    :depth(2) {
      BackgroundColor #88CCEE
      RoundCorner 10
    }
    :depth(3) {
      BackgroundColor #88CCEE
      RoundCorner 10
    }
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** SpecB
*** testB1
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#figure-execution-hierarchy-concurrent-concurrent-execution">Execution with <code>CONCURRENT</code> Specifications, <code>CONCURRENT</code> Features</a> shows the result of setting <code>defaultSpecificationExecutionMode=CONCURRENT</code> and <code>defaultExecutionMode=CONCURRENT</code>, both specifications and features will run concurrently.</p>
</div>
<div class="sect4">
<h5 id="_execution_mode_inheritance"><a class="link" href="#_execution_mode_inheritance">Execution Mode Inheritance</a></h5>
<div class="paragraph">
<p>If nothing else is explicit configured, specifications will use <code>defaultSpecificationExecutionMode</code> and features use <code>defaultExecutionMode</code>.
However, this changes when you set the execution mode explicitly via <code>@Execution</code>.
Each node (specification, feature) checks first if it has an explicit execution mode set,
otherwise it will check its parents for an explicit setting and fall back to the respective defaults otherwise.</p>
</div>
<div class="paragraph">
<p>The following examples have <code>defaultSpecificationExecutionMode=SAME_THREAD</code> and <code>defaultExecutionMode=SAME_THREAD</code>.
If you invert the values <code>SAME_THREAD</code> and <code>CONCURRENT</code> in these examples you will get the inverse result.</p>
</div>
<div id="figure-execution-hierarchy-inheritance-feature-execution" class="literalblock">
<div class="title">Execution with <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features and explicit <code>@Execution</code> on Features</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
  .concurrent * {
      BackgroundColor #88CCEE
      RoundCorner 10
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** @Execution(CONCURRENT)\ntestA2 &lt;&lt;concurrent&gt;&gt;
** SpecB
*** testB1
*** @Execution(CONCURRENT)\ntestB2 &lt;&lt;concurrent&gt;&gt;
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p>In <a href="#figure-execution-hierarchy-inheritance-feature-execution">Execution with <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features and explicit <code>@Execution</code> on Features</a> <code>@Execution</code> is applied on the features and those features and iterations will execute concurrently while the rest will execute in the same thread.</p>
</div>
<div id="figure-execution-hierarchy-inheritance-spec-execution" class="literalblock">
<div class="title">Execution with <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features and explicit <code>@Execution</code> on a Specification</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
  .concurrent * {
      BackgroundColor #88CCEE
      RoundCorner 10
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** @Execution(CONCURRENT)\nSpecB  &lt;&lt;concurrent&gt;&gt;
*** testB1
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p>In <a href="#figure-execution-hierarchy-inheritance-spec-execution">Execution with <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features and explicit <code>@Execution</code> on a Specification</a> <code>@Execution</code> is applied on one specification causing the specification and all its features to run concurrently.
The features execute concurrently since they inherit the explicit execution mode from the specification.</p>
</div>
<div id="figure-execution-hierarchy-inheritance-spec-feature-execution" class="literalblock">
<div class="title">Execution with <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features and explicit <code>@Execution</code> on Features and Specifications</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #DDCC77
  .concurrent * {
      BackgroundColor #88CCEE
      RoundCorner 10
  }
  .samethread * {
      BackgroundColor #DDCC77
      RoundCorner 0
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** @Execution(CONCURRENT)\nSpecB  &lt;&lt;concurrent&gt;&gt;
*** @Execution(SAME_THREAD)\ntestB1 &lt;&lt;samethread&gt;&gt;
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#figure-execution-hierarchy-inheritance-spec-feature-execution">Execution with <code>SAME_THREAD</code> Specifications, <code>SAME_THREAD</code> Features and explicit <code>@Execution</code> on Features and Specifications</a> showcases the combined application of <code>@Execution</code> on a specification and some of its features.
As in the previous example the specification and its features will execute concurrently except <code>testB1</code> since it has its own explicit execution mode set.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resource_locks"><a class="link" href="#_resource_locks">Resource Locks</a></h3>
<div class="paragraph">
<p>With parallel execution comes a new set of challenges for testing, as shared state can be modified and consumed by multiple tests at the same time.</p>
</div>
<div class="paragraph">
<p>A simple example would be two features that test the use a system property, both setting it to a specific value in the respective <code>given</code> block and then executing the code to test the expected behavior.
If they run sequentially then both complete without issue. However, if the run at the same time both <code>given</code> blocks will run before the <code>when</code> blocks and one feature will fail since the system property did not contain the expected value.</p>
</div>
<div class="paragraph">
<p>The above example could simply be fixed if both features are part of the same specification by setting them to run in the same thread with <code>@Execution(SAME_THREAD)</code>.
However, this is not really practicable when the features are in separate specifications.
To solve this issue Spock has support to coordinate access to shared resources via <code>@ResourceLock</code>.</p>
</div>
<div class="paragraph">
<p>With <code>@ResourceLock</code> you can define both a <code>key</code> and a <code>mode</code>. By default, <code>@ResourceLock</code> assumes <code>ResourceAccessMode.READ_WRITE</code>, but you can weaken it to <code>ResourceAccessMode.READ</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ResourceAccessMode.READ_WRITE</code> will enforce exclusive access to the resource.</p>
</li>
<li>
<p><code>ResourceAccessMode.READ</code> will prevent any <code>READ_WRITE</code> locks, but will allow other <code>READ</code> locks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>READ</code>-only locks will isolate tests from others that modify the shared resource, while at the same time allowing tests that also only read the resource to execute.
You should not modify the shared resource when you only hold a <code>READ</code> lock, otherwise the assurances don&#8217;t hold.</p>
</div>
<div class="paragraph">
<p>Certain <a href="#extensions">extensions</a> also set implicit locks when they are applied.</p>
</div>
<div id="figure-lock-contention-basics" class="literalblock">
<div class="title">Two features with <code>@ResourceLock</code></div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #88CCEE
  RoundCorner 10
  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .write_lock * {
      LineStyle 4
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** @ResourceLock("R")\ntestA2 &lt;&lt;write_lock&gt;&gt;
** SpecB
*** @ResourceLock("R")\ntestB1 &lt;&lt;write_lock&gt;&gt;
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
<div class="sect3">
<h4 id="_lock_inheritance"><a class="link" href="#_lock_inheritance">Lock inheritance</a></h4>
<div class="paragraph">
<p>If a parent node has a <code>READ_WRITE</code> lock, it forces its children to run in the same thread.
As <code>READ_WRITE</code> locks cause serialized execution anyway, this is effectively not different from what would happen if the lock would be applied to every child directly.
However, if the parent node has only <code>READ</code> locks, then it allows parallel execution of its children.</p>
</div>
<div id="figure-lock-inherit-iterate-feature" class="literalblock">
<div class="title">Locks on data driven features</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #88CCEE
  RoundCorner 10
  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .samethread * {
      BackgroundColor #DDCC77
      RoundCorner 0
  }

  .write_lock * {
      LineStyle 4
      LineThickness 2.5
      LineColor #117733
  }

  .read_lock * {
      LineStyle 2
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** @ResourceLock("R")\ntestA2 &lt;&lt;write_lock&gt;&gt;
**** testA2[1] &lt;&lt;samethread&gt;&gt;
**** testA2[2] &lt;&lt;samethread&gt;&gt;
** SpecB
*** testB1
*** @ResourceLock(value="R", mode=READ)\nStestB2 &lt;&lt;read_lock&gt;&gt;
**** testB2[1] &lt;&lt;read_lock&gt;&gt;
**** testB2[2] &lt;&lt;read_lock&gt;&gt;
@endwbs</pre>
</div>
</div>
<div id="figure-lock-inherit-spec" class="literalblock">
<div class="title">Locks on spec inherited by features</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #88CCEE
  RoundCorner 10
  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .samethread * {
      BackgroundColor #DDCC77
      RoundCorner 0
  }

  .write_lock * {
      LineStyle 4
      LineThickness 2.5
      LineColor #117733
  }

  .read_lock * {
      LineStyle 2
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** SpecA
*** testA1
*** testA2
** @ResourceLock("R")\nSpecB &lt;&lt;write_lock&gt;&gt;
*** testB1 &lt;&lt;samethread&gt;&gt;
*** testB2 &lt;&lt;samethread&gt;&gt;
**** testB2[1] &lt;&lt;samethread&gt;&gt;
**** testB2[2] &lt;&lt;samethread&gt;&gt;
** @ResourceLock(value="R", mode=READ)\nSpecC &lt;&lt;read_lock&gt;&gt;
*** testC1 &lt;&lt;read_lock&gt;&gt;
*** testC2 &lt;&lt;read_lock&gt;&gt;
**** testC2[1] &lt;&lt;read_lock&gt;&gt;
**** testC2[2] &lt;&lt;read_lock&gt;&gt;
@endwbs</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lock_coarsening"><a class="link" href="#_lock_coarsening">Lock coarsening</a></h4>
<div class="paragraph">
<p>To avoid deadlocks, Spock pulls up locks to the specification, when locks are defined on both the specification and features.
The Specification will then contain all defined locks.
If the features both had <code>READ_WRITE</code> and <code>READ</code> locks for the same resource, then the <code>READ</code> will be merged into the <code>READ_WRITE</code>.</p>
</div>
<div id="figure-lock-coarsening-before" class="literalblock">
<div class="title">Lock coarsening - before</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #88CCEE
  RoundCorner 10
  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .samethread * {
      BackgroundColor #DDCC77
      RoundCorner 0
  }

  .write_lock * {
      LineStyle 4
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** @ResourceLock("S")\nSpecA &lt;&lt;write_lock&gt;&gt;
*** @ResourceLock("A")\ntestA1 &lt;&lt;write_lock&gt;&gt;
*** @ResourceLock("B")\ntestA2 &lt;&lt;write_lock&gt;&gt;
@endwbs</pre>
</div>
</div>
<div id="figure-lock-coarsening-after" class="literalblock">
<div class="title">Lock coarsening - after</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #88CCEE
  RoundCorner 10
  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .samethread * {
      BackgroundColor #DDCC77
      RoundCorner 0
  }

  .write_lock * {
      LineStyle 4
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** @ResourceLock("A")\n@ResourceLock("B")\n@ResourceLock("S")\nSpecA &lt;&lt;write_lock&gt;&gt;
*** testA1 &lt;&lt;samethread&gt;&gt;
*** testA2 &lt;&lt;samethread&gt;&gt;
@endwbs</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="isolated-execution"><a class="link" href="#isolated-execution">Isolated Execution</a></h4>
<div class="paragraph">
<p>Sometimes, you want to modify and test something that affects every other feature, you could put a <code>READ</code> <code>@ResourceLock</code> on <em>every</em> feature, but that is impractical.
The <code>@Isolated</code> extension enforces, that only this feature runs without any other features running at the same time.
You can think of this as an implicit global lock.</p>
</div>
<div class="paragraph">
<p>As with other locks, the features in an <code>@Isolated</code> specification will run in <code>SAME_THREAD</code> mode.
<code>@Isolated</code> can only be applied at the specification level so if you have a large specification and only need it for a few features,
you might want to consider splitting the spec into <code>@Isolated</code> and non isolated.</p>
</div>
<div id="figure-isolated" class="literalblock">
<div class="title"><code>@Isolated</code> execution</div>
<div class="content">
<pre>@startwbs
&lt;style&gt;
wbsDiagram {
  BackgroundColor #88CCEE
  RoundCorner 10
  node {
    :depth(0) {
      BackgroundColor #DDCC77
      RoundCorner 0
    }
  }

  .isolated * {
      BackgroundColor #CC6677
      RoundCorner 0
      LineStyle 8
      LineThickness 2.5
      LineColor #117733
  }
}
&lt;/style&gt;
skinparam shadowing false
* SpockEngine
** @Isolated\nSpecA  &lt;&lt;isolated&gt;&gt;
*** testA1
*** testA2
** SpecB
*** testB1
*** testB2
**** testB2[1]
**** testB2[2]
@endwbs</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parallel-thread-pool"><a class="link" href="#parallel-thread-pool">Parallel Thread Pool</a></h3>
<div class="paragraph">
<p>With parallel execution enabled, specifications and features can execute concurrently.
You can control the size of the thread pool that executes the features.
Spock uses <code>Runtime.getRuntime().availableProcessors()</code> to determine the available processors.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dynamic(BigDecimal factor)</code> - Computes the desired parallelism based on the number of available processors multiplied by the <code>factor</code> and rounded down to the nearest integer.
For example a factor of <code>0.5</code> will use half your processors.</p>
</li>
<li>
<p><code>dynamicWithReservedProcessors(BigDecimal factor, int reservedProcessors)</code> - Same as <code>dynamic</code> but ensures that the given amount of <code>reservedProcessors</code> is not used.
The <code>reservedProcessors</code> are counted against the available cores not the result of the factor.</p>
</li>
<li>
<p><code>fixed(int parallelism)</code> - Uses the given amount of threads.</p>
</li>
<li>
<p><code>custom(int parallelism, int minimumRunnable, int maxPoolSize, int corePoolSize, int keepAliveSeconds)</code> - Allows complete control over the threadpool.
However, it should only be used when the other options are insufficient, and you need that extra bit of control.
Check the Javadoc of <code>spock.config.ParallelConfiguration</code> for a detailed description the parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Spock uses <code>dynamicWithReservedProcessors(1.0, 2)</code> that is all your logical processors minus <code>2</code>.</p>
</div>
<div class="paragraph">
<p>If the calculated parallelism is less than <code>2</code>, then Spock will execute single threaded, basically the same as <code>runner.parallel.enabled=false</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example SpockConfig.groovy with <code>fixed</code> setting</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">runner {
  parallel {
    enabled true
    fixed(4)
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modules"><a class="link" href="#_modules">Modules</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="junit-4"><a class="link" href="#junit-4">JUnit 4 Module</a></h3>
<div class="paragraph">
<p>Integration with JUnit 4 features for Spock 2+ (which internally uses JUnit Platform - part of JUnit 5). Please add dependency <a href="https://search.maven.org/artifact/org.spockframework/spock-junit4"><code>org.spockframework:spock-junit4</code></a> to your project.</p>
</div>
<div class="paragraph">
<p>The module is required for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>running JUnit 4 rules and class ruless (<code>@Rule</code>/<code>@ClassRule</code>)</p>
</li>
<li>
<p>using JUnit 4&#8217;s test fixture annotations (<code>@BeforeClass</code>, <code>@Before</code>, <code>@After</code>, <code>@AfterClass</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This module does its best to support old features from JUnit 4, however, users are encouraged to migrate to the native Spock counterparts.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_guice_module"><a class="link" href="#_guice_module">Guice Module</a></h3>
<div class="paragraph">
<p>Integration with the <a href="https://github.com/google/guice">Guice</a> IoC container. Please add dependency <a href="https://search.maven.org/artifact/org.spockframework/spock-guice"><code>org.spockframework:spock-guice</code></a> to your project. For examples see the specs in the
<a href="https://github.com/spockframework/spock/tree/master/spock-guice/src/test/groovy/org/spockframework/guice">codebase</a>.</p>
</div>
<div class="paragraph">
<p>With Spock 1.2+ detached mocks are automatically attached to the <code>Specification</code> if they are injected via <code>@Inject</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-module"><a class="link" href="#spring-module">Spring Module</a></h3>
<div class="paragraph">
<p>The Spring module enables integration with <a href="https://docs.spring.io/spring/docs/4.1.5.RELEASE/spring-framework-reference/html/testing.html#testcontext-framework">Spring TestContext Framework</a>.
It supports the following spring annotations <code>@ContextConfiguration</code> and <code>@ContextHierarchy</code>. Furthermore, it supports the meta-annotation <code>@BootstrapWith</code> and so any annotation that is annotated with <code>@BootstrapWith</code> will also work, such as <code>@SpringBootTest</code>, <code>@WebMvcTest</code>. Please add dependency <a href="https://search.maven.org/artifact/org.spockframework/spock-spring"><code>org.spockframework:spock-spring</code></a> to your project.</p>
</div>
<div class="sect3">
<h4 id="SpringMocks"><a class="link" href="#SpringMocks">Mocks</a></h4>
<div class="paragraph">
<p>Spock 1.1 introduced the <code>DetachedMockFactory</code> and the <code>SpockMockFactoryBean</code> which allow the creation of Spock mocks outside of a specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although the mocks can be created outside of a specification, they only work properly inside the scope of a specification.
      All interactions with them until they are attached to one, are handled by the default behavior and not recorded.
     <br>
      Furthermore, mocks can only be attached to one <code>Specification</code> instance at a time so keep that in mind when using multi-threaded executions
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_java_config"><a class="link" href="#_java_config">Java Config</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class DetachedJavaConfig {
  def mockFactory = new DetachedMockFactory()

  @Bean
  GreeterService serviceMock() {
    return mockFactory.Mock(GreeterService)
  }

  @Bean
  GreeterService serviceStub() {
    return mockFactory.Stub(GreeterService)
  }

  @Bean
  GreeterService serviceSpy() {
    return mockFactory.Spy(GreeterServiceImpl)
  }

  @Bean
  FactoryBean&lt;GreeterService&gt; alternativeMock() {
    return new SpockMockFactoryBean(GreeterService)
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_xml"><a class="link" href="#_xml">XML</a></h5>
<div class="paragraph">
<p>Spock has spring namespace support, so if you declare the spock namespace with <code>xmlns:spock="https://www.spockframework.org/spring"</code> you get access to the convenience functions for creating mocks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:spock="http://www.spockframework.org/spring"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.spockframework.org/spring https://www.spockframework.org/spring/spock.xsd"&gt;

  &lt;spock:mock id="serviceMock" class="org.spockframework.spring.docs.GreeterService"/&gt;   <i class="conum" data-value="1"></i><b>(1)</b>
  &lt;spock:stub id="serviceStub" class="org.spockframework.spring.docs.GreeterService"/&gt;   <i class="conum" data-value="2"></i><b>(2)</b>
  &lt;spock:spy id="serviceSpy" class="org.spockframework.spring.docs.GreeterServiceImpl"/&gt; <i class="conum" data-value="3"></i><b>(3)</b>

  &lt;bean id="someExistingBean" class="java.util.ArrayList"/&gt;                              <i class="conum" data-value="4"></i><b>(4)</b>
  &lt;spock:wrapWithSpy ref="someExistingBean"/&gt;                                            <i class="conum" data-value="4"></i><b>(4)</b>

  &lt;bean id="alternativeMock" class="org.spockframework.spring.xml.SpockMockFactoryBean"&gt; <i class="conum" data-value="5"></i><b>(5)</b>
    &lt;constructor-arg value="org.spockframework.spring.docs.GreeterService"/&gt;
    &lt;property name="mockNature" value="MOCK"/&gt;                                           <i class="conum" data-value="6"></i><b>(6)</b>
  &lt;/bean&gt;


&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a <code>Mock</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates a <code>Stub</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates a <code>Spy</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Wraps an existing bean with a <code>Spy</code>. Fails fast if referenced bean is not found.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If you don&#8217;t want to use the special namespace support you can create the beans via the <code>SpockMockFactoryBean</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>mockNature</code> can be <code>MOCK</code>, <code>STUB</code>, or <code>SPY</code> and defaults to <code>MOCK</code> if not declared.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_usage"><a class="link" href="#_usage">Usage</a></h5>
<div class="paragraph">
<p>To use the mocks just inject them like any other bean and configure them as usual.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Autowired @Named('serviceMock')
GreeterService serviceMock

@Autowired @Named('serviceStub')
GreeterService serviceStub

@Autowired @Named('serviceSpy')
GreeterService serviceSpy

@Autowired @Named('alternativeMock')
GreeterService alternativeMock

def "mock service"() {
  when:
  def result = serviceMock.greeting

  then:
  result == 'mock me'
  1 * serviceMock.getGreeting() &gt;&gt; 'mock me'
}

def "sub service"() {
  given:
  serviceStub.getGreeting() &gt;&gt; 'stub me'

  expect:
  serviceStub.greeting == 'stub me'
}

def "spy service"() {
  when:
  def result = serviceSpy.greeting

  then:
  result == 'Hello World'
  1 * serviceSpy.getGreeting()
}

def "alternative mock service"() {
  when:
  def result = alternativeMock.greeting

  then:
  result == 'mock me'
  1 * alternativeMock.getGreeting() &gt;&gt; 'mock me'
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_annotation_driven"><a class="link" href="#_annotation_driven">Annotation driven</a></h5>
<div class="paragraph">
<p>Spock 1.2 adds support for exporting mocks from a <code>Specification</code> into an <code>ApplicationContext</code>. This was inspired by
Spring Boot&#8217;s <code>@MockBean</code>(realised via Mockito) but adapted to fit into Spock style. It does not require any Spring Boot dependencies,
however it requires Spring Framework 4.3.5 or greater to work.</p>
</div>
<div class="sect5">
<h6 id="_using_springbean"><a class="link" href="#_using_springbean">Using <code>@SpringBean</code></a></h6>
<div class="paragraph">
<p>Registers mock/stub/spy as a spring bean in the test context.</p>
</div>
<div class="paragraph">
<p>To use <code>@SpringBean</code> you have to use a strongly typed field <code>def</code> or <code>Object</code> won&#8217;t work. You also need to directly assign the
<code>Mock</code>/<code>Stub</code>/<code>Spy</code> to the field using the standard Spock syntax. You can even use the initializer blocks to define common behavior,
however they are only picked up once they are attached to the <code>Specification</code>.</p>
</div>
<div class="paragraph">
<p><code>@SpringBean</code> definitions can replace existing Beans in your <code>ApplicationContext</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spock&#8217;s <code>@SpringBean</code> actually creates a proxy in the <code>ApplicationContext</code> which forwards everything to the current
      mock instance. The type of the proxy is determined by the type of the annotated field.
     <br>
      The proxy attaches itself to the current mock in the setup phase, that is why the mock must be created when the field is initialized.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@SpringBean
Service1 service1 = Mock()

@SpringBean
Service2 service2 = Stub() {
  generateQuickBrownFox() &gt;&gt; "blubb"
}

def "injection with stubbing works"() {
  expect:
  service2.generateQuickBrownFox() == "blubb"
}

def "mocking works was well"() {
  when:
  def result = service1.generateString()

  then:
  result == "Foo"
  1 * service1.generateString() &gt;&gt; "Foo"
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
As with Spring&#8217;s own <code>@MockBean</code> this will modify your <code>ApplicationContext</code>, and will create an unique context for your
         <code>Specification</code> preventing it from being reused by Spring&#8217;s
         <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/testing.html#testcontext-ctx-management-caching">Context Caching</a>
         outside of the current <code>Specification</code>.
        <br>
         If you are using a small context this won&#8217;t matter much, but if it is a heavy context you might want to use
         the other approaches, e.g., using the <code>DetachedMockFactory</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_using_springspy"><a class="link" href="#_using_springspy">Using <code>@SpringSpy</code></a></h6>
<div class="paragraph">
<p>If you want to spy on an existing bean, you can use the <code>@SpringSpy</code> annotation to wrap the bean in a spy.
As with <code>@SpringBean</code> the field must be of the type you want to spy on, however you cannot use an initializer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@SpringSpy
Service2 service2

@Autowired
Service1 service1

def "default implementation is used"() {
  expect:
  service1.generateString() == "The quick brown fox jumps over the lazy dog."
}

def "mocking works was well"() {
  when:
  def result = service1.generateString()

  then:
  result == "Foo"
  1 * service2.generateQuickBrownFox() &gt;&gt; "Foo"
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_using_stubbeans"><a class="link" href="#_using_stubbeans">Using <code>@StubBeans</code></a></h6>
<div class="paragraph">
<p><code>@StubBeans</code> registers plain <code>Stub</code> instances in an <code>ApplicationContext</code>.
Use this if you just need to satisfy some dependencies without actually doing anything with these stubs.
If you need to control the stubs, e.g., configure return values then use <code>@SpringBean</code> instead.
Like <code>@SpringBean</code> <code>@StubBeans</code> also replaced existing BeanDefinitions,so you can use it to remove real beans from an ApplicationContext.
<code>@StubBeans</code> can be replaced by <code>@SpringBean</code>, this can be useful if you need to replace some <code>@StubBeans</code> defined in a parent class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@StubBeans(Service2)
@ContextConfiguration(classes = DemoMockContext)
class StubBeansExamples extends Specification {</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_spring_boot"><a class="link" href="#_spring_boot">Spring Boot</a></h5>
<div class="paragraph">
<p>The recommended way to use Spock mocks in <code>@WebMvcTest</code> or other <code>@SpringBootTest</code>-style tests,
is to use the <code>@SpringBean</code> and <code>@SpringSpy</code> annotations as shown above.</p>
</div>
<div class="paragraph">
<p>Alternatively you can use an embedded config annotated with <code>@TestConfiguration</code> and to create the mocks using the <code>DetachedMockFactory</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@WebMvcTest
class WebMvcTestIntegrationSpec extends Specification {

  @Autowired
  MockMvc mvc

  @Autowired
  HelloWorldService helloWorldService

  def "spring context loads for web mvc slice"() {
    given:
    helloWorldService.getHelloMessage() &gt;&gt; 'hello world'

    expect: "controller is available"
    mvc.perform(MockMvcRequestBuilders.get("/"))
      .andExpect(status().isOk())
      .andExpect(content().string("hello world"))
  }

  @TestConfiguration
  static class MockConfig {
    def detachedMockFactory = new DetachedMockFactory()

    @Bean
    HelloWorldService helloWorldService() {
      return detachedMockFactory.Stub(HelloWorldService)
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more examples see the specs in the <a href="https://github.com/spockframework/spock/tree/master/spock-spring/src/test/groovy/org/spockframework/spring">codebase</a> and <a href="https://github.com/spockframework/spock/tree/master/spock-spring/boot-test/src/test/groovy/org/spockframework/boot">boot examples</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scopes"><a class="link" href="#_scopes">Scopes</a></h4>
<div class="paragraph">
<p>Spock ignores bean that is not a <code>singleton</code> (in the <code>singleton</code> scope) by default. To enable mocks to work for scoped beans
you need to add <code>@ScanScopedBeans</code> to the spec and make sure that the scope allows access to the bean during the setup phase.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>request</code> and <code>session</code> scope will throw exceptions by default, if there is no active request/session.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can limit the scanning to certain scopes by using the <code>value</code> property of <code>@ScanScopedBeans</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_shared_fields_injection"><a class="link" href="#_shared_fields_injection">Shared fields injection</a></h4>
<div class="paragraph">
<p>Due to certain limitations, injection into shared fields is not enabled by default but can be opted-in to.
Refer to javadoc of <code>org.spockframework.spring.EnableSharedInjection</code> for further information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tapestry_module"><a class="link" href="#_tapestry_module">Tapestry Module</a></h3>
<div class="paragraph">
<p>Integration with the <a href="https://tapestry.apache.org/tapestry5/">Tapestry5</a> IoC container. Please add dependency <a href="https://search.maven.org/artifact/org.spockframework/spock-tapestry"><code>org.spockframework:spock-tapestry</code></a> to your project. For examples see the specs in the
<a href="https://github.com/spockframework/spock/tree/master/spock-tapestry/src/test/groovy/org/spockframework/tapestry">codebase</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unitils_module"><a class="link" href="#_unitils_module">Unitils Module</a></h3>
<div class="paragraph">
<p>Integration with the <a href="https://www.unitils.org/">Unitils</a> library. Please add dependency <a href="https://search.maven.org/artifact/org.spockframework/spock-unitils"><code>org.spockframework:spock-unitils</code></a> to your project. For examples see the specs in the
<a href="https://github.com/spockframework/spock/tree/master/spock-unitils/src/test/groovy/org/spockframework/unitils">codebase</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_grails_module"><a class="link" href="#_grails_module">Grails Module</a></h3>
<div class="paragraph">
<p>The Grails plugin has moved to its own <a href="https://github.com/spockframework/spock-grails">GitHub project</a>. It has legacy status and was last released for <a href="https://search.maven.org/artifact/org.spockframework/spock-grails">Spock 0.7 and Groovy versions 1.8 and 2.0</a>, because it is no longer necessary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Grails 2.3 and higher have built-in Spock support and do not require a plugin.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_groovy_syntax_useful_for_spock"><a class="link" href="#_groovy_syntax_useful_for_spock">Groovy Syntax Useful for Spock</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_merge_2_maps"><a class="link" href="#_merge_2_maps">Merge 2 Maps</a></h3>
<div class="paragraph">
<p>Let&#8217;s say our first map is <code>[a: true, b: false]</code> and the second <code>[a:false]</code>. To merge them and get
<code>[a: false, b:false]</code>, we can use plus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">assert [ a: true, b: false ] + [ a: false ] == [ a: false, b: false ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or left shift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">assert [ a: true, b: false ] &lt;&lt; [ a: false ] == [ a: false, b: false ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference is that <code>&lt;&lt;</code>
<a href="https://github.com/groovy/groovy-core/blob/GROOVY_2_4_X/src/main/org/codehaus/groovy/runtime/DefaultGroovyMethods.java#L12296">adds the right hand map into the left hand map</a>.
When we use <code>+</code>, it
<a href="https://github.com/groovy/groovy-core/blob/GROOVY_2_4_X/src/main/org/codehaus/groovy/runtime/DefaultGroovyMethods.java#L7433">constructs a new Map based on the LHS</a>,
and adds the right hand map into it</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We also have <code>-</code> that acts accordingly
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="release-notes"><a class="link" href="#release-notes">Release Notes</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_2_4_tbd"><a class="link" href="#_2_4_tbd">2.4 (tbd)</a></h3>
<div class="paragraph">
<p><em>This is a summary of the highlights of the milestone releases</em></p>
</div>
<div class="sect3">
<h4 id="_highlights"><a class="link" href="#_highlights">Highlights</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for combining two or more data providers using cartesian product spockIssue:1062[]</p>
</li>
<li>
<p>Add support for a <code>filter</code> block after a <code>where</code> block to filter out unwanted iterations spockPull:1927[]</p>
</li>
<li>
<p>Add <a href="#block-listener"><code>IBlockListener</code></a> extension point to listen to block execution events within feature methods spockPull:1575[]</p>
</li>
<li>
<p>Add support for defining condition blocks with implicit assertions in helper methods annotated with <code>@Verify</code> or <code>@VerifyAll</code> spockPull:2112[]</p>
</li>
<li>
<p>Spock now supports pluggable <a href="#mock-makers">mock makers</a> loaded via ServiceLoader spockPull:1746[]</p>
<div class="ulist">
<ul>
<li>
<p>This allows external libraries to contribute mocking logic to Spock and use the same API for the users</p>
</li>
<li>
<p>You can select the used mock maker during mock creation: <code>Mock(mockMaker:MockMakers.byteBuddy)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Added <a href="#mock-makers-mockito">mockito</a> mock maker spockPull:1753[] which supports:</p>
<div class="ulist">
<ul>
<li>
<p>Mocking of final classes and final methods</p>
</li>
<li>
<p>Mocking of static methods</p>
</li>
<li>
<p>Mocking of classes and interface from different classloaders spockPull:1878[]</p>
</li>
<li>
<p>Requires <code>org.mockito:mockito-core</code> &gt;= 4.11 in the test class path</p>
</li>
</ul>
</div>
</li>
<li>
<p>Added support for mocking of static methods also for Java code with the new API <code>SpyStatic()</code> spockPull:1756[]</p>
<div class="ulist">
<ul>
<li>
<p>The <a href="#static-mocks">static mock methods</a> will delegate the creation to the mock makers</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add <a href="#verify-each">verifyEach</a> method to perform assertions on each element of an <code>Iterable</code> spockPull:1887[], spockPull:2043[]</p>
</li>
<li>
<p>Add <a href="#parameter-injection">annotation extensions for parameters</a> spockPull:1599[]</p>
</li>
<li>
<p>Add support for <a href="#extension-store">keeping state in extensions</a> spockPull:1692[]</p>
</li>
<li>
<p>Add <a href="#spock-interceptors">feature-scoped interceptors</a> spockPull:1844[]</p>
</li>
<li>
<p>Add <code>@Snapshot</code> extension for <a href="#snapshot-testing">snapshot testing</a> spockPull:1873[]</p>
</li>
<li>
<p>Add <code>!!</code> as <a href="#opt-out-of-condition-handling">opt-out operator for assertions</a> spockPull:1532[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_changes"><a class="link" href="#_breaking_changes">Breaking Changes</a></h4>
<div class="ulist">
<ul>
<li>
<p><em>This affects users of the <code>@Snapshot</code> extension, only if you were using the snapshotter in parent specification classes.</em><br>
<code>@Snapshot</code> used to look up snapshots in directories named after the class containing feature methods. Now, the snapshots will be loaded from directories named after the bottom class in the specification hierarchy. The motivation of the change is to allow users to define features in base specification classes, but overwrite expected snapshots per child specification.
spockPull:2112[]</p>
</li>
<li>
<p><em>Most users will probably be unaffected by this change as it only becomes relevant in a multithreaded situation where multiple threads do interaction invocations that care about shared state.</em><br>
Calculated responses for interactions (<code>&gt;&gt; { &#8230;&#8203; }</code>) previously were all executed synchronized on the respective mock controller instance, so could safely mutate shared state to a certain degree, even if the invocations were happening
on different threads.
This also caused that one response calculation could not wait on something happening in another response calculation, as they were all executed sequentially due to the synchronization.
Starting with this release, the response calculations are no longer happening synchronized.
If you depend on shared state in such calculations, you now have to make sure yourself, that this is done in a thread-safe manner.
spockPull:1910[]</p>
</li>
<li>
<p><em>This should not affect most users, only if you were subclassing <code>SingleResponseGenerator</code> and doing unusual things.</em><br>
<code>SingleResponseGenerator#isAtEndOfCycle</code> is now <code>final</code> and <code>SingleResponseGenerator#doRespond</code> is now <code>protected</code>.
When subclassing <code>SingleResponseGenerator</code> it does not make sense to override the first method, and it does not make sense to call the second method from somewhere else.
spockPull:1910[]</p>
</li>
<li>
<p>Calling <code>old(&#8230;&#8203;)</code> with multiple arguments is now a compilation error. Previously the additional arguments were simply ignored.</p>
</li>
<li>
<p>Creating <code>GroovyMock</code>/<code>GroovyStub</code>/<code>GroovySpy</code> for an already mocked type will now fail.</p>
</li>
<li>
<p>Creating a global <code>GroovyMock</code>/<code>GroovyStub</code>/<code>GroovySpy</code> when <a href="#parallel-execution">parallel execution</a> is enabled,
will now require that the spec is annotated with <a href="#isolated-execution">@Isolated</a> or <code>@ResourceLock(org.spockframework.runtime.model.parallel.Resources.META_CLASS_REGISTRY)</code>. See <a href="#global-mocks-parallel-execution">Global mocks and parallel execution</a> spockPull:1848[]</p>
</li>
<li>
<p><code>@TempDir</code> <code>spock.tempDir.keep</code> has been replaced by <code>spock.tempdir.cleanup</code>. See <a href="#temp-dir-cleanup">TempDir Cleanup</a> spockPull:1525[]</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_m6_2025_04_15"><a class="link" href="#_2_4_m6_2025_04_15">2.4-M6 (2025-04-15)</a></h3>
<div class="sect3">
<h4 id="_highlights_2"><a class="link" href="#_highlights_2">Highlights</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for defining condition blocks with implicit assertions in helper methods annotated with <code>@Verify</code> or <code>@VerifyAll</code> spockPull:2112[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_changes_2"><a class="link" href="#_breaking_changes_2">Breaking Changes</a></h4>
<div class="ulist">
<ul>
<li>
<p><em>This affects users of the <code>@Snapshot</code> extension, only if you were using the snapshotter in parent specification classes.</em><br>
<code>@Snapshot</code> used to look up snapshots in directories named after the class containing feature methods. Now, the snapshots will be loaded from directories named after the bottom class in the specification hierarchy. The motivation of the change is to allow users to define features in base specification classes, but overwrite expected snapshots per child specification.
spockPull:2112[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc"><a class="link" href="#_misc">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Improve publish module-alignment metadata spockPull:2082[]</p>
</li>
<li>
<p>Improve render multidimensional arrays in comparisons and invocation matchers spockPull:2107[]</p>
</li>
<li>
<p>Improve replace unnecessary reflection spockPull:2115[]</p>
</li>
<li>
<p>Fix ExtensionException in OSGi environment for global extension spockIssue:2076[]</p>
<div class="ulist">
<ul>
<li>
<p>This issue was introduced with spockPull:1995[]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fix <code>@RestoreSystemProperties</code> not restoring state between iterations of a data-driven feature spockIssue:2104[]</p>
</li>
<li>
<p>Fix <code>VerifyError: Stack map does not match the one at exception handler</code> introduced in 2.4-M5 spockIssue:2080[]</p>
</li>
<li>
<p>Fix throw <code>SpockMultipleFailuresError</code> instead of a generic <code>MultipleFailuresError</code> in case of multiple failed assertions spockPull:2112[]</p>
</li>
<li>
<p>Fix cross-multiplication of multi-assignment data providers spockPull:2078[]</p>
</li>
<li>
<p>Fix using the same previous data table column multiple times in the same cell spockPull:2084[]</p>
</li>
<li>
<p>Fix unintuitive behavior by removing the optimization which data provider is remembered in a multiplication spockPull:2119[]</p>
</li>
<li>
<p>Fix several bugs in cross-multiplication implementation spockPull:2123[]</p>
</li>
<li>
<p>Fix filter blocks with shared fields and derived data variables spockPull:2088[]</p>
</li>
<li>
<p>Fix combined labels with comments being ignored spockPull:2121[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Andreas Turban, BjÃ¶rn Kautler, Christoph Loy, Marcin ZajÄczkowski, Pavlo Shevchenko</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_m5_2025_01_07"><a class="link" href="#_2_4_m5_2025_01_07">2.4-M5 (2025-01-07)</a></h3>
<div class="sect3">
<h4 id="_highlights_3"><a class="link" href="#_highlights_3">Highlights</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for combining two or more data providers using cartesian product spockIssue:1062[]</p>
</li>
<li>
<p>Add support for a <code>filter</code> block after a <code>where</code> block to filter out unwanted iterations spockPull:1927[]</p>
</li>
<li>
<p>Add <a href="#block-listener"><code>IBlockListener</code></a> extension point to listen to block execution events within feature methods spockPull:1575[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc_2"><a class="link" href="#_misc_2">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add <code>globalTimeout</code> to the  <code>@Timeout</code> extension to apply a timeout to all features in a specification, configurable via the Spock configuration file spockPull:1986[]</p>
</li>
<li>
<p>Add new <a href="#default-value-provider"><code>IDefaultValueProviderExtension</code></a> extension point to add support for special classes in the Stub&#8217;s default <code>EmptyOrDummyResponse</code> spockPull:1994[]</p>
</li>
<li>
<p>Add support for Groovy-4-style range expressions spockIssue:1956[]</p>
</li>
<li>
<p>Add <code>IStatelessAnnotationDrivenExtension</code> to allow a single extension instance to be reused across all specifications spockPull:2055[]</p>
</li>
<li>
<p>Add new well-known versions to <code>Jvm</code> helper to support versions up to <code>29</code> spockPull:2057[]</p>
<div class="ulist">
<ul>
<li>
<p>Built-in extensions have been updated to use this new interface where applicable</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add best-effort error reporting for interactions on final methods when using the <code>byte-buddy</code> mock maker spockIssue:2039[]</p>
</li>
<li>
<p>Add support for <code>@FailsWith</code> to assert an exception message spockIssue:2039[]</p>
</li>
<li>
<p>Add support for accessing the <code>IStore</code> via <code>ISpecificationContext</code> spockPull:2064[]</p>
</li>
<li>
<p>Add support for ContextClassLoader when loading optional classes via <code>ReflectionUtil</code> spockPull:1995[]</p>
<div class="ulist">
<ul>
<li>
<p>This enables the loading of optional classes in, e.g., OSGi environments</p>
</li>
</ul>
</div>
</li>
<li>
<p>Improve <code>@Timeout</code> extension will now use virtual threads if available spockPull:1986[]</p>
</li>
<li>
<p>Improve mock argument matching; types constraints or arguments in interactions can now handle primitive types like <code>_ as int</code> spockIssue:1974[]</p>
</li>
<li>
<p>Improve <code>verifyEach</code> to accept an optional second index parameter for the assertion block closure spockPull:2043[]</p>
</li>
<li>
<p>Improve size of data providers is no longer calculated multiple times but only once spockPull:2032[]</p>
</li>
<li>
<p>Improve documentation about data providers and <code>size()</code> calls spockIssue:2022[]</p>
</li>
<li>
<p>Improve <code>EmbeddedSpecRunner</code> and <code>EmbeddedSpecCompiler</code> now support the construction with a custom <code>ClassLoader</code> spockPull:1988[]</p>
<div class="ulist">
<ul>
<li>
<p>This allows the use of these classes in an OSGi environment, where the class imports in the embedded spec are not visible to the Spock OSGi bundle ClassLoader</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fix a mocking issue with the ByteBuddy MockMaker when using multiple classloaders in Java 21 spockIssue:2017[]</p>
</li>
<li>
<p>Fix the mocking of final classes via <code>@SpringBean</code> and <code>@SpringSpy</code> spockIssue:1960[]</p>
</li>
<li>
<p>Fix exception when using <code>@RepeatUntilFailure</code> with a data provider with unknown iteration amount spockPull:2031[]</p>
</li>
<li>
<p>Fix compile error with single explicit assert in switch expression branch spockIssue:1845[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Andreas Turban, BjÃ¶rn Kautler, Christoph Loy, Marcin ZajÄczkowski</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_m4_2024_03_21"><a class="link" href="#_2_4_m4_2024_03_21">2.4-M4 (2024-03-21)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Fix nested regex finding in conditions spockPull:1931[]</p>
<div class="ulist">
<ul>
<li>
<p>Fixes spockIssue:1930[] a regression introduced in M2 by spockPull:1921[]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: BjÃ¶rn Kautler,</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_m3_2024_03_21"><a class="link" href="#_2_4_m3_2024_03_21">2.4-M3 (2024-03-21)</a></h3>
<div class="sect3">
<h4 id="_breaking_changes_3"><a class="link" href="#_breaking_changes_3">Breaking Changes</a></h4>
<div class="ulist">
<ul>
<li>
<p><em>Most users will probably be unaffected by this change as it only becomes relevant in a multithreaded situation where multiple threads do interaction invocations that care about shared state.</em><br>
Calculated responses for interactions (<code>&gt;&gt; { &#8230;&#8203; }</code>) previously were all executed synchronized on the respective mock controller instance, so could safely mutate shared state to a certain degree, even if the invocations were happening
on different threads.
This also caused that one response calculation could not wait on something happening in another response calculation, as they were all executed sequentially due to the synchronization.
Starting with this release, the response calculations are no longer happening synchronized.
If you depend on shared state in such calculations, you now have to make sure yourself, that this is done in a thread-safe manner.
spockPull:1910[]</p>
</li>
<li>
<p><em>This should not affect most users, only if you were subclassing <code>SingleResponseGenerator</code> and doing unusual things.</em><br>
<code>SingleResponseGenerator#isAtEndOfCycle</code> is now <code>final</code> and <code>SingleResponseGenerator#doRespond</code> is now <code>protected</code>.
When subclassing <code>SingleResponseGenerator</code> it does not make sense to override the first method, and it does not make sense to call the second method from somewhere else.
spockPull:1910[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc_3"><a class="link" href="#_misc_3">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add option to create Groovy spies with existing instances spockPull:1825[]</p>
</li>
<li>
<p>Improve Spock&#8217;s documentation by automatically linking source snippets in the docs to the code spockPull:1904[]</p>
</li>
<li>
<p>Improve <code>@Retry</code> extension parallel-safeness spockPull:1701[]</p>
</li>
<li>
<p>Improve <code>@RepeatUntilFailure</code> by allowing multiple annotations in the same specification spockPull:1912[]</p>
</li>
<li>
<p><span class="line-through">Improve collection matchers by supporting them in nested in complex assertions spockPull:1921[]</span></p>
</li>
<li>
<p>Improve stacktrace filtering by also handling suppressed exceptions spockPull:1923[]</p>
</li>
<li>
<p>Fix possible deadlock when blocking in mock response generators spockPull:1910[]</p>
<div class="ulist">
<ul>
<li>
<p>Fix fallout of spockPull:1885[] introduced in M2</p>
</li>
<li>
<p>This actually fixes the issues: spockIssue:583[], spockIssue:1882[], spockIssue:1899[]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fix possible <code>StackOverflowError</code> when filtering exception cause loops spockPull:1922[]</p>
</li>
<li>
<p>Fix NullPointerException after exception in data provider spockPull:1925[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Andreas Turban, BjÃ¶rn Kautler, Marcin ZajÄczkowski</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_m2_2024_02_26"><a class="link" href="#_2_4_m2_2024_02_26">2.4-M2 (2024-02-26)</a></h3>
<div class="sect3">
<h4 id="_highlights_4"><a class="link" href="#_highlights_4">Highlights</a></h4>
<div class="ulist">
<ul>
<li>
<p>Spock now supports pluggable <a href="#mock-makers">mock makers</a> loaded via ServiceLoader spockPull:1746[]</p>
<div class="ulist">
<ul>
<li>
<p>This allows external libraries to contribute mocking logic to Spock and use the same API for the users</p>
</li>
<li>
<p>You can select the used mock maker during mock creation: <code>Mock(mockMaker:MockMakers.byteBuddy)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Added <a href="#mock-makers-mockito">mockito</a> mock maker spockPull:1753[] which supports:</p>
<div class="ulist">
<ul>
<li>
<p>Mocking of final classes and final methods</p>
</li>
<li>
<p>Mocking of static methods</p>
</li>
<li>
<p>Mocking of classes and interface from different classloaders spockPull:1878[]</p>
</li>
<li>
<p>Requires <code>org.mockito:mockito-core</code> &gt;= 4.11 in the test class path</p>
</li>
</ul>
</div>
</li>
<li>
<p>Added support for mocking of static methods also for Java code with the new API <code>SpyStatic()</code> spockPull:1756[]</p>
<div class="ulist">
<ul>
<li>
<p>The <a href="#static-mocks">static mock methods</a> will delegate the creation to the mock makers</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add <a href="#verify-each">verifyEach</a> method to perform assertions on each element of an <code>Iterable</code> spockPull:1887[]</p>
</li>
<li>
<p>Add <a href="#parameter-injection">annotation extensions for parameters</a> spockPull:1599[]</p>
</li>
<li>
<p>Add support for <a href="#extension-store">keeping state in extensions</a> spockPull:1692[]</p>
</li>
<li>
<p>Add <a href="#spock-interceptors">feature-scoped interceptors</a> spockPull:1844[]</p>
</li>
<li>
<p>Add <code>@Snapshot</code> extension for <a href="#snapshot-testing">snapshot testing</a> spockPull:1873[]</p>
</li>
<li>
<p>Add <code>!!</code> as <a href="#opt-out-of-condition-handling">opt-out operator for assertions</a> spockPull:1532[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_changes_4"><a class="link" href="#_breaking_changes_4">Breaking Changes</a></h4>
<div class="ulist">
<ul>
<li>
<p>Calling <code>old(&#8230;&#8203;)</code> with multiple arguments is now a compilation error. Previously the additional arguments were simply ignored.</p>
</li>
<li>
<p>Creating <code>GroovyMock</code>/<code>GroovyStub</code>/<code>GroovySpy</code> for an already mocked type will now fail.</p>
</li>
<li>
<p>Creating a global <code>GroovyMock</code>/<code>GroovyStub</code>/<code>GroovySpy</code> when <a href="#parallel-execution">parallel execution</a> is enabled,
will now require that the spec is annotated with <a href="#isolated-execution">@Isolated</a> or <code>@ResourceLock(org.spockframework.runtime.model.parallel.Resources.META_CLASS_REGISTRY)</code>. See <a href="#global-mocks-parallel-execution">Global mocks and parallel execution</a> spockPull:1848[]</p>
</li>
<li>
<p><code>@TempDir</code> <code>spock.tempDir.keep</code> has been replaced by <code>spock.tempdir.cleanup</code>. See <a href="#temp-dir-cleanup">TempDir Cleanup</a> spockPull:1525[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc_4"><a class="link" href="#_misc_4">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for parameter injection of <code>@TempDir</code></p>
</li>
<li>
<p>Add cleanup switch for <code>@TempDir</code> spockPull:1525[]</p>
</li>
<li>
<p>Add support for creation of global Groovy mocks for abstract classes spockPull:1754[]</p>
</li>
<li>
<p>Add optional reason to <code>@ResourceLock</code> spockPull:1890[]</p>
</li>
<li>
<p>Add optional reason to <code>@Execution</code> spockPull:1576[]</p>
</li>
<li>
<p>Add <code>onTimeout</code> support for <code>PollingConditions</code> spockPull:1853[]</p>
</li>
<li>
<p>Add <code>SpecInfo#getAll&#8230;&#8203;Methods()</code> methods spockPull:1770[]</p>
</li>
<li>
<p>Add array support to collection conditions spockPull:1734[]</p>
</li>
<li>
<p>Add support for logging thread dumps when <a href="#timeout-extension">@Timeout interrupts</a> are ignored spockPull:1658[]</p>
</li>
<li>
<p>Add implied features to force execution of features even when removed by a build tool spockPull:1598[]</p>
</li>
<li>
<p>Improve StackTraceFilter by ignoring <code>java.lang.invoke.*</code> spockPull:1892[]</p>
</li>
<li>
<p>Improve <code>@TempDir</code> field injection, now it happens before field initialization, so it can be used by other field initializers.</p>
</li>
<li>
<p>Improve Spock-Compiler does not use wrapper types anymore spockPull:1765[]</p>
</li>
<li>
<p>Improve reduce lock contention of the <code>byte-buddy</code> mock maker, when multiple mocks are created concurrently spockPull:1778[]</p>
</li>
<li>
<p>Improve <code>@Use</code> on feature and fixture method for parallel execution spockPull:1691[]</p>
</li>
<li>
<p>Improve IDE support</p>
<div class="ulist">
<ul>
<li>
<p>by adding a closure signature hint that derives closure argument type from variable type spockPull:1785[]</p>
</li>
<li>
<p>by adding missing closure hints for Spy(T, Closure) spockPull:1786[]</p>
</li>
<li>
<p>by adding GDSL/DSLD for ConditionalExtension&#8217;s annotations spockPull:1808[]</p>
</li>
<li>
<p>by making <code>spock.gdsl</code> fail-safe and cover some more cases spockPull:1783[]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Improve RunContexts behavior in multithreaded executions spockPull:1758[], spockPull:1846[]</p>
</li>
<li>
<p>Improve generic handling by replacing <code>gentyref</code> code with <a href="https://github.com/leangen/geantyref">geantyref</a> library spockPull:1743[]</p>
<div class="ulist">
<ul>
<li>
<p>This is now a required dependency used by spock: <code>io.leangen.geantyref:geantyref:1.3.14</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Improve handling of passing <code>null</code> to <code>thrown()</code> to be consistent with mock object creation spockPull:1799[]</p>
</li>
<li>
<p>Improve <code>old(&#8230;&#8203;)</code> calls by validating their argument count spockPull:1810[]</p>
</li>
<li>
<p>Improve robustness of the AST transformation against missing classes in the compile classpath spockPull:1704[]</p>
</li>
<li>
<p>Improve handling of <code>shared.</code> conditions in <code>@IgnoreIf</code>/<code>@Requires</code>, the condition is now checked before creating data providers spockPull:1711[]</p>
</li>
<li>
<p>Fix issue with mocks of Groovy classes, where the Groovy MOP for <code>@Internal</code> methods was not honored by the <code>byte-buddy</code> mock maker spockPull:1729[]</p>
<div class="ulist">
<ul>
<li>
<p>This fixes multiple issues with Groovy MOP: spockIssue:1501[], spockIssue:1452[], spockIssue:1608[] and spockIssue:1145[]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Improve support for generic return types for mocks spockPull:1731[]</p>
<div class="ulist">
<ul>
<li>
<p>This fixes the issues: spockIssue:520[], spockIssue:1163[]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fix the lifecycle of simple features spockPull:1675[]</p>
</li>
<li>
<p>Fix exception when configured <code>baseDir</code> was not existing, now <code>@TempDir</code> will create the baseDir directory if it is missing.</p>
</li>
<li>
<p>Fix bad error message for collection conditions, when one of the operands is <code>null</code></p>
</li>
<li>
<p>Fix docs about initializer method interceptors spockPull:1666[]</p>
</li>
<li>
<p><span class="line-through">Fix possible deadlock, when blocking in mock response generators spockPull:1885[]</span></p>
<div class="ulist">
<ul>
<li>
<p><span class="line-through">This fixes the issues: spockIssue:583[], spockIssue:1882[]</span></p>
</li>
</ul>
</div>
</li>
<li>
<p>Fix SpringSpy not working with <code>DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD</code> spockPull:1869[]</p>
</li>
<li>
<p>Fix null handling for collection conditions spockPull:1858[]</p>
</li>
<li>
<p>Fix interceptor contexts spockPull:1676[]</p>
</li>
<li>
<p>Fix properly call <code>IRunListener.specSkipped</code> and <code>.featureSkipped</code> spockPull:1811[]</p>
</li>
<li>
<p>Fix defining responses for additionalInterfaces spockPull:1730[]</p>
</li>
<li>
<p>Fix lost execution mode for iteration nodes of implied data-driven features spockPull:1615[]</p>
</li>
<li>
<p>Fix docs how to register all possible interceptors spockPull:1667[], spockPull:1824[]</p>
</li>
<li>
<p>Document <code>@ConditionBlock</code> Annotation spockPull:1709[]</p>
</li>
<li>
<p>Document <code>old</code>-Method spockPull:1708[]</p>
</li>
<li>
<p>Document for DetachedMockFactory spockPull:1728[]</p>
</li>
<li>
<p>Clarify documentation for global Mocks spockPull:1755[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release:  Andreas Turban, BjÃ¶rn Kautler, Goooler, JÃ©rÃ´me Prinet, Marcin ZajÄczkowski, MichaÅ WiÅniewski, Nelson Osacky, Pavlo Shevchenko, RahulGautamSingh, Said Boudjelda, Tasuku Nakagawa, jochenberger, soosue</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_m1_2022_11_30"><a class="link" href="#_2_4_m1_2022_11_30">2.4-M1 (2022-11-30)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Fix issues with Spring 6/Spring Boot 3 spockPull:1541[]</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_2_3_2022_09_29"><a class="link" href="#_2_3_2022_09_29">2.3 (2022-09-29)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Add RepeatUntilFailure extension spockPull:1522[]</p>
</li>
<li>
<p>Fix problem with TempDir failing when using a custom class that extends from <code>File</code> or <code>Path</code> spockPull:1519[]</p>
</li>
<li>
<p>Fix issue with <code>Object</code> methods on interface spies spockPull:1529[]</p>
</li>
<li>
<p>Fix equality checking of Mocks that implement <code>Comparable</code> spockPull:1323[]</p>
</li>
<li>
<p>Validate uniqueness of fixture methods per specification class spockPull:1521[]</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The changes to equality checking for <code>Comparable</code> mocks can lead to different behavior when no explicit <code>compareTo</code> interactions was defined.
For example, Groovy will use <code>compareTo</code> to check equality when classes implement <code>Compareable</code>.
Until now, the mock would return <code>0</code> for default invocations, which would lead to the objects being considered equal.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Jackson Popkin</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_2022_08_31"><a class="link" href="#_2_2_2022_08_31">2.2 (2022-08-31)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Support for <code>@SpringBean</code> and <code>@SpringSpy</code> marked with <code>@Primary</code> spockPull:1503[]</p>
</li>
<li>
<p>Fix issue that <code>displayName</code> values for the <code>Specification</code>, which were changed by extensions such as <a href="#title-and-narrative-extension">@Title</a>, not being picked up. spockPull:1509[]</p>
</li>
<li>
<p>Update to JUnit 5.9.0</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Alexander Kriegisch, Marcin ZajÄczkowski, Jonny Carter, alopukhov, Jerome Prinet, Matthew Moss, BJ Hargrave, konradczajka</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_m3_2022_07_15"><a class="link" href="#_2_2_m3_2022_07_15">2.2-M3 (2022-07-15)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Add support for <code>IterationSelector</code> to run individual iterations</p>
</li>
<li>
<p>Update to JUnit 5.9.0-RC1</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marc Philipp</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_m2_2022_07_15"><a class="link" href="#_2_2_m2_2022_07_15">2.2-M2 (2022-07-15)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Add junit-platform <code>TestTag</code> support with the <a href="#test-tag-extension">@Tag</a> extension spockPull:1467[]</p>
</li>
<li>
<p>Add <code>IDataDriver</code> extension point and refactor data provider handling spockPull:1479[]</p>
</li>
<li>
<p>Add <a href="#multi-data-pipe-named">named deconstruction</a> for multi variable datapipes.
This might lead to changed behavior results if the data object implements <code>Map</code> but supports both positional <code>getAt(int)</code> and named <code>getAt(String)</code> access. In earlier versions, the positional access was used, but now the named access will be used. spockPull:1463[]</p>
</li>
<li>
<p>Add custom class support to <code>@TempDir</code>, you can use any class that has a single <code>java.io.File</code> or <code>java.nio.file.Path</code> as constructor parameter spockPull:1430[]</p>
</li>
<li>
<p>Improve <code>@Stepwise</code> can be applied to data-driven feature methods, having the effect of executing them sequentially (even if concurrent test mode is active) and to skip subsequent iterations is one iteration fails. spockPull:1442[]</p>
</li>
<li>
<p>Improve <code>EmbeddedSpecCompiler</code> by making package declaration configurable in <code>EmbeddedSpecCompiler</code></p>
</li>
<li>
<p>Improve do not evaluate feature-skipping conditions for skipped specs spockPull:1459[]</p>
</li>
<li>
<p>Improve behavior when trying to run Spock with unsupported Groovy version in IDEA spockIssue:1421[]</p>
</li>
<li>
<p>Improve Java 17 compatibility by using new <code>invokeDefault</code> instead of reflection</p>
</li>
<li>
<p>Fix compatibility with certain locales, for example <code>tr_TR</code> spockIssue:1414[]</p>
</li>
<li>
<p>Fix Spring 6 incompatibility spockIssue:1428[]</p>
</li>
<li>
<p>Fix test reporting issue with Maven, where an error on the Specification level was not visible spockIssue:1444[]</p>
</li>
<li>
<p>Fix context pollution in <code>IterationNode.around()</code> spockIssue:1441[]</p>
</li>
<li>
<p>Fix Discard unnecessary state in <code>ConfineMetaClassChangesInterceptor</code> spockPull:1460[]</p>
</li>
<li>
<p>Fix make <code>EnableSharedInjection</code> public spockPull:1472[]</p>
</li>
<li>
<p>Fix gradle module metadata dependencies spockPull:1490[]</p>
</li>
<li>
<p>Remove runtime dependency on Jetbrains Annotations spockPull:1468[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Alexander Kriegisch, Marcin ZajÄczkowski, Jonny Carter, alopukhov, Jerome Prinet, Matthew Moss, BJ Hargrave</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_m1_2022_02_16"><a class="link" href="#_2_2_m1_2022_02_16">2.2-M1 (2022-02-16)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Add Groovy 4 support spockPull:1382[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>No other changes to the 2.1 release.</p>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marcin ZajÄczkowski</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_1_2022_02_15"><a class="link" href="#_2_1_2022_02_15">2.1 (2022-02-15)</a></h3>
<div class="paragraph">
<p>No functional changes to 2.1-M2.</p>
</div>
</div>
<div class="sect2">
<h3 id="_official_spock_logo"><a class="link" href="#_official_spock_logo">Official Spock Logo</a></h3>
<div class="imageblock text-center">
<div class="content">
<img src="images/spock-main-logo.png" alt="Spock Logo" width="20%">
</div>
</div>
<div class="paragraph">
<p>The Spock Framework Project has an official logo.
Many thanks to AyÅe AltÄ±nsoy (@AltinsoyAyse) for creating the logo through many iterations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_misc_5"><a class="link" href="#_misc_5">Misc</a></h3>
<div class="ulist">
<ul>
<li>
<p>Documentation fixes</p>
</li>
<li>
<p>Build maintenance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marc Philipp, Miles Thomason, BJ Hargrave, Marcin ZajÄczkowski, LÅrinc Pap, Felipe Pedrosa, Marcin ÅwierczyÅski, Benedikt Ritter, Alexander Kriegisch, JÃ©rÃ´me Prinet, Pin Zhang</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_1_m2_2021_11_12"><a class="link" href="#_2_1_m2_2021_11_12">2.1-M2 (2021-11-12)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Fix issue with generated gradle module metadata that caused issues with consumers.</p>
</li>
<li>
<p>Update JUnit, ASM, ByteBuddy dependencies.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_2_1_m1_2021_11_12"><a class="link" href="#_2_1_m1_2021_11_12">2.1-M1 (2021-11-12)</a></h3>
<div class="sect3">
<h4 id="_highlights_5"><a class="link" href="#_highlights_5">Highlights</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add <a href="#collection-conditions">collection conditions</a> spockIssue:1372[]</p>
</li>
<li>
<p>Add support for selecting individual iterations via their unique ID (IDE support required). spockPull:1376[]</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_changes_5"><a class="link" href="#_breaking_changes_5">Breaking Changes</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add <code>data.</code> support to conditional extensions spockIssue:1360[].
This replaces the  current behavior of accessing data variables without any prefix.
See <a href="#precondition-context">Precondition Context</a> for more details.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc_6"><a class="link" href="#_misc_6">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add exception translation to JUnit4 Rules spockPull:1342[]</p>
</li>
<li>
<p>Add option to omit feature name from iterations spockPull:1386[]
and add additional <a href="#unroll-tokens">Special Tokens</a> to unroll patterns.</p>
</li>
<li>
<p>Add optional reason to <code>@Requires</code> and <code>@IgnoreIf</code> spockPull:1362[]</p>
</li>
<li>
<p>Add <code>shared.</code> support to conditional extensions spockPull:1359[].
See <a href="#precondition-context">Precondition Context</a> for more details.</p>
</li>
<li>
<p>Set the owner for condition closures on spec annotations spockPull:1357[]</p>
<div class="paragraph">
<p>This allows access to static methods when <code>@IgnoreIf</code>, <code>@Requires</code> and <code>@PendingFeatureIf</code> is used on a Specification.</p>
</div>
</li>
<li>
<p>Update bnd Gradle plugin to 6.0.0 (OSGI) spockPull:1377[]</p>
</li>
<li>
<p>Fix selector ordering issue spockPull:1375[]</p>
</li>
<li>
<p>Fix <code>@TempDir</code> not working for <code>@Shared</code> inherited fields spockPull:1373[]</p>
</li>
<li>
<p>Fix JUnit rule run order spockPull:1363[]</p>
</li>
<li>
<p>Prevent removal of ErrorSpecNode from execution hierarchy spockPull:1358[]</p>
<div class="paragraph">
<p>As the ErrorSpecNode does not have children it would get removed
when trying to select specific tests methods
For example, gradle will report that no test were found,
and not report the actual error.</p>
</div>
</li>
<li>
<p>Fix double invocation of IRunListener.beforeSpec and IRunListener.afterSpec spockPull:1344[]</p>
</li>
<li>
<p>Fix regression with multi-assignment of method call result spockPull:1333[]</p>
</li>
<li>
<p>Fix Build MethodSource with the correct spec class name spockPull:1345[]</p>
<div class="paragraph">
<p>Prior to this fix, all <code>SpockNode</code> that use a <code>MethodSource</code>
did not use the actual test class of the discovered method, and
instead used the declaring class. This was problematic for inherited test
methods, since they appeared to come from the declaring class instead of
the current test class. In addition, the Maven Surefire provider failed
to match such methods when executing tests matching a mask (e.g., via
<code>-Dtest=*MaskTest</code>).</p>
</div>
</li>
<li>
<p>Automatically test on CI with JDK 17 (only <code>-groovy-3.0</code> variant)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marc Philipp, Miles Thomason, BJ Hargrave, Marcin ZajÄczkowski, LÅrinc Pap, Felipe Pedrosa, Marcin ÅwierczyÅski, Benedikt Ritter</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_0_2021_05_17"><a class="link" href="#_2_0_2021_05_17">2.0 (2021-05-17)</a></h3>
<div class="sect3">
<h4 id="_highlights_6"><a class="link" href="#_highlights_6">Highlights</a></h4>
<div class="ulist">
<ul>
<li>
<p>Spock is now a test engine based on the JUnit Platform</p>
</li>
<li>
<p>Spock now supports <a href="#parallel-execution">Parallel Execution</a> on the spec and feature level, with powerful tools for shared resource access.</p>
</li>
<li>
<p>Support for Groovy 3</p>
</li>
<li>
<p>Data driven tests are now unrolled by default with a more informative naming scheme</p>
</li>
<li>
<p>Data driven tests can now declare a subset of parameters, which are injected by name instead of position.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>... and many more, read the full release notes for every detail.</p>
</div>
</div>
<div class="sect3">
<h4 id="_migrating_from_1_x"><a class="link" href="#_migrating_from_1_x">Migrating from 1.x</a></h4>
<div class="paragraph">
<p>The <a href="#migration-guide-2-0">Migration Guide 1.x - 2.0</a> covers the major breaking changes between 1.3 and 2.0</p>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_changes_from_2_0_m5"><a class="link" href="#_breaking_changes_from_2_0_m5">Breaking Changes (from 2.0-M5)</a></h4>
<div class="ulist">
<ul>
<li>
<p>Remove <code>@ResourceLockChildren</code> again, as JUnit Platform 5.7.2 makes it obsolete.
With the update a <code>READ</code> lock on a parent node, does not force same thread execution on its children.
If you are one of the few that have already used <code>@ResourceLockChildren</code>, just replace it with <code>@ResourceLock</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc_7"><a class="link" href="#_misc_7">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Fix NPE if variable is initialized using a method with the same in features with cleanup blocks or using thrown condition spockIssue:1266[] spockIssue:1313[]</p>
</li>
<li>
<p>Fix implicit this conversion after bugfix in Groovy 3.0.8 spockIssue:1318[]</p>
</li>
<li>
<p>Fix extension-provided method arguments in fixture methods spockIssue:1305[]</p>
</li>
<li>
<p>Update <code>Jvm</code> helper to support versions up to 23 (next LTS release)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors (all 2.0 Milestones): BjÃ¶rn Kautler, Marcin ZajÄczkowski, DQYuan, Marcin Erdmann, Alexander Kriegisch, Jasper Vandemalle, Tom Wieczorek, Josh Soref, Vaidotas Valuckas, Raymond AugÃ©, Roman Tretiak, Camilo Jorquera, Shil Sinha, Ryan Gardner, k3v1n0x90</p>
</div>
<div class="paragraph">
<p>Special thanks goes to Marc Philipp who helped a lot with the integration of the JUnit Platform.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_0_m5_2021_03_23"><a class="link" href="#_2_0_m5_2021_03_23">2.0-M5 (2021-03-23)</a></h3>
<div class="sect3">
<h4 id="_breaking_changes_6"><a class="link" href="#_breaking_changes_6">Breaking Changes</a></h4>
<div class="ulist">
<ul>
<li>
<p>The <code>ReportLogExtension</code> vestiges were removed. As this extension was mostly used for an unreleased Spock module, this won&#8217;t affect many users.
If you are using a <a href="#spock-configuration-file">Spock Configuration File</a> with a <code>report</code> section,
then you must delete everything from this section except for <code>issueNamePrefix</code> and <code>issueUrlPrefix</code>.
These two properties are still supported and used by the <code>@Issue</code> extension.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_misc_8"><a class="link" href="#_misc_8">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for injection into <code>@Shared</code> fields in <code>spock-spring</code> module which users can opt-in for by adding
<code>@EnableSharedInjection</code> to the specification. spockIssue:76[]</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Add new <code>displayName</code> via <code>INameable</code> for <code>SpecInfo</code>, <code>FeatureInfo</code>, and <code>IterationInfo</code>.
This field can be set via extensions to change the reported name.
The existing iteration <code>NameProvider</code> now also sets the <code>displayName</code> instead of the <code>name</code>.
Modifying the <code>name</code> instead of <code>displayName</code> is now considered <code>deprecated</code> for extensions.
spockIssue:1236[]</p>
</li>
<li>
<p>Add support for constructor injection for extensions</p>
</li>
<li>
<p>Improve final field handling.
Final fields are now transformed similar to shared fields, so that we can still delay the initialization but keep them
unmodifiable to user code. spockIssue:1011[]</p>
</li>
<li>
<p>Improve parallel extensions to support inheritance spockIssue:1245[]</p>
</li>
<li>
<p>Improve PollingConditions</p>
</li>
<li>
<p>Improve some AST transformation code regarding error handling</p>
</li>
<li>
<p>Deprecate <code>AbstractGlobalExtension</code> and replace with <code>IGlobalExtension</code></p>
</li>
<li>
<p>Remove unnecessary try-finally construct for assertions</p>
</li>
<li>
<p>Fix ErrorSpecNode throw Exception in <code>prepare</code> instead of <code>execute</code>
this fixes an issue that interceptors for <code>prepare</code>, <code>before</code>, and <code>around</code>
were still executed and any Exception they throw would hide the actual cause.</p>
</li>
<li>
<p>Fix spockIssue:1294[] swallowing of unrecoverable Errors</p>
</li>
<li>
<p>Fix spockIssue:1260[] Change InteractionRewriter to keep casting of ListExpressions intact</p>
</li>
<li>
<p>Fix spockIssue:1282[] Make TempDirInterceptor safe for parallel invocation of iterations</p>
</li>
<li>
<p>Fix spockIssue:1267[] Retry extension behavior for unrolled tests</p>
</li>
<li>
<p>Fix spockIssue:1267[] Retry extension behavior for unrolled tests</p>
</li>
<li>
<p>Fix spockIssue:1229[] <code>@TempDir</code> not working for inherited fields</p>
</li>
<li>
<p>Fix spockIssue:1232[] compile error for nested conditions without top-level condition</p>
</li>
<li>
<p>Fix spockIssue:1256[] handling of <code>is</code> as getter for boolean properties on Mocks</p>
</li>
<li>
<p>Fix spockIssue:1270[] handling of <code>is</code> as getter for boolean properties on GroovyMocks</p>
</li>
<li>
<p>Fix <code>ErrorSpecNode</code> to re-throw <code>Exception</code> in <code>prepare</code> instead of <code>execute</code>,
this fixes an issue that interceptors for <code>prepare</code>, <code>before</code>, and <code>around</code>
were still executed and any Exception they throw would hide the actual cause.</p>
</li>
<li>
<p>Fix spockIssue:1263[] ExceptionAdapterExtension to also handle inherited fixture methods</p>
</li>
<li>
<p>Fix spockIssue:1279[] Cast data variables with type coercion to the declared parameter type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marcin Erdmann, BjÃ¶rn Kautler, Alexander Kriegisch, Josh Soref, Vaidotas Valuckas</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_0_m4_2020_11_01"><a class="link" href="#_2_0_m4_2020_11_01">2.0-M4 (2020-11-01)</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Added <a href="#parallel-execution">Parallel Execution</a> support</strong></p>
</li>
<li>
<p>Add a way to register <code>ConfigurationObject</code> globally without the need for a global extension.</p>
</li>
<li>
<p>Annotations for local extensions can now be defined as <code>@Repeatable</code> and applied multiple times to the same target.
Spock will handle this appropriately and call the extensions <code>visitSpecAnnotations</code> method with all annotations.
If these methods are not overwritten, they forward to the usual <code>visitSpecAnnotation</code> methods once for each annotation.</p>
</li>
<li>
<p><code>@ConfineMetaClassChanges</code>, <code>@Issue</code>, <code>@IgnoreIf</code>, <code>@PendingFeatureIf</code>, <code>@Requires</code>, <code>@See</code>, <code>@Subject</code>, <code>@Use</code>, and <code>@UseModules</code> are now repeatable annotations</p>
</li>
<li>
<p><code>@Requires</code>, <code>@IgnoreIf</code> and <code>@PendingFeatureIf</code> can now access instance fields, shared fields and instance methods
by using the <code>instance.</code> qualifier inside the condition closure.</p>
</li>
<li>
<p><code>AbstractAnnotationDrivenExtension</code> is now deprecated and its logic was moved to <code>default</code> methods of
<code>IAnnotationDrivenExtension</code> which should be implemented directly now instead of extending the abstract class.</p>
</li>
<li>
<p>Add <code>@TempDir</code> built-in extension</p>
</li>
<li>
<p><code>@PendingFeature</code> and <code>@PendingFeatureIf</code> can now be used together</p>
</li>
<li>
<p>Fix spockIssue:1158[] Fix strange bug with setter/getter handling of mocks in groovy</p>
</li>
<li>
<p>Fix spockIssue:1216[] perform argument coercion for <code>GroovyMock</code> method arguments</p>
</li>
<li>
<p>Fix spockIssue:1169[] check skipped state in Node.prepare and do nothing if already skipped</p>
</li>
<li>
<p>Fix spockIssue:1200[] name clashes where variables that are named like method calls destroy the method call</p>
</li>
<li>
<p>Fix spockIssue:1202[] NullPointerException with array initializers</p>
</li>
<li>
<p>Fix spockIssue:994[] don&#8217;t treat nested closures in argument constraints as implicit assertions anymore</p>
</li>
<li>
<p>Replace <code>hamcrest-core</code> dependency by <code>hamcrest</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: BjÃ¶rn Kautler, Marcin ZajÄczkowski, DQYuan, Tom Wieczorek, Alexander Kriegisch, Jasper Vandemalle</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_0_m3_2020_06_11"><a class="link" href="#_2_0_m3_2020_06_11">2.0-M3 (2020-06-11)</a></h3>
<div class="sect3">
<h4 id="_breaking_changes_7"><a class="link" href="#_breaking_changes_7">Breaking Changes</a></h4>
<div class="sect4">
<h5 id="_sputnik_runner_removed_an_alternative"><a class="link" href="#_sputnik_runner_removed_an_alternative">Sputnik Runner removed (an alternative)</a></h5>
<div class="paragraph">
<p>In 2.0-M1 the Sputnik runner was removed and the 2.0-M2 release notes explicitly mentioned that enhancements
that extend <code>Sputnik</code> or use it as a delegate like for example the <code>PowerMockRunnerDelegate</code> will not work anymore.</p>
</div>
<div class="paragraph">
<p>This is not the full truth though, but be aware that the information in this section is just for informational purpose.
This is not a solution the Spock maintainers explicitly support or maintain. It is just mentioned as hint for those
that have no other choice right now. It is strongly recommended to instead use native solutions or integrations. If
those are not available, you might consider asking about proper integration with Spock for a proper long-term solution.
As long as this is not available, the work-around described here is at least usable as fallback and mid-term solution
as long as the JUnit team decides to maintain this legacy support module.</p>
</div>
<div class="paragraph">
<p>There is a JUnit 4 runner provided by JUnit 5 called <code>JUnitPlatform</code> that can
run any JUnit platform based tests - like Spock 2+ based tests - in a JUnit 4 environment. This is intended
for situations where an IDE, build tool, CI server, or similar does not yet natively support JUnit platform.
It is provided in the artifact <code>org.junit.platform:junit-platform-runner</code>.</p>
</div>
<div class="paragraph">
<p>This means, if you make sure your tests are launched with JUnit 4 and you use <code>JUnitPlatform</code> where you before used
<code>Sputnik</code>, all should work out properly. In case of PowerMock this means you annotate your specification with
<code>@RunWith(PowerMockRunner)</code> and <code>@PowerMockRunnerDelegate(JUnitPlatform)</code> and make sure your tests are launched
using JUnit 4.</p>
</div>
</div>
<div class="sect4">
<h5 id="_removal_of_junit_4_dependency_from_spock_core"><a class="link" href="#_removal_of_junit_4_dependency_from_spock_core">Removal of JUnit 4 dependency from spock-core</a></h5>
<div class="paragraph">
<p>Spock 2.0 from the beginning has leveraged JUnit Platform to execute tests. However, starting with 2.0-M3 <code>junit4.jar</code> is no longer a transitive dependency of <code>spock-core</code>. This might affect people using <code>@Before/@After/&#8230;&#8203;</code> instead of Spock-native <code>setup/cleanup/&#8230;&#8203;</code> fixture methods. To keep it work the <code>spock-junit4</code> dependency has to be added.</p>
</div>
<div class="paragraph">
<p>As a side effect of the removal, the order of the fixture methods execution has changed from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>beforeClass, setupSpec, before, setup, cleanup, after, setup, before, cleanup, after, cleanupSpec, afterClass</code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>setupSpec, beforeClass, setup, before, cleanup, after, setup, before, cleanup, after, cleanupSpec, afterClass</code></pre>
</div>
</div>
<div class="paragraph">
<p>which should not be a problem in the majority of cases.</p>
</div>
<div class="paragraph">
<p>At the same time, using JUnit 4&#8217;s annotations is discouraged (and considered <code>deprecated</code>), the same using the other elements of JUnit 4 (as <code>(Class)Rule</code>&#8203;s).</p>
</div>
</div>
<div class="sect4">
<h5 id="_reduce_spock_core_direct_groovy_dependencies"><a class="link" href="#_reduce_spock_core_direct_groovy_dependencies">Reduce spock-core direct groovy dependencies</a></h5>
<div class="paragraph">
<p><code>spock-core</code> now only depends on <code>groovy.jar</code>. All other Groovy dependencies have been removed,
this should make dependency management a bit easier.
If you relied on other groovy dependencies transitively, you will need to add them directly.</p>
</div>
</div>
<div class="sect4">
<h5 id="_upgrade_to_junit_5_6_and_junit_platform_1_6"><a class="link" href="#_upgrade_to_junit_5_6_and_junit_platform_1_6">Upgrade to JUnit 5.6 (and JUnit Platform 1.6)</a></h5>
<div class="paragraph">
<p>JUnit Platform 1.6 <a href="https://junit.org/junit5/docs/5.6.0/release-notes/index.html#deprecations-and-breaking-changes">deprecated</a> methods (from experimental API)  in <code>EngineExecutionResults</code> that Spock was using. To keep runtime compatibility with JUnit 5.6 and incoming 5.7 the implementation has been switched to the new methods. As a result, Spock 2.0-M3 cannot work with JUnit 5.5 and lower. The problem might only occur if a project overrides default JUnit Platform version provided by Spock.</p>
</div>
</div>
<div class="sect4">
<h5 id="_new_meaning_of"><a class="link" href="#_new_meaning_of">New meaning of <code>&gt;&gt; _</code></a></h5>
<div class="paragraph">
<p>The meaning of <code>&gt;&gt; _</code> has changed from "use the default response" to "return a stubbed value" (<a href="#_returning_a_default_response">Docs</a>).
The original behavior was only ever documented in the Javadocs and was basically the same to just omitting it.
The only use-case was chained responses <code>&gt;&gt; "a" &gt;&gt; _ &gt;&gt; "b"</code>,
but even here it is clearer to just use <code>null</code> or <code>{ callRealMethod() }</code> explicitly.
With the new behavior, you can have a <code>Mock</code> or <code>Spy</code> return the same value as a <code>Stub</code> would.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">subscriber.receive(_) &gt;&gt; _</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_renamed_iterationcount_token"><a class="link" href="#_renamed_iterationcount_token">Renamed iterationCount token</a></h5>
<div class="paragraph">
<p>The token <code>#iterationCount</code> in unroll patterns was renamed to <code>#iterationIndex</code>.
If you use it somewhere, you have to manually change it to the new name
or the test will fail unless you disabled expression asserting,
then you will get an <code>#Error:iterationCount</code> rendering instead.</p>
</div>
</div>
<div class="sect4">
<h5 id="_no_access_to_data_variables_in_data_pipes_anymore"><a class="link" href="#_no_access_to_data_variables_in_data_pipes_anymore">No access to data variables in data pipes anymore</a></h5>
<div class="paragraph">
<p>It is not possible anymore to access any data variable from a data pipe or anything else but a previous data table
column in a data table cell. This access was partly possible, but could easily prematurely drain iterators, access
data providers sooner as expected, behaved differently depending on the concrete code construct used. All these
points are more confusing than necessary. If you want to calculate a data variable from others, you can always use
a derived data variable that has full access to all previous data variables and can also call helper methods for
more complex logic.</p>
</div>
<div class="paragraph">
<p>If you switch your tests that are fully green to use Spock 2.0 and get any <code>MissingPropertyException</code>s, you are probably hitting this change, you should then change to a derived data variable there instead of a data pipe.</p>
</div>
<div class="paragraph">
<p>If you for example had:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a &lt;&lt; [1, 2]
b &lt;&lt; a</code></pre>
</div>
</div>
<div class="paragraph">
<p>what you want instead is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a &lt;&lt; [1, 2]
b = a</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_assert_unroll_expressions_by_default"><a class="link" href="#_assert_unroll_expressions_by_default">Assert unroll expressions by default</a></h5>
<div class="paragraph">
<p>The system property <code>spock.assertUnrollExpressions</code> is not supported anymore.
Instead the new default behavior is equal to having this property set to <code>true</code>.
This means tests that were successful but had an <code>#Error:</code> name rendering will now fail.
It can be set back to the old pre Spock 2.0 behaviour by setting
<code>unroll { validateExpressions false }</code> in the Spock configuration file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_for_extension_developers"><a class="link" href="#_for_extension_developers">For extension developers</a></h5>
<div class="ulist">
<ul>
<li>
<p><code>FeatureInfo#getDataVariables()</code> and <code>FeatureInfo#getParameterNames()</code> used to return the
same value, the parameter names, in the order of the method parameters. This can disturb some calculations like method
argument determination and so on and is plainly wrong, as some parameters could be injected by extensions like
injecting mock objects or test proxies or similar. <code>FeatureInfo#getDataVariables()</code> now only returns the actual data
variables and in the order how they are defined in the <code>where</code> block.</p>
</li>
<li>
<p>Method arguments in <code>MethodInfo</code> now have a value of <code>MethodInfo.MISSING_ARGUMENT</code> if no value was set so far,
for example by some extensions or from data variables. If any of these is not replaced by some value, an exception
will be thrown at runtime.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_ant_support_removed"><a class="link" href="#_ant_support_removed">Ant support removed</a></h5>
<div class="paragraph">
<p><code>SpecClassFileSelector</code> was removed, which was the only class that required <code>ant</code>.
If you are still using spock with <code>ant</code>, then you can just copy the class from the spock source code into your build.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_misc_9"><a class="link" href="#_misc_9">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>A new <code>MutableClock</code> utility class to support time related testing, see <a href="#mutable-clock">docs</a>.</p>
</li>
<li>
<p>Defining interactions on property getters within Mock instantiation closures or <code>with</code> closures works now without
the need to explicitly qualify the property access with <code>it.</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Foo foo = Stub {
    bar &gt;&gt; 'my stubbed property'
}</code></pre>
</div>
</div>
</li>
<li>
<p>A sequence of two or more underscores can be used to separate multiple data tables in one <code>where</code> block.</p>
</li>
<li>
<p>Type casts in conditions are now properly carried over to properly disambiguate method calls.
For more information see issue spockIssue:1022[].</p>
</li>
<li>
<p>Data tables now support any amount of semicolons to separate data table columns as alternative
to pipes and double pipes, but cannot be mixed with them in one table:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a ; b ;; c
1 ; 2 ;; 3</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>The default unroll pattern changed from the rather generic <code>#featureName[#iterationIndex]</code> to a more fancy
version that lists all data variables and their values additionally to the feature name and iteration index.
If you prefer to retain the old behaviour, you can set the setting
<code>unroll { defaultPattern '#featureName[#iterationIndex]' }</code> in the Spock configuration file
and you will get the same result as previously.</p>
</li>
<li>
<p>If neither a parameter to the <code>@Unroll</code> annotation is given, nor the method name contains a <code>#</code>,
now the configuration file setting <code>unroll { defaultPattern }</code> is inspected. If it is set to a non-<code>null</code> string,
this value is used as unroll pattern.</p>
</li>
<li>
<p><code>IterationInfo</code> now has a property for the <code>iterationIndex</code> and one for a map of data variable names to values.
This is typically not interesting for the average user, but might be helpful for authors of Spock extensions.</p>
</li>
<li>
<p><code>constructorArgs</code> now properly transport type cast information to the constructor selection,
for example to disambiguate multiple candidate constructors:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">Spy(constructorArgs: [null as String, (Pattern) null])</code></pre>
</div>
</div>
</li>
<li>
<p>Accessing previous data table columns was broken in some cases, now it should work properly,
even cross-table and without being disturbed by previous derived data variables.</p>
</li>
<li>
<p>The order of parameters in a data-driven feature does no longer have to be identical to
the declaration order in the <code>where</code> block. Data variables are now injected by name.</p>
</li>
<li>
<p>Data driven features do no longer have the requirement that either none or all data variables are declared as
parameters and that all parameters are also data variables. Now you can either declare none, some, or all data
variables as parameters and also have additional method parameters that are no data variables.
Those additional parameters must be provided by some Spock extension though. If they are not set at execution time,
an exception will be thrown.</p>
</li>
<li>
<p>Condition closures used in <code>@Requires</code>, <code>@IgnoreIf</code> and <code>@PendingFeatureIf</code> now also get the context passed
as argument, so you can use this, typed as <code>org.spockframework.runtime.extension.builtin.PreconditionContext</code> to
enable IDE support like code completion:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@IgnoreIf({ PreconditionContext it -&gt; it.os.windows })
def "I'll run everywhere but on Windows"() { ... }</code></pre>
</div>
</div>
</li>
<li>
<p>Execution with an unsupported Groovy version can be allowed with <code>-Dspock.iKnowWhatImDoing.disableGroovyVersionCheck=true</code> spockPull:1164[]</p>
</li>
<li>
<p>Relax maximum allowed Groovy version in snapshot builds spockPull:1108[]</p>
</li>
<li>
<p>Upgrade Groovy to 2.5.12 (improved Java 14+ support) and 3.0.4 (fixes spockIssue:1127[])</p>
</li>
<li>
<p>Upgrade JUnit 4 to 4.13 (in <code>spock-junit4</code>)</p>
</li>
<li>
<p>Upgrade Hamcrest to 2.2 (from 1.3 provided previously by <code>junit4.jar</code>)</p>
</li>
<li>
<p>Derived data variables (assignments in <code>where</code> blocks) now also support multi-assignment syntax, including ignoring
some values with the wildcard expression.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">(a, b, _, c) = row</code></pre>
</div>
</div>
</li>
<li>
<p>Multi-variable data pipes now also support nesting.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">[a, [_, b]] &lt;&lt; [
  [1, [5, 1]],
  [2, [5, 2]]
]</code></pre>
</div>
</div>
</li>
<li>
<p>The condition closures for <code>@IgnoreIf</code>, <code>@Requires</code> and <code>@PendingFeatureIf</code> can now access data variables
if applied to a data driven feature. This has further implications that are documented in the respective
documentation parts and JavaDocs.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Data driven features are now unrolled by default. <code>@Unroll</code> can still be used to specify a custom naming pattern.
A simple <code>@Unroll</code> without argument is not needed anymore except when undoing a spec-level <code>@Rollup</code> annotation
or if unrolling by default is disabled, so any simple <code>@Unroll</code> annotations can be removed from existing code. You
can verify this by looking at the test count which should not have been changed after you removed the simple
<code>@Unroll</code> annotations.</p>
</li>
<li>
<p><code>@Rollup</code> can now be used on feature and spec level to explicitly roll up any feature where the reporting of single
iterations is not wanted.</p>
</li>
<li>
<p>The setting <code>unroll { unrollByDefault false }</code> in the Spock configuration file can be set to roll up all
features by default if not overwritten by explicit <code>@Unroll</code> annotations and thus reinstate the pre
Spock 2.0 behaviour.</p>
</li>
<li>
<p>Updated OSGI support with using <code>bnd</code> (spockPull:1154[], spockPull:1175[])</p>
</li>
<li>
<p>Fix <code>@PendingFeature</code> logic spockPull:1103[]</p>
</li>
<li>
<p>Do not strip type information from arguments spockPull:1134[]</p>
</li>
<li>
<p>Simplify work-around to get the reference to the current closure spockPull:1131[]</p>
</li>
<li>
<p>Set source position for return statement in data provider method spockPull:1116[]</p>
</li>
<li>
<p>Add <code>Spy(T obj, Closure interactions)</code> spockPull:1115[]</p>
</li>
<li>
<p>Reduce number of Groovy dependencies to just groovy.jar spockPull:1109[]</p>
</li>
<li>
<p>Improve <code>ExceptionUtil.sneakyThrow</code> declaration spockPull:1077[]</p>
</li>
<li>
<p>Print up to 5 last mock invocations for a wrong order error spockPull:1093[]</p>
</li>
<li>
<p>Fix <code>EmptyOrDummyResponse</code> returning mock instance for <code>Object</code> spockPull:1092[]</p>
</li>
<li>
<p>Remove unnecessary reflection for Java 8 types in <code>EmptyOrDummyResponse</code> spockPull:1091[]</p>
</li>
<li>
<p>Update old Issue annotations to point to migrated github issues spockPull:1003[]</p>
</li>
<li>
<p>Test Spock with Java 14 spockPull:1155[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: BjÃ¶rn Kautler, Marcin ZajÄczkowski, Raymond AugÃ©, Roman Tretiak, Camilo Jorquera, Shil Sinha</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_0_m2_2020_02_10"><a class="link" href="#_2_0_m2_2020_02_10">2.0-M2 (2020-02-10)</a></h3>
<div class="sect3">
<h4 id="_groovy_3_0_support"><a class="link" href="#_groovy_3_0_support">Groovy-3.0 Support</a></h4>
<div class="paragraph">
<p>The main feature of this milestone is support for Groovy 3.
To use Spock in your Groovy 3 project just select the <code>spock-\*-2.0-M2</code> artifact(s) ending with <code>-groovy-3.0</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As Groovy 3 is not backward compatible with Groovy 2, there is a layer of abstraction in Spock to allow to build (and use) the project with both Groovy 2 and 3.
      As a result, an extra artifact <code>spock-groovy2-compat</code> is (automatically) used in projects with Groovy 2.
      It is <strong>very important</strong> to <strong>do not mix</strong> the <code>spock-*-2.x-groovy-2.5</code> artifacts with the <code>groovy-*-3.x</code> artifacts on a classpath.
      This may result in weird runtime errors.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_changes_8"><a class="link" href="#_breaking_changes_8">Breaking Changes</a></h4>
<div class="sect4">
<h5 id="_sputnik_runner_removed"><a class="link" href="#_sputnik_runner_removed">Sputnik Runner removed</a></h5>
<div class="paragraph">
<p>Although already in 2.0-M1 it wasn&#8217;t explicitly mentioned: All enhancements that either extended <code>Sputnik</code>
or used it as a delegate runner will not work anymore, e.g, <code>PowerMockRunnerDelegate</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_misc_10"><a class="link" href="#_misc_10">Misc</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add <code>@PendingFeatureIf</code> annotation (<a href="#_pendingfeatureif">Docs</a>)</p>
</li>
<li>
<p>Fail-fast for invalid <code>Stub</code> interactions, added new validation that catches more invalid usage of <code>Stub</code></p>
</li>
<li>
<p>Forbid spying on <code>Spy</code> instances, as this doesn&#8217;t work anyway and leads to wrong expectations (spockIssue:1029[])</p>
</li>
<li>
<p>Update <code>Jvm</code> helper utility to include new Java versions, removed pre 8 versions</p>
</li>
<li>
<p>Update docs regarding ByteBuddy, cglib, objenesis</p>
</li>
<li>
<p>Provide compatibility to both JUnit 5.5.2 and 5.6.0</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marcin ZajÄczkowski (Groovy 3 support), BjÃ¶rn Kautler, Ryan Gardner</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_0_m1_2019_12_31"><a class="link" href="#_2_0_m1_2019_12_31">2.0-M1 (2019-12-31)</a></h3>
<div class="paragraph">
<p>This is the first milestone release to version 2.0. This means that we have migrated to the new
JUnit Platform and all internal tests pass. We have tried to keep the API as compatible as possible
and if you&#8217;ve only used the public spock API then there is a high possibility that all you have to
do is to update the spock version and configure gradle/maven to use the JUnit Platform.</p>
</div>
<div class="paragraph">
<p>However, this doesn&#8217;t mean that the API is finalized yet, the goal for the first milestone was just
to get it running on the new platform. The next milestones will focus on improvements like the much
requested parallel execution support.</p>
</div>
<div class="paragraph">
<p>Please try it out and report any new bugs so that we can fix them for the final 2.0 release.</p>
</div>
<div class="sect3">
<h4 id="_breaking_changes_9"><a class="link" href="#_breaking_changes_9">Breaking Changes</a></h4>
<div class="sect4">
<h5 id="_new_junit_platform"><a class="link" href="#_new_junit_platform">New JUnit Platform</a></h5>
<div class="paragraph">
<p>Switch from JUnit 4 to the JUnit Platform.
See <a href="https://junit.org/junit5/docs/current/user-guide/#running-tests-build" class="bare">https://junit.org/junit5/docs/current/user-guide/#running-tests-build</a> on how to configure
maven and gradle to use the JUnit Platform.</p>
</div>
<div class="paragraph">
<p>JUnit 4 Rules are not supported by <code>spock-core</code> anymore, however, there is a new  <code>spock-junit4</code>
module that provides best effort support to ease migration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_misc_11"><a class="link" href="#_misc_11">Misc</a></h5>
<div class="ulist">
<ul>
<li>
<p>Spock now requires at least Java 8</p>
</li>
<li>
<p>All data-driven test iterations are always reported (unrolled), while <code>@Unroll</code> is not necessary anymore
it can still be used to define the name template</p>
</li>
<li>
<p><code>@Retry.Mode.FEATURE</code> didn&#8217;t work anymore and has been removed</p>
</li>
<li>
<p><code>spock-report</code> module has been removed, it was never officially released</p>
</li>
<li>
<p>The <code>SpockReportingExtension</code> has been disabled until we can integrate it with JUnitPlatform</p>
</li>
<li>
<p>Removed testing for <code>spring-2.x</code> as it is incompatible</p>
</li>
<li>
<p>Fix some Javadocs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Special thanks goes to Marc Philipp who helped a lot with the integration of the JUnit Platform.</p>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marcin ZajÄczkowski, k3v1n0x90</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_2019_03_05"><a class="link" href="#_1_3_2019_03_05">1.3 (2019-03-05)</a></h3>
<div class="paragraph">
<p>No functional changes</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_rc1_2019_01_22"><a class="link" href="#_1_3_rc1_2019_01_22">1.3-RC1 (2019-01-22)</a></h3>
<div class="paragraph">
<p>The theme for this release is to increase the information that is provided when an assertion failed.</p>
</div>
<div class="sect3">
<h4 id="_potential_breaking_changes"><a class="link" href="#_potential_breaking_changes">Potential breaking changes</a></h4>
<div class="sect4">
<h5 id="_code_argument_constraints_are_treated_as_implicit_assertions"><a class="link" href="#_code_argument_constraints_are_treated_as_implicit_assertions">code argument constraints are treated as implicit assertions</a></h5>
<div class="paragraph">
<p>Before this release the code argument constrains worked by returning a boolean result.
This was fine if you just wanted to do a simple comparison, but it breaks down if you
need to do 5 comparisons. Users also often assumed that it worked like the assertions in
<code>then</code> blocks and didn&#8217;t add <code>&amp;&amp;</code> to chain multiple assertions together, so their constraint
ignored all before the next line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">1 * mock.foo( { it.size() &gt; 1
                it[0].length == 2 })</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would only use the length comparison, to make it work you had to add <code>&amp;&amp;</code>.
Another problem arises by having more than one comparison inside the constraints,
you don&#8217;t know which of the 5 comparisons failed. If you just expected one method
call you could use an explicit <code>assert</code> as a workaround, but since it immediately
breaks, you can&#8217;t use it if you want to have multiple different calls to the same
mock.</p>
</div>
<div class="paragraph">
<p>With 1.3 the above code will actually work as intended, and even more important it
will give actual feedback what didn&#8217;t match.</p>
</div>
<div class="paragraph">
<p>So what can break?</p>
</div>
<div class="paragraph">
<p>If you used the code argument constraint as a way of capturing
the argument value, then this will most likely not work anymore, since assignments
to already declared variables are forbidden in implicit assertion block.
If you still need access to the argument, you can use the response generator closure
instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def extern = null

1 * mock.foo( { extern = it; it.size() &gt; 0 })  // old
1 * mock.foo( { it.size() &gt; 0 }) &gt;&gt; { extern = it[0] } // new</code></pre>
</div>
</div>
<div class="paragraph">
<p>The added benefit of this changes is, that it clearly differentiates the condition from
the capture.</p>
</div>
<div class="paragraph">
<p>Another consequence of the change is, that the empty <code>{}</code> assertion block will now pass
instead of fail, since no assertion error is being treated as passing, while it required
a <code>true</code> result beforehand.</p>
</div>
<div class="paragraph">
<p>It is advised, that if you have multiple conditions joined by <code>&amp;&amp;</code>, that you remove
it to get individual assertions reports instead of a large joined block.</p>
</div>
</div>
<div class="sect4">
<h5 id="_assertions_with_explicit_messages_now_include_power_assertions_output"><a class="link" href="#_assertions_with_explicit_messages_now_include_power_assertions_output">assertions with explicit messages now include power assertions output.</a></h5>
<div class="listingblock">
<div class="title">Given</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def a = 1
def b = 2
assert a == b : "Additional message"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Before</div>
<div class="content">
<pre>a == b

Additional message</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Now</div>
<div class="content">
<pre>a == b
| |  |
1 |  2
  false

Additional message</pre>
</div>
</div>
<div class="paragraph">
<p>If you relied on this behavior to hide some output, or to prevent a stack overflow due to a self referencing
data structure, then you need to move the condition into a separate method that just returns the boolean result.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release"><a class="link" href="#_whats_new_in_this_release">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add implicit assertions for CodeArgument constraints spockPull:956[]</p>
</li>
<li>
<p>Add power assertion output to asserts with explicit message spockPull:928[]</p>
</li>
<li>
<p>Add support for mixed named and positional arguments in mocks spockPull:919[]</p>
</li>
<li>
<p>Add NamedParam support for groovy-2.5 with backport to 2.4 spockPull:921[]</p>
</li>
<li>
<p>Add special rendering for Set comparisons spockPull:925[]</p>
</li>
<li>
<p>Add identity hash code to type hints in comparison failures if they are identical</p>
</li>
<li>
<p>Fix erroneous regex where an optional colon was defined instead of a non-capturing group spockPull:931[]</p>
</li>
<li>
<p>Improve CodeArgumentConstraint by supporting assertions spockPull:918[]</p>
</li>
<li>
<p>Improve IDE type inference in MockingApi spockPull:920[]</p>
</li>
<li>
<p>Improve reporting of TooFewInvocationsError spockPull:912[]</p>
</li>
<li>
<p>Improve render class loader for classes in comparison failures spockPull:932[]</p>
</li>
<li>
<p>Improve record class literal values to display FQCN in comparison failures spockPull:935[]</p>
</li>
<li>
<p>Improve filter Java 9+ reflection stack frames</p>
</li>
<li>
<p>Improve show stacktrace of throwables in comparison failure result</p>
</li>
<li>
<p>Improve use canonical class name in comparison failure results if present</p>
</li>
<li>
<p>Improve render otherwise irrelevant expressions if they get a type hint in comparison failure spockPull:936[]</p>
</li>
<li>
<p>Fix do not convert implicit "this" expression like when calling the constructor of a non-static inner class spockPull:930[]</p>
</li>
<li>
<p>Fix class expression recording when there are comments with dots in the same line spockPull:937[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: BjÃ¶rn Kautler, Marc Philipp, Marcin ZajÄczkowski, Martin Vseticka, Michael Kutz, Kacper Bublik</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_2018_09_23"><a class="link" href="#_1_2_2018_09_23">1.2 (2018-09-23)</a></h3>
<div class="paragraph">
<p>Breaking Changes: Spock 1.2 drops support for Java 6, Groovy 2.0 and Groovy 2.3</p>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release_2"><a class="link" href="#_whats_new_in_this_release_2">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for Java 11+ (spockIssue:895[], spockIssue:902[], spockIssue:903[])</p>
</li>
<li>
<p>Add Groovy 2.5.0 Variant for better Java 10+ Support</p>
</li>
<li>
<p>Add <code>@SpringBean</code> and <code>@SpringSpy</code> inspired by <code>@MockBean</code>, Also add <code>@StubBeans</code> (<a href="#_annotation_driven">Docs</a>)</p>
</li>
<li>
<p>Add <code>@UnwrapAopProxy</code> to make automatically unwrap SpringAopProxies</p>
</li>
<li>
<p>Add <code>@AutoAttach</code> extension  (<a href="#_autoattach">Docs</a>)</p>
</li>
<li>
<p>Add <code>@Retry</code> extension (<a href="#_retry">Docs</a>)</p>
</li>
<li>
<p>Add flag to UnrollNameProvider to assert unroll expressions (set the system property <code>spock.assertUnrollExpressions</code> to <code>true</code>) (spockIssue:767[])</p>
</li>
<li>
<p>Add automatic module name descriptors for Java 9</p>
</li>
<li>
<p>Add configurable <code>condition</code> to <code>@Retry</code> extension to allow for customizing when retries should be attempted (<a href="#_retry">Docs</a>)</p>
</li>
<li>
<p>Improve <code>@PendingFeature</code> to now have an optional <code>reason</code> attribute (spockIssue:907[])</p>
</li>
<li>
<p>Improve <code>@Retry</code> to be declarable on a spec class which will apply it to all feature methods in that class and subclasses (<a href="#_retry">Docs</a>)</p>
</li>
<li>
<p>Improve StepwiseExtension mark only subsequent features as skipped in case of failure (spockIssue:893[])</p>
</li>
<li>
<p>Improve in assertions Spock now uses <code>DefaultGroovyMethods.dump</code> instead of <code>toString</code> if a class doesn&#8217;t override the default <code>Object.toString</code>.</p>
</li>
<li>
<p>Improve <code>verifyAll</code> can now also have a target same as <code>with</code></p>
</li>
<li>
<p>Improve static type hints for <code>verifyAll</code> and <code>with</code></p>
</li>
<li>
<p>Improve reporting of exceptions during cleanup, they are now properly reported as suppressed exceptions instead of hiding the real exception</p>
</li>
<li>
<p>Improve default responses for stubs, Java 8 types like <code>Optional</code> and <code>Streams</code> now return empty, <code>CompletableFuture</code> completes with <code>null</code> result</p>
</li>
<li>
<p>Improve support for builder pattern, stubs now return themselves if the return type matches the type of the stub</p>
</li>
<li>
<p>Improve tapestry support with by supporting <code>@ImportModule</code></p>
</li>
<li>
<p>Improve <code>constructorArgs</code> for spies can now accept a map directly without the need to wrap it in a list</p>
</li>
<li>
<p>Improve <a href="#_guice_module">Guice Module</a> now automatically attaches detached mocks</p>
</li>
<li>
<p>Improve unmatched mock messages by using <code>dump</code> instead of <code>inspect</code> for classes which don&#8217;t provide a custom <code>toString</code></p>
</li>
<li>
<p>Improve spying on concrete instances to enable partial mocking</p>
</li>
<li>
<p>Fix use String renderer for Class instances (spockIssue:909[])</p>
</li>
<li>
<p>Fix mark new Spring extensions as @Beta (spockIssue:890[])</p>
</li>
<li>
<p>Fix exclude groovy-groovysh from compile dependencies (spockIssue:882[])</p>
</li>
<li>
<p>Fix <code>Retry.Mode.FEATURE</code> and <code>Retry.Mode.SETUP_FEATURE_CLEANUP</code> to make a test pass if a retry was successful.</p>
</li>
<li>
<p>Fix issue with <code>@SpringBean</code> mocks throwing <code>InvocationTargetException</code> instead of actual declared exceptions (spockIssue:878[], spockIssue:887[])</p>
</li>
<li>
<p>Fix void methods with implicit targets failing in <code>with</code> and <code>verifyAll</code> (spockIssue:886[])</p>
</li>
<li>
<p>Fix SpockAssertionErrors and its subclasses now are properly <code>Serializable</code></p>
</li>
<li>
<p>Fix Spring injection of JUnit Rules, due to the changes in 1.1 the rules where initialized before Spring could inject them,
this has been fixed by performing the injection earlier in the process</p>
</li>
<li>
<p>Fix SpringMockTestExecutionListener initializes lazy beans</p>
</li>
<li>
<p>Fix OSGi Import-Package header</p>
</li>
<li>
<p>Fix re-declare recorder variables (spockIssue:783[]), this caused annotations such as <code>@Slf4j</code> to break Specifications</p>
</li>
<li>
<p>Fix MissingFieldException in DiffedObjectAsBeanRenderer</p>
</li>
<li>
<p>Fix problems with nested <code>with</code> and <code>verifyAll</code> method calls</p>
</li>
<li>
<p>Fix assertion of mock invocation order with nested invocations (spockIssue:475[])</p>
</li>
<li>
<p>Fix ignore inferred type for Spies on existing instance</p>
</li>
<li>
<p>General dependency update</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marc Philipp, Rob Elliot, jochenberger, Jan Papenbrock, Paul King, Marcin ZajÄczkowski, mrb-twx,
Alexander Kazakov, Serban Iordache, Xavier Fournet, timothy-long, John Osberg, AlexElin, Benjamin Muschko, Andreas Neumann, geoand,
Burk Hufnagel, signalw, Martin Vseticka, Tilman Ginzel</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_rc3_2018_09_16"><a class="link" href="#_1_2_rc3_2018_09_16">1.2-RC3 (2018-09-16)</a></h3>
<div class="sect3">
<h4 id="_whats_new_in_this_release_3"><a class="link" href="#_whats_new_in_this_release_3">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add support for Java 11+ (spockPull:895[], spockPull:902[], spockPull:903[])</p>
</li>
<li>
<p>Improve <code>@PendingFeature</code> to now have an optional <code>reason</code> attribute spockPull:907[]</p>
</li>
<li>
<p>Fix use String renderer for Class instances spockPull:909[]</p>
</li>
<li>
<p>Fix mark new Spring extensions as @Beta spockPull:890[]</p>
</li>
<li>
<p>Fix exclude groovy-groovysh from compile dependencies spockPull:882[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marc Philipp, Marcin ZajÄczkowski, signalw</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_rc2_2018_09_04"><a class="link" href="#_1_2_rc2_2018_09_04">1.2-RC2 (2018-09-04)</a></h3>
<div class="sect3">
<h4 id="_whats_new_in_this_release_4"><a class="link" href="#_whats_new_in_this_release_4">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add configurable <code>condition</code> to <code>@Retry</code> extension to allow for customizing when retries should be attempted (<a href="#_retry">Docs</a>)</p>
</li>
<li>
<p>Fix <code>Retry.Mode.FEATURE</code> and <code>Retry.Mode.SETUP_FEATURE_CLEANUP</code> to make a test pass if a retry was successful.</p>
</li>
<li>
<p>Improve <code>@Retry</code> to be declarable on a spec class which will apply it to all feature methods in that class and subclasses (<a href="#_retry">Docs</a>)</p>
</li>
<li>
<p>Improve StepwiseExtension mark only subsequent features as skipped in case of failure spockPull:893[]</p>
</li>
<li>
<p>Fix issue with <code>@SpringBean</code> mocks throwing <code>InvocationTargetException</code> instead of actual declared exceptions (spockPull:878[], spockPull:887[])</p>
</li>
<li>
<p>Fix void methods with implicit targets failing in <code>with</code> and <code>verifyAll</code> spockPull:886[]</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Marc Philipp, Tilman Ginzel, Marcin ZajÄczkowski, Martin Vseticka</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_rc1_2018_08_14"><a class="link" href="#_1_2_rc1_2018_08_14">1.2-RC1 (2018-08-14)</a></h3>
<div class="paragraph">
<p>Breaking Changes: Spock 1.2 drops support for Java 6, Groovy 2.0 and Groovy 2.3</p>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release_5"><a class="link" href="#_whats_new_in_this_release_5">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add Groovy 2.5.0 Variant for better Java 10 Support</p>
</li>
<li>
<p>Add @SpringBean and @SpringSpy inspired by @MockBean, Also add @StubBeans</p>
</li>
<li>
<p>Add @UnwrapAopProxy to make automatically unwrap SpringAopProxies</p>
</li>
<li>
<p>Add flag to UnrollNameProvider to assert unroll expressions (set the system property <code>spock.assertUnrollExpressions</code> to <code>true</code>) spockIssue:767[]</p>
</li>
<li>
<p>Add automatic module name descriptors for Java 9</p>
</li>
<li>
<p>Add <code>@AutoAttach</code> extension (<a href="#_autoattach">Docs</a>)</p>
</li>
<li>
<p>Add <code>@Retry</code> extension (<a href="#_retry">Docs</a>)</p>
</li>
<li>
<p>Fix SpockAssertionErrors and its subclasses now are properly <code>Serializable</code></p>
</li>
<li>
<p>Fix Spring injection of JUnit Rules, due to the changes in 1.1 the rules where initialized before Spring could inject them,
this has been fixed by performing the injection earlier in the process</p>
</li>
<li>
<p>Fix SpringMockTestExecutionListener initializes lazy beans</p>
</li>
<li>
<p>Fix OSGi Import-Package header</p>
</li>
<li>
<p>Fix re-declare recorder variables spockPull:783[], this caused annotations such as <code>@Slf4j</code> to break Specifications</p>
</li>
<li>
<p>Fix MissingFieldException in DiffedObjectAsBeanRenderer</p>
</li>
<li>
<p>Fix problems with nested <code>with</code> and <code>verifyAll</code> method calls</p>
</li>
<li>
<p>Fix assertion of mock invocation order with nested invocations spockPull:475[]</p>
</li>
<li>
<p>Fix ignore inferred type for Spies on existing instance</p>
</li>
<li>
<p>Improve in assertions Spock now uses <code>DefaultGroovyMethods.dump</code> instead of <code>toString</code> if a class doesn&#8217;t override the default <code>Object.toString</code>.</p>
</li>
<li>
<p>Improve <code>verifyAll</code> can now also have a target same as <code>with</code></p>
</li>
<li>
<p>Improve static type hints for <code>verifyAll</code> and <code>with</code></p>
</li>
<li>
<p>Improve reporting of exceptions during cleanup, they are now properly reported as suppressed exceptions instead of hiding the real exception</p>
</li>
<li>
<p>Improve default responses for stubs, Java 8 types like <code>Optional</code> and <code>Streams</code> now return empty, <code>CompletableFuture</code> completes with <code>null</code> result</p>
</li>
<li>
<p>Improve support for builder pattern, stubs now return themselves if the return type matches the type of the stub</p>
</li>
<li>
<p>Improve tapestry support with by supporting <code>@ImportModule</code></p>
</li>
<li>
<p>Improve <code>constructorArgs</code> for spies can now accept a map directly without the need to wrap it in a list</p>
</li>
<li>
<p>Improve <a href="#_guice_module">Guice Module</a> now automatically attaches detached mocks</p>
</li>
<li>
<p>Improve unmatched mock messages by using <code>dump</code> instead of <code>inspect</code> for classes which don&#8217;t provide a custom <code>toString</code></p>
</li>
<li>
<p>Improve spying on concrete instances to enable partial mocking</p>
</li>
<li>
<p>General dependency update</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Rob Elliot, jochenberger, Jan Papenbrock, Paul King, Marcin ZajÄczkowski, mrb-twx,
Alexander Kazakov, Serban Iordache, Xavier Fournet, timothy-long, John Osberg, AlexElin, Benjamin Muschko, Andreas Neumann, geoand,
Burk Hufnagel</p>
</div>
</div>
<div class="sect3">
<h4 id="_known_issues"><a class="link" href="#_known_issues">Known Issues</a></h4>
<div class="ulist">
<ul>
<li>
<p>Groovy 2.4.10 introduced a bug that interfered with the way <code>verifyAll</code> works, it has been fixed in 2.4.12</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_2017_05_01"><a class="link" href="#_1_1_2017_05_01">1.1 (2017-05-01)</a></h3>
<div class="sect3">
<h4 id="_whats_new_in_this_release_6"><a class="link" href="#_whats_new_in_this_release_6">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Update docs to include info/examples for Spying instantiated objects</p>
</li>
<li>
<p>Fix integer overflow that could occur when the OutOfMemoryError protection while comparing huge strings kicked in</p>
</li>
<li>
<p>Improve rendering for OutOfMemoryError protection</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_rc_4_2017_03_28"><a class="link" href="#_1_1_rc_4_2017_03_28">1.1-rc-4 (2017-03-28)</a></h3>
<div class="paragraph">
<p>This should be the last rc for 1.1</p>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release_7"><a class="link" href="#_whats_new_in_this_release_7">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>15 merged pull requests</p>
</li>
<li>
<p>Spies can now be created with an already existing target</p>
</li>
<li>
<p>Fix for scoped Spring Beans</p>
</li>
<li>
<p>Fix incompatibility with Spring 2/3 that was introduced in 1.1-rc-1</p>
</li>
<li>
<p>Fix groovy compatibility</p>
</li>
<li>
<p>Fix ByteBuddy compatibility</p>
</li>
<li>
<p>Fix OutOfMemoryError when comparing huge strings</p>
</li>
<li>
<p>Improve default response for <code>java.util.Optional&lt;T&gt;</code>, will now return empty optional</p>
</li>
<li>
<p>Improve detection of Spring Boot tests</p>
</li>
<li>
<p>Improve documentation for global extensions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Taylor Wicksell, Rafael Winterhalter, Marcin ZajÄczkowski, Eduardo Grajeda, Paul King, Andrii, BjÃ¶rn Kautler, Libor Rysavy</p>
</div>
<div class="paragraph">
<p>Known issues with groovy 2.4.10 which breaks a smoke test, but should have little impact on normal use spockPull:709[].</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_rc_3_released_2016_10_17"><a class="link" href="#_1_1_rc_3_released_2016_10_17">1.1-rc-3 (released 2016-10-17)</a></h3>
<div class="paragraph">
<p>Adds compatibility with ByteBuddy as an alternative to cglib for generating mocks and stubs for classes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_rc_2_released_2016_08_22"><a class="link" href="#_1_1_rc_2_released_2016_08_22">1.1-rc-2 (released 2016-08-22)</a></h3>
<div class="paragraph">
<p>1.1 should be here soon but in the meantime there&#8217;s a new release candidate.</p>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release_8"><a class="link" href="#_whats_new_in_this_release_8">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>Support for the new test annotations in Spring Boot 1.4.</p>
</li>
<li>
<p>Fixed the integration of JUnit method rules which now correctly happen "outside" the <code>setup</code> / <code>cleanup</code> methods.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to all the contributors to this release: Jochen Berger, Leonard BrÃ¼nings, Mariusz Gilewicz, Tomasz Juchniewicz, Gamal Mateo, Tobias Schulte, Florian Wilhelm, Kevin Wittek</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_rc_1_released_2016_06_30"><a class="link" href="#_1_1_rc_1_released_2016_06_30">1.1-rc-1 (released 2016-06-30)</a></h3>
<div class="paragraph">
<p>A number of excellent pull requests have been integrated into the 1.1 stream.
Currently some features are incubating.
We encourage users to try out these new features and provide feedback so we can finalize the content for a 1.1 release.</p>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release_9"><a class="link" href="#_whats_new_in_this_release_9">What&#8217;s New In This release</a></h4>
<div class="ulist">
<ul>
<li>
<p>44 merged pull requests</p>
</li>
<li>
<p>The <code>verifyAll</code> method can be used to assert multiple boolean expressions <em>without</em> short-circuiting those after a failure.
For example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>then:
verifyAll {
  a == b
  b == c
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Detached mocks via the <code>DetachedMockFactory</code> and <code>SpockMockFactoryBean</code> classes see the <a href="#spring-module">Spring Module Docs</a>.</p>
</li>
<li>
<p>Cells in a data table can refer to the current value for a column to the left.</p>
</li>
<li>
<p><code>Spy</code> can be used to create partial mocks for Java 8 interfaces with <code>default</code> methods just as it can for abstract classes.</p>
</li>
<li>
<p>Improved power assert output when an exception occurs evaluating an assertion.</p>
</li>
<li>
<p>A new <code>@PendingFeature</code> annotation to distinguish incomplete functionality from features with <code>@Ignore</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Special thanks to all the contributors to this release: Dmitry Andreychuk, Aseem Bansal, Daniel Bechler, Fedor Bobin, Leonard BrÃ¼nings, Leonard Daume, Marcin Erdmann, Jarl Friis, SÃ¸ren Berg Glasius, Serban Iordache, Michal Kordas, Pap LÅrinc, Vlad Muresan, Etienne Neveu, Glyn Normington, David Norton, Magnus PalmÃ©r, Gus Power, Oliver Reissig, Kevin Wittek and Marcin ZajÄczkowski</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_0_released_2015_03_02"><a class="link" href="#_1_0_released_2015_03_02">1.0 (released 2015-03-02)</a></h3>
<div class="paragraph">
<p>1.0 has arrived! Finally (and some years late) the version number communicates what
<a href="https://code.google.com/p/spock/wiki/WhoIsUsingSpock">Spock users</a> have known for ages - that Spock isn&#8217;t only useful
and fun, but also reliable, mature, and here to stay. So please, go out and tell everyone who hasn&#8217;t been assimilated
that now is the time to join the party!</p>
</div>
<div class="paragraph">
<p>A special thanks goes to all our tireless speakers and supporters, only a few of which are listed here: Andres Almiray,
CÃ©dric Champeau, David Dawson, Rob Fletcher, Sean Gilligan, Ken Kousen, Guillaume Laforge,
<a href="https://www.nofluffjuststuff.com/home/main">NFJS Tour</a>, Graeme Rocher, Baruch Sadogursky, Odin Hole Standal,
Howard M. Lewis Ship, Ken Sipe, Venkat Subramaniam, Russel Winder.</p>
</div>
<div class="sect3">
<h4 id="_whats_new_in_this_release_10"><a class="link" href="#_whats_new_in_this_release_10">What&#8217;s New In This Release</a></h4>
<div class="ulist">
<ul>
<li>
<p><a href="#_contributors">17 contributors</a>, <a href="#_resolved_issues">21 resolved issues</a>, <a href="#_merged_pull_requests">18 merged pull requests</a>,
<a href="#_ongoing_work">some ongoing work</a>. No ground-breaking new features, but significant improvements and fixes across the board.</p>
</li>
<li>
<p>Minimum runtime requirements raised to JRE 1.6 and Groovy 2.0.</p>
</li>
<li>
<p>Improved and restyled reference documentation at <a href="https://docs.spockframework.org" class="bare">https://docs.spockframework.org</a>. Generated with
<a href="https://asciidoctor.org/">Asciidoctor</a> (what else?).</p>
</li>
<li>
<p>Maven plugin removed. Just let Maven Surefire run your Spock specs like your JUnit tests
(see <a href="https://examples.spockframework.org">spock-example</a> project).</p>
</li>
<li>
<p>Official support for Java 1.8, Groovy 2.3 and Groovy 2.4. Make sure to pick the <code>groovy-2.0</code> binaries for Groovy
2.0/2.1/2.2, <code>groovy-2.3</code> binaries for Groovy 2.3, and <code>groovy-2.4</code> binaries for Groovy 2.4 and higher.</p>
</li>
<li>
<p>Improved infrastructure to allow for easier community involvement: Switch to
<a href="https://issues.spockframework.org">GitHub issue tracker</a>, <a href="https://winbuilds.spockframework.org">Windows</a> and
<a href="https://builds.spockframework.org">Linux</a> CI builds, pull requests automatically tested, all development on <code>master</code>
branch (bye-bye <code>groovy-x.y</code> branches!).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_other_news"><a class="link" href="#_other_news">Other News</a></h4>
<div class="ulist">
<ul>
<li>
<p>Follow our new <a href="https://twitter.spockframework.org">Twitter account</a></p>
</li>
<li>
<p>Try these <a href="#_new_third_party_extensions">new third-party extensions</a></p>
</li>
<li>
<p>Check out the upcoming <a href="https://manning.com/kapelonis/">Java Testing with Spock</a> book from Manning</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_whats_up_next"><a class="link" href="#_whats_up_next">What&#8217;s Up Next?</a></h4>
<div class="paragraph">
<p>With a revamped build/release process and a reforming core team, we hope to release much more frequently from now on.
Another big focus will be to better involve the community and their valuable contributions. Last but not least, we are
finally shooting for a professional logo and website. Stay tuned for announcements!</p>
</div>
<div class="paragraph">
<p>Test Long And Prosper,</p>
</div>
<div class="paragraph">
<p>The Spock Team</p>
</div>
<hr>
</div>
<div class="sect3">
<h4 id="_contributors"><a class="link" href="#_contributors">Contributors</a></h4>
<div class="paragraph">
<p>17 awesome people contributed to this release:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jblack10101">Jordan Black</a></p>
</li>
<li>
<p><a href="https://github.com/Fuud">Fedor Bobin</a></p>
</li>
<li>
<p><a href="https://github.com/leonard84">Leonard BrÃ¼nings</a></p>
</li>
<li>
<p><a href="https://github.com/cetnar">cetnar</a></p>
</li>
<li>
<p><a href="https://github.com/ldaley">Luke Daley</a></p>
</li>
<li>
<p><a href="https://github.com/daviddawson">David Dawson</a></p>
</li>
<li>
<p><a href="https://github.com/selenium34">Scott G</a></p>
</li>
<li>
<p><a href="https://github.com/msgilligan">Sean Gilligan</a></p>
</li>
<li>
<p><a href="https://github.com/tawus">Taha Hafeez</a></p>
</li>
<li>
<p><a href="https://github.com/lhotari">Lari Hotari</a></p>
</li>
<li>
<p><a href="https://github.com/niligulmohar">Nicklas Lindgren</a></p>
</li>
<li>
<p><a href="https://github.com/david-w-millar">David W Millar</a></p>
</li>
<li>
<p><a href="https://github.com/pniederw">Peter Niederwieser</a></p>
</li>
<li>
<p><a href="https://github.com/palmplam">Jean-Baptiste Nallet</a></p>
</li>
<li>
<p><a href="https://github.com/Opalo">Opalo</a></p>
</li>
<li>
<p><a href="https://github.com/magdzikk">Magda StoÅ¼ek</a></p>
</li>
<li>
<p><a href="https://github.com/rvarlikli">Ramazan VARLIKLI</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_resolved_issues"><a class="link" href="#_resolved_issues">Resolved Issues</a></h4>
<div class="paragraph">
<p>21 burning issues were fixed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=221">Create a example which uses ConfineMetaClassChanges</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=273">Mistakes in PollingConditions sphinx docs</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=274">Closure used as data value in where-block can&#8217;t be called with method syntax</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=276">old() expression blows up when part of failing condition</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=278">Reflect subsequent filtering/sorting in a spec&#8217;s JUnit description</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=282">After/AfterClass/Before/BeforeClass methods from superclass should not be called if they have been overrided in the derived class</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=286">Data values in where-block are not resolved in nested closures</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=290">spock-maven:0.7-groovy-2.0 has an invalid descriptor (and a workaround for this)</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=291">PollingConditions doesn&#8217;t report failed assertion</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=292">Provide a Specification.with() overload that states the expected target type</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=294">Problem with array arguments to mock methods</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=296">spock-tapestry should support @javax.inject.Inject and @InjectService</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=297">Compilation error when using multi assignment</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=302">Groovy mocks should allow to mock final classes/methods</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=307">Better generics support for mocks and stubs</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=338">GC calls to finalize() on mocks cause strict interaction specifications (0 * _) to fail intermittently</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=371">Multiple Assignment in when: and anything in cleanup:</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=385">Move OptimizeRunOrderSuite from spock-core to spock-maven to solve a problem with Android&#8217;s test runner</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=391">Support running on JDK 8</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=392">Release binary variants for Groovy 2.3 and Groovy 2.4</a></p>
</li>
<li>
<p><a href="https://code.google.com/p/spock/issues/detail?id=393">Port reference documentation to Asciidoc</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_merged_pull_requests"><a class="link" href="#_merged_pull_requests">Merged Pull Requests</a></h4>
<div class="paragraph">
<p>18 hand-crafted pull requests were merged or cherry-picked:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spockframework/spock/pull/51">Update extensions.rst</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/48">allow one column data-table to be passed as parameter</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/45">Use https:// link to Maven Central</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/44">Change Snapshot Repository to use https:// URL</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/43">Fix incorrect code listing in docs</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/41">Minor documentation corrections: spelling, code examples. README.md corr&#8230;&#8203;</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/40">added manifest to core.gradle to allow spock core to work in OSGi land</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/38">Allow Build on Windows</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/33">Small typo fixed</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/32">Update interaction_based_testing.rst</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/31">Closure used as data value in where-block can&#8217;t be called with method syntax</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/30">Added docs for Stepwise, Timeout, Use, ConfineMetaClassChanges, AutoClea&#8230;&#8203;</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/16">Spring @ContextHierarchy support</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/14">Add groovy console support for the specs project, to ease debugging of the AST.</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/13">Update spock-report/src/test/groovy/org/spockframework/report/sample/Fig&#8230;&#8203;</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/12">spock-tapestry: added support for @InjectService, @javax.inject.Inject</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/11">missing code</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/10">Support overriding Junit After*/Before* methods in the derived class</a>(</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_new_third_party_extensions"><a class="link" href="#_new_third_party_extensions">New Third Party Extensions</a></h4>
<div class="paragraph">
<p>These awesome extensions have been published or updated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension">Spock Subjects-Collaborators Extension</a></p>
</li>
<li>
<p><a href="https://github.com/renatoathaydes/spock-reports">Spock Reports Extension</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ongoing_work"><a class="link" href="#_ongoing_work">Ongoing Work</a></h4>
<div class="paragraph">
<p>These great features didn&#8217;t make it into this release (but hopefully the next!):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://spockframework.github.io/spock/sampleReports/Ninja%20Commander.html">Spock reports</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/49">Render exceptions in conditions as condition failure</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/50">Soft asserts: check all then throw all failures</a></p>
</li>
<li>
<p><a href="https://github.com/spockframework/spock/pull/17">Detached mocks</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_0_7_released_2012_10_08"><a class="link" href="#_0_7_released_2012_10_08">0.7 (released 2012-10-08)</a></h3>
<div class="sect3">
<h4 id="_snapshot_repository_moved"><a class="link" href="#_snapshot_repository_moved">Snapshot Repository Moved</a></h4>
<div class="paragraph">
<p>Spock snapshots are now available from <a href="https://oss.sonatype.org/content/repositories/snapshots/org/spockframework/" class="bare">https://oss.sonatype.org/content/repositories/snapshots/org/spockframework/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_new_reference_documentation"><a class="link" href="#_new_reference_documentation">New Reference Documentation</a></h4>
<div class="paragraph">
<p>The new Spock reference documentation is available at <a href="https://docs.spockframework.org" class="bare">https://docs.spockframework.org</a>.
It will gradually replace the documentation at <a href="https://wiki.spockframework.org" class="bare">https://wiki.spockframework.org</a>.
Each Spock version is documented separately (e.g. <a href="https://docs.spockframework.org/en/spock-0.7-groovy-1.8" class="bare">https://docs.spockframework.org/en/spock-0.7-groovy-1.8</a>).
Documentation for the latest Spock snapshot is at <a href="https://docs.spockframework.org/en/latest" class="bare">https://docs.spockframework.org/en/latest</a>.
As of Spock 0.7, the chapters on <a href="#data-driven-testing">Data Driven Testing</a> and
<a href="#interaction-based-testing">Interaction Based Testing</a> are complete.</p>
</div>
</div>
<div class="sect3">
<h4 id="_improved_mocking_failure_message_for_toomanyinvocationserror"><a class="link" href="#_improved_mocking_failure_message_for_toomanyinvocationserror">Improved Mocking Failure Message for <code>TooManyInvocationsError</code></a></h4>
<div class="paragraph">
<p>The diagnostic message accompanying a <code>TooManyInvocationsError</code> has been greatly improved.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Too many invocations for:

3 * person.sing(_)   (4 invocations)

Matching invocations (ordered by last occurrence):

2 * person.sing("do")   &lt;-- this triggered the error
1 * person.sing("re")
1 * person.sing("mi")</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#_verification_of_interactions">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_improved_mocking_failure_message_for_toofewinvocationserror"><a class="link" href="#_improved_mocking_failure_message_for_toofewinvocationserror">Improved Mocking Failure Message for <code>TooFewInvocationsError</code></a></h4>
<div class="paragraph">
<p>The diagnostic message accompanying a <code>TooFewInvocationsError</code> has been greatly improved.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Too few invocations for:

1 * person.sing("fa")   (0 invocations)

Unmatched invocations (ordered by similarity):

1 * person.sing("re")
1 * person.say("fa")
1 * person2.shout("mi")</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#_verification_of_interactions">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_stubs"><a class="link" href="#_stubs">Stubs</a></h4>
<div class="paragraph">
<p>Besides mocks, Spock now has explicit support for stubs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = Stub(Person)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A stub is a restricted form of mock object that responds to invocations without ever demanding them.
Other than not having a cardinality, a stub&#8217;s interactions look just like a mock&#8217;s interactions.
Using a stub over a mock is an effective way to communicate its role to readers of the specification.</p>
</div>
<div class="paragraph">
<p><a href="#Stubs">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_spies"><a class="link" href="#_spies">Spies</a></h4>
<div class="paragraph">
<p>Besides mocks, Spock now has support for spies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = Spy(Person, constructorArgs: ["Fred"])</code></pre>
</div>
</div>
<div class="paragraph">
<p>A spy sits atop a real object, in this example an instance of class <code>Person</code>. All invocations on the spy
that don&#8217;t match an interaction are delegated to that object. This allows to listen in on and selectively
change the behavior of the real object. Furthermore, spies can be used as partial mocks.</p>
</div>
<div class="paragraph">
<p><a href="#Spies">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_declaring_interactions_at_mock_creation_time"><a class="link" href="#_declaring_interactions_at_mock_creation_time">Declaring Interactions at Mock Creation Time</a></h4>
<div class="paragraph">
<p>Interactions can now be declared at mock creation time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = Mock(Person) {
    sing() &gt;&gt; "tra-la-la"
    3 * eat()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature is particularly attractive for <a href="#Stubs">Stubs</a>.</p>
</div>
<div class="paragraph">
<p><a href="#Stubs">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_groovy_mocks"><a class="link" href="#_groovy_mocks">Groovy Mocks</a></h4>
<div class="paragraph">
<p>Spock now offers specialized mock objects for spec&#8217;ing Groovy code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def mock = GroovyMock(Person)
def stub = GroovyStub(Person)
def spy = GroovySpy(Person)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Groovy mock automatically implements <code>groovy.lang.GroovyObject</code>. It allows stubbing and mocking
of dynamic methods just like for statically declared methods. When a Groovy mock is called from Java
rather than Groovy code, it behaves like a regular mock.</p>
</div>
<div class="paragraph">
<p><a href="#GroovyMocks">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_global_mocks"><a class="link" href="#_global_mocks">Global Mocks</a></h4>
<div class="paragraph">
<p>A Groovy mock can be made <em>global</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">GroovySpy(Person, global: true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A global mock can only be created for a class type. It effectively replaces all instances of that type and makes them
amenable to stubbing and mocking. (You may know this behavior from Groovy&#8217;s <code>MockFor</code> and <code>StubFor</code> facilities.)
Furthermore, a global mock allows mocking of the type&#8217;s constructors and static methods.</p>
</div>
<div class="paragraph">
<p><a href="#MockingAllInstancesOfAType">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_grouping_conditions_with_same_target_object"><a class="link" href="#_grouping_conditions_with_same_target_object">Grouping Conditions with Same Target Object</a></h4>
<div class="paragraph">
<p>Inspired from Groovy&#8217;s <code>Object.with</code> method, the <code>Specification.with</code> method allows to group conditions
involving the same target object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = new Person(name: "Fred", age: 33, sex: "male")

expect:
with(person) {
    name == "Fred"
    age == 33
    sex == "male"
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grouping_interactions_with_same_target_object"><a class="link" href="#_grouping_interactions_with_same_target_object">Grouping Interactions with Same Target Object</a></h4>
<div class="paragraph">
<p>The <code>with</code> method can also be used for grouping interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def service = Mock(Service)
app.service = service

when:
app.run()

then:
with(service) {
    1 * start()
    1 * act()
    1 * stop()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#_grouping_interactions_with_same_target">Reference Documentation</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_polling_conditions"><a class="link" href="#_polling_conditions">Polling Conditions</a></h4>
<div class="paragraph">
<p><code>spock.util.concurrent.PollingConditions</code> joins <code>AsyncConditions</code> and <code>BlockingVariable(s)</code> as another utility for
testing asynchronous code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = new Person(name: "Fred", age: 22)
def conditions = new PollingConditions(timeout: 10)

when:
Thread.start {
    sleep(1000)
    person.age = 42
    sleep(5000)
    person.name = "Barney"
}

then:
conditions.within(2) {
    assert person.age == 42
}

conditions.eventually {
    assert person.name == "Barney"
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_experimental_dsl_support_for_eclipse"><a class="link" href="#_experimental_dsl_support_for_eclipse">Experimental DSL Support for Eclipse</a></h4>
<div class="paragraph">
<p>Spock now ships with a DSL descriptor that lets Groovy Eclipse better
understand certain parts of Spock&#8217;s DSL. The descriptor is automatically
detected and activated by the IDE. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">// currently need to type variable for the following to work
Person person = new Person(name: "Fred", age: 42)

expect:
with(person) {
    name == "Fred" // editor understands and auto-completes 'name'
    age == 42      // editor understands and auto-completes 'age'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = Stub(Person) {
    getName() &gt;&gt; "Fred" // editor understands and auto-completes 'getName()'
    getAge() &gt;&gt; 42      // editor understands and auto-completes 'getAge()'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DSL support is activated for Groovy Eclipse 2.7.1 and higher. If necessary,
it can be deactivated in the Groovy Eclipse preferences.</p>
</div>
</div>
<div class="sect3">
<h4 id="_experimental_dsl_support_for_intellij_idea"><a class="link" href="#_experimental_dsl_support_for_intellij_idea">Experimental DSL Support for IntelliJ IDEA</a></h4>
<div class="paragraph">
<p>Spock now ships with a DSL descriptor that lets Intellij IDEA better
understand certain parts of Spock&#8217;s DSL. The descriptor is automatically
detected and activated by the IDE. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = new Person(name: "Fred", age: 42)

expect:
with(person) {
    name == "Fred" // editor understands and auto-completes 'name'
    age == 42      // editor understands and auto-completes 'age'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def person = Stub(Person) {
    getName() &gt;&gt; "Fred" // editor understands and auto-completes 'getName()'
    getAge() &gt;&gt; 42      // editor understands and auto-completes 'getAge()'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DSL support is activated for IntelliJ IDEA 11.1 and higher.</p>
</div>
</div>
<div class="sect3">
<h4 id="_splitting_up_class_specification"><a class="link" href="#_splitting_up_class_specification">Splitting up Class Specification</a></h4>
<div class="paragraph">
<p>Parts of class <code>spock.lang.Specification</code> were pulled up into two new super classes: <code>spock.lang.MockingApi</code>
now contains all mocking-related methods, and <code>org.spockframework.lang.SpecInternals</code> contains internal methods
which aren&#8217;t meant to be used directly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_improved_failure_messages_for_notthrown_and_noexceptionthrown"><a class="link" href="#_improved_failure_messages_for_notthrown_and_noexceptionthrown">Improved Failure Messages for <code>notThrown</code> and <code>noExceptionThrown</code></a></h4>
<div class="paragraph">
<p>Instead of just passing through exceptions, <code>Specification.notThrown</code> and <code>Specification.noExceptionThrown</code>
now fail with messages like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expected no exception to be thrown, but got 'java.io.FileNotFoundException'

Caused by: java.io.FileNotFoundException: ...</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hamcrestsupport_expect"><a class="link" href="#_hamcrestsupport_expect"><code>HamcrestSupport.expect</code></a></h4>
<div class="paragraph">
<p>Class <code>spock.util.matcher.HamcrestSupport</code> has a new <code>expect</code> method that makes
<a href="https://hamcrest.org/JavaHamcrest/">Hamcrest</a> assertions read better in then-blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">when:
def x = computeValue()

then:
expect x, closeTo(42, 0.01)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_beta"><a class="link" href="#_beta">@Beta</a></h4>
<div class="paragraph">
<p>Recently introduced classes and methods may be annotated with <code>@Beta</code>, as a sign that they may still undergo incompatible
changes. This gives us a chance to incorporate valuable feedback from our users. (Yes, we need your feedback!) Typically,
a <code>@Beta</code> annotation is removed within one or two releases.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fixed_issues"><a class="link" href="#_fixed_issues">Fixed Issues</a></h4>
<div class="paragraph">
<p>See the <a href="https://code.google.com/p/spock/issues/list?can=1&amp;q=label%3AMilestone-0.7">issue tracker</a> for a list of fixed issues.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_0_6_released_2012_05_02"><a class="link" href="#_0_6_released_2012_05_02">0.6 (released 2012-05-02)</a></h3>
<div class="sect3">
<h4 id="_mocking_improvements"><a class="link" href="#_mocking_improvements">Mocking Improvements</a></h4>
<div class="paragraph">
<p>The mocking framework now provides better diagnostic messages in some cases.</p>
</div>
<div class="paragraph">
<p>Multiple result declarations can be chained. The following causes method bar to throw an <code>IOException</code> when first called,
return the numbers one, two, and three on the next calls, and throw a <code>RuntimeException</code> for all subsequent calls:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">foo.bar() &gt;&gt; { throw new IOException() } &gt;&gt;&gt; [1, 2, 3] &gt;&gt; { throw new RuntimeException() }</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s now possible to match any argument list (including the empty list) with <code>foo.bar(*_)</code>.</p>
</div>
<div class="paragraph">
<p>Method arguments can now be constrained with <a href="https://hamcrest.org/JavaHamcrest/">Hamcrest</a> matchers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import static spock.util.matcher.HamcrestMatchers.closeTo

...

1 * foo.bar(closeTo(42, 0.001))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extended_junit_rules_support"><a class="link" href="#_extended_junit_rules_support">Extended JUnit Rules Support</a></h4>
<div class="paragraph">
<p>In addition to rules implementing <code>org.junit.rules.MethodRule</code> (which has been deprecated in JUnit 4.9), Spock now also
supports rules implementing the new <code>org.junit.rules.TestRule</code> interface. Also supported is the new <code>@ClassRule</code>
annotation. Rule declarations are now verified and can leave off the initialization part. I that case Spock will
automatically initialize the rule by calling the default constructor. The <code>@TestName</code> rule, and rules in general, now
honor the <code>@Unroll</code> annotation and any defined naming pattern.</p>
</div>
<div class="paragraph">
<p>See <a href="https://code.google.com/p/spock/issues/detail?id=240">Issue 240</a> for a known limitation with Spock&#8217;s TestRule support.</p>
</div>
</div>
<div class="sect3">
<h4 id="_condition_rendering_improvements"><a class="link" href="#_condition_rendering_improvements">Condition Rendering Improvements</a></h4>
<div class="paragraph">
<p>When two objects are compared with the <code>==</code> operator, they are unequal, but their string representations are the same,
Spock will now print the objects' types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>enteredNumber == 42
|             |
|             false
42 (java.lang.String)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_junit_fixture_annotations"><a class="link" href="#_junit_fixture_annotations">JUnit Fixture Annotations</a></h4>
<div class="paragraph">
<p>Fixture methods can now be declared with JUnit&#8217;s <code>@Before</code>, <code>@After</code>, <code>@BeforeClass</code>, and <code>@AfterClass</code> annotations,
as an addition or alternative to Spock&#8217;s own fixture methods. This was particularly needed for Grails 2.0 support.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tapestry_5_3_support"><a class="link" href="#_tapestry_5_3_support">Tapestry 5.3 Support</a></h4>
<div class="paragraph">
<p>Thanks to a contribution from <a href="https://howardlewisship.com/">Howard Lewis Ship</a>, the Tapestry module is now compatible
with Tapestry 5.3. Older 5.x versions are still supported.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ibm_jdk_support"><a class="link" href="#_ibm_jdk_support">IBM JDK Support</a></h4>
<div class="paragraph">
<p>Spock now runs fine on IBM JDKs, working around a bug in the IBM JDK&#8217;s verifier.</p>
</div>
</div>
<div class="sect3">
<h4 id="_improved_junit_compatibility"><a class="link" href="#_improved_junit_compatibility">Improved JUnit Compatibility</a></h4>
<div class="paragraph">
<p><code>org.junit.internal.AssumptionViolatedException</code> is now recognized and handled as known from JUnit. <code>@Unrolled</code> methods
no longer cause "yellow" nodes in IDEs.</p>
</div>
</div>
<div class="sect3">
<h4 id="improved-unroll-0.6"><a class="link" href="#improved-unroll-0.6">Improved <code>@Unroll</code></a></h4>
<div class="paragraph">
<p>The <code>@Unroll</code> naming pattern can now be provided in the method name, instead of as an argument to the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll
def "maximum of #a and #b is #c"() {
    expect:
    Math.max(a, b) == c

    where:
    a | b | c
    1 | 2 | 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The naming pattern now supports property access and zero-arg method calls:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll
def "#person.name.toUpperCase() is #person.age years old"() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Unroll</code> annotation can now be applied to a spec class. In this case, all data-driven feature methods in the class
will be unrolled.</p>
</div>
</div>
<div class="sect3">
<h4 id="_improved_timeout"><a class="link" href="#_improved_timeout">Improved <code>@Timeout</code></a></h4>
<div class="paragraph">
<p>The <code>@Timeout</code> annotation can now be applied to a spec class. In this case, the timeout applies to all feature methods
(individually) that aren&#8217;t already annotated with <code>@Timeout</code>. Timed methods are now executed on the regular test
framework thread. This can be important for tests that rely on thread-local state (like Grails integration tests).
Also the interruption behavior has been improved, to increase the chance that a timeout can be enforced.</p>
</div>
<div class="paragraph">
<p>The failure exception that is thrown when a timeout occurs now contains the stacktrace of test execution, allowing you
to see where the test was âstuckâ or how far it got in the allocated time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_improved_data_table_syntax"><a class="link" href="#_improved_data_table_syntax">Improved Data Table Syntax</a></h4>
<div class="paragraph">
<p>Table cells can now be separated with double pipes. This can be used to visually set apart expected outputs from
provided inputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">...
where:
a | b || sum
1 | 2 || 3
3 | 1 || 4</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_groovy_1_82_0_support"><a class="link" href="#_groovy_1_82_0_support">Groovy 1.8/2.0 Support</a></h4>
<div class="paragraph">
<p>Spock 0.6 ships in three variants for Groovy 1.7, 1.8, and 2.0. Make sure to pick the right version - for example,
for Groovy 1.8 you need to use spock-core-0.6-groovy-1.8 (likewise for all other modules). The Groovy 2.0 variant
is based on Groovy 2.0-beta-3-SNAPSHOT and only available from <a href="https://m2repo.spockframework.org" class="bare">https://m2repo.spockframework.org</a>. The Groovy 1.7 and
1.8 variants are also available from Maven Central. The next version of Spock will no longer support Groovy 1.7.</p>
</div>
</div>
<div class="sect3">
<h4 id="_grails_2_0_support"><a class="link" href="#_grails_2_0_support">Grails 2.0 Support</a></h4>
<div class="paragraph">
<p>Spock&#8217;s Grails plugin was split off into a separate project and now lives at <a href="https://github.spockframework.org/spock-grails" class="bare">https://github.spockframework.org/spock-grails</a>.
The plugin supports both Grails 1.3 and 2.0.</p>
</div>
<div class="paragraph">
<p>The Spock Grails plugin supports all of the new Grails 2.0 test mixins, effectively deprecating the existing unit
testing classes (e.g. UnitSpec). For integration testing, IntegrationSpec must still be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_intellij_idea_integration"><a class="link" href="#_intellij_idea_integration">IntelliJ IDEA Integration</a></h4>
<div class="paragraph">
<p>The folks from <a href="https://www.jetbrains.com">JetBrains</a> have added a few handy features around data tables. Data tables
will now be layed out automatically when reformatting code. Data variables are no longer shown as "unknown" and have
their types inferred from the values in the table (!).</p>
</div>
</div>
<div class="sect3">
<h4 id="_github_repository"><a class="link" href="#_github_repository">GitHub Repository</a></h4>
<div class="paragraph">
<p>All source code has moved to <a href="https://github.spockframework.org/" class="bare">https://github.spockframework.org/</a>. The <a href="https://github.spockframework.org/spock-grails">Grails Spock plugin</a>,
<a href="https://github.spockframework.org/spock-example">Spock Example</a> project, and
<a href="https://github.spockframework.org/spockwebconsole">Spock Web Console</a> now have their own GitHub projects.
Also available are slides and code for various Spock presentations (such as
<a href="https://github.spockframework.org/smarter-testing-with-spock">this one</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_gradle_build"><a class="link" href="#_gradle_build">Gradle Build</a></h4>
<div class="paragraph">
<p>Spock is now exclusively built with Gradle. Building Spock yourself is as easy as cloning the
<a href="https://github.spockframework.org/spock">Github repo</a> and executing <code>gradlew build</code>. No build tool installation is
required; the only prerequisite for building Spock is a JDK installation (1.5 or higher).</p>
</div>
</div>
<div class="sect3">
<h4 id="_fixed_issues_2"><a class="link" href="#_fixed_issues_2">Fixed Issues</a></h4>
<div class="paragraph">
<p>See the <a href="https://code.google.com/p/spock/issues/list?can=1&amp;q=label%3AMilestone-0.6">issue tracker</a> for a list of fixed issues.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_migration_guide"><a class="link" href="#_migration_guide">Migration Guide</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page explains incompatible changes between successive versions and provides suggestions on how to deal with them.</p>
</div>
<div class="sect2">
<h3 id="migration-guide-2-0"><a class="link" href="#migration-guide-2-0">2.0</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section only touches on the breaking changes, see the <a href="release_notes.html#release-notes">Release Notes</a> for a full list of changes and new features.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spock 2.0 aims to be as compatible as possible for existing code bases, while making the necessary changes to stay a modern test framework.</p>
</div>
<div class="paragraph">
<p>The biggest change is the switch from being a JUnit 4 Runner to a full-fledged JUnit Platform <code>TestEngine</code>.
That means, that you&#8217;ll have to configure your build to use the JUnit Platform to execute tests.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://junit.org/junit5/docs/current/user-guide/#running-tests-build">JUnit Platform Guide</a> on how to configure your build to use the JUnit Platform.</p>
</div>
<div class="sect3">
<h4 id="_junit_4_support"><a class="link" href="#_junit_4_support">JUnit 4 support</a></h4>
<div class="paragraph">
<p>Support for JUnit 4 has been removed from <code>spock-core</code>, you can use the new <code>spock-junit4</code> module if you still need JUnit 4 features, such as <code>@Rule</code>.</p>
</div>
<div class="paragraph">
<p>You can replace the <code>TemporaryFolder</code> rule with the new built-in <code>@TempDir</code> <a href="#temp-dir">extension</a>.</p>
</div>
<div class="paragraph">
<p>Spock 2.0 also removed the <code>Sputnik</code> runner, so if you have used <code>PowerMockRunnerDelegate</code> or other things that relied on the runner, you&#8217;ll have to find other solutions.
Take a look at <a href="https://github.com/spockframework/spock/wiki/Third-Party-Extensions">Third-Party-Extensions</a> for solutions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reduce_spock_core_direct_groovy_dependencies_2"><a class="link" href="#_reduce_spock_core_direct_groovy_dependencies_2">Reduce spock-core direct groovy dependencies</a></h4>
<div class="paragraph">
<p><code>spock-core</code> now only depends on <code>groovy.jar</code>. All other Groovy dependencies have been removed,
this should make dependency management a bit easier.
If you relied on other groovy dependencies transitively, you will need to add them directly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_unroll_changes"><a class="link" href="#_unroll_changes">Unroll changes</a></h4>
<div class="ulist">
<ul>
<li>
<p>Data driven features are now unrolled by default. <code>@Unroll</code> can still be used to specify a custom naming pattern.
A simple <code>@Unroll</code> without argument is not needed anymore except when undoing a spec-level <code>@Rollup</code> annotation
or if unrolling by default is disabled, so any simple <code>@Unroll</code> annotations can be removed from existing code. You
can verify this by looking at the test count which should not have been changed after you removed the simple
<code>@Unroll</code> annotations.</p>
</li>
<li>
<p><code>@Rollup</code> can now be used on feature and spec level to explicitly roll up any feature where the reporting of single
iterations is not wanted.</p>
</li>
<li>
<p>The setting <code>unroll { unrollByDefault false }</code> in the Spock configuration file can be set to roll up all
features by default if not overwritten by explicit <code>@Unroll</code> annotations and thus reinstate the pre
Spock 2.0 behaviour.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>The default unroll pattern changed from the rather generic <code>#featureName[#iterationIndex]</code> to a more fancy
version that lists all data variables and their values additionally to the feature name and iteration index.
If you prefer to retain the old behaviour, you can set the setting
<code>unroll { defaultPattern '#featureName[#iterationIndex]' }</code> in the Spock configuration file
and you will get the same result as previously.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_assert_unroll_expressions_by_default_2"><a class="link" href="#_assert_unroll_expressions_by_default_2">Assert unroll expressions by default</a></h4>
<div class="paragraph">
<p>The system property <code>spock.assertUnrollExpressions</code> is not supported anymore.
Instead the new default behavior is equal to having this property set to <code>true</code>.
This means tests that were successful but had an <code>#Error:</code> name rendering will now fail.
It can be set back to the old pre Spock 2.0 behaviour by setting
<code>unroll { validateExpressions false }</code> in the Spock configuration file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_renamed_iterationcount_token_2"><a class="link" href="#_renamed_iterationcount_token_2">Renamed iterationCount token</a></h4>
<div class="paragraph">
<p>The token <code>#iterationCount</code> in unroll patterns was renamed to <code>#iterationIndex</code>.
If you use it somewhere, you have to manually change it to the new name
or the test will fail unless you disabled expression asserting,
then you will get an <code>#Error:iterationCount</code> rendering instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="_new_meaning_of_2"><a class="link" href="#_new_meaning_of_2">New meaning of <code>&gt;&gt; _</code></a></h4>
<div class="paragraph">
<p>The meaning of <code>&gt;&gt; _</code> has changed from "use the default response" to "return a stubbed value" (<a href="#_returning_a_default_response">Docs</a>).
The original behavior was only ever documented in the Javadocs and was basically the same to just omitting it.
The only use-case was chained responses <code>&gt;&gt; "a" &gt;&gt; _ &gt;&gt; "b"</code>,
but even here it is clearer to just use <code>null</code> or <code>{ callRealMethod() }</code> explicitly.
With the new behavior, you can have a <code>Mock</code> or <code>Spy</code> return the same value as a <code>Stub</code> would.</p>
</div>
</div>
<div class="sect3">
<h4 id="_no_access_to_data_variables_in_data_pipes_anymore_2"><a class="link" href="#_no_access_to_data_variables_in_data_pipes_anymore_2">No access to data variables in data pipes anymore</a></h4>
<div class="paragraph">
<p>It is not possible anymore to access any data variable from a data pipe or anything else but a previous data table
column in a data table cell. This access was partly possible, but could easily prematurely drain iterators, access
data providers sooner as expected, behaved differently depending on the concrete code construct used. All these
points are more confusing than necessary. If you want to calculate a data variable from others, you can always use
a derived data variable that has full access to all previous data variables and can also call helper methods for
more complex logic.</p>
</div>
<div class="paragraph">
<p>If you switch your tests that are fully green to use Spock 2.0 and get any <code>MissingPropertyException</code>s, you are probably hitting this change, you should then change to a derived data variable there instead of a data pipe.</p>
</div>
<div class="paragraph">
<p>If you for example had:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a &lt;&lt; [1, 2]
b &lt;&lt; a</code></pre>
</div>
</div>
<div class="paragraph">
<p>what you want instead is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">where:
a &lt;&lt; [1, 2]
b = a</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ant_support_removed_2"><a class="link" href="#_ant_support_removed_2">Ant support removed</a></h4>
<div class="paragraph">
<p><code>SpecClassFileSelector</code> was removed, which was the only class that required <code>ant</code>.
If you are still using spock with <code>ant</code>, then you can just copy the class from the spock source code into your build.</p>
</div>
</div>
<div class="sect3">
<h4 id="_other_breaking_changes"><a class="link" href="#_other_breaking_changes">Other Breaking changes</a></h4>
<div class="ulist">
<ul>
<li>
<p>Add new <code>displayName</code> via <code>INameable</code> for <code>SpecInfo</code>, <code>FeatureInfo</code>, and <code>IterationInfo</code>.
This field can be set via extensions to change the reported name.
The existing iteration <code>NameProvider</code> now also sets the <code>displayName</code> instead of the <code>name</code>.
Modifying the <code>name</code> instead of <code>displayName</code> is now considered <code>deprecated</code> for extensions.
spockIssue:1236[]</p>
</li>
<li>
<p>Spock now requires at least Java 8</p>
</li>
<li>
<p><code>@Retry.Mode.FEATURE</code> didn&#8217;t work anymore and has been removed</p>
</li>
<li>
<p><code>spock-report</code> module has been removed, it was never officially released
:leveloffset: -1</p>
</li>
<li>
<p>The <code>ReportLogExtension</code> vestiges were removed. As this extension was mostly used for an unreleased Spock module, this won&#8217;t affect many users.
If you are using a <a href="#spock-configuration-file">Spock Configuration File</a> with a <code>report</code> section,
then you must delete everything from this section except for <code>issueNamePrefix</code> and <code>issueUrlPrefix</code>.
These two properties are still supported and used by the <code>@Issue</code> extension.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_0"><a class="link" href="#_1_0">1.0</a></h3>
<div class="paragraph">
<p>Specs, Spec base classes and third-party extensions may have be recompiled in order to work with Spock 1.0.</p>
</div>
<div class="paragraph">
<p>JRE 1.5 and Groovy versions below 2.0 are no longer supported.</p>
</div>
<div class="paragraph">
<p>Make sure to pick the right binaries for your Groovy version of choice: <code>groovy-2.0</code> for Groovy 2.0/2.1/2.2,
<code>groovy-2.3</code> for Groovy 2.3, and <code>groovy-2.4</code> for Groovy 2.4 and higher. Spock won&#8217;t let you run with a "wrong" version.</p>
</div>
<div class="paragraph">
<p>No known source incompatible changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_0_7"><a class="link" href="#_0_7">0.7</a></h3>
<div class="paragraph">
<p>Client code must be recompiled in order to work with Spock 0.7. This includes third-party Spock extensions and base classes.</p>
</div>
<div class="paragraph">
<p>No known source incompatible changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_0_6"><a class="link" href="#_0_6">0.6</a></h3>
<div class="sect3">
<h4 id="_class_initialization_order"><a class="link" href="#_class_initialization_order">Class initialization order</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only affects cases where one specification class inherits from another one.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Given these specifications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Base extends Specification {
    def base1 = "base1"
    def base2

    def setup() { base2 = "base2" }
}

class Derived extends Base {
    def derived1 = "derived1"
    def derived2

    def setup() { derived2 = "derived2" }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In 0.5, above assignments happened in the order <code>base1</code>, <code>base2</code>, <code>derived1</code>, <code>derived2</code>. In other words, field
initializers were executed right before the setup method in the same class. In 0.6, assignments happen in the order
<code>base1</code>, <code>derived1</code>, <code>base2</code>, <code>derived2</code>. This is a more conventional order that solves a few problems that users
faced with the previous behavior, and also allows us to support JUnit&#8217;s new <code>TestRule</code>. As a result of this change,
the following will no longer work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Base extends Specification {
    def base

    def setup() { base = "base" }
}

class Derived extends Base {
    def derived = base + "derived" // base is not yet set
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To overcome this problem, you can either use a field initializer for <code>base</code>, or move the assignment of <code>derived</code> into
a setup method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_unroll_naming_pattern_syntax"><a class="link" href="#_unroll_naming_pattern_syntax"><code>@Unroll</code> naming pattern syntax</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is not a change from 0.5, but a change compared to 0.6-SNAPSHOT.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only affects the Groovy 1.8 and 2.0 variants.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In 0.5, the naming pattern was string based:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll("maximum of #a and #b is #c")
def "maximum of two numbers"() {
    expect:
    Math.max(a, b) == c

    where:
    a | b | c
    1 | 2 | 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In 0.6-SNAPSHOT, this was changed to a closure returning a <code>GString</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Unroll({"maximum of $a and $b is $c"})
def "maximum of two numbers"() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For various reasons, the new syntax didn&#8217;t work out as we had hoped, and eventually we decided to go back to the string
based syntax. See <a href="release_notes.html#improved-unroll-0.6">Improved <code>@Unroll</code></a> for recent improvements to that syntax.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hamcrest_matcher_syntax"><a class="link" href="#_hamcrest_matcher_syntax">Hamcrest matcher syntax</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only affects users moving from the Groovy 1.7 to the 1.8 or 2.0 variant.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spock offers a very neat syntax for using <a href="https://hamcrest.org/JavaHamcrest/">Hamcrest</a> matchers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import static spock.util.matcher.HamcrestMatchers.closeTo

...

expect:
answer closeTo(42, 0.001)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Due to changes made between Groovy 1.7 and 1.8, this syntax no longer works in as many cases as it did before.
For example, the following will no longer work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">expect:
object.getAnswer() closeTo(42, 0.001)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid such problems, use <code>HamcrestSupport.that</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import static spock.util.matcher.HamcrestSupport.that

...

expect:
that answer, closeTo(42, 0.001)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A future version of Spock will likely remove the former syntax and strengthen the latter one.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_frequently_asked_questions_faq"><a class="link" href="#_frequently_asked_questions_faq">Frequently Asked Questions (FAQ)</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_are_spocks_optional_dependencies_used_for"><a class="link" href="#_what_are_spocks_optional_dependencies_used_for">What are Spock&#8217;s optional dependencies used for?</a></h3>
<div class="paragraph">
<p>Spock runs fine without optional dependencies, hence the term <em>optional</em>. So what are they used for?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Objenesis (artifact <code>org.objenesis:objenesis</code>) is required for mocking classes without default constructors.</p>
</li>
<li>
<p>Either ByteBuddy (artifact <code>net.bytebuddy:byte-buddy</code>) or CGLIB (artifact <code>cglib:cglib-nodep</code>) are required for mocking classes and not just interfaces.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also <a href="#_mocking_classes">Mocking Classes</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_are_there_two_options_bytebuddy_vs_cglib_for_mocking_classes"><a class="link" href="#_why_are_there_two_options_bytebuddy_vs_cglib_for_mocking_classes">Why are there two options (ByteBuddy vs CGLIB) for mocking classes?</a></h3>
<div class="paragraph">
<p>The main reason is backwards compatibility.
CGLIB came first historically, ByteBuddy was added later.
Both libraries basically provide identical features from a Spock user&#8217;s perspective.</p>
</div>
<div class="paragraph">
<p>If you are starting with Spock now, we recommend ByteBuddy as our preferred choice.</p>
</div>
<div class="paragraph">
<p>CGLIB is in legacy support mode, we will support it as long as the maintenance effort is relatively low.
So you may continue to use CGLIB for now if e.g. your tests use it in another context already.
If you have no compelling reasons to avoid ByteBuddy, you can just switch from CGLIB to ByteBuddy in an existing project.
Your tests should continue to run like before.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_known_issues_2"><a class="link" href="#_known_issues_2">Known Issues</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="instance-spy-on-java-17"><a class="link" href="#instance-spy-on-java-17">Constructing a Spy from an existing instance on Java 17+</a></h3>
<div class="paragraph">
<p>Java continues to tighten up on reflection usage,
and it is no longer possible to make fields accessible in every case.</p>
</div>
<div class="paragraph">
<p>As spying on an existing instance involves creating a spy instance,
and then copying the fields from the original instance to the spy instance,
this can run into issues on Java 17+ when the code does not have access to the module of the class being spied upon, or any of its parent classes.</p>
</div>
<div class="paragraph">
<p>A workaround is to use the appropriate <code>--add-opens</code> parameter to the jvm.
For example, if you are spying on a class in the <code>java.util</code>, <code>--add-opens java.base/java.util=ALL-UNNAMED</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Be aware that this will affect all code in the test JVM, so it can hide issues in the code under test.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In general, it is recommended to use <code>Mock</code>/<code>Stub</code> instead of <code>Spy</code> when possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_usage_of_final_in_a_feature_method_with_cleanup_spockissue1017"><a class="link" href="#_usage_of_final_in_a_feature_method_with_cleanup_spockissue1017">Usage of <code>final</code> in a feature method with <code>cleanup</code> spockIssue:1017[]</a></h3>
<div class="paragraph">
<p>You might run into issues if you use <code>final</code> in your Specification.
Groovy 2.5 introduced a final checker which broke previously compiling code.</p>
</div>
<div class="paragraph">
<p><strong>tl;dr</strong>: Do not use <code>final</code> inside of features if you get compile errors.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Users combining <code>final</code> and <code>@CompileStatic</code> or <code>final</code> and Spock may see errors from the <code>final</code> variable analyzer.
Work is underway to resolve those error messages.
You may need to temporarily remove the final modifier in the meantime.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="https://groovy-lang.org/releasenotes/groovy-2.5.html#Groovy2.5releasenotes-Knownissues">Groovy 2.5 Release Notes</a>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Broken extends Specification {
    def "test"() {
        final value = 'hello'

        expect:
        value.size() &gt; 3

        cleanup:
        clean value
    }

    def clean(v) {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will fail with something like.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; Task :compileTestGroovy FAILED
startup failed:
/Users/acme/projects/spock-tests/src/test/groovy/Broken.groovy: 11: The variable [value] may be uninitialized
. At [11:15]  @ line 11, column 15.
           clean value</pre>
</div>
</div>
<div class="paragraph">
<p>This is due to how Spock implements <code>cleanup</code>, by wrapping the whole body in a <code>try-finally</code> block during the AST transformation.
If you look at the compiled code you can see how it was transformed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">try {
    java.lang.Object value                                       <i class="conum" data-value="1"></i><b>(1)</b>
    java.lang.Throwable $spock_feature_throwable
    try {
        value = 'hello'                                          <i class="conum" data-value="2"></i><b>(2)</b>
        try {
            org.spockframework.runtime.SpockRuntime.verifyCondition($spock_errorCollector, $spock_valueRecorder.reset(), 'value.size() &gt; 3', 8, 9, null, $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(5), $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(3), $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(0), value).$spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(1), 'size')()) &gt; $spock_valueRecorder.record($spock_valueRecorder.startRecordingValue(4), 3)))
        }
        catch (java.lang.Throwable throwable) {
            org.spockframework.runtime.SpockRuntime.conditionFailedWithException($spock_errorCollector, $spock_valueRecorder, 'value.size() &gt; 3', 8, 9, null, throwable)}
        finally {
        }
    }
    catch (java.lang.Throwable $spock_tmp_throwable) {
        $spock_feature_throwable = $spock_tmp_throwable
        throw $spock_tmp_throwable
    }
    finally {
        try {
            this.clean(value)                                   <i class="conum" data-value="3"></i><b>(3)</b>
        }
        catch (java.lang.Throwable $spock_tmp_throwable) {
            if ( $spock_feature_throwable != null) {
                $spock_feature_throwable.addSuppressed($spock_tmp_throwable)
            } else {
                throw $spock_tmp_throwable
            }
        }
        finally {
        }
    }
    this.getSpecificationContext().getMockController().leaveScope()
}
finally {
    $spock_errorCollector.validateCollectedErrors()
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here it moved the variable declaration outside of the <code>try-finally</code> block</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here it tries to initialize the field</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here it is passed to cleanup</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The catch-22 is that the variable must be declared outside of the <code>try-finally</code> block, to be available in the finally,
but for the variable initialization to be covered by the cleanup it must be initialized inside the <code>try</code> block.
This works fine for normal variables, but final variable can only be initialized when they are declared.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_traits_with_specifications"><a class="link" href="#_using_traits_with_specifications">Using Traits with Specifications</a></h3>
<div class="paragraph">
<p>Traits on Specifications are not supported by Spock, some use-cases might work while others don&#8217;t.
This is due to how groovy implements traits and AST transformations.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Traits are not officially compatible with AST transformations. Some of them, like @CompileStatic will be applied on the trait itself (not on implementing classes), while others will apply on both the implementing class and the trait. There is absolutely no guarantee that an AST transformation will run on a trait as it does on a regular class, so use it at your own risk!</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="https://docs.groovy-lang.org/next/html/documentation/core-traits.html#_compatibility_with_ast_transformations">Groovy Docs</a>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_groovy_version_compatibility"><a class="link" href="#_groovy_version_compatibility">Groovy version compatibility</a></h3>
<div class="paragraph">
<p>By default, Spock can only be used with the Groovy version it was compiled with. It means that Spock <code>2.0-groovy-2.5</code> can only executed with Groovy 2.5.x, <code>2.0-groovy-3.0</code> with 3.0.x, etc. That restriction was introduced to help users find an appropriate Groovy variant and limit number of reported invalid issues caused by the incompatibilities between the major Groovy versions.</p>
</div>
<div class="paragraph">
<p>However, occasionally it might be useful to be able to play with the next (officially unsupported) Groovy version, especially that usually, in the majority of cases, it should just work fine. Starting with Groovy 2.0 that restriction has been relaxed in the Spock SNAPSHOT versions. In addition, the early adopters can implicitly disable that check - also in the production versions - providing the system property <code>-Dspock.iKnowWhatImDoing.disableGroovyVersionCheck=true</code>. <strong>Please bear in mind, however, that it is completely unsupported and might lead to some unexpected errors</strong>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The idea behind allowing method parameters is to enable better IDE support. However, recent versions of IntelliJ IDEA recognize data variables automatically, and even infer their types from the values contained in the data table.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. For example, a feature method could use data variables in its <code>given:</code> block, but not in any conditions.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. For additional ways to create mock objects, see <a href="#OtherKindsOfMockObjects">Other Kinds of Mock Objects</a> and <a href="#ALaCarteMocks">A la Carte Mocks</a>.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. The <code>subscriber</code> variable cannot be referenced from the closure because it is being declared as part of the same statement.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. The destructuring semantics for closure arguments come straight from Groovy.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. You may know this behavior from Groovy&#8217;s <a href="https://docs.groovy-lang.org/docs/groovy-4.0.13/html/gapi/groovy/mock/interceptor/MockFor.html">MockFor</a> and <a href="https://docs.groovy-lang.org/docs/groovy-4.0.13/html/gapi/groovy/mock/interceptor/StubFor.html">StubFor</a> facilities.
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. Because mock configurations are immutable, the interface contains just the properties' getters.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version X-replaced-by-gradle<br>
Last updated 2025-06-04 11:22:06 UTC
</div>
</div>
</body>
</html>